
/* 
 * _init.js
 */
function initPage(controllerName, actionName)
{
    var functionName = 'init' + controllerName;
    if (typeof eval('window.' + functionName) == 'function') {
        eval(functionName+ '()');
    }
    functionName = 'init' + controllerName + actionName;
    if (typeof eval('window.' + functionName) == 'function') {
        eval(functionName+ '()');
    }
}
/* 
 * _main.js
 */
/**
 * Переопределяется в компоненте yaMetrika
 */
window.yaMetrika = false;

if (!window.Promise) {
    $.ajax({
        url      : '//cdn.jsdelivr.net/bluebird/3.5.0/bluebird.min.js',
        dataType : 'script',
        cache    : true,
    })
}

var twig = {
    compile : function(tpl) {
        return Twig.twig({data:tpl})
    },
    render : function(parsedTpl, params, toDOM) {
        var result = parsedTpl.render(params)
        return (toDOM === true) ? $(result) : result
    },
}

setTimeout(function () {
    var notification = $("#global_notification");
    if (notification) {
        $(notification).find('a.close').on('click',function(){
            var src = $(this).attr('href');
            $.ajax({
                type     : 'POST',
                url      : '/a/user/notificationRead/',
                data     : 'notification_id='+notification.data('id')+'&BITRIX_SECURITY_KEY=' + BITRIX_SECURITY_KEY,
                dataType : 'json',
                success  : function(json) {
                    if (src) {
                        window.location = src;
                    } else {
                        notification.addClass('h');
                    }
                }
            });
            if (src) {
                return false;
            }
        });
    }

    if (typeof alarm == "undefined") {
        return;
    }
    alarm.each(function (item) {
        var a = item.split('|');
        alert2(a[0], a[1]);
    });
}, 0);

function filterDigits(event) {
    // Allow: backspace, delete, tab, escape, and enter
    if ( event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 27 || event.keyCode == 13 ||
        // Allow: Ctrl+A
        (event.keyCode == 65 && event.ctrlKey === true) ||
        // Allow: home, end, left, right
        (event.keyCode >= 35 && event.keyCode <= 39)) {
        // let it happen, don't do anything
        return;
    }
    else {
        // Ensure that it is a number and stop the keypress
        if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105 )) {
            event.preventDefault();
        }
    }
}

/**
 * Функция возвращает окончание для множественного числа слова на основании числа и массива окончаний
 * @param  iNumber Integer Число на основе которого нужно сформировать окончание
 * @param  aEndings Array Массив слов или окончаний для чисел (1, 4, 5),
 *         например ['яблоко', 'яблока', 'яблок']
 * @return String
 */
function getNumEnding(iNumber, aEndings) {
    console.warn('deprecated usage');
    console.warn(aEndings);
    var sEnding, i;
    iNumber = iNumber % 100;
    if (iNumber >= 11 && iNumber <= 19) {
        sEnding = aEndings[2];
    }
    else {
        i = iNumber % 10;
        switch (i) {
            case (1):
                sEnding = aEndings[0];
                break;
            case (2):
            case (3):
            case (4):
                sEnding = aEndings[1];
                break;
            default:
                sEnding = aEndings[2];
        }
    }
    return sEnding;
}

function objLength(obj) {
    var result = 0;
    for (var i in obj) if (obj.hasOwnProperty(i)) {
        result++;
    }
    return result;
};

function moneyFormat(price) {
    price = parseInt(price);
    return price.number_format(0, '.', ' ');
}

Number.prototype.number_format = function(c, d, t){
    var n = this,
        c = isNaN(c = Math.abs(c)) ? 2 : c,
        d = d == undefined ? "." : d,
        t = t == undefined ? "," : t,
        s = n < 0 ? "-" : "",
        i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "",
        j = (j = i.length) > 3 ? j % 3 : 0;
    return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
};

function showHiddenBlock(btn, id) {
    var el = document.id(id);
    if (el) {
        el.removeClass('h');
        btn.destroy();
    }
}

function getCookie(name) {
    var matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
    return matches ? decodeURIComponent(matches[1]) : undefined;
}

function setCookie(name, value, options) {
    options = options || {};

    var expires = options.expires;

    if (typeof expires == "number" && expires) {
        var d = new Date();
        d.setTime(d.getTime() + expires*1000);
        expires = options.expires = d;
    }
    if (expires && expires.toUTCString) {
        options.expires = expires.toUTCString();
    }

    value = encodeURIComponent(value);

    var updatedCookie = name + "=" + value + ';secure';

    for(var propName in options) {
        updatedCookie += "; " + propName;
        var propValue = options[propName];
        if (propValue !== true) {
            updatedCookie += "=" + propValue;
        }
    }

    document.cookie = updatedCookie;
}

function deleteCookie(name, path) {
    if (!path) {path='/';}
    document.cookie=name+"="+((path) ? ";path="+path:"")+";domain=."+SITE_DOMAIN+";expires=Thu, 01 Jan 1970 00:00:01 GMT";
}

function in_array(needle, haystack, strict) {
    var found = false, strict = !!strict;
    for (var key in haystack) {
        if ( (strict && haystack[key] === needle) || (!strict && haystack[key] == needle) ) {
            found = true;
            break;
        }
    }
    return found;
}

function strpos (haystack, needle, offset) {
    var i = (haystack+'').indexOf(needle, (offset || 0));
    return i === -1 ? false : i;
}

function initCkEditor(id, toolbar, opt) {
    if(typeof CKEDITOR != 'undefined') {
        if (CKEDITOR.instances[id]) {
            CKEDITOR.instances[id].destroy(true);
        }
        var initOpt = {toolbar: toolbar};
        if (opt.setFocus) {
            initOpt.startupFocus = true;
        }
        CKEDITOR.replace(id,initOpt);
        return CKEDITOR.instances[id];
    } else {
        return false;
    }

}
var getMonthName = function(monthNumber, genetive, short)
{
    genetive = !!genetive
    short = !!short
    monthNumber = +monthNumber

    if (short) {
        var monthes = ['',
            t(''),
            t(''),
            t(''),
            t(''),
            t('May'),
            t(''),
            t(''),
            t(''),
            t(''),
            t(''),
            t(''),
            t(''),
        ]
    } else if (genetive) {
        var monthes = ['',
            t('January'),
            t('February'),
            t('March'),
            t('April'),
            t('May'),
            t('June'),
            t('July'),
            t('August'),
            t('September'),
            t('October'),
            t('November'),
            t('December'),
        ]
    } else {
        var monthes = ['',
            t('January'),
            t('February'),
            t('March'),
            t('April'),
            t('May'),
            t('June'),
            t('July'),
            t('August'),
            t('September'),
            t('October'),
            t('November'),
            t('December'),
        ]
    }
    return monthes[monthNumber]
}

var daysInMonth = function(month, year) {
    // приведение месяца и года к числовому типу
    month = +month;
    year  = +year;

    // если февраль, то отдадим кол-во дне йв зависимости от високосности
    if (month == 2) {
        var isLeap = new Date(year, (month-1), 29).getDate() == 29;
        return (isLeap ? 29 : 28);
    }
    // иначе для остальных месяцев отдадим кол-во дней
    switch (month) {
        case 4:
        case 6:
        case 9:
        case 11:
            return 30;
        default:
            return 31;
    }
}
var getDOWName = function(date, needShort)
{
    needShort = !!needShort; // приведение к boolean'у

    if (needShort) {
        var names = [t('Sun'), t('Mon'), t('Tue'), t('Wed'), t('Thu'), t('Fri'), t('Sat')];
    } else {
        var names  = [t('Sunday'), t('Monday'), t('Tuesday'), t('Wednesday'), t('Thursday'), t('Friday'), t('Saturday')];
    }

    if ((typeof date).toLowerCase() == 'string') {
        date = date.split('-');
    }
    var dow = new Date(date[0], date[1]-1, date[2]).getDay();
    return names[dow];
}

function fillSelect($select, items)
{
    $select.empty();
    for (var i in items) if (items.hasOwnProperty(i)) {
        var item = items[i],
            $option = $('<option />').attr('value', item.value).text(item.text),
            text;

        if (item.attr) {
            for (var attrName in item.attr) if (item.attr.hasOwnProperty(attrName)) {
                $option.attr(attrName, item.attr[attrName]);
            }
        } else {
        }
        $option.appendTo($select);
    }
    $select.change();
}

function getUrlParameters() {
    var urlVars = window.location.search.substring(1).split('&');
    var parameters = new Object();
    for (var i = 0; i < urlVars.length; i++) {
        var items = urlVars[i].split('=');
        parameters[items[0]] = items[1];
    }
    return parameters;
}


/*
 * Функция, которая ищет в тексте кусок и обрамляет его в тэг
 * @param string text - текст, в котором будет искать
 * @param string needle - чо будем искать
 * @param string tag - тэг, в который обрамлять (необязательный параметр. по-дефолту "b")
 */
var highlightText = function(text, needle, tag) {
    if (!text) {
    }
    if (!needle) {
        return text;
    }
    if (!tag) {
        tag = 'b';
    }

    var reg = new RegExp('(.*?)(' + needle + ')(.*?)', 'ig');
    return text.replace(reg, "$1<" + tag + ">$2</" + tag + ">$3");
}

/*
 * функции взяты с инторнетов
 */
String.prototype.capitalize = function(onlyFirst)
{
    if (onlyFirst) {
        return this.charAt(0).toUpperCase() + this.slice(1);
    } else {
        return this.replace( /(^|\s)([А-ЯA-Zа-яa-zёЁ])/g , function(m, p1, p2){ return p1 + p2.toUpperCase(); } );
    }
};

Number.prototype.padLeft = function(n, str)
{
    if (!n) n = 2
    if (!str) str = '0'
    var numLength = String(this).length
    if (numLength > n) {
        return this + ''
    }
    return Array(n - numLength + 1).join(str) + this
}

function getProperty(obj, prop)
{
    return prop.split('.')
        .reduce(function (m, i) {
            return m && typeof m == 'object' ? m[i] : null;
        }, obj);
}

function copyObject(obj)
{
    if (Array.isArray(obj)) {
        var result = []
    } else {
        var result = {}
    }
    for (var field in obj) if (obj.hasOwnProperty(field)) {
        if (obj[field] === null) {
            result[field] = null
            continue
        }
        switch ((typeof obj[field]).toLowerCase()) {
            case 'object' :
                result[field] = copyObject(obj[field])
                break
            default :
                result[field] = obj[field]
        }
    }
    return result
}

function equalArrays(arr1, arr2) {
    if (arr1.length !== arr2.length) {
        return false
    }
    for (var i=0; arr1[i] || arr1[i] === 0; i++) {
        if (arr2.indexOf(arr1[i]) < 0) {
            return false
        }
    }
    return true
}

Array.prototype.getBy = function(field, value) {
    if (!this.length) return null

    for (var i=0; this[i]; i++) {
        if (this[i][field] === value) {
            return this[i]
        }
    }

    return null
}

function getParamFromUrl(paramName) {
    var reg = new RegExp(paramName + '=([^&]*)')
    var match = document.location.search.match(reg)
    if (match !== null) {
        return match[1]
    }
    return null
}
/* 
 * alert2.js
 */
var $alert2Block = false;;
function alert2(text, type)
{
    if ($alert2Block === false) {
        $alert2Block = $('<div />').addClass('alert2_block').attr('id', 'alert2').appendTo($('body'));
        $alert2Block.on('click', function(ev){
            var $el = $(ev.target);
            if ($el.is('[alert2-action="close"]')) {
                $el.remove();
            }
        });
    }

    if (!type) {
        type = 'success';
    }

    var $item = $('<div class="alert2_item" data-type="' + type + '" alert2-action="close">' + alertText(text) + '</div>');

    $item.appendTo($alert2Block);
    setTimeout(function(){
        $item.addClass('_hide');
        setTimeout(function(){
            $item.remove();
        }, 2000);
    }, 4000);
}
// Текст алерта
function alertText(text) {
    // Словарь сообщений
    var billet = {
        // Авторизация
        //no_yaru_account:'Чтобы авторизоваться на сайте, вам нужно создать страницу на my.ya.ru',
        no_yaru_account:'Регистрация через Яндекс временно недоступна',
        //
        all_fields_required:'Необходимо заполнить все поля формы',
        // Фотогалерея
        photo_load_fail:'Не удалось загрузить фотографию, повторите попытку',
        // Бюжет
        budget_item_deleted:'Предмет удален',
        budget_small:'Бюжет слишком мал',
        // Форум
        topic_comments_deleted:'Сообщения помечены как удаленные',
        topic_deleted:'Топик помечен как удаленный',
        topics_deleted:'Темы помечены как удаленные',
        topic_for_nevesta:'Топик открыт только для невест',
        topic_for_all:'Топик открыт для всех',
        // Переписка
        nopmlink:'Чтобы отправлять личные сообщения необходимо авторизоваться',
        // Прочее
        request_error:'Ошибка запроса',
        unknown:'Unknown error'
    }
    if (billet[text]) {
        return billet[text];
    } else {
        return text;
    }
}
$(document).ready(function(){
    // загрузка алертов из хтмл
    var alert2error = $('#alert2error');
    if (alert2error.size()) {
        alert2(alert2error.val(), 'error');
    }
    // загрузка алертов из хтмл new
    if (window.alert2_items) {
        $.each(alert2_items, function(i, item){
            alert2(item.text, item.type);
        });
    }
});
/* 
 * bigpreloader.js
 */
var bigpreloader = {
    $main : null,

    tpl : '<div class="bigpreloader{% if theme %}-{{ theme }}{% endif %}"></div>',

    show : function(theme) {
        if (bigpreloader.$main !== null) {
            return false
        }
        bigpreloader.$main = simpleTpl(bigpreloader.tpl, {theme:theme}, true).appendTo($('body'))
    },
    hide : function() {
        if (bigpreloader.$main === null) {
            return true
        }
        bigpreloader.$main.remove()
        bigpreloader.$main = null
    }
}

$(document).ready(function(){
    imagePreload.load('/i/preloader/bigpreloader.gif')
    imagePreload.load('/i/svg/logo/blue.svg')
})

/* 
 * busyActual.js
 */
var busyActual = {
    $button : null,

    tpl : twig.compile(
        '<div class="busyActual">' +
            '<p class="lightbox_text">' + t('', {'{link}': SITE_URL + LANG_URL + '/my/freeDates/'}) + '</p>' +
        '</div>'),

    init : function() {
        if (!USER.eventFreedateActual) return false
        var $popup = twig.render(busyActual.tpl, null, true)
        lightbox.show($popup, 630)
    },
}

$(document).ready(function() {
    busyActual.init()
})
/* 
 * calendar.js
 */
calendar = {
    range : null,
    point : null,

    $main    : null,
    $monthes : null,
    $name    : null,
    $years   : null,

    info     : {},
    today    : null,
    current  : null,
    monthHeight : 0,
    filling  : false,
    values   : [],
    extended : false,

    callback : {
        onPick  : null,
        close   : null,
        balloon : null,
    },

    windowBinded : false,

    tpl : {
        main :
            '<div class="calendar" calendar-elem="main">' +
                '{% if caption %}<p class="calendar_caption">{{ caption }}</p>{% endif %}' +
                '<div class="calendar_items">' +
                    '{% if years %}' +
                        '<select class="calendar_year" calendar-action="year">{{ years }}</select>' +
                    '{% endif %}' +
                    '<div class="calendar_slider" calendar-elem="slider">' +
                        '<div class="calendar_knob" calendar-elem="knob"></div>' +
                        '{{ monthNames }}' +
                    '</div>' +
                    '<div class="calendar_monthes" calendar-elem="monthes">{{ monthes }}</div>' +
                '</div>' +
                '{{ addHtml }}' +
            '</div>',
        year : '<option value="{{ year }}"{% if selected %} selected{% endif %}>{{ year }}</option>',
        monthName : '<p class="calendar_monthName">{{ name }}</p>',
        month :
            '<table class="calendar_month" data-month="{{ date }}">' +
                '<thead class="calendar_thead">' +
                    '<tr>' +
                        '<th class="calendar_th-caption" colspan="{% if startDoW %}4{% else %}5{% endif %}">{{ name }}</th>' +
                        '<th class="calendar_th">' + t('Fri') + '</th>' +
                        '<th class="calendar_th">' + t('Sat') + '</th>' +
                        '{% if startDoW %}<th class="calendar_th"></th>{% endif %}' +
                    '</tr>' +
                '</thead>' +
                '<tbody>{{ weeks }}</tbody>' +
            '</table>',
        week : '<tr>{{ days }}</tr>',
        day  : twig.compile(
            '<td class="calendar_day' +
                '{% if current %} _cur{% endif %}"' +
                '{% if date %} ' +
                    'data-date="{{ date }}"' +
                '{% endif %}' +
                '{% if schedule %} ' +
                    'data-status="{{ schedule.status }}" ' +
                    'title="{{ schedule.title }}"' +
                '{% elseif title %}' +
                    'title="{{ title }}"' +
                '{% endif %}' +
                '{% if colspan > 1 %} colspan="{{ colspan }}"{% endif %}' +
            '>{{ day }}</td>'
            ),
        dayExtended : twig.compile(
            '<td class="calendar_day' +
                '{% if current %} _cur{% endif %}"' +
                '{% if colspan > 1 %} colspan="{{ colspan }}"{% endif %}' +
            '>' +
                '{% set class = "" %}' +
                '{% if date %} ' +
                    '{% if schedule %} ' +
                        '{% for busy, status in schedule if status.count %}' +
                            '{% set class = class ~ " _status" ~ busy %}' +
                        '{% endfor %}' +
                    '{% endif %}' +
                '{% endif %}' +
                '<div class="calendar_dayext{{ class }}"{% if date %} data-date="{{ date }}"{% else %} calendar-hover="hide_baloon"{% endif %}>' +
                    '{{ day }}' +
                '</div>' +
            '</td>'
        ),
    },

    close : function() {
        with (calendar) {
            if ($main === null) {
                return true;
            }
            $main.parent().removeClass('_calendarOwner');
            $main.remove();
            $main = null;
            if (callback.close) {
                callback.close();
            }
            callback = {
                close   : null,
                onPick  : null,
                balloon : null,
            };
            info = {}
            current = null;
            values = [];
            filling = false;
            extended = false
        }
    },

    fill : function(dates) {
        var count = dates.length
        if (!count) return false
        with (calendar) {
            filling = true
            if (info.type == 'range') {
                var fromDate = dates[0].split('-')
                var toDate   = dates[1].split('-')
                var todayDate = new Date()
                if (todayDate > new Date(toDate[0], toDate[1]-1, toDate[2])) {
                    return false
                }
                if (todayDate > new Date(fromDate[0], fromDate[1]-1, fromDate[2])) {
                    dates[0] = today.year + '-' + today.month.padLeft(2) + '-' + today.day.padLeft(2)
                }
            }

            for (var i=0; i<count; i++) {
                var $date = $monthes.find('[data-date="' + dates[i] + '"]')
                if (!$date.length) {
                    continue
                }
                calendar[info.type].pick($date)
            }
            filling = false
        }
    },

    changeYear : function(_year) {
        var $monthes = calendar.render.monthes(_year, true);
        calendar.$monthes.empty().append($monthes);
    },

    render : {
        monthNames : function(interval, render) {
            var month = 1
            var year  = calendar.info.current && interval !== '+12' ? calendar.info.current.year : calendar.today.year
            if (interval) {
                if (interval == '+12') {
                    month = calendar.today.month;
                } else if (+interval) {
                    year = +interval;
                }
            }
            var result = '';
            for (var m=1; m<=12; m++) {
                if (month > 12) {
                    month = 1
                    year++
                    var monthName = getMonthName(month) + ', ' + year
                } else {
                    var monthName = getMonthName(month)
                }
                result += simpleTpl(calendar.tpl.monthName, {
                    date : year + '-' + month,
                    name : monthName,
                });
                month++
            }
            return render ? $(result) : result
        },
        monthes : function(interval, render) {
            var month = 1
            var year  = calendar.info.current && interval != '+12' ? calendar.info.current.year : calendar.today.year
            var checkPicked = {
                from : false,
                to   : false,
            }
            if (interval) {
                if (interval == '+12') {
                    month = calendar.today.month
                    checkPicked.from = calendar.today.year + '-' + calendar.today.month.padLeft() + '-' + calendar.today.day.padLeft()
                } else if (+interval) {
                    year = +interval
                    var interval = calendar.info.interval
                    if ( interval.from && (interval.from.year == year) ) {
                        checkPicked.from = year + '-' + interval.from.month.padLeft() + '-' + interval.from.day.padLeft()
                    } else {
                        checkPicked.from = year + '-01-01'
                    }
                    if ( interval.to && (interval.to.year == year) ) {
                        checkPicked.to = year + '-' + interval.to.month.padLeft() + '-' + interval.to.day.padLeft()
                    } else {
                        checkPicked.to = year + '-12-31'
                    }
                } else {
                    if (interval.from) {
                        checkPicked.from = interval.from.year + '-' + interval.from.month.padLeft() + '-' + interval.from.day.padLeft()
                    }
                    if (interval.to) {
                        checkPicked.to = interval.to.year + '-' + interval.to.month.padLeft() + '-' + interval.to.day.padLeft()
                    }
                }
            }

            var disabled = {
                list    : null,
                current : null,
            }
            if (calendar.info.disabled) {
                disabled.list = calendar.info.disabled.concat()
            }
            var result = ''
            for (var m=1; m<=12; m++) {
                if (month > 12) {
                    month = 1
                    year++
                }
                var maxDay = daysInMonth(month, year)

                var day   = 1
                var dow   = new Date(year, month-1, 1).getDay()
                var weeks = ''
                var startDoW = moment.localeData(LOCALE).firstDayOfWeek()
                var endDoW = startDoW + 6
                if (startDoW && dow == 0) {
                    dow = 7
                }

                for (var w=0; w<6; w++) {
                    var days = ''
                    for (var d=startDoW; d<=endDoW; d++) {
                        // добавим пустые ячейки перед началом месяца
                        if ( (w == 0) && (d < dow) ) {
                            d = dow - 1;
                            days += twig.render(calendar.tpl.day, {colspan : d + (1 - startDoW)})
                            continue
                        }
                        // и добавим в конце месяца
                        if (day > maxDay) {
                            days += twig.render(calendar.tpl.day, {colspan : (endDoW - d + 1)})
                            break
                        }
                        // остальные дни заполним
                        var dayParams = {day : day}
                        var date = year + '-' + month.padLeft() + '-' + day.padLeft()
                        var canPicked = true
                        if (disabled.list) {
                            if (disabled.current) {
                                if (date >= disabled.list[disabled.current][0] && date <= disabled.list[disabled.current][1]) {
                                    if (date == disabled.list[disabled.current][1]) {
                                        disabled.list.splice(disabled.current, 1)
                                        disabled.current = null
                                    }
                                    canPicked = false
                                }
                            } else {
                                for (var i=0; disabled.list[i]; i++) {
                                    if (disabled.list[i][2]) {
                                        if (date == disabled.list[i]) {
                                            canPicked = false
                                            disabled.list.splice(i, 1)
                                            break
                                        }
                                    } else {
                                        if (date >= disabled.list[i][0] && date <= disabled.list[i][1]) {
                                            disabled.current = i
                                            canPicked = false
                                        }
                                        break
                                    }
                                }
                            }
                        }
                        if (canPicked) {
                            if (checkPicked.from && date < checkPicked.from) {
                                canPicked = false
                            } else if (checkPicked.to && date > checkPicked.to) {
                                canPicked = false
                            }
                        }

                        if (canPicked) {
                            dayParams.date = date
                        }
                        if (calendar.info.current) {
                            if ( (day == calendar.info.current.day) && (month == calendar.info.current.month) && (year == calendar.info.current.year) ) {
                                dayParams.current = true
                                if (calendar.info.type == 'point' && calendar.info.single) {
                                    dayParams.date = null
                                }
                            }
                        }
                        var tpl = calendar.tpl.day
                        if (calendar.info.extended) {
                            tpl = calendar.tpl.dayExtended
                        }
                        if (calendar.info.schedule && calendar.info.schedule[date]) {
                            dayParams.schedule = calendar.info.schedule[date]
                        } else if (calendar.info.title) {
                            dayParams.title = calendar.info.title
                        }
                        days += twig.render(tpl, dayParams)
                        day++
                    }
                    weeks += simpleTpl(calendar.tpl.week, {days:days})
                    if (w == 5) {
                        var daysLeft = endDoW - d + 1
                        if (daysLeft < endDoW) {
                            weeks += simpleTpl(calendar.tpl.week, {
                                days : twig.render(calendar.tpl.day, {colspan : 7})
                            })
                        }
                    }
                }

                // теперь сам календарик для месяца соберём и отправим его в правый столбец
                result += simpleTpl(calendar.tpl.month, {
                    date     : year + '-' + month,
                    name     : getMonthName(month),
                    weeks    : weeks,
                    startDoW : startDoW,
                })
                month++
            }
            return render ? $(result) : result
        },
        main : function() {
            with (calendar) {
                var tplParams = info
                var interval = tplParams.interval
                tplParams.monthes    = render.monthes(interval);
                tplParams.monthNames = render.monthNames(interval);
                if ( !interval || (interval.from && (interval.from.year < calendar.today.year)) || (interval.to && (interval.to.year > calendar.today.year)) ) {
                    tplParams.years = '';
                    var startYear = (interval && interval.from) ? interval.from.year : today.year - 3;
                    var endYear = (interval && interval.to) ? interval.to.year : today.year
                    for (var year=startYear; year<=endYear; year++) {
                        tplParams.years += simpleTpl(tpl.year, {
                            year     : year,
                            selected : (info.current ? (year == info.current.year) : (year == today.year))
                        });
                    }
                }
                return simpleTpl(tpl.main, tplParams, true);
            }
        }
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target);
            with (calendar) {
                if ($el.is('[data-date]')) {
                    calendar[info.type].pick($el);
                } else if ($el.is('[calendar-action]')) {
                    var action = $el.attr('calendar-action');
                    if (callback[action]) {
                        callback[action]();
                    }
                }
            }
        },
        change : function(ev) {
            var $el = $(ev.target);
            with (calendar) {
                if ($el.is('[calendar-action="year"]')) {
                    changeYear($el.val());
                }
            }
        },
        mouseover : function(ev) {
            var $el = $(ev.target)
            if (!calendar.callback.balloon) {
                return
            }
            if ($el.is('[data-date]') && calendar.callback.balloon.show) {
                calendar.callback.balloon.show($el)
            } else if ($el.is('[calendar-hover="hide_baloon"]') && calendar.callback.balloon.hide) {
                calendar.callback.balloon.hide($el)
            }
        },
        mouseout : function(ev) {
            var $el = $(ev.target)
            if ($el.closest('[calendar-elem="balloon"]').length) {
                if (calendar.callback.balloon && calendar.callback.balloon.hide) {
                    calendar.callback.balloon.hide()
                }
            }
        },
    },

    initToday : function() {
        var today = new Date()
        calendar.today = {
            day   : today.getDate(),
            month : today.getMonth() + 1,
            year  : today.getFullYear(),
        }
    },

    init : function(_$owner, _info, _callbacks) {
        with (calendar) {
            if ($main !== null) {
                close()
            }
            if (today === null) {
                initToday()
            }

            info = _info;
            if (info.current) {
                if ( (typeof info.current).toLowerCase() == 'string' ) {
                    if (info.current == 'now') {
                        info.current = calendar.today
                    } else {
                        info.current = info.current.split('-')
                        info.current = {
                            day   : info.current[2],
                            month : info.current[1],
                            year  : info.current[0],
                        }
                    }
                }
            }
            if (!info.current && info.dates) {
                info.current = info.dates[0].split('-');
                info.current = {
                    day   : info.current[2],
                    month : info.current[1],
                    year  : info.current[0],
                };
            }
            if (info.disabled) {
                info.disabled = info.disabled.map(function(date) {
                    return (date.indexOf('~') >= 0) ? date.split('~') : date
                })
            }

            for (var action in _callbacks) if (_callbacks.hasOwnProperty(action)) {
                callback[action] = _callbacks[action];
            }
            if (info.interval) {
                info.interval = info.interval.split('~').map(function(date){
                    if (date == 'now') {
                        return [today.year, today.month, today.day]
                    } else {
                        return date.split('-');
                    }
                });
                if (info.interval.length == 2) {
                    info.interval = {
                        from : {
                            year  : +info.interval[0][0],
                            month : +info.interval[0][1],
                            day   : +info.interval[0][2],
                        },
                        to : {
                            year  : +info.interval[1][0],
                            month : +info.interval[1][1],
                            day   : +info.interval[1][2],
                        }
                    }
                } else {
                    info.interval = info.interval[0][0];
                }
            }

            $main = render.main().appendTo(_$owner);
            _$owner.addClass('_calendarOwner');
            $monthes = $main.find('[calendar-elem="monthes"]');
            $name    = $main.find('[name="name"]');

            $years = $main.find('[calendar-action="year"]');
            if (!$years.length) {
                $years = null;
            }
            calendar[info.type].reset();
            if (info.dates) {
                fill(info.dates);
            }

            $main.on(events);
            slider.init();

            if (info.current) {
                var $date = $monthes.find('._cur');
                if ($date.length) {
                    $monthes.scrollTop(+$date.position().top - 30);
                }
            }

            if (calendar.$main.offset().left < 0) {
                calendar.$main.css({
                    left      : '-40px',
                    transform : 'none',
                })
            } else if (window.innerWidth - calendar.$main.offset().left - calendar.$main.innerWidth() < 0) {
                calendar.$main.css({
                    left      : 'auto',
                    right     : '0',
                    transform : 'none',
                })
            }

            if (!windowBinded) {
                $(window).on('click', function(ev) {
                    var $el = $(ev.target);
                    if (!$el.closest('._calendarOwner').length) {
                        calendar.close();
                    }
                });
                windowBinded = true;
            }
        }
    }
}

/* 
 * calendar_point.js
 */
calendar.point = {
    reset : function() {
        calendar.values = [];
    },
    pick : function($date) {
        with (calendar.point) {
            var date = $date.attr('data-date');
            if ($date.is('._edge')) {
                $date.removeClass('_edge');
                calendar.values.splice(calendar.values.indexOf(date), 1);
            } else {
                $date.addClass('_edge');
                calendar.values.push(date);
            }
            if (!calendar.filling && calendar.callback.onPick) calendar.callback.onPick(calendar.values);
        }
    }
}

/* 
 * calendar_range.js
 */
calendar.range = {
    picks : 0,
    $range : {
        from : false,
        to   : false
    },
    reset : function() {
        with (calendar.range) {
            picks = 0;
            $range.from && $range.from.removeClass('_edge');
            $range.from = false;
            $range.to && $range.to.removeClass('_edge');
            $range.to = false;
            calendar.values = [];
            make();
        }
    },
    make : function() {
        with (calendar.range) {
            var $days = calendar.$monthes.find('[data-date]');
            $days.filter('._selected').removeClass('_selected');
            if ( ($range.from === false) || ($range.to === false) ) {
                return true;
            }

            var ranged = false;
            var from = $range.from.attr('data-date');
            var to   = $range.to.attr('data-date');

            for (var i in $days) if ($days.hasOwnProperty(i)) {
                $day = $($days[i]);
                if ( (ranged === false) && ($day.attr('data-date') == from) ) {
                    ranged = true;
                }
                if (ranged === false) {
                    continue;
                }
                $day.addClass('_selected');
                if ( (ranged === true) && ($day.attr('data-date') == to)) {
                    break;
                }
            }
            if (!calendar.filling && calendar.callback.onPick) calendar.callback.onPick([$range.from.attr('data-date'), $range.to.attr('data-date')]);
        }
    },
    pick : function($date) {
        with (calendar.range) {
            var pickedDate = $date.attr('data-date')
            var pickedIsFrom = ($range.from !== false) && ($range.from.attr('data-date') == pickedDate)
            var pickedIsTo   = ($range.to !== false) && ($range.to.attr('data-date') == pickedDate)
            if ( pickedIsFrom || pickedIsTo ) {
                return false
            }
            $date.addClass('_edge')
            switch (picks) {
                case 2 : reset()
                case 0 : $range.from = $date
                    break
                case 1 :
                    var from = $range.from.attr('data-date').split('-')
                    from = new Date(from[0], from[1]-1, from[2])
                    var picked = pickedDate.split('-')
                    picked = new Date(picked[0], picked[1]-1, picked[2])

                    if (picked < from) {
                        $range.to   = $range.from
                        $range.from = $date
                    } else {
                        $range.to = $date
                    }
                    calendar.values = [$range.from.attr('data-date'), $range.to.attr('data-date')]
                    make()
                    break
            }
            picks++
        }
    }
}

/* 
 * calendar_slider.js
 */
calendar.slider = {
    $main : false,
    $knob : false,

    maxTop   : {
        slider  : 0,
        monthes : 0
    },
    mainY    : 0,
    halfKnob : 0,
    startY   : 0,

    startSlide : function(ev) {
        var Slider = calendar.slider
        Slider.startY   = ev.pageY
        Slider.mainY    = Slider.$main.offset().top
        $('body').addClass('calendar_sliding')
        Slider.slide(ev)
        $(window).on({
            mousemove : Slider.slide,
            mouseup   : Slider.stopSlide,
        })
        return false // IE fix
    },

    stopSlide : function() {
        $(window).off('mousemove').off('mouseup')
        $('body').removeClass('calendar_sliding')
    },

    slide : function(ev) {
        var Slider = calendar.slider
        var sliderTop = ev.pageY - Slider.mainY - Slider.halfKnob
        // корректируем расположение (чтоб не выходил за края)
        if (sliderTop < 0) {
            sliderTop = 0
        } else if (sliderTop > Slider.maxTop.slider) {
            sliderTop = Slider.maxTop.slider
        }
        // осталось подвигать список сцен
        var stepRatio  = sliderTop / Slider.maxTop.slider
        var monthesTop = Slider.maxTop.monthes * stepRatio
        calendar.$monthes.scrollTop(monthesTop)
    },

    scroll : function() {
        var Slider = calendar.slider
        var stepRatio = calendar.$monthes.scrollTop() / Slider.maxTop.monthes
        if (stepRatio > 1) {
            stepRatio = 1
        }
        var sliderTop = Slider.maxTop.slider * stepRatio
        Slider.$knob.css('top', sliderTop + 'px')
        if (calendar.callback.balloon && calendar.callback.balloon.hide) {
            calendar.callback.balloon.hide()
        }
    },

    init : function() {
        var Slider = calendar.slider
        Slider.$main = calendar.$main.find('[calendar-elem="slider"]')
        Slider.$knob = Slider.$main.find('[calendar-elem="knob"]')

        Slider.halfKnob = Math.floor(Slider.$knob.height() / 2)

        Slider.maxTop.monthes = calendar.$monthes.height() * (-1)

        calendar.$monthes.height() * (-1)
        var $monthes = calendar.$monthes.children()
        for (var i=0; $monthes[i]; i++) {
            Slider.maxTop.monthes += $($monthes[i]).height()
        }
        Slider.maxTop.slider = Slider.$main.height() - Slider.$knob.height()

        Slider.$main.on('mousedown', Slider.startSlide)
        calendar.$monthes.on('scroll', Slider.scroll)
    }
}

/* 
 * comments.js
 */
var comments = {
    votes : null,

    $main : false,
    $form : {
        new    : false,
        answer : false
    },

    info  : {
        id   : 0,
        type : false
    },
    count : 0,
    defaultType : 'media',

    tpl : {
        main : '<div class="comments" data-caption="' + t('Comments') + '" data-count=""></div>',
        form :
            '<form class="comment-form" comment-elem="form" data-type="{{ type }}">' +
                '<input type="hidden" name="parent_id" value="{{ parentId }}">' +
                '<img src="{{ user.avatar_b }}" alt="" class="avatar-{{ user.color }}" width="50" heigth="50">' +
                '<textarea name="text" rows="2" class="comment_field" placeholder="' + t('Your comment') + '" ff-empty="1"></textarea>' +
                '<button class="button-small" comment-action="send" ff-elem="button" type="button">' + t('Send') + '</button>' +
            '</form>',
        item :
            '<div class="comment-{{ level }} user" user-elem="main" user-id="{{ user.id }}" user-my_fav="{{ user.my_fav }}" user-my_doer="{{ user.my_doer }}" data-id="{{ id }}" data-parent_id="{{ parent_id }}" comment-elem="main" comment-level="{{ level }}" data-my_vote="{{ my_vote }}">' +
                '{{ avatar }}' +
                '<div class="comment_text">{{ text }}</div>' +
                '<div class="comment_info">' +
                    '<a href="{{ user.profile_url }}">{{ user.name }}</a>, {{ back_date }}' +
                    '{{ actions }}' +
                '</div>' +
                '<div class="comment_votes" data-votes="{{ votes }}" votes-action="show" comment-elem="votes"></div>' +
            '</div>',
        actions :
            '<span class="comment_actions" comment-elem="actions">' +
                '<button class="button-small comment_answer" comment-action="answer">' + t('Reply') + '</button>' +
                '{{ delete }}' +
                '<span class="comment_vote-good" comment-action="vote" data-vote="1"></span>' +
                '<span class="comment_vote-bad" comment-action="vote" data-vote="-1"></span>' +
            '</span>',
        delete :
            '<button class="button-small button-red comment_answer ml10" comment-action="delete">' + t('Delete') + '</button>'
    },


    vote : function($comment, $vote) {
        var vote = +$vote.attr('data-vote');
        $.ajax({
            type     : 'POST',
            url      : '/a/comment/vote/',
            data     : {
                comment_id : +$comment.attr('data-id'),
                vote : vote,
                action : 'comment',
                BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
            },
            dataType : 'json',
            success  : function(json) {
                if (json.votes) {
                    $comment.attr('data-my_vote', vote).find('[comment-elem="votes"]').attr('data-votes', json.votes);
                }
            }
        });
    },

    render : function(items, level) {
        level = level || 0;
        if (level > 7) {
            level = 7;
        }
        var commentsStr = '';
        for (var i in items) if (items.hasOwnProperty(i)) {
            var comment = items[i];
            comment.level = level;
            comment.avatar = user.avatar.render(comment.user, 50, true);
            comment.user.my_doer = +comment.user.my_doer;
            comment.user.my_fav = +comment.user.my_fav;
            var adminAction = {};
            if (USER.group == 'admin') {
                adminAction.delete = simpleTpl(comments.tpl.delete);
            }
            if (!USER.isGuest) {
                comment.actions = simpleTpl(comments.tpl.actions, adminAction);
            }
            commentsStr += simpleTpl(comments.tpl.item, comment);
            comments.count++;
            if (comment.comments.length) {
                commentsStr += comments.render(comment.comments, level+1);
            }
        }

        if (level == 0) {
            comments.$main.attr('data-count', comments.count).prepend(commentsStr);
        } else {
            return commentsStr;
        }
    },

    closeAnswer : function() {
        with (comments) {
            if ($form.answer === false) {
                return false;
            }
            $form.answer.remove();
            $form.answer = false;
        }
    },

    send : function($form) {
        var $text = $form.find('[name="text"]');
        $.ajax({
            type     : 'POST',
            url      : API_URL + '/v2/' + comments.info.type + '/' + comments.info.id + '/comments',
            xhrFields: {
                withCredentials: true
            },
            data     : JSON.stringify({
                parent_id : $form.find('[name="parent_id"]').val(),
                text      : $text.val().replace(/\n\r/g, '<br>').replace(/\n/g, '<br>')
            }),
            contentType: 'application/json',
            dataType : 'json',
            success  : function(json) {
                json.actions = simpleTpl(comments.tpl.actions);
                json.avatar = user.avatar.render(json.user, 50, true);
                simpleTpl(comments.tpl.item, json, true).insertBefore($form);
                if ($form.attr('data-type') == 'new') {
                    $text.val('').change();
                } else {
                    comments.closeAnswer();
                }
                comments.count++
                comments.$main.attr('data-count', comments.count);
            }
        });
    },

    delete : function($comment) {
        $.ajax({
            type     : 'DELETE',
            url      : API_URL + '/v2/comments/' + $comment.attr('data-id'),
            xhrFields: {
                withCredentials: true
            },
            dataType : 'json',
            success  : function(json) {
                comments.removeElem($comment);
            }
        });
    },

    removeElem : function ($comment) {
        with (comments) {
            var commentId = $comment.attr('data-id');
            $comment.remove();
            $.each($main.find('[data-parent_id="' + commentId + '"]'), function () {
                comments.removeElem($(this));
            });
        }
    },

    answer : function($comment) {
        with (comments) {
            var parentId = +$comment.attr('data-id');
            if ($form.answer === false) {
                $form.answer = simpleTpl(tpl.form, {user:USER, parentId:parentId, type:'answer' }, true);
                fillFields.init($form.answer);
            } else {
                $form.answer.find('[name="parent_id"]').val(parentId);
            }
            var answerLevel = Math.min(+$comment.attr('comment-level') + 1, 7);
            $form.answer.attr('class', 'comment-form comment-' + answerLevel);
            $form.answer.insertAfter($comment);
            $form.answer.find('[name="text"]').focus();
        }
    },

    load : function() {
        var result = {};
        var order = null;
        if (comments.info.type == 'restaurants') {
            order = '-id';
        }
        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/' + comments.info.type + '/' + comments.info.id + '/comments',
            data     : {
                city_id : CITY_ID,
                order: order
            },
            xhrFields: {
                withCredentials: true
            },
            dataType : 'json'
        });
    },

    init : function(id, type) {
        with (comments) {
            info.id = id;
            info.type = (type || defaultType).toLowerCase();

            if ($main !== false) {
                $main.remove();
                $main = false;
                count = 0;
            }

            $main = simpleTpl(comments.tpl.main, {}, true);

            load().then(function(json) {
                render(json.comments);
            });

            if (!USER.isGuest) {
                $form.new = simpleTpl(tpl.form, {user:USER, type:'new'}, true).appendTo($main);
                fillFields.init($form.new);
            }

            $main.on({
                'click' : function(ev){
                    var $el = $(ev.target);
                    if ($el.is('[comment-action]')) {
                        var $comment = $el.closest('[comment-elem="main"]');
                        switch ($el.attr('comment-action')) {
                            case 'votes'  : comments.votes.show($comment); break;
                            case 'vote'   : comments.vote($comment, $el); break;
                            case 'answer' : comments.answer($comment); break;
                            case 'delete' : comments.delete($comment); break;
                            case 'send'   : comments.send($el.closest('[comment-elem="form"]')); return false; break;
                        }
                    } else if ($el.is('[name="text"]')) {
                        if ($el.closest('[comment-elem="form"]').is('[data-type="new"]')) {
                            closeAnswer();
                        }
                    }
                }
            });

            votes.init();
            return $main;
        }
    }
}

/* 
 * comments_votes.js
 */
comments.votes = {
    $main : false,

    inited : false,
    currentId : 0,

    tpl : {
        main :
            '<div class="commentVotes bubble">' +
                '<div class="commentVotes_count-good">{{ count.1 }}</div><div class="commentVotes_count-bad">{{ count.-1 }}</div>' +
                '<p class="commentVotes_caption">' + t('Users that supported the comment') + ':</p>' +
                '{{ users }}' +
            '</div>',
        user :
            '<a href="{{ profile_url }}" class="commentVotes_user" title="{{ name }}">' +
                '<img width="50" height="50" src="{{ avatar_url }}">' +
            '</a>'
    },

    load : function(id) {
        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/comments/' + id + '/votes',
            data : {
                count    : 'value',
                per_page : 50
            },
            xhrFields: {
                withCredentials: true
            },
            dataType : 'json'
        });
    },

    render : function(info) {
        with (comments.votes) {
            info.users = '';
            var rendered = 0;
            for (var i in info.votes) if (info.votes.hasOwnProperty(i)) {
                if (info.votes[i].value < 0) {
                    continue;
                }
                info.users += simpleTpl(tpl.user, info.votes[i].user);
                rendered++;
                if (rendered == 9) {
                    break;
                }
            }
            return simpleTpl(tpl.main, info, true);
        }
    },

    toggle : function($comment) {
        with (comments.votes) {
            var id = +$comment.attr('data-id'),
                show = (currentId != id);

            close();
            if (show) {
                currentId = id;
                load(currentId).then(function(json) {
                    comments.votes.$main = comments.votes.render(json).appendTo($comment.find('[comment-elem="votes"]'));
                });
            }
        }
    },

    close : function() {
        with (comments.votes) {
            if ($main === false) {
                return true;
            }
            $main.remove();
            $main = false;
            currentId = 0;
        }
    },

    init : function() {
        with (comments.votes) {
            if (inited) {
                return false;
            }

            $(window).on('click', function(ev){
                var $el = $(ev.target);
                if ($el.is('[votes-action="show"]')) {
                    comments.votes.toggle($el.closest('[comment-elem="main"]'));
                } else if ( !$el.closest('[votes-action="show"]').length && ($main !== false) ) {
                    comments.votes.close();
                }
            });
            inited = true;
        }
    }
}

/* 
 * corrector.js
 */
/*
    прописываем input'у аттрибут "corrector" и оно не даёт писать лишнего.
        int - целочисленное значение
        float - дробное
        letter - только буквы
        range - диапазон из целых чисел формата "X-Y", где X и Y - целые числа
        paste - разрешается только копипасту вставлять. набор символов запрещён
        X-Y - разрешает число, входящее в допустимый диапазон, где X и Y - целые числа (если нужно только "до", то "0-Y")
        [регулярка] - символы, допущенные для набора
*/
var corrector = {
    inited : false,

    allowKeyCodes : [
        8, // backspace
        9, // tab
        13, // enter
        16, 17, 18, // shift, ctrl, alt
        35, 36, // end, home
        37, 38, 39, 40, // стрелочки
        45, 46, // insert, delete
        112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123 // F1 - F12
    ],

    digits : [0,1,2,3,4,5,6,7,8,9], // цифры
    letter : /[a-zA-Zа-яА-ЯёЁ]/, // буквы

    checkPattern : function(char, pattern) {
        var reg = /^(\d+)\-(\d+)$/
        var limits = pattern.match(reg)
        if (limits) {
            pattern = 'limits'
        }

        switch (pattern) {
            case 'paste'  : break
            case 'time'   :
                if (value.indexOf(':') >= 0) {
                    var timeInfo = value.split(':')
                    if ( (timeInfo[0].length == 2) && ($el[0].selectionStart == 2) ) {
                        return false
                    }
                    if ( (timeInfo[1].length == 2) && ($el[0].selectionStart == value.length) ) {
                        return false
                    }
                }
                if ( (value.length >= 5) && ($el[0].selectionStart == $el[0].selectionEnd) ) {
                    return false
                }
                if ( (char == ':') && (value.indexOf(':') < 0) ) {
                    return true
                }
                return (char !== ' ') && (corrector.digits.indexOf(+char) >= 0)
            case 'float'  :
                if ( (char == '.') && (value.indexOf('.') < 0) ) {
                    return true
                }
            case 'limits' :
                if ((char !== ' ') && (corrector.digits.indexOf(+char) >= 0)) {
                    // кол-во цифр, которые удалим, если в поле имеется выделение текста
                    var delCount = $el[0].selectionEnd - $el[0].selectionStart
                    // далее мы определяем какое число у нас получится, если разрешим ввести цифру
                    var num = value.split('')
                    num.splice($el[0].selectionStart, delCount, char)
                    num = +num.join('')
                    if (num <= limits[2]) {
                        return true
                    }
                }
                break
            case 'int'    : return (char !== ' ') && (corrector.digits.indexOf(+char) >= 0)
            case 'range'  :
                if ( (char !== ' ') && (corrector.digits.indexOf(+char) >= 0) ) {
                    return true
                }
                if ( (char == '-') && (value.indexOf('-') < 0) ) {
                    return true
                }
                break
            case 'letter' : return !!char.match(corrector.letter)
            default :
                var reg = new RegExp(pattern)
                return !!char.match(reg)
        }
        return false
    },

    // проверки при вводе значения
    check : function(ev) {
        var $el = $(ev.target)
        if (!$el.is('[corrector],[corrector-maxlength]')) {
            return true
        }
        // для FF разрешаем служебные кнопки
        if ( !ev.charCode && (corrector.allowKeyCodes.indexOf(ev.keyCode) >= 0) ) {
            return true
        }
        if (ev.ctrlKey === true) {
            return true
        }

        var value = $el.val()
        var maxlength = $el.attr('corrector-maxlength')
        if ( maxlength && value.length >= +maxlength ) {
            return false
        }

        var pattern = $el.attr('corrector')
        var correct = true
        if (pattern) {
            var char = String.fromCharCode(ev.which)
            correct = corrector.checkPattern(char, pattern)
        }
        return correct
    },

    // проверки при копипасте
    paste : function(ev) {
        var $el = $(ev.target)
        if (!$el.is('[corrector]')) {
            return true
        }
        var clipboardData = window.clipboardData || ev.originalEvent.clipboardData
        var text = clipboardData.getData('text')

        var pattern = $el.attr('corrector')
        var reg = /^(\d+)\-(\d+)$/
        var limits = pattern.match(reg)
        if (limits) {
            pattern = 'limits'
        }
        switch (pattern) {
            case 'limits' :
                text = +text
                if (!text) {
                    return false
                }
                if (text >= +limits[1] && text <= +limits[2]) {
                    return true
                }
                return false
                break
            case 'time'   :
                reg = /^\d+\:\d+$/;
                if (!!text.match(reg)) {
                    $el.val('')
                }
                break
            case 'int'    : reg = /^\d+$/; break
            case 'float'  : reg = /^\d+(\.\d+|)$/; break
            case 'range'  : reg = /^\d+(\-\d+|)$/; break
            case 'letter' : reg = /^[a-zA-Zа-яА-ЯёЁ]+$/; break
            default       : reg = new RegExp('^' + pattern + '+$'); break
        }
        return !!text.match(reg)
    },

    after : function(ev) {
        var $el = $(ev.target);
        if (!$el.is('[corrector],[corrector-maxlength]')) {
            return true
        }
        var value   = $el.val()

        var maxlength = $el.attr('corrector-maxlength')
        if ( maxlength && $el.is('[corrector-crop="auto"]') ) {
            $el.val($el.val().substring(0,35))
        }

        var pattern = $el.attr('corrector')
        switch (pattern) {
            case 'time'  :
                if (value.indexOf(':') < 0) {
                    if (value.length == 2) {
                        $el.val(value + ':')
                    } else if (value.length >= 3) {
                        value = value.split('')
                        value.splice(2,0,':')
                        $el.val(value.join(''))
                    }
                }
                break
        }
    },

    init : function() {
        if (corrector.inited) {
            return false
        }

        $(window).on({
            'keypress' : corrector.check,
            'paste'    : corrector.paste,
            'keyup'    : corrector.after,
        })
        corrector.inited = true
    }
}

$(window).ready(function(){
    corrector.init()
});

/* 
 * discountPopup.js
 */
var discountPopup = {
    $main  : null,
    $digit : {
        seconds : null,
        minutes : null,
        hours : null,
        days : null,
    },

    tpl : twig.compile(
        '<div class="discountPopup">' +
            '<div class="discountPopup_area" discountPopup-action="close"></div>' +
            '<div class="discountPopup_content">' +
                '<a class="discountPopup_close" discountPopup-action="close">' + t('Close') + '</a>' +
                '<div class="discountPopup_promo"></div>' +
                '<p class="discountPopup_text">Акция заканчивается через:</p>' +
                '<div class="discountPopup_timer">' +
                    '{% for block in blocks %}' +
                        '<div class="discountPopup_block">' +
                            '<div class="proCoupons_numbers" block-elem="{{ block.label }}">' +
                                '<span class="proCoupons_number-{{ block.digit.0 }}" number-current="{{ block.digit.0 }}" block-elem="digit"></span>' +
                                '<span class="proCoupons_number-{{ block.digit.1 }}" number-current="{{ block.digit.1 }}" block-elem="digit"></span>' +
                            '</div>' +
                            '<p class="discountPopup_label">{{ block.name }}</p>' +
                        '</div>' +
                    '{% endfor %}' +
                '</div>' +
            '</div>' +
        '</div>'),

    timerId : 0,
    seconds : 0,
    minutes : 0,
    hours   : 0,
    days    : 0,

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[discountPopup-action="close"]')) {
                discountPopup.close()
            } else if ($el.is('[block-elem="digit"]')) {
                flapNumbers()
            }
        }
    },

    init : function() {
        if (!window.bigSaleInfo || !window.bigSaleInfo.show) {
            return false
        }
        var seconds = bigSaleInfo.end - bigSaleInfo.now
        var days3 = 60*60*24*3 // 3 дня
        if (seconds <= 0 || seconds > days3) {
            return
        }
        discountPopup.days    = Math.floor(seconds / 60 / 60 / 24)
        seconds = seconds - discountPopup.days * 60 * 60 * 24
        discountPopup.hours   = Math.floor(seconds / 60 / 60)
        seconds = seconds - discountPopup.hours * 60 * 60
        discountPopup.minutes = Math.floor(seconds / 60)
        discountPopup.seconds = seconds - discountPopup.minutes * 60

        var params = {
            blocks : [
                {
                    label : 'days',
                    name  : 'дни',
                    digit : discountPopup.days.padLeft().split(''),
                },{
                    label : 'hours',
                    name  : 'часы',
                    digit : discountPopup.hours.padLeft().split(''),
                },{
                    label : 'minutes',
                    name  : 'минуты',
                    digit : discountPopup.minutes.padLeft().split(''),
                },{
                    label : 'seconds',
                    name  : 'секунды',
                    digit : discountPopup.seconds.padLeft().split(''),
                },
            ]
        }
        discountPopup.$main = twig.render(discountPopup.tpl, params, true).prependTo($('body'))
        params.blocks.forEach(function(block) {
            discountPopup.$digit[block.label] = discountPopup.$main.find('[block-elem="' + block.label + '"]').find('[block-elem="digit"]')
        })
        discountPopup.$main.on(discountPopup.events)
        discountPopup.timerId = setInterval(function() {
            discountPopup.flapDigits()
        }, 1000)
    },

    close : function() {
        discountPopup.$main.remove()
        discountPopup.$main = null
        $.ajax({
            type     : 'PUT',
            url      : API_URL + '/v2/my/var',
            data     : JSON.stringify({
                key   : 'big_sale_2021_banner',
                value : '1',
            }),
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
        })
    },

    flapDigit : function($digit, next) {
        $digit.attr('class', 'proCoupons_number-' + next)
        $digit.addClass('_flap')
        setTimeout(function() {
            $digit.addClass('_flapped')
            setTimeout(function() {
                $digit.removeClass('_flapped').removeClass('_flap')
                $digit.attr('number-current', next)
            }, 250)
        }, 250)
    },

    flapDigits : function() {
        var next = {
            seconds : discountPopup.seconds,
            minutes : discountPopup.minutes,
            hours   : discountPopup.hours,
            days    : discountPopup.days,
        }
        next.seconds--
        if (next.seconds < 0) {
            next.seconds = 60
            next.minutes--
            if (next.minutes < 0) {
                next.minutes = 60
                next.hours--
                if (next.hours < 0) {
                    next.hours = 24
                    next.days--
                    if (next.days < 0) {
                        clearInterval(discountPopup.timerId)
                        discountPopup.timerId = 0
                        return false
                    }
                }
            }
        }
        for (var label in next) if (next.hasOwnProperty(label)) {
            if (next[label] == discountPopup[label]) {
                continue
            }
            var currentDigit = discountPopup[label].padLeft().split('')
            var nextDigit = next[label].padLeft().split('')
            for (var i=0; i<2; i++) {
                if (currentDigit[i] == nextDigit[i]) {
                    continue
                }
                discountPopup.flapDigit($(discountPopup.$digit[label][i]), nextDigit[i])
            }
            discountPopup[label] = next[label]
        }
    },
}


$(document).ready(function() {
    discountPopup.init()
})

/* 
 * e.js
 */
$(document).ready(function() {
    $(window).on({
        'keydown' : function (ev) {
            var $el = $(ev.target);
            if (!$el.is('[value-type="number"]') && !$el.is('input.input_number[type="text"]')) {
                return true;
            }
            var keyCode = (ev.keyCode >= 96) ? (ev.keyCode - 48) : ev.keyCode; // поправка на NumPad-цифорки
            if ( (keyCode != 8) // Backspace
                  && (keyCode != 9) // Tab
                  && (keyCode != 46) // Delete
                  && ((keyCode < 37) || (keyCode > 40)) // стрелошки
                  && ((keyCode < 48) || (keyCode > 57)) ) { // цифорки
                return false;
            }
        }
    });

    $('select').bind('change', function(ev) {
        var el = $(ev.target);
        if (el.val()) {
            var option = el.find('option[value="' + el.val() + '"]');
            var text = (option.data('value2')) ? option.data('value2') : option.text();
            $(this).prev('input:text').val(text).change();
        }
    });
});
/* 
 * fakeUpload.js
 */
function fakeUpload(file, callback, params)
{
    // Create an image
    var img = document.createElement('img')
    // Create a file reader
    var reader = new FileReader()
    // Set the image once loaded into file reader
    reader.onload = function(ev) {
        img.src = ev.target.result
        img.onload = function(ev2) {
            var canvas = document.createElement("canvas")
            var ctx = canvas.getContext("2d")
            ctx.drawImage(img, 0, 0)

            var src = {
                width  : img.width,
                height : img.height,
                ratio  : img.width / img.height,
            }
            var dst = {
                width  : src.width,
                height : src.height,
                ratio  : src.ratio,
                crop   : 0,
            }

            if (params && params.size) {
                var size = params.size.split('x')
                if (size[0] !== undefined) {
                    dst.width = +size[0]
                }
                if (size[1] !== undefined) {
                    dst.height = +size[1]
                }
                if (size[2] !== undefined) {
                    dst.crop = +size[2]
                }
            }
            if (dst.width == 0) {
                dst.width = dst.height * src.ratio
            }
            dst.ratio = dst.width / dst.height

            var width = src.width
            var height = src.height

            if ( (dst.ratio > 1 && src.ratio > 1 && dst.crop) ||
                 (dst.ratio > 1 && src.ratio <= 1 && !dst.crop) ||
                 (dst.ratio <= 1 && src.ratio >= 1 && dst.crop) ||
                 (dst.ratio <= 1 && src.ratio < 1 && !dst.crop) ) {
                height = dst.height
                width = height * src.ratio
            } else {
                width = dst.width
                height = width / src.ratio
            }

            canvas.width = dst.width
            canvas.height = dst.height
            var x = 0
            var y = 0
            if (dst.crop === 0) {
                canvas.width = Math.min(canvas.width, width)
                canvas.height = Math.min(canvas.height, height)
            } else {
                x = (canvas.width - width) / 2
                y = (canvas.height - height) / 2
            }
            var ctx = canvas.getContext("2d")
            ctx.drawImage(img, x, y, width, height)
            callback(canvas.toDataURL("image/png"), canvas.width, canvas.height)
        }
    }
    // Load files into file reader
    reader.readAsDataURL(file)
}
/* 
 * fancy.js
 */
function hideFancy(without_after) {
    $('div.fancy_layer').remove();
    $('div.fancy_back').remove();
    if (!without_after && window.hideFancyAfter) {
        hideFancyAfter();
        window.hideFancyAfter = null;
    }
}

function initFancy(block, title, options)
{
    var fancy_layer = $('<div class="fancy_back">').attr('onclick', 'hideFancy()');
    fancy_layer.appendTo($('body'));
    var fancy_layer = $('<div class="fancy_layer">');
    fancy_layer.appendTo($('body'));
    var fancy_wrapper = $('<div id="fancy_block" class="fancy_block">');
    fancy_wrapper.appendTo(fancy_layer);
    if (title) {
        var div0 = $('<div class="fancy_title">').text(title);
            var div1 = $('<div class="fancy_close">').attr('onclick', 'hideFancy()').text(t('Close')).appendTo(div0);
                var div2 = $('<div class="fancy_close_icon">').appendTo(div1);
        div0.appendTo(fancy_wrapper);
    } else {
        var div0 = $('<div class="fancy_close upper">').attr('onclick', 'hideFancy()').text(t('Close'));
            var div1 = $('<div class="fancy_close_icon">').appendTo(div0);
        div0.appendTo(fancy_wrapper);
    }

    if (options && options['fancy_block']) {
        $('#fancy_block').addClass(options['fancy_block']);
    }
    if (options && options['fancy_close'] == 'red') {
        $('.fancy_close').removeClass('upper').html('').addClass('red');
    }

    if (typeof block == 'string') {
        fancy_wrapper.append(block);
    } else {
        block.appendTo(fancy_wrapper);
    }

    fancy_wrapper.center();
}

jQuery.fn.center = function () {
    this.css("position","absolute");
    this.css("top", (($(window).height() - this.outerHeight(true)) / 2) + $(window).scrollTop() + "px");
    this.css("left", (($(window).width() - this.outerWidth(true)) / 2) + $(window).scrollLeft() + "px");
    return this;
}
/* 
 * fav.js
 */
var fav = {
    tpl : Twig.twig({data:
        '<a class="fav" fav-action="toggle" model-name="{{ model.type }}" model-id="{{ model.id }}"{% if isFav %} fav-value="1"{% endif %} href="javascript:void(0);"></a>'
    }),

    binded : false,
    list : {},
    isFavPage : 0,

    directory : {
        car        : 'cars',
        place      : 'places',
        restaurant : 'restaurants',
        shop       : 'shops',
        dressmodel : 'dresses',
        shopdress  : 'shopdresses',
        user       : 'users',
        venue      : 'venues',
    },

    counter : {
        $main : null,
        count : 0,
        refresh : function(force) {
            var counter = fav.counter
            if (counter.$main === null) {
                return false
            }
            counter.$main.text(counter.count)
            if ( counter.count > 0 ) {
                var url = document.location.origin + document.location.pathname
                var query = []
                if (!fav.isFavPage) {
                    query.push('is_fav=1')
                }
                var match = document.location.search.match(/type=(auto|limousine)/)
                if (match) {
                    query.push('type=' + match[1])
                }
                if (query.length) {
                    url += '?' + query.join('&')
                }
                counter.$main.attr('href', url)
            } else if ( counter.count == 0 && (counter.$main.attr('href') || force) ) {
                counter.$main.removeAttr('href')
            }
        }
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[fav-action="toggle"]:not(._disabled)') ) {
                fav.toggle.do($el.attr('model-name'), $el.attr('model-id'), $el.is('[fav-value="1"]'), $el)
            }
        },
    },

    render : function(model) {
        if (model.type === 'carrental' || model.type === 'users') {
            model.type = 'user'
        }
        return fav.tpl.render({
            model : model,
            isFav: fav.isFav(model.type, model.id),
        })
    },

    toggle : {
        do : function(modelName, modelId, isFav, $button) {
            isFav = +!isFav
            modelName = modelName.toLowerCase()
            modelId = +modelId
            if (isFav) {
                fav.toggle.set(modelName, modelId, $button)
            } else {
                fav.toggle.remove(modelName, modelId, $button)
            }
        },
        set : function(modelName, modelId, $button) {
            $button.addClass('_disabled')
            $.ajax({
                type     : 'POST',
                url      : API_URL + '/v2/' + fav.directory[modelName] + '/' + modelId + '/favorites',
                dataType : 'json',
                xhrFields: {
                    withCredentials: true
                },
                statusCode  : {
                    201  : function(json) {
                        if (!fav.list[modelName]) {
                            fav.list[modelName] = []
                        }
                        if (fav.list[modelName].indexOf(modelId) < 0) {
                            fav.list[modelName].push(+modelId)
                        }
                        $('[fav-action="toggle"][model-name="' + modelName + '"][model-id="' + modelId + '"]').attr('fav-value', 1)
                        fav.counter.count++
                        fav.counter.refresh()
                        $button.removeClass('_disabled')
                    },
                    501 : function() {
                        $button.removeClass('_disabled')
                    }
                }
            });
        },
        remove : function(modelName, modelId, $button) {
            $button.addClass('_disabled')
            $.ajax({
                type     : 'DELETE',
                url      : API_URL + '/v2/' + fav.directory[modelName] + '/' + modelId + '/favorites',
                dataType : 'json',
                xhrFields: {
                    withCredentials: true
                },
                statusCode  : {
                    200: function(json) {
                        alert2(json.error);
                    },
                    204: function() {
                        var index = fav.list[modelName].indexOf(modelId)
                        if (index >= 0) {
                            fav.list[modelName].splice(index, 1)
                        }
                        $('[fav-action="toggle"][model-name="' + modelName + '"][model-id="' + modelId + '"]').removeAttr('fav-value')
                        fav.counter.count--
                        fav.counter.refresh()
                        $button.removeClass('_disabled')
                    }
                }
            });
        }
    },

    load : function() {
        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/favorites',
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
            success  : function(json) {
                var favs = json.favorites
                fav.list = {}
                for (var i=0; favs[i]; i++) {
                    var modelName = favs[i].model_name.toLowerCase()
                    if (!fav.list[modelName]) {
                        fav.list[modelName] = []
                    }
                    fav.list[modelName].push(+favs[i].model_id)
                }
            }
        });
    },

    isFav : function(modelName, modelId) {
        return fav.list[modelName] && (fav.list[modelName].indexOf(modelId) >= 0)
    },

    setOnPage : function() {
        for (var modelName in fav.list) if (fav.list.hasOwnProperty(modelName)) {
            var favs = fav.list[modelName]
            for (var i=0; favs[i]; i++) {
                $('[fav-action="toggle"][model-name="' + modelName + '"][model-id="' + favs[i] + '"]').attr('fav-value', 1)
            }
        }
    },

    init : function() {
        if (fav.binded) {
            return true
        }

        $(window).on(fav.events)

        fav.isFavPage = document.location.search.indexOf('is_fav=1') >= 0
        fav.load().then(function() {
            var counter = fav.counter
            counter.$main = $('#fav_count')
            if (!counter.$main.length) {
                counter.$main = null
            } else {
                counter.$main.toggleClass('_cur', fav.isFavPage)
                var modelName = counter.$main.attr('model-name')
                if (modelName) {
                    var favs = fav.list[modelName.toLowerCase()]
                    if (favs) {
                        counter.count = favs.length
                    }
                } else {
                    counter.count = +counter.$main.text()
                }
                counter.refresh()
            }

            fav.setOnPage()
        })

        fav.binded = true
    }
}

$(document).ready(function() {
    if ($('#forum').length) {
        return false
    }
    fav.init()
})
/* 
 * fillFields.js
 */
/*
 * Биндит на блок проверку на заполненность полей
 * @param $main - jQ-блок или id'шник блока, который содержит поля
 * @param callback - функция, которая должна выполниться после проверки полей (если нужно, конечно)
 * @param startWords - фраза, с которой должно начинаться предложение об ошибках (не везде оно одинаковое)
 * @param params - объект, который может содержать поля (сделано для совместимости со старьём. Но лучше использовать аттрибут ff-elem в подобных тэгах):
 *      text - jQ-блок или его #id'шник, куда надо будет выводить инфу об ошибках
 *      button - jQ-кнопка или её #id'шник, которую будем дизейблить (если есть ошибки) или активировать (если их нет)
 *      errorClass - класс, который надо будет повесить на элемент, если проверка 
 *
 * ff-аттрибуты в тэгах:
 *      ff-elem:
 *          text - в этот блок будут писаться ошибки
 *          button - кнопка, которую нужно дизейблить
 *
 *      ff-empty - если поле пусто, то в ошибки добавится фраза, которая содержится в этом аттрибуте.
 *      ff-error - фраза, которая добавляется в ошибки при каких-то различных условиях (например, поле не пустое, но его содержимое не подходит под шаблон).
 *      ff-isfirst - фраза, которая добавляется перед фразами ff-error и ff-empty в случае, если среди неверных полей данное является первым.
 *      ff-pattern - если содержимое поля не подходит под регулярку, указанную в этом аттрибуте, то добавится фраза из аттрибута ff-error.
 *      ff-group - если несколько полей нужно считать за одно (например, номер телефона в три поля "+7 123 4567890"), то этот аттрибут сделает это. Checkbox'ы и RadioButton'ы по-дефолту группируются через аттрибут "name", поэтому для них не обязательно указывать ff-group.
 *      ff-hint - если в случае ошибки (то есть те же случаи, что и ff-error) и нужно вывести всплывающую подсказку, то в этом аттрибуте указывается фраза для подсказки. Не работает для чекбоксов и радиобаттонов. (! ТРЕБУЕТ НАЛИЧИЯ hint.js !)
 *      ff-need - если в группе чекбоксов нужно обязательно отметить более 1 пункта, то этот аттрибут указывает необходимое кол-во. Если выбран только один пункт, а нужно больше и есть ff-error, то ff-error перекроет ff-empty.
 *
 * В ff-empty, ff-error и ff-isfirst можно обрамить текст в коды [ff][/ff], и тогда они заменяться на <span class=""fillfield"></span>
 */
var fillFields = {
    list : [],

    init : function($main, callback, startWords, params) {
        if ($main.is('[ff-list_id]')) {
            fillFields.check($main.attr('ff-list_id'))
            return false
        }

        if (!$main) {
            return false
        }

        if ((typeof $main).toLowerCase() == 'string') {
            $main = $('#' + $main)
            if (!$main.length) {
                return false
            }
        }

        if (!startWords) {
            startWords = t('You must specify')
        }

        var listId = fillFields.list.length
        $main.attr({
            'ff-elem'    : 'form',
            'ff-list_id' : listId,
        })
        fillFields.list[listId] ={
            $main      : $main,
            callback   : callback,
            startWords : startWords,
            params     : params,
        }

        // навесим события на блок с полями
        $main.on({
            'change input' : function(ev) {
                fillFields.check(listId)
            },
            focusout : function(ev) {
                var $field = $(ev.target)
                if (!$field.attr('ff-empty') && !$field.attr('ff-error')) {
                    return
                }
                $field.attr('ff-was_filled', 1)
                fillFields.check(listId)
            },
        })
        fillFields.check(listId)

        return listId
    },

    hasHiddenParent : function($item) {
        var $parent = $item.parent();
        while (!$parent.is('[ff-elem="form"]')) {
            if ($parent.is('.h')) {
                return true;
            }
            $parent = $parent.parent();
        }
        return $parent.is('.h');
    },

    // функция проверки полей
    check : function(listId, $field) {
        if (listId === undefined) {
            if (fillFields.list.length == 1) {
                listId = 0;
            } else {
                return false;
            }
        }

        with (fillFields.list[listId]) {
            var $elem = {
                'text'   : false,
                'button' : false
            }
            for (var name in $elem) if ($elem.hasOwnProperty(name)) {
                $elem[name] = $main.find('[ff-elem="' + name + '"]');
                if ($elem[name].size() > 0) {
                    continue;
                }
                if (params && params[name]) {
                    if ((typeof params[name]).toLowerCase() == 'string') {
                        $elem[name] = $('#' + params[name]);
                        if ($elem[name].size() > 0) {
                            continue;
                        }
                    } else {
                        $elem[name] = params[name];
                    }
                    continue;
                }
                $elem[name] = false;
            }

            if ($elem.text !== false) {
                $elem.text.empty();
            }

            var error = []; // стэк ошибок
            var group = []; // стэк групп. нужно чтобы проверять, есть ли ошибки в группе или нет

            // проходим по каждому полю и выясняем, в каких из них есть ошибки или незаполненности
            $main.find('[ff-empty]').each(function(i, $item){
                $item = $($item);
                // для начала проигнорируем ненужные поля
                if ($item.is('[ff-ignore="1"]')) {
                    return;
                }

                // скроем всплывающие подсказки
                if ($item.attr('ff-hint') && hint) {
                    hint.hide($item.attr('name'));
                }

                // если поле находится в скрытом блоке, то игнорим его
                if (fillFields.hasHiddenParent($item)) {
                    if (params && params.errorClass && $item.hasClass(params.errorClass)) {
                        $item.removeClass(params.errorClass)
                    }
                    return;
                }
                // если поле не активно, то игнорим его
                if ($item.prop('disabled')) {
                    if (params && params.errorClass && $item.hasClass(params.errorClass)) {
                        $item.removeClass(params.errorClass)
                    }
                    return;
                }

                // если поле radio button
                if ($item.prop('type') == 'radio') {
                    // группировка всех radio button с одинаковым аттрибутом "name"
                    var radioName = $item.attr('name');
                    if (group[radioName]) {
                        return;
                    }
                    group[radioName] = 1;
                    // проверка наличия выбранного radio button
                    var $checked = $('input:checked[name="' + radioName + '"]');
                    if (!$checked.length) {
                        error[error.length] = ( ((error.length == 0) && $item.attr('ff-isfirst')) ? $item.attr('ff-isfirst') + ' ' : '') + $item.attr('ff-empty');
                    }
                    return;
                }

                // если поле checkbox
                if ($item.prop('type') == 'checkbox') {
                    // группировка всех checkbox'ов с одинаковым аттрибутом "name"
                    var cbName = $item.attr('ff-group') || $item.attr('name');
                    if (group[cbName]) {
                        return;
                    }
                    group[cbName] = 1;
                    // проверка наличия выбранного radio button
                    var $checked = $main.find('input:checked[ff-group="' + cbName + '"]');
                    if (!$checked.length) {
                        $checked = $main.find('input:checked[name="' + cbName + '"]');
                    }
                    var need = ($item.attr('ff-need')) || 1; // узнаем, сколько минимум чекбоксов должно быть отмечено
                    if ($checked.length < need) {
                        var phrase = ( ($checked.length > 0) && $item.attr('ff-error') ) ? $item.attr('ff-error') : $item.attr('ff-empty');
                        error[error.length] = ( ((error.length == 0) && $item.attr('ff-isfirst')) ? $item.attr('ff-isfirst') + ' ' : '') + phrase;
                        return;
                    }
                }

                // теперь пройдёмся по текстовым полям
                var itemValue = $item.val();

                // если поле не заполненно, то сообщим об этом
                if (itemValue.length == 0 || itemValue === 'null') {
                     // если элемент сгруппирован и у этой группы уже есть ошибка, то обрабатывать дальше не стоит
                    if ($item.attr('ff-group')) {
                        var groupName = $item.attr('ff-group')
                        var need = +$item.attr('ff-need') || $main.find('[ff-group="' + groupName + '"]').length; // кол-во полей, которые должны быть заполнены в группе
                        if (!group[groupName]) {
                            group[groupName] = $main.find('[ff-group="' + groupName + '"]:not(:disabled)').length; // счётчик заполненных полей
                        }
                        group[groupName]--;
                        if ( group[groupName] != (need - 1) ) {
                            if ($item.attr('ff-was_filled')) {
                                $main.find('[ff-group="' + groupName + '"]').attr('ff-was_filled', 1)
                            }
                            return
                        }
                    }
                    // если ошибку нужно выводить только в случае, если содержимое поля не соответствует шаблону, то не будет добавлять ошибку.
                    if ($item.attr('ff-empty') != '[pattern]') {
                        error[error.length] = ( ((error.length == 0) && $item.attr('ff-isfirst')) ? $item.attr('ff-isfirst') + ' ' : '') + $item.attr('ff-empty');
                    }
                    // если после элемента есть красная точка валидации, то выключим ее
                    if ($item.next('.form_validate_dot')) $item.next('.form_validate_dot').addClass('h');
                    if (params && params.errorClass && $item.attr('ff-was_filled')) {
                        var groupName = $item.attr('ff-group')
                        if (groupName) {
                            $main.find('[ff-group="' + groupName + '"]').addClass(params.errorClass)
                        } else {
                            $item.addClass(params.errorClass)
                        }
                    }
                    return;
                }

                // иначе, если же поле заполненно с ошибкой, то сообщим об этом
                if ( $item.attr('ff-pattern') && !itemValue.match($item.attr('ff-pattern')) ) {
                    // если после элемента есть красная точка валидации, то включим ее
                    if ($item.next('.form_validate_dot')) $item.next('.form_validate_dot').removeClass('h');
                    // если элемент сгруппирован и у этой группы уже есть ошибка, то обрабатывать дальше не стоит
                    if ($item.attr('ff-group')) {
                        if (group[$item.attr('ff-group')]) {
                            return;
                        }
                        group[$item.attr('ff-group')] = 1;
                    }
                    error.push($item.attr('ff-error') ? $item.attr('ff-error') : $item.attr('ff-empty'));
                    // если нужно вывести подсказку, то выведем её
                    if ($item.attr('ff-hint') && hint) {
                        hint.show($item.attr('name'), $item.attr('ff-hint'), 'error', '_error');
                    }
                    if (params && params.errorClass && $item.attr('ff-was_filled')) {
                        $item.addClass(params.errorClass)
                    }
                    return
                } else {
                    // если после элемента есть красная точка валидации, то выключим ее
                    if ($item.next('.form_validate_dot')) $item.next('.form_validate_dot').addClass('h');
                }
                if (params && params.errorClass) {
                    var groupName = $item.attr('ff-group')
                    if (groupName) {
                        $main.find('[ff-group="' + groupName + '"]').removeClass(params.errorClass)
                    } else if ($item.hasClass(params.errorClass)) {
                        $item.removeClass(params.errorClass)
                    }
                }
            });

            // узнаем кол-во ошибок
            var errorCount = error.length;
            var hasError = (errorCount > 0);
            if ($elem.button !== false) {
                var tagName = $elem.button[0].tagName.toLowerCase();
                if ( (tagName == 'button') || (tagName == 'input') ) {
                    $elem.button.prop('disabled', hasError);
                } else {
                    $elem.button.toggleClass('_disabled', hasError);
                }
            }

            if (typeof callback == 'function') callback(hasError);

            if (!hasError) {
                return;
            }

            // выведем ошибки
            if ($elem.text !== false) {
                errorCount--;
                todoHtml = startWords + ' ';
                for (var i=0; i<=errorCount; i++) {
                    if (i > 0) {
                        todoHtml += (i == errorCount) ? ' ' + t('and') + ' ' : ', ';
                    }
                    todoHtml += error[i].replace(/\[ff\]/g, '<span class="fillfield">').replace(/\[\/ff\]/g, '</span>');
                }
                $elem.text.html(todoHtml);
            }

            return;
        }
    }
}

$(document).ready(function(){
    $('[ff-elem="form"]').each(function(i, $form) {
        fillFields.init($($form));
    });
});

/* 
 * filters.js
 */
var filters = {
    date        : null,
    multiselect : null,
    select      : null,

    $main  : null,
    $area  : null,
    $dummy : null,

    entity : {
        type   : null,
        typeId : 0,
    },
    callback : null,
    list : [],
    indexes : {},
    current : null,
    offsetY : 0,
    isSticky : false,
    depends : {},

    baseUrl: '',
    friendlyUrls: [],

    tpl : {
        main  : Twig.twig({data:
            '<div id="filters" class="filters" columns="3">' +
                '<div class="filters_area" filters-elem="area"></div>' +
            '</div>'
        }),
        dummy : Twig.twig({data:'<div class="filters_dummy" style="height:{{ height }}px"></div>'}),
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ( !$el.closest('[filter-elem="main"]').length && (filters.current !== null) ) {
                filters.toggle(filters.current.label)
            } else if ($el.is('[filter-action]')) {
                var label = $el.closest('[filter-elem="main"]').attr('filter-label')
                switch ($el.attr('filter-action')) {
                    case 'toggle' : return filters.toggle(label)
                    case 'clear'  : return filters.clear(label)
                }
            }
        },
        scroll : function(ev) {
            filters.checkSticky()
        },
    },

    init : function() {
        filters.offsetY = filters.$main.offset().top + 30
        $(window).on(filters.events)
        filters.recalcColumns()
    },

    render : {
        main : function() {
            return $(filters.tpl.main.render())
        },
        items : function(list) {
            var values = {}
            var friendlyUrls = filters.friendlyUrls.filter(function (url) {
                return url.url === document.location.origin + decodeURI(document.location.pathname)
            })
            var query = []
            if (friendlyUrls.length) {
                query = friendlyUrls[0].params.split('&')
            } else {
                query = document.location.search.replace('?', '').split('&')
            }
            for (var i = 0; query[i]; i++) {
                var value = query[i].split('=')
                values[value[0]] = value[1].split(',')
            }
            delete query
            var dependQuery = []
            list.map(function(item, i) {
                if (item.depends) {
                    for (var label in item.depends) if (item.depends.hasOwnProperty(label)) {
                        var key = item.depends[label]
                        if (!filters.depends[label]) {
                            filters.depends[label] = {}
                        }
                        filters.depends[label][filters.list.length] = key
                        var dependFilter = null
                        for (var i=0; filters.list[i]; i++) {
                            if (filters.list[i].label == label) {
                                dependFilter = filters.list[i]
                                item.hidden = dependFilter.result[0] != key
                                break
                            }
                        }
                        if (dependFilter === null) {
                            dependQuery.push(label)
                        }
                    }
                }
                var filter = null
                item.values = []
                if (item.default) {
                    item.default = item.default.map(function (item) {
                        return "" + item
                    })
                }
                if (values[item.label]) {
                    item.values = values[item.label]
                } else if (item.current) {
                    item.values = [item.current]
                } else if (item.default) {
                    item.values = item.default
                }
                switch (item.type) {
                    case 'select' :
                    case 'color' :
                        if (item.multiple === false) {
                            filter = filters.select.create(item)
                        } else {
                            filter = filters.multiselect.create(item)
                        }
                        break
                    case 'date' :
                        if (item.values[0] < moment().format('YYYY-MM-DD')) {
                            item.values = []
                        }
                        filter = filters.date.create(item)
                        break
                }
                filters.indexes[item.label] = filters.list.push(filter) - 1
                filter.$main.appendTo(filters.$area)
            })
        }
    },

    load : function() {
        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/directory/filters',
            data     : {
                city_id : CITY_ID,
                type    : filters.entity.type,
                type_id : filters.entity.typeId,
            },
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
        });
    },

    alignValues : function() {
        if (filters.current.$values === undefined) {
            return
        }
        var columns = filters.$main.attr('columns')
        var index = 1
        for (var i=0; filters.list[i]; i++) {
            if (filters.list[i].hidden) {
                continue
            }
            if (filters.list[i].label == filters.current.label) {
                break
            }
            index++
        }
        if (index % columns == 0 || ['5_2', '7_4'].indexOf(columns + '_' + index) >= 0) {
            if (filters.current.$main.width() < filters.current.$values.width()) {
                filters.current.$values.addClass('_right')
            }
        }
    },

    toggle : function(label) {
        if (filters.current !== null) {
            var onlyClose = (label == filters.current.label)
            filters.current.toggle(false)
            if (onlyClose) {
                filters.current = null
                return true
            }
        }
        for (var i=0; filters.list[i]; i++) {
            if (filters.list[i].label == label) {
                filters.current = filters.list[i]
                filters.current.toggle(true)
                filters.alignValues()
                break
            }
        }
    },

    generateQueryString : function() {
        var query = []
        var checkCom = document.location.search.match(/com=([^&]+)/i)
        if (checkCom && checkCom.length === 2) {
            query.push('com=' + checkCom[1])
        }
        var checkUtm = document.location.search.match(/utm_landing=([^&]+)/i)
        if (checkUtm && checkUtm.length === 2) {
            query.push('utm_landing=' + checkUtm[1])
        }
        for (var i=0; filters.list[i]; i++) {
            var filter = filters.list[i]
            if (!filter.hidden && filter.result.length && filter.result != 'reset') {
                if (!filter.default || !equalArrays(filter.result, filter.default)) {
                    query.push(filter.label + '=' + filter.result.join(','))
                }
            }
        }
        if (document.location.search.indexOf('is_fav') > 0) {
            query.push('is_fav=1')
        }
        if (catalog && catalog.fields !== null) {
            for (var field in catalog.fields) if (catalog.fields.hasOwnProperty(field)) {
                query.push(field + '=' + catalog.fields[field])
            }
        }
        return query.length ? '?' + query.join('&') : ''
    },

    send : function() {
        var queryString = filters.generateQueryString()
        var checkCom = document.location.search.match(/com=([^&]+)/i)
        var filterQueryString = checkCom && checkCom.length === 2 ? queryString.replace(/com=([^&]+)&?/, '') :  queryString
        filterQueryString = filterQueryString.replace('?', '')
        var url = filters.baseUrl
        var friendlyUrls = filters.friendlyUrls.filter(function(f) { return f.params===filterQueryString})
        if (friendlyUrls.length) {
            url = friendlyUrls[0].url
            queryString = checkCom && checkCom.length===2 ? '?com=' + checkCom[1] : ''
        }
        if (queryString) {
            url += queryString
        }
        history.pushState(null, null, url);
        if (filters.callback) {
            filters.callback(filters.list.map(function(filter){
                return {
                    label : filter.label,
                    value : filter.result,
                }
            }))
        } else {
            catalog.show(1, function() {ajaxHit(url)});
        }
    },

    clear : function(label) {
        filters.list[filters.indexes[label]].clear()
    },

    checkSticky : function() {
        if ($(window).scrollTop() > filters.offsetY) {
            if (!filters.isSticky) {
                filters.$main.addClass('_sticky')
                filters.isSticky = true
            }
        } else {
            if (filters.isSticky) {
                filters.$main.removeClass('_sticky')
                filters.isSticky = false
            }
        }
    },

    getColumns : function() {
        var columns = 0
        filters.list.map(function(filter){
            if (!filter.hidden) {
                columns++
            }
        })
        if (columns == 4) {
            columns = 2
        } else if (columns == 6 || columns > 7) {
            columns = 3
        }
        return columns
    },

    recalcColumns : function() {
        filters.$main.attr('columns', filters.getColumns())
        filters.$dummy.height(filters.$main[0].clientHeight)
    },

    create : function($block, entityType, entityTypeId, callback) {
        filters.entity.type = entityType
        filters.entity.typeId = entityTypeId
        if (callback) {
            filters.callback = callback
        }
        filters.load()
        .then(function(list) {
            filters.friendlyUrls = list.friendly_urls
            filters.baseUrl = list.base_url
            list = list.filters
            if (list.length) {
                filters.$main = filters.render.main()
                filters.$area = filters.$main.find('[filters-elem="area"]')
                filters.render.items(list)
                filters.$main.insertBefore($block)
                filters.$dummy = $(filters.tpl.dummy.render({height:filters.$main[0].clientHeight})).insertAfter(filters.$main)
                filters.init()
                $block.remove()
                filters.checkSticky()
            }
        })
    }
}

$(document).ready(function() {
    var $filters = $('#filters')
    if ($filters.length) {
        filters.create($filters, $filters.attr('entity-type'), $filters.attr('entity-type_id'))
    }
})

/* 
 * filters_date.js
 */
filters.date = {
    tpl : Twig.twig({data:
        '<div class="filter filter-date{% if filter.result|length %} _filled{% endif %}{% if filter.hidden %} h{% endif %}" filter-elem="main" filter-label="{{ filter.label }}">' +
            '<div class="filter_caption">{{ filter.caption }}</div>' +
            '<div class="filter_select" filter-elem="text" filter-action="toggle">{{ text }}</div>' +
            '<a class="filter_clear" filter-action="clear"></a>' +
        '</div>'
    }),

    render : function(filter, info) {
        var text = filter.placeholder
        if (info.values.length) {
            filter.result = info.values
            text = moment(filter.result[0]).format('LL')
        }
        return $(filters.date.tpl.render({
            filter : filter,
            text    : text,
        }))
    },

    create : function(info, isUpper) {
        var filter = {
            $main    : null,
            $text    : null,

            label   : info.label,
            caption : info.name,
            placeholder : info.name,
            hidden  : info.hidden || false,
            result  : [],

            toggle : function(show) {
                if (show !== true && show !== false) {
                    show = filter.$main.is('_opened')
                }
                filter.$main.toggleClass('_opened', show)
                if (!filter.result.length) {
                    var text = show ? '' : filter.placeholder
                    filter.$text.text(text)
                }
                if (show) {
                    var params = {
                        interval : '+12',
                        type     : 'point',
                        single   : true,
                    }
                    if (filter.result.length) {
                        params.dates = filter.result
                    }
                    calendar.init(filter.$main, params, {
                        onPick : filter.onPick,
                    })
                } else {
                    filters.current = null
                    calendar.close()
                }
            },
            setWeddingDate : function(date) {
                return $.ajax({
                    type     : 'PUT',
                    url      : API_URL + '/v2/directory/filterDate',
                    data     : JSON.stringify({
                        date : date,
                    }),
                    dataType : 'json',
                    xhrFields: {
                        withCredentials: true
                    }
                })
            },
            onPick : function(date) {
                date = date.pop()
                filter.result = [date]
                var text = moment(date).format('LL')
                filter.$main.addClass('_filled')
                filter.$text.text(text).attr('title', text)
                filter.toggle(false)
                filter.setWeddingDate(date).then(filters.send)
            },
            clear : function() {
                filter.result = []
                filter.$main.removeClass('_filled')
                if (!filter.$main.is('._opened')) {
                    filter.$text.text(filter.placeholder)
                }
                filter.setWeddingDate(0).then(filters.send)
                filter.toggle(false)
            },
            disable : function(disabled) {
                filter.hidden = disabled
                filter.$main.toggleClass('h', filter.hidden)
                filters.recalcColumns()
            },
        }
        moment.locale(LOCALE)
        filter.$main = filters.date.render(filter, info)
        filter.$text = filter.$main.find('[filter-elem="text"]')
        return filter
    }
}
/* 
 * filters_multiselect.js
 */
filters.multiselect = {
    tpl : {
        main : Twig.twig({data:
            '<div class="filter{% if filter.result|length %} _filled{% endif %}{% if filter.type=="color" %} filter-color{% endif %}{% if filter.hidden %} h{% endif %}" filter-elem="main" filter-label="{{ filter.label }}">' +
                '<div class="filter_caption">{{ filter.caption }}</div>' +
                '<div class="filter_select" filter-elem="text" filter-action="toggle"{% if filter.result|length > 1 %} filter-count="{{ filter.result|length }}"{% endif %}{% if title %} title="{{ title }}"{% endif %}>{{ text }}</div>' +
                '<a class="filter_clear" filter-action="clear"></a>' +
            '</div>'
        }),
        values : Twig.twig({data:
            '<div class="filter_values">' +
                '<div class="filter_list">{{ options }}</div>' +
                '<div class="filter_apply h" filter-elem="apply"><a filter-action="apply">' + t('Apply') + '</a></div>' +
            '</div>'
        }),
        option : Twig.twig({data:
            '<label class="switcher filter_value">' +
                '<input type="checkbox" value="{{ item.key }}" name="{{ label }}[]" class="switcher-checkbox"{% if item.checked %} checked{% endif %} value-text="{{ item.text }}"{% if hasGroup %} has_group{% endif %}{% if group %} group-id="{{ group }}"{% endif %}>' +
                '<span class="switcher_icon"></span>' +
                '<span class="switcher_text">{{ item.text }}</span>' +
            '</label>'
        }),
        color : Twig.twig({data:
            '<label class="filter_value-color">' +
                '<input type="checkbox" value="{{ item.key }}" name="{{ label }}[]" class="filter_color_checkbox"{% if item.checked %} checked{% endif %} value-text="{{ item.text }}">' +
                '<span class="filter_color-{{ item.key }}"></span>' +
                '{{ item.text }}' +
            '</label>'
        }),
        group : Twig.twig({data:
            '<div class="filter_group{% if collapsed %} _collapsed{% endif %}" filter-elem="group" group-key="{{ key }}">' +
                '{{ items }}' +
                '{% if collapsed %}' +
                    '<p class="filter_expander" filter-elem="expander">' +
                        '<a href="javascript:void(0);" filter-action="expand">{{ expandText }}</a>' +
                    '</p>' +
                '{% endif %}' +
            '</div>'
        }),
    },

    render : {
        main : function(filter) {
            var text = []
            for (var i=0; filter.items[i]; i++) {
                var item = filter.items[i]
                var value = '' + item.key
                if (filter.result.indexOf(value) >= 0) {
                    text.push(item.text)
                }
                if (item.items && item.items.length) {
                    var items$ = []
                    for (var j=0; item.items[j]; j++) {
                        var subItem = item.items[j]
                        value = '' + subItem.key
                        if (filter.result.indexOf(value) >= 0) {
                            text.push(subItem.text)
                        }
                    }
                }
            }
            return $(filters.multiselect.tpl.main.render({
                filter  : filter,
                text    : text.length ? text.join(', ') : filter.placeholder,
                title   : text.length ? text.join(', ') : null,
            }))
        },

        values : function(filter) {
            var options$ = []
            for (var i=0; filter.items[i]; i++) {
                var item = filter.items[i]
                item.checked = filter.result.indexOf("" + item.key) >= 0
                if (filter.type == 'color') {
                    options$.push(filters.multiselect.tpl.color.render({
                        label : filter.label,
                        item  : item,
                    }))
                } else {
                    options$.push(filters.multiselect.tpl.option.render({
                        label    : filter.label,
                        item     : item,
                        hasGroup : (item.items && item.items.length),
                    }))
                    if (item.items && item.items.length) {
                        var items$ = []
                        for (var j=0; item.items[j]; j++) {
                            var subItem = item.items[j]
                            subItem.checked = item.checked || filter.result.indexOf("" + subItem.key) >= 0
                            items$.push(filters.multiselect.tpl.option.render({
                                label : filter.label,
                                item  : subItem,
                                group : item.key,
                            }))
                        }

                        var collapsed = false
                        if (item.items.length > 6) {
                            collapsed = true
                        }
                        options$.push(filters.multiselect.tpl.group.render({
                            key        : item.key,
                            items      : items$.join(''),
                            collapsed  : collapsed,
                            expandText : t('+ more {count}', {'{count}':item.items.length - 5}),
                        }))
                    }
                }
            }
            return $(filters.multiselect.tpl.values.render({
                options : options$.join(''),
            }))
        },
    },

    create : function(info) {
        var filter = {
            $main     : null,
            $values   : null,
            $text     : null,
            $apply    : null,

            type        : info.type,
            placeholder : info.name,
            label       : info.label,
            caption     : info.name,
            result      : info.values || [],
            items       : info.items || [],
            default     : info.default || [],
            hidden      : info.hidden || false,
            changes     : {
                values : [],
                text   : [],
            },

            toggle : function(show) {
                if (show !== true && show !== false) {
                    show = filter.$main.is('_opened')
                }
                filter.$main.toggleClass('_opened', show)
                if (!filter.result.length) {
                    var text = show ? '' : filter.placeholder
                    filter.$text.text(text)
                }
                if (show) {
                    filter.$values = filters.multiselect.render.values(filter).appendTo(filter.$main)
                    filter.$apply = filter.$values.find('[filter-elem="apply"]')
                } else {
                    if (filter.$values !== null) {
                        filter.$values.remove()
                        filter.$values = null
                        filter.$apply = null
                    }
                    filters.current = null
                }
            },

            expand : function($expander) {
                $expander.closest('[filter-elem="group"]').removeClass('_collapsed')
                $expander.closest('[filter-elem="expander"]').remove()
            },

            apply : function() {
                if (filter.$text === null) {
                    return true
                }
                var text = filter.changes.text.join(', ')
                filter.result = filter.changes.values.slice()
                if (filter.result.length) {
                    filter.$main.addClass('_filled')
                    filter.$text.text(text).attr('title', text)
                } else {
                    filter.$main.removeClass('_filled')
                    filter.$text.text('').removeAttr('title')
                }
                if (filter.result.length > 1) {
                    filter.$text.attr('filter-count', filter.result.length)
                } else {
                    filter.$text.removeAttr('filter-count')
                }
                if (filters.depends[filter.label]) {
                    var depends = filters.depends[filter.label]
                    for (var index in depends) if (depends.hasOwnProperty(index)) {
                        var disable = true
                        for (var i=0; filter.result[i]; i++) {
                            if (filter.result[i] == depends[index]) {
                                disable = false
                                break
                            }
                        }
                        filters.list[index].disable(disable)
                    }
                }
                filters.send()
                filter.toggle(false)
            },

            events : {
                click : function(ev) {
                    var $el = $(ev.target)
                    if ($el.is('[filter-action="expand"]')) {
                        filter.expand($el)
                        return false
                    } else if ($el.is('[filter-action="apply"]')) {
                        filter.apply()
                        return false
                    }
                },
                change : function(ev) {
                    var $el = $(ev.target)
                    if (filter.multiple === false) {
                        filter.$main.find('input:checked:not([value="' + $el.val() + '"])').prop('checked', false)
                    }
                    if ($el.is('[has_group]')) {
                        var groupId = $el.attr('value')
                        filter.$main.find('[group-id="' + groupId + '"]').prop('checked', $el.prop('checked'))
                    }
                    if ($el.is('[group-id]')) {
                        var groupId = $el.attr('group-id')
                        var $checkboxes = $el.closest('[filter-elem="group"]').find('[group-id="' + groupId + '"]:not(:checked)')
                        var checked = !$checkboxes.length
                        filter.$main.find('[value="' + groupId + '"]').prop('checked', checked)
                    }
                    filter.change()
                }
            },

            change : function() {
                var $checkboxes = filter.$main.find('input')
                filter.changes.values = []
                filter.changes.text = []
                var groups = []
                for (var i=0; $checkboxes[i]; i++) {
                    var $checkbox = $($checkboxes[i])
                    if ($checkbox.prop('checked')) {
                        var key = $checkbox.attr('value')
                        if ($checkbox.is('[has_group]')) {
                            groups.push(key)
                        } else if ($checkbox.is('[group-id]')) {
                            if (groups.indexOf($checkbox.attr('group-id')) >= 0) {
                                continue
                            }
                        }
                        filter.changes.values.push(key)
                        filter.changes.text.push($checkbox.attr('value-text'))
                    }
                }
                if (filter.$apply.hasClass('h')) {
                    filter.$apply.removeClass('h')
                }
                filter.$apply.attr('text', t('{count} selected', {'{count}':filter.changes.values.length}))
            },

            clear : function() {
                filter.changes.values = []
                filter.changes.text = []
                filter.$main.find('input').prop('checked', false).change()
                filter.apply()
                if (!filter.$main.is('._opened')) {
                    filter.$text.text(filter.placeholder)
                }
            },

            disable : function(disabled) {
                filter.hidden = disabled
                filter.$main.toggleClass('h', filter.hidden)
                filters.recalcColumns()
            },
        }

        filter.$main  = filters.multiselect.render.main(filter)
        filter.$text  = filter.$main.find('[filter-elem="text"]')
        
        if (!filter.$text.length) {
            filter.$text = null
        }
        filter.$main.on(filter.events)
        return filter
    }
}
/* 
 * filters_select.js
 */
filters.select = {
    tpl : {
        main : Twig.twig({data:
            '<div class="filter{% if filter.result|length %} _filled{% endif %}{% if filter.hidden %} h{% endif %}" filter-elem="main" filter-label="{{ filter.label }}">' +
                '<div class="filter_caption">{{ filter.caption }}</div>' +
                '<div class="filter_select" filter-elem="text" filter-action="toggle"{% if title %} title="{{ title }}"{% endif %}>{{ text }}</div>' +
            '</div>'
        }),
        values : Twig.twig({data:
            '<div class="filter_values">' +
                '<div class="filter_list">' +
                    '{% for item in items %}' +
                        '<a class="filter_value{% if current == item.key %} _cur{% endif %}" value="{{ item.key }}" filter-action="select">{{ item.text }}</a>' +
                    '{% endfor %}' +
                '</div>' +
            '</div>'
        }),
    },

    render : {
        main : function(filter) {
            var text = null
            for (var i=0; filter.items[i]; i++) {
                var item = filter.items[i]
                var value = '' + item.key
                if (filter.result.indexOf(value) >= 0) {
                    text = item.text
                    break
                }
            }
            return $(filters.select.tpl.main.render({
                filter : filter,
                text   : text || filter.placeholder,
                title  : text,
            }))
        },

        values : function(filter) {
            return $(filters.select.tpl.values.render({
                items   : filter.items,
                current : filter.result[0],
            }))
        },
    },

    create : function(info) {
        var filter = {
            $main     : null,
            $values   : null,
            $text     : null,

            type        : info.type,
            placeholder : info.name,
            label       : info.label,
            caption     : info.name,
            result      : info.values || [],
            items       : info.items || [],
            default     : info.default || [],
            hidden      : info.hidden || false,
            changes     : {
                values : [],
                text   : [],
            },

            toggle : function(show) {
                if (show !== true && show !== false) {
                    show = filter.$main.is('_opened')
                }
                filter.$main.toggleClass('_opened', show)
                if (!filter.result.length) {
                    var text = show ? '' : filter.placeholder
                    filter.$text.text(text)
                }
                if (show) {
                    filter.$values = filters.select.render.values(filter).appendTo(filter.$main)
                } else {
                    if (filter.$values !== null) {
                        filter.$values.remove()
                        filter.$values = null
                    }
                    filters.current = null
                }
            },

            expand : function($expander) {
                $expander.closest('[filter-elem="group"]').removeClass('_collapsed')
                $expander.closest('[filter-elem="expander"]').remove()
            },

            apply : function($item) {
                if (filter.$text === null) {
                    return true
                }
                if (filter.result[0] != $item.attr('value')) {
                    var text = $item.text()
                    filter.result = [$item.attr('value')]
                    filter.$main.addClass('_filled')
                    filter.$text.text(text).attr('title', text)
                    if (filters.depends[filter.label]) {
                        var depends = filters.depends[filter.label]
                        for (var index in depends) if (depends.hasOwnProperty(index)) {
                            var disable = true
                            for (var i=0; filter.result[i]; i++) {
                                if (filter.result[i] == depends[index]) {
                                    disable = false
                                    break
                                }
                            }
                            filters.list[index].disable(disable)
                        }
                    }
                    filters.send()
                }
                filter.toggle(false)
            },

            events : {
                click : function(ev) {
                    var $el = $(ev.target)
                    if ($el.is('[filter-action="expand"]')) {
                        filter.expand($el)
                        return false
                    } else if ($el.is('[filter-action="select"]')) {
                        filter.apply($el)
                        return false
                    }
                },
            },

            disable : function(disabled) {
                filter.hidden = disabled
                filter.$main.toggleClass('h', filter.hidden)
                filters.recalcColumns()
            },
        }

        filter.$main  = filters.select.render.main(filter)
        filter.$text  = filter.$main.find('[filter-elem="text"]')
        
        if (!filter.$text.length) {
            filter.$text = null
        }
        filter.$main.on(filter.events)
        return filter
    }
}
/* 
 * formItem.js
 */
var formItem = {
    del : function($main) {
        var $ff = $main.closest('[ff-elem="form"]');
        var $parent = $main.parent()
        $main.remove();
        $parent.trigger('formItemDeleted')
        if ($ff.length) {
            fillFields.check($ff.attr('ff-list_id'));
        }
    },

    add : function($main) {
        var $new = $main.clone();
        $new.find('input:not([formitem-keep]), textarea, select').each(function(i, $field) {
            $field = $($field);
            var val = ($field.attr('formitem-default')) || '';
            $field.val(val);
        });
        $new.find('[formitem-noclone]').remove();
        $new.insertAfter($main);
        $new.find('[formitem-on]').each(function(i, $field) {
            $field = $($field);
            $field[$field.attr('formitem-on')]();
        })
    },

    increment: function($main) {
        $main.find('[formitem-increment]').each(function(i, item){
            $(item).html(i+1)
        });
    },

    init : function() {
        $(window).on('click', function(ev){
            var $el = $(ev.target);
            if ($el.is('[formitem-action]')) {
                var action = $el.attr('formitem-action');
                var $parent = $el.closest('[formitem-elem="main"]').parent();
                switch (action) {
                    case 'del' :
                    case 'add' :
                        formItem[action]($el.closest('[formitem-elem="main"]'));
                        break;
                }
                formItem.increment($parent);
            }
        });
    }
}

formItem.init();

/* 
 * gallery.js
 */
var gallery = {
    list       : null,

    $main     : null,
    $photo    : false,
    $video    : false,
    $wrapper  : false,
    $stage    : false,
    $butLike  : false,
    $info     : false,
    $user     : false,
    $original : false,
    $arrow    : {
        prev : false,
        next : false
    },

    cache     : {},
    media     : {
        id      : 0,
        my_like : 0,
        prev    : 0,
        next    : 0,
    },
    lastColor : false,
    parentUrl : null,
    jsHit : {metrika: false, google: true},

    tpl : {
        main :
            '<div class="mediaGallery_content" data-my_like="{{ my_like }}">' +
                '<div class="mediaGallery_stage" gallery-elem="stage">' +
                    '<div class="mediaGallery_like" gallery-action="like"></div>' +
                    '<div class="mediaGallery_arrow-prev" gallery-action="prev"></div>' +
                    '<div class="mediaGallery_arrow-next" gallery-action="next"></div>' +
                    '<div class="mediaGallery_fullscreen" gallery-action="fullscreen"></div>' +
                    '<img class="mediaGallery_photo" src="{{ preview_url }}" gallery-elem="photo">' +
                    '<div gallery-elem="video_wrapper"></div>' +
                    '<div class="mediaGallery_bgcolors">' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#fff" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#ccc" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#999" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#666" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#333" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#191919" gallery-action="bgcolor"></div>' +
                        '<div class="mediaGallery_bgcolor" style="background-color:#000" gallery-action="bgcolor"></div>' +
                    '</div>'+
                '</div>' +
                '<div class="mediaGallery_actions">' +
                    '<button class="button-small" gallery-action="comment">' + t('Add a comment') + '</button>' +
                    '<button class="buttonLike" gallery-action="like" gallery-elem="butLike" data-my_like="{{ my_like }}">' + t('Likes') + '</button>' +
                    '<a class="mediaGallery_original" href="{{ original_url }}" target="_blank" gallery-elem="original">' + t('Original') + '</a>' +
                '</div>' +
                '<div class="mediaInfo" gallery-elem="info"></div>' +
            '</div>',
        user :
            '<div class="user">' +
                '{{ fav }}' +
                '{{ avatar }}' +
                '<div class="user_info">' +
                    '<p class="user_name"><a href="{{ profile_url }}">{{ name }}</a></p>' +
                    '<p class="user_role">{{ role.name }}, {{ city.name }}</p>' +
                    '<p class="user_contacts"><a ppcontacts-action="show" cp-contentType="user" cp-contentId="{{ id }}" controller="album" href="javascript:void(0);">' + t('Show phone and contact info') + '</a></p>' +
                '</div>' +
            '</div>',
        video : '<iframe class="mediaGallery_video" src="{{ video_link }}" gallery-elem="video" frameborder="0" allowfullscreen></iframe>',
    },

    load : function(mediaId, cacheOnly, galleryType) {
        if (!mediaId) return false;
        cacheOnly = !!cacheOnly;

        if (window.pinterest && pinterest.allow) {
            pinterest.load();
        }


        if (gallery.cache[mediaId]) {
            if (cacheOnly == false) {
                gallery.show(mediaId, galleryType, gallery.cache[mediaId]);
                return true;
            }
        }
        var data = {embed : 'user'};
        if (galleryType === undefined) { // для фотопотока
            data = {embed : 'user', preview_size:"940x700x0"};
        }
        var result = {};
        $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/media/' + mediaId + '/',
            data     : data,
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
            success  : function(json){
                result = json.media;
                result.my_like = +result.my_like;
                result.user.my_fav = +result.user.my_fav;
                result.user.my_doer = +result.user.my_doer;
                gallery.cache[mediaId] = result;
                gallery.cache[mediaId].$photo = $('<img src="' + gallery.cache[mediaId].preview_url + '">');
                if (cacheOnly == false) {
                    gallery.show(mediaId, galleryType, gallery.cache[mediaId]);
                }
            }
        });
    },

    toggleLike : function(isLike) {
        with (gallery) {
            media.my_like = isLike;
            cache[media.id].my_like = media.my_like;
            $main.attr('data-my_like', media.my_like);
            $butLike.attr('data-my_like', media.my_like);
            // TODO потом сделать выборку нормальной... Как-нибудь... Возможно, никогда :(
            var $like = $('.album_grid[data-id="' + media.id + '"]');
            $like.find('.album_grid_like_but').toggleClass('active', isLike);
            var $count = $like.find('.album_grid_like_cnt');
            var count = +$count.text();
            count += (isLike) ? 1 : (-1);
            $count.text(count);
        }
    },

    fullscreen : function() {
        with (gallery) {
            $main.toggleClass('_fullscreen');
            $('body').toggleClass('stopScrolling');
            if (!$main.is('._fullscreen')) {
                $stage.css('background-color', '');
            } else if (lastColor) {
                bgcolor(lastColor);
            }
        }
    },

    close : function() {
        $('body').removeClass('stopScrolling');
        with (gallery) {
            media.id = 0;
            $main = null;
            $video = false;
            if (list.galleryType != 'frompage') { // TODO вытащить из list'а
                history.pushState(null, null, parentUrl);
            }
        }
    },

    bgcolor : function(color) {
        with (gallery) {
            $stage.css('background-color', color);
            lastColor = color;
        }
    },

    arrows : function(index) {
        with (gallery) {
            media.prev = (index == 0) ? 0 : list.ids[index-1];
            $arrow.prev.toggleClass('h', (media.prev == 0) );
            media.next = (index == (list.ids.length-1) ) ? 0 : list.ids[index+1];
            $arrow.next.toggleClass('h', (media.next == 0) );

            for (var i=index-1; i<=index+3; i++) {
                if ( (i >= 0) && list.ids[i] ) {
                    load(list.ids[i], true);
                }
            }
        }
    },

    show : function(mediaId, galleryType, info) {
        with (gallery) {
            if (mediaId == media.id) {
                return true;
            }
            if (mediaId == 0) {
                return false;
            }

            if (!info) {
                load(mediaId, false, galleryType);
                return false;
            }
            media.id = +mediaId;
            media.my_like = info.my_like;
            media.video_link = info.video_link;

            if ($main !== null) {
                $main.attr('data-my_like', media.my_like);
                $butLike.attr('data-my_like', media.my_like);
                $photo.removeClass('h');
                $wrapper.empty().removeAttr('style');
                $photo.attr('src', info.preview_url);

                if (info.original_url) {
                    $original.attr('href', info.original_url).removeClass('h');
                } else {
                    $original.addClass('h');
                }
                $user.remove();
                if ($video !== false) {
                    $video.remove();
                    $video = false;
                }
            } else {
                if (galleryType) {
                    info.galleryType = galleryType;
                }
                init(info);
            }

            if (info.video_link) {
                videoPlayer.init(info, $wrapper);
            }
            $main.toggleClass('_video', !!info.video_link)
            $main.toggleClass('_photo', !info.video_link)

            if ( !list.galleryType || (list.galleryType != 'frompage') ) {
                var url = info.url.indexOf(origin)===0 ? info.url : info.static_url;
                ajaxHit(url, document.location.href, jsHit);
                jsHit = {metrika: true, google: true};
                history.pushState(null, null, url);
                // todo: пока это галерея только фотопотока
                viewInfo({'controller':'mediaFeed','action':'index','contentType':'user','contentId':info.user.id});
                countView(mediaId);
                if (window.pinterest) {
                    if (!pinterest.$block) {
                        pinterest.render($stage);
                    }
                    pinterest.hit(info.preview_url);
                }
            }
            list.setPreview(media.id, arrows);
            info.user.avatar = user.avatar.render(info.user, 60);
            info.user.fav = fav.render({
                type : 'user',
                id   : info.user.id,
            })
            $user = simpleTpl(tpl.user, info.user, true).appendTo($info);
            likes.init(media.id).appendTo($main);
            comments.init(media.id).appendTo($main);
            if (USER.isGuest == true) {
                $main.find('[gallery-action="like"]').remove();
            }
        }
    },

    countView : function (mediaId) {
        $.ajax({
            type     : 'POST',
            url      : API_URL + '/v2/media/' + mediaId + '/countView/',
            xhrFields: {
                withCredentials: true
            },
            success  : function() {
            }
        });
    },

    init : function(info) {
        if (window.pinterest) {
            pinterest.init();
        }

        with (gallery) {
            var isOver = gallery.$main === null
            $main = simpleTpl(tpl.main, info, true);
            lightbox.show($main, 940, {close:close}, {
                class         : 'mediaGallery',
                woCloseButton : true,
                isOver        : isOver,
            });

            $stage    = $main.find('[gallery-elem="stage"]');
            $photo    = $stage.find('[gallery-elem="photo"]');
            $wrapper  = $stage.find('[gallery-elem="video_wrapper"]');
            $info     = $main.find('[gallery-elem="info"]');
            $butLike  = $main.find('[gallery-elem="butLike"]');
            $original = $main.find('[gallery-elem="original"]');
            $arrow.prev = $main.find('[gallery-action="prev"]');
            $arrow.next = $main.find('[gallery-action="next"]');
            if (USER.isGuest) {
                $main.find('[gallery-action="comment"]').remove();
            }

            parentUrl = window.location.href;
            var listInfo = {};
            if (info.galleryType) {
                listInfo.galleryType = info.galleryType;
            }
            list.init(listInfo).appendTo($info);

            $main.on('click', function(ev){
                var $el = $(ev.target);
                if ($el.is('[gallery-action]')) {
                    var action = $el.attr('gallery-action');
                    switch (action) {
                        case 'like'       : likes.toggleLike(gallery.media.id, gallery.media.my_like, gallery.toggleLike); break;
                        case 'show'       : gallery.show($el.attr('data-id')); break;
                        case 'fullscreen' : gallery.fullscreen(); break;
                        case 'bgcolor'    : gallery.bgcolor($el.css('background-color')); break;
                        case 'comment'    : $main.find('[data-type="new"] textarea').focus(); break;
                        case 'prev'       :
                        case 'next'       :
                            gallery.show(gallery.media[action]);
                            break;
                    }
                }
            });

            $(document).off('keyup')
            $(document).on('keyup', function(ev) {
                switch (ev.keyCode) {
                    case 37 :
                    case 39 :
                        var $el = $(ev.target)
                        if ($('textarea:focus,input:focus').length) {
                            return false
                        }
                        var action = (ev.keyCode == 37) ? 'prev' : 'next'
                        gallery.show(gallery.media[action])
                        break
                }
            })

            return info;
        }
    }
}

/* 
 * gallery_list.js
 */
gallery.list = {
    $main    : false,
    $list    : false,
    $current : false,
    $page    : {
        prev : false,
        next : false
    },

    ids       : [],
    pageIndex : 0,
    perPage   : 5,
    limit     : 20,
    ready     : false,
    end       : {
        prev : false,
        next : false,
    },
    galleryType : null,
    viewportWidth : 0,

    onLoad : null,

    tpl: {
        main:
            '<div class="mediaGallery_photos">' +
                '<div class="mediaGallery_page-prev" list-action="prev"></div>' +
                '<div class="mediaGallery_list">' +
                    '<div class="mediaGallery_items" list-elem="list"></div>' +
                '</div>' +
                '<div class="mediaGallery_page-next" list-action="next"></div>' +
            '</div>',
        item  : '<img src="{{ preview_url }}" class="mediaGallery_item" gallery-action="show" data-id="{{ id }}" width="60" height="60">',
    },


    check : function () {
        with (gallery.list) {
            // 2 - за сколько страниц до границы начать подгрузку
            if ( (pageIndex < perPage*2) && !end.prev ) {
                load(-1);
            } else if ( (pageIndex > ids.length - perPage*2) && !end.next ) {
                load(1);
            } else {
                var hide = (pageIndex < 1);
                $page.prev.toggleClass('h', hide);
                hide = (pageIndex > (ids.length - perPage - 1));
                $page.next.toggleClass('h', hide);
            }
        }
    },

    changePage : function (dir) {
        with (gallery.list) {
            if (dir == 0) {
                load(0);
            } else {
                if (!ready) {
                    return false;
                }
                var getPageIndex = pageIndex + dir * perPage,
                    left = parseInt($list.css('left'));

                if ( (getPageIndex < (1-perPage)) || (getPageIndex > (ids.length-1)) ) {
                    return false;
                }
                left = left + (-1) * dir * viewportWidth;
                pageIndex = getPageIndex;
                ready = false;
                $list.css('left', left + 'px');
                setTimeout(function() {
                    gallery.list.ready = true;
                }, 320)
                check();
            }
        }
    },

    setPreview : function(mediaId, callback) {
        with (gallery.list) {
            if ($current !== false) {
                if (+$current.attr('data-id') == mediaId) return false;
                $current.removeClass('_cur');
            }

            var index = ids.indexOf(mediaId);
            if ( (index < 0) || !ready ) {
                onLoad = function() {
                    gallery.list.setPreview(mediaId, callback);
                }
                return true;
            }
            $current = $list.find('[data-id="' + mediaId + '"]').addClass('_cur');

            if ( index >= (pageIndex + perPage) ){
                changePage(1);
            } else if (index < pageIndex) {
                changePage(-1);
            }

            if (callback) {
                callback(index);
            }
        }
    },

    prepare : function(mediaId) {
        with (gallery.list) {
            var $medias = $('[media-elem="main"]'),
                result = {
                    prev    : [],
                    current : false,
                    next    : [],
                    meta    : {
                        prev_count : 0,
                        next_count : 0
                    }
                },
                block = 'prev';

            for (var i=0; $medias[i]; i++) {
                var $media = $($medias[i]),
                    mediaInfo = {
                        id          : +$media.attr('media-id'),
                        preview_url : $media.attr('src').replace('/pe/', '/p60x60x1/')
                    };
                if (mediaInfo.id == gallery.media.id) {
                    result.current = mediaInfo;
                    block = 'next';
                    continue;
                }
                result[block].push(mediaInfo);
            }
            result.meta.prev_count = result.prev.length;
            result.meta.next_count = result.next.length;

            render(result);
        }
    },

    render : function(json, skip) {
        with (gallery.list) {
            var left, itemsTpl;

            if (!ids.length && !(skip & 1)) { // 1 - скипаем блок с текущей фоткой, если надо
                ids = [json.current.id];
                pageIndex = Math.floor(perPage/2) * (-1);
                simpleTpl(tpl.item, json.current, true).appendTo($list);

                setTimeout(function() {
                    left = Math.floor(viewportWidth/2 - $list.innerWidth()/2);
                    $list.addClass('_noanimation').css('left', left + 'px');
                    setTimeout(function() {
                        gallery.list.$list.removeClass('_noanimation');
                    }, 2);
                    render(json, skip|1);
                }, 1);
                return false;
            }

            if (json.meta.prev_count && !(skip & 2)) { // 2 - скипаем блок с предыдущими фотками, если надо
                itemsTpl = '';
                for (var i=0; json.prev[i]; i++) {
                    var mediaInfo = json.prev[i];
                    ids.splice(i, 0, mediaInfo.id);
                    itemsTpl += simpleTpl(tpl.item, mediaInfo);
                }

                left = +$list.innerWidth();
                $(itemsTpl).prependTo($list);

                setTimeout(function() {
                    left = parseInt($list.css('left')) + left - $list.innerWidth();
                    $list.addClass('_noanimation').css('left', left + 'px');
                    setTimeout(function() {
                        gallery.list.$list.removeClass('_noanimation');
                    }, 2);
                    render(json, skip|2);
                }, 1);

                pageIndex += json.meta.prev_count;
                return false;

            }
            if ( (json.meta.prev_count < limit) || (galleryType == 'frompage') ) {
                end.prev = true;
            }

            if (json.meta.next_count) {
                itemsTpl = '';
                for (var i=0; json.next[i]; i++) {
                    var mediaInfo = json.next[i];
                    ids.push(mediaInfo.id);
                    itemsTpl += simpleTpl(tpl.item, mediaInfo);
                }

                $(itemsTpl).appendTo($list);

            }
            if ( (json.meta.next_count < limit) || (galleryType == 'frompage') ) {
                end.next = true;
            }

            check();
            ready = true;
            if (onLoad !== null) {
                onLoad();
                onLoad = null;
            }
        }
    },

    load : function (dir) {
        with (gallery.list) {
            // случай, когда список фоточек берём не со страницы, а грузим через АПИ
            if (galleryType != 'frompage') {
                var getMediaId = gallery.media.id,
                    getParams = {
                        type         : galleryType,
                        preview_size : '60x60x1'
                    };

                if (dir < 0) {
                    getParams.prev_limit = limit;
                    getMediaId = ids[0];
                } else if (dir > 0) {
                    getParams.next_limit = limit;
                    getMediaId = ids[ids.length-1];
                } else {
                    getParams.prev_limit = limit;
                    getParams.next_limit = limit;
                }

                $.ajax({
                    type     : 'GET',
                    url      : API_URL + '/v2/mediaFeed/' + getMediaId + '/neighbor',
                    data     : getParams,
                    xhrFields : {
                        withCredentials: true
                    },
                    dataType : 'json',
                    success  : gallery.list.render
                });

            // случай, когда берём фоточки с текущей страницы
            } else {
                prepare();
            }
        }
    },

    init: function (info) {
        with (gallery.list) {
            $main = simpleTpl(tpl.main, {}, true);
            $list = $main.find('[list-elem="list"]');
            $page.prev = $main.find('[list-action="prev"]');
            $page.next = $main.find('[list-action="next"]');
            $current = false;

            ids       = [];
            pageIndex = 0;
            ready     = false;
            end.prev  = false;
            end.next  = false;
            setTimeout(function() {
                viewportWidth = +$list.parent().innerWidth() + 1;
            },1);
            galleryType = (info && info.galleryType) ? info.galleryType : $('[data-gallery_type]').attr('data-gallery_type');

            changePage(0);

            $main.on('click', function (ev) {
                var $el = $(ev.target);
                if ($el.is('[list-action]')) {
                    var action = $el.attr('list-action');
                    switch (action) {
                        case 'prev' :
                        case 'next' :
                            var dir = (action == 'prev') ? (-1) : 1;
                            gallery.list.changePage(dir);
                            break;
                    }
                }
            });

            return $main;
        }
    }
}

/* 
 * getTpl.js
 */
var getTpl = function(url, data)
{
    var tpl = false;
    data = data || {};
    data['BITRIX_SECURITY_KEY'] = BITRIX_SECURITY_KEY;
    $.ajax({
        type     : 'POST',
        url      : url,
        data     : data,
        dataType : 'json',
        async    : false,
        success  : function(json) {
            tpl = json.tpl;
        }
    });
    return tpl;
}

/* 
 * get_num_ending.js
 */
/**
 * Функция возвращает окончание для множественного числа слова на основании числа и массива окончаний
 * @param  iNumber Integer Число на основе которого нужно сформировать окончание
 * @param  aEndings Array Массив слов или окончаний для чисел (1, 4, 5),
 *         например ['яблоко', 'яблока', 'яблок']
 * @return String
 */
function getNumEnding(iNumber, aEndings) {
    var sEnding, i;
    iNumber = iNumber % 100;
    if (iNumber >= 11 && iNumber <= 19) {
        sEnding = aEndings[2];
    }
    else {
        i = iNumber % 10;
        switch (i) {
            case (1):
                sEnding = aEndings[0];
                break;
            case (2):
            case (3):
            case (4):
                sEnding = aEndings[1];
                break;
            default:
                sEnding = aEndings[2];
        }
    }
    return sEnding;
}
/* 
 * gorkoMap.js
 */
gorkoMap = {
    edit   : null,
    yandex : null,
    google : null,
    utils  : null,

    count : 0,

    default : {
        zoom : 15,
    },

    /*
     * @points - массив точек с инфой
        coords - [float, float] формат(lat, long)
        address - string
        name - string
        opened - boolean
     * @params - параметры карты
        zoom - integer
        numeric - boolean точки с номерами на пипках
        showAllPoints - boolean отмасштабировать карту так, чтоб было видно все точки
        center - [float, float] формат(lat, long)
        editable - boolean
        $elem - {
            address - DOM поле с адресом
            city - DOM поле с названием города
            latitude - DOM поле с широтой
            longitude - DOM поле с долготой
        }
     */
    init : function($block, points, params, map) {
        if ($block !== null && (typeof $block).toLowerCase() === 'string') {
            $block = $('#' + $block)
        }

        if (!params) {
            params = {}
        }
        if (!params.zoom) {
            params.zoom = gorkoMap.default.zoom
        }
        points = gorkoMap.preparePoints(points)
        if (!params.center) {
            params.center = points.length ? points[0].coords : [null, null]
        }
        if (params.center && (!params.center[0] || !params.center[1])) {
            if (!params.cityName && params.$elem && params.$elem.city) {
                params.cityName = params.$elem.city.val()
            }
            params.center = null
        }
        if (!map) {
            map = {
                edit : null,
                id   : ++gorkoMap.count,
                $map : $block,

                engine : MAP_ENGINE,
                editable : params.editable || false,
                numeric : params.numeric || false,
                showAllPoints : params.showAllPoints || false,
                map : null,
                balloon : null,

                events : {
                    onMarker : params.onMarker || null,
                    onClick  : params.events && params.events.onClick || null,
                },
                destroy : null,
                shape : {
                    dot    : null,
                    circle : null,
                    remove : null,
                },
                openBalloon : null,
                render : {
                    map    : null,
                    points : null,
                },
                tophighlight : params.tophighlight || false,
            }
            map = gorkoMap[map.engine].create(map, params)
        }
        if (gorkoMap[map.engine].init(points, params, map)) {
            if (!params.center && params.cityName) {
                map.$map.addClass('isPreloading')
                gorkoMap[map.engine].findCenter(points, params, map)
                return false
            }
            map = gorkoMap.edit.extend(map)
            map.render.map(params)
            map.render.points(points)
            if (map.editable) {
                map.edit.init(points, params)
            }
            if (map.$map.hasClass('isPreloading')) {
                map.$map.removeClass('isPreloading')
            }
        } else {
            map.$map.addClass('isPreloading')
        }
        return map
    },

    preparePoints : function(points) {
        return points.filter(function(point) {
            if (point.coords[0] && point.coords[1] && point.coords[0] !== 'NaN' && point.coords[1] !== 'NaN') {
                return true
            } else {
                console.warn('point has no coords: ', point)
                return false
            }
        })
    },
}

$(document).ready(function() {
    imagePreload.load('/i/map_pointer.png')
    imagePreload.load('/i/map_pointer-numeric.png')
})
/* 
 * gorkoMap_edit.js
 */
gorkoMap.edit = {
    extend : function(map) {
        map.edit = {
            $address : null,
            $city    : null,
            $coords  : {
                latitude  : null,
                longitude : null,
            },

            marker : null,
            lastAddress : '',
            cityName : '',
            timer   : {
                id : 0,
                duration : 1000,
            },
            
            tpl : {
                coord : Twig.twig({data:'<input class="h" type="text" name="coord[{{ type }}]" value="{{ value }}">'}),
            },

            placeMarker : null,
            savePosition : null,
            geocode : null,

            init : function(point, params) {
                var editor = map.edit
                if (point.length) {
                    point = point[0]
                }
                var typeIndex = 0
                for (var coordType in editor.$coords) if (editor.$coords.hasOwnProperty(coordType)) {
                    if (params.$elem && params.$elem[coordType] && params.$elem[coordType].length) {
                        editor.$coords[coordType] = params.$elem[coordType]
                    } else {
                        editor.$coords[coordType] = $(editor.tpl.coord.render({
                            type  : coordType,
                            value : point && point.coords ? point.coords[typeIndex] : '',
                        })).insertAfter(map.$map)
                    }
                    typeIndex++
                }

                if (params.$elem.address && params.$elem.address.length) {
                    editor.$address = params.$elem.address
                    editor.lastAddress = editor.$address.val()
                    editor.$address.on({
                        'change keyup' : function(ev){
                            var $el = $(ev.target)
                            editor.search($el.val())
                        }
                    })
                }
                if (params.$elem.city && params.$elem.city.length) {
                    editor.$city = params.$elem.city
                    editor.$city.on({
                        'change keyup' : function(ev){
                            var $el = $(ev.target)
                            editor.cityName = $el.val()
                        }
                    })
                    if (editor.$city.val() != '') {
                        editor.cityName = editor.$city.val()
                    }
                } else if (params.cityName) {
                    editor.cityName = params.cityName
                }
            },

            search : function(address) {
                var editor = map.edit
                if (editor.lastAddress == address) {
                    return false
                }
                if (editor.timer.id) {
                    clearTimeout(editor.timer.id)
                }

                editor.lastAddress = address;
                if (editor.lastAddress == '') {
                    editor.$address.removeClass('_search')
                    return true
                }

                editor.$address.addClass('_search')
                editor.timer.id = setTimeout(function() {
                    editor.geocode()
                }, editor.timer.duration)
            }
        }
        map = gorkoMap.edit[map.engine](map)
        return map
    },

    google : function (map) {
        map.edit.geocoder = new google.maps.Geocoder()

        map.edit.placeMarker = function(coords) {
            var editor = map.edit
            if (!editor.marker) {
                map.render.points([{coords:coords}])
            } else {
                editor.marker.setPosition(new google.maps.LatLng(coords[0],coords[1]))
            }
            editor.savePosition()
        }

        map.edit.savePosition = function() {
            var editor = map.edit
            var coords = editor.marker.getPosition()
            editor.$coords.latitude.val(coords.lat)
            editor.$coords.longitude.val(coords.lng).change()
        }

        map.edit.geocode = function() {
            var editor = map.edit
            var address = [editor.cityName, editor.lastAddress].join(' ')
            editor.geocoder.geocode({
                address : address
            }, function(results, status) {
                if (status == 'OK') {
                    var coords = results[0].geometry.location
                    editor.placeMarker([coords.lat(), coords.lng()])
                    map.map.setCenter(coords)
                    map.map.setZoom(gorkoMap.default.zoom)
                }
                editor.$address.removeClass('_search')
            })
        }

        return map
    },

    yandex : function(map) {
        map.edit.placeMarker = function(coords) {
            var editor = map.edit
            if (!editor.marker) {
                map.render.points([{coords:coords}])
            } else {
                editor.marker.geometry.setCoordinates(coords)
            }
            editor.savePosition()
        }

        map.edit.savePosition = function() {
            var editor = map.edit
            var coords = editor.marker.geometry.getCoordinates()
            editor.$coords.latitude.val(coords[0])
            editor.$coords.longitude.val(coords[1]).change()
        }

        map.edit.geocode = function() {
            var editor = map.edit
            var address = [editor.cityName, editor.lastAddress].join(' ')
            ymaps.geocode(address, {results:1, kind:'house'}).then(
                function(result) {
                    if (result.metaData.geocoder.found) {
                        var coords = result.geoObjects.get(0).geometry.getCoordinates()
                        editor.placeMarker(coords)
                        map.map.setCenter(coords)
                        map.map.setZoom(gorkoMap.default.zoom)
                    }
                    editor.$address.removeClass('_search')
                }
            )
        }

        return map
    }
}
/* 
 * gorkoMap_google.js
 */
gorkoMap.google = {
    url : 'https://maps.googleapis.com/maps/api/js',
    loading : {
        status : false,
        maps   : [],
    },

    tpl : {
        balloon : Twig.twig({data:
            '{% if name %}' +
                '<p class="gorkoMap_bCaption">' +
                    '{% if url %}' +
                        '<a href="{{ url }}" target="_blank">{{ name }}</a>' +
                    '{% else %}' +
                        '{{ caption }}' +
                    '{% endif %}' +
                '</p>' +
            '{% endif %}' +
            '{% if address %}<p class="gorkoMap_bText">{{ address }}</p>{% endif %}'
        }),
    },

    create : function(map, params) {
        map.tpl = {
            balloon : params.balloon ? Twig.twig({data:params.balloon}) : gorkoMap.google.tpl.balloon,
        }

        map.destroy = function() {
            map.balloon = null
            map.map     = null
        }

        map.createBalloon = function() {
            map.balloon = new google.maps.InfoWindow({
                content : '',
                maxWidth : 350,
            })
            google.maps.event.addListener(map.balloon, 'domready', function() {
                var $balloon = $('.gm-style-iw')
                $balloon.parent().removeAttr('class')
                $balloon.attr('class', 'gorkoMap_balloon-google')
                $balloon.children('button').remove()
                $balloon.prev().remove()
                $balloon.next().remove()
            })
        }

        map.openBalloon = function(point) {
            map.balloon.open(map.map, point.marker)
            map.balloon.setContent(map.tpl.balloon.render(point))
        }

        map.closeBalloon = function() {
            if (map.balloon) {
                map.balloon.close()
            }
        }

        map.render.map = function(params) {
            if (!map.map) {
                map.map = new google.maps.Map(map.$map[0], {
                    zoom   : params.zoom,
                    center : {
                        lat : parseFloat(params.center[0]),
                        lng : parseFloat(params.center[1]),
                    },
                    styles: [
                        {
                            "featureType": "poi.business",
                            "stylers": [
                                {
                                    "visibility": "off"
                                }
                            ]
                        }
                    ]
                })
                if (map.editable) {
                    google.maps.event.addListener(map.map, 'click', function(event) {
                        map.edit.placeMarker([event.latLng.lat(), event.latLng.lng()])
                    })
                } else if (map.events.onClick) {
                    google.maps.event.addListener(map.map, 'click', function(event) {
                        map.events.onClick([event.latLng.lat(), event.latLng.lng()])
                    })
                }
            }
            if (!map.balloon) {
                map.createBalloon()
            }
        }

        map.render.points = function(points) {
            var editor = map.edit
            if (map.showAllPoints) {
                var bounds = new google.maps.LatLngBounds()
            }
            for (var i=0; points[i]; i++) {
                var position = [
                    parseFloat(points[i].coords[0]),
                    parseFloat(points[i].coords[1]),
                ]
                var markerParams = {
                    position: {
                        lat : position[0],
                        lng : position[1],
                    },
                    icon : {
                        url    : '/i/map_pointer' + (map.tophighlight && !+points[i].top ? '-netop' : '') + '.png',
                        size   : new google.maps.Size(36, 35),
                        origin : new google.maps.Point(0, 0),
                        anchor : new google.maps.Point(11, 35),
                    },
                    map : map.map,
                }
                if (map.editable) {
                    markerParams.draggable = true
                }
                if (map.numeric) {
                    markerParams.icon.url = '/i/map_pointer-numeric.png'
                    markerParams.icon.labelOrigin = new google.maps.Point(11, 11)
                    markerParams.label = {
                        color : 'white',
                        fontSize : '11px',
                        fontWeight : 'bold',
                        text : '' + parseInt(i + 1),
                    }
                }

                points[i].marker = new google.maps.Marker(markerParams)

                if (map.editable) {
                    if (!editor.marker) {
                        editor.marker = points[i].marker
                        google.maps.event.addListener(editor.marker, 'dragend', editor.savePosition)
                    }
                } else {
                    if (map.showAllPoints) {
                        bounds.extend(new google.maps.LatLng(position[0], position[1]))
                    }
                    if (points[i].opened) {
                        map.openBalloon(points[i])
                    }
                    google.maps.event.addListener(points[i].marker, 'click', (function(point) {
                        return function() {
                            map.openBalloon(point)
                            if (map.events.onMarker) {
                                map.events.onMarker(point)
                            }
                        }
                    })(points[i]))
                }
            }
            if (map.showAllPoints) {
                map.map.fitBounds(bounds)
            }
        }

        map.panTo = function(point, zoom) {
            var latLng = new google.maps.LatLng(point[0], point[1])
            map.map.panTo(latLng)
            map.map.setZoom(zoom)
        }

        map.shape.circle = function(params) {
            if (!params || !params.center) {
                return false
            }
            var border = gorkoMap.utils.border(params.border)
            var fill = gorkoMap.utils.color(params.fill)
            return new google.maps.Circle({
                map           : map.map,
                center        : new google.maps.LatLng(parseFloat(params.center[0]), parseFloat(params.center[1])),
                radius        : params.radius || 1000,
                strokeColor   : border.color,
                strokeOpacity : parseFloat(border.opacity),
                strokeWeight  : parseInt(border.width),
                fillColor     : fill.color,
                fillOpacity   : parseFloat(fill.opacity),
                clickable     : params.clickable || false,
            })
        }

        map.shape.dot = function(params) {
            if (!params || !params.center) {
                return false
            }
            var border = gorkoMap.utils.border(params.border)
            return new google.maps.Marker({
                map       : map.map,
                position  : new google.maps.LatLng(parseFloat(params.center[0]), parseFloat(params.center[1])),
                clickable : params.clickable || false,
                icon      : {
                    path          : google.maps.SymbolPath.CIRCLE,
                    strokeColor   : border.color,
                    strokeOpacity : parseFloat(border.opacity),
                    strokeWeight  : parseInt(border.width),
                    scale         : params.size || 2,
                },
            })
        }

        map.shape.remove = function(shape) {
            shape.setMap(null)
        }

        return map
    },

    loadLibrary : function() {
        gorkoMap.google.loading.status = true
        return $.ajax({
            url      : gorkoMap.google.url,
            data     : {
                key : MAP_GOOGLE_KEY,
                senson : false,
            },
            dataType : 'script',
            cache    : true,
        })
    },

    findCenter : function(points, params, map, callback) {
        new google.maps.Geocoder().geocode({
            address : params.cityName
        }, function(results, status) {
            if (status == 'OK') {
                var coords = results[0].geometry.location
                params.center = [coords.lat(), coords.lng()]
            }
            if (callback) {
                callback(params.center)
            } else {
                gorkoMap.init(null, points, params, map)
            }
        })
    },

    init : function(points, params, map) {
        var gMap = gorkoMap.google
        if (!window.google || !google.maps) {
            gMap.loading.maps.push({
                points : points,
                params : params,
                map    : map,
            })
            if (gMap.loading.status) {
                return false
            }
            gMap.loadLibrary().then(function() {
                gMap.loading.status = false
                while (gMap.loading.maps.length) {
                    var mapArgs = gMap.loading.maps.shift()
                    gorkoMap.init(null, mapArgs.points, mapArgs.params, mapArgs.map)
                }
            })
            return false
        } else {
            return true
        }
    }
}
/* 
 * gorkoMap_utils.js
 */
gorkoMap.utils = {
    border : function(border) {
        var borderInfo = []
        if (border) {
            var regExp = /(?:(\d*)px[\s]*|)(?:(#[0-9abcdef]{6})(?:\,([01](?:\.[0-9]*|))|)|)/
            var borderInfo = border.match(regExp)
        }
        return {
            width   : +borderInfo[1] || 2,
            color   : borderInfo[2] ||'#FF0000',
            opacity : borderInfo[3] || 1,
        }
    },

    color : function(color) {
        var colorInfo = []
        if (color) {
            var regExp = /(#[0-9abcdef]{6})(?:\,([01](?:\.[0-9]*|))|)/
            var colorInfo = color.match(regExp)
        }
        return {
            color   : colorInfo[1] ||'#FF0000',
            opacity : colorInfo[2] || 1,
        }
    },
}
/* 
 * gorkoMap_yandex.js
 */
gorkoMap.yandex = {
    url : 'https://api-maps.yandex.ru/2.1/',
    loading : {
        status : false,
        maps   : [],
    },

    tpl : {
        balloon : '<div class="gorkoMap_balloon-yandex" balloon-elem="main">{{ body }}</div>',
        balloonBody :
            '<p class="gorkoMap_bCaption">' +
                '{% if properties.url %}' +
                    '<a href="{{ properties.url }}" target="_blank">{{ properties.name }}</a>' +
                '{% else %}' +
                    '{{ properties.name }}' +
                '{% endif %}' +
            '</p>' +
            '<p class="gorkoMap_bText">{{ properties.address }}</p>',
        numericIcon : '<div class="gorkoMap_point-numeric">{{ number }}</div>'
    },

    create : function(map, params) {
        var balloonBody = params.balloon ? params.balloon.replace(/{{ (.*?) }}/g, '{{ properties.$1 }}') : gorkoMap.yandex.tpl.balloonBody
        map.tpl = {
            balloon : gorkoMap.yandex.tpl.balloon.replace('{{ body }}', balloonBody),
            numericIcon : gorkoMap.yandex.tpl.numericIcon,
        }

        map.destroy = function() {
            map.map = null
        }

        map.createBalloon = function() {
            map.balloon = ymaps.templateLayoutFactory.createClass(map.tpl.balloon)
        }

        map.openBalloon = function(point) {
            point.marker.balloon.open()
            map.map.panTo(point.coords)
        }

        map.closeBalloon = function() {
            if (map.map && map.map.balloon) {
                map.map.balloon.close()
            }
        }

        map.createNumericIcon = function(number) {
            return ymaps.templateLayoutFactory.createClass(map.tpl.numericIcon.replace('{{ number }}', number))
        }

        map.render.map = function(params) {
            if (!map.$map.attr('id')) {
                map.$map.attr('id', 'gorkoMap_' + map.id)
            }

            if (!map.map) {
                map.map = new ymaps.Map(map.$map.attr('id'), {
                    zoom      : params.zoom,
                    center    : params.center,
                    behaviors : ["default", "scrollZoom"],
                    controls  : ['zoomControl'],
                }, {
                    yandexMapDisablePoiInteractivity: true
                })
                if (map.editable) {
                    map.map.events.add('click', function(ev) {
                        map.edit.placeMarker(ev.get('coords'))
                    })
                } else if (map.events.onClick) {
                    map.map.events.add('click', function(ev) {
                        map.events.onClick(ev.get('coords'))
                    })
                }
            }
            if (!map.balloon) {
                map.createBalloon()
            }
        }

        map.render.points = function(points) {
            var editor = map.edit
            if (map.showAllPoints) {
                var collection = new ymaps.GeoObjectCollection()
            }
            for (var i=0; points[i]; i++) {
                var markerParams = {
                    iconLayout      : 'default#image',
                    iconImageHref   : '/i/map_pointer' + (map.tophighlight && !+points[i].top ? '-netop' : '') + '.png',
                    iconImageSize   : [36, 35],
                    iconImageOffset : [0, 0],
                    iconOffset      : [-11, -35]
                }
                if (!map.editable) {
                    markerParams.balloonLayout = map.balloon
                    markerParams.balloonShadow = false
                } else {
                    markerParams.draggable = true
                }
                if (map.numeric) {
                    markerParams.iconLayout = map.createNumericIcon(i+1)
                    markerParams.iconShape = {
                        type: 'Rectangle',
                        coordinates: [[0, 0], [21, 35]],
                    }
                }
                points[i].marker = new ymaps.GeoObject(
                    {
                        geometry : { type:"Point", coordinates:points[i].coords },
                        properties : points[i]
                    }, markerParams
                )
                if (map.events.onMarker) {
                    points[i].marker.events.add('click', (function(point) {
                        return function() {
                            map.events.onMarker(point)
                        }
                    })(points[i]))
                }
                if (map.showAllPoints) {
                    collection.add(points[i].marker);
                } else {
                    map.map.geoObjects.add(points[i].marker)
                }
                if (map.editable && !editor.marker) {
                    editor.marker = points[i].marker
                    editor.marker.events.add('dragend', editor.savePosition)
                }
                if (points[i].opened) {
                    points[i].marker.balloon.open()
                }
            }
            if (map.showAllPoints) {
                map.map.geoObjects.add(collection)
                map.map.setBounds(collection.getBounds())
            }
        }

        map.panTo = function(point, zoom) {
            map.map.setCenter(point, zoom)
        }

        map.shape.circle = function(params) {
            if (!params || !params.center) {
                return false
            }
            var border = gorkoMap.utils.border(params.border)
            var fill = gorkoMap.utils.color(params.fill)
            var circle = new ymaps.Circle(
                [params.center, params.radius || 1000],
                null,
                {
                    strokeColor   : border.color,
                    strokeOpacity : parseFloat(border.opacity),
                    strokeWeight  : parseInt(border.width),
                    fillColor     : fill.color,
                    fillOpacity   : parseFloat(fill.opacity),
                    clickable     : params.clickable || false,
                    interactivityModel : 'default#silent',
                }
            )
            map.map.geoObjects.add(circle)
            return circle
        }

        map.shape.dot = function(params) {
            if (!params || !params.center) {
                return false
            }
            var border = gorkoMap.utils.border(params.border)
            var radius = params.size + border.width
            var style = [
                'width:' + params.size + 'px',
                'height:' + params.size + 'px',
                'border:' + border.width + 'px solid ' + border.color,
                'opacity:' + border.opacity,
                'border-radius:' + radius*2 + 'px',
            ]
            var dotLayout = ymaps.templateLayoutFactory.createClass('<div style="' + style.join(';') + '"></div>')
            var dot = new ymaps.Placemark(
                params.center,
                null,
                {
                    iconLayout : dotLayout,
                    iconShape  : {
                        type : 'Circle',
                        coordinates: [0, 0],
                        radius: radius
                    },
                    iconOffset : [-radius, -radius],
                    interactivityModel : 'default#silent',
                }
            )
            map.map.geoObjects.add(dot)
            return dot
        }

        map.shape.remove = function(shape) {
            map.map.geoObjects.remove(shape)
        }

        return map
    },

    loadLibrary : function() {
        return $.ajax({
            url      : gorkoMap.yandex.url,
            data     : {
                lang : 'ru_RU',
                coordorder : 'latlong',
                apikey : '1cfa4201-4955-4428-9084-401bbc6d887c',
            },
            dataType : 'script',
            cache    : true,
        });
    },

    findCenter : function(points, params, map, callback) {
        ymaps.geocode(params.cityName, {results:1, kind:'house'}).then(
            function(result) {
                if (result.metaData.geocoder.found) {
                    params.center = result.geoObjects.get(0).geometry.getCoordinates()
                }
                if (callback) {
                    callback(params.center)
                } else {
                    gorkoMap.init(null, points, params, map)
                }
            }
        )
    },

    init : function(points, params, map) {
        var yMap = gorkoMap.yandex
        if (!window.ymaps) {
            yMap.loading.maps.push({
                points : points,
                params : params,
                map    : map,
            })
            if (yMap.loading.status) {
                return false
            }
            gorkoMap.yandex.loadLibrary().then(function() {
                ymaps.ready(function() {
                    yMap.loading.status = false
                    while (yMap.loading.maps.length) {
                        var mapArgs = yMap.loading.maps.shift()
                        gorkoMap.init(null, mapArgs.points, mapArgs.params, mapArgs.map)
                    }
                })
            })
            return false
        } else {
            return true
        }
    }
}
/* 
 * head.js
 */
var head = {
    $main : false,

    city : null,
    lang : null,

    init : function() {
        with(head) {
            $main = $('#head');
            city.init();
            lang.init();
        }
    }
}

$(document).ready(function(){
    head.init();
});

/* 
 * head_city.js
 */
head.city = {
    $main     : false,
    $search   : false,
    $cities   : false,
    $city     : false,

    tpl : {
        city     : '<a class="head_list_item" headcity-elem="city" data-id="{{ id }}" href="{{ url }}">{{ name }}{% if withRegion %}<span class="head_list_region">{{ region.name }}</span>{% endif %}</a>',
        notFound : '<p class="head_notFound">' + t('There are no cities under this name') + ' :(</p>'
    },

    inited  : false,
    toggled : false,
    found    : 0,
    selected : false,
    timerId   : 0,
    timerTime : 333,
    lastSearch : '',

    toggle : function(show) {
        with (head.city) {
            if (show !== false && show !== true) {
                show = !toggled;
            }
            toggled = show;
            $main.toggleClass('_expanded', show);
            if (toggled) {
                lastSearch = '';
                $search.val(lastSearch).focus().change();
                search('', true);
            }
        }
    },

    render : function(data) {
        with (head.city) {
            if (lastSearch !== '' || data.user_city) {
                $cities.removeAttr('data-caption');
                if (data.user_city) {
                    data.cities.unshift(data.user_city);
                }
            } else {
                $cities.attr('data-caption', t('Neighboring cities'));
            }
            found = 0;
            var unique = {};
            var withRegion = false;
            $cities.empty();
            for (var i in data.cities) if (data.cities.hasOwnProperty(i)) {
                var info = data.cities[i];
                if (unique[info.name] === undefined) {
                    unique[info.name] = 1;
                    withRegion = info.is_show_region;
                } else {
                    withRegion = true;
                }
                info.withRegion = withRegion;
                info.url = (info.url + '/').replace(/\/\/$/, '/');
                console.log(info.url);
                // регуляркой выделим жирным найденный участок вымени
                if (lastSearch !== '') {
                    var reg = new RegExp('(.*?)(' + lastSearch + ')(.*?)', 'ig');
                    info.name = info.name.replace(reg, "$1<b>$2</b>$3");
                }
                $(simpleTpl(tpl.city, info)).appendTo($cities);
                found++;
            }
            if (found == 0) {
                $cities.html(tpl.notFound);
            } else {
                $city = $cities.find('[headcity-elem="city"]');
            }
        }
    },

    search : function (searchText, forced) {
        with (head.city) {
            if ( !forced && (searchText == lastSearch) ) {
                return false;
            }
            lastSearch = searchText;

            if (timerId != 0) {
                clearTimeout(timerId);
            }

            $cities.empty();
            selected = false;
            $city = false;

            var postData = {
                name : lastSearch,
                per_page: 10,
                embed: 'region',
                fields: 'url'
            };
            if (lastSearch == '') {
                postData['region_id'] = $main.attr('data-region_id');
            }
            timerId = setTimeout(function(){
                $.ajax({
                    type : 'GET',
                    url : API_URL + '/v2/cities',
                    xhrFields: {
                        withCredentials: true
                    },
                    data : postData,
                    dataType : 'json',
                    success  : render
                });
            }, timerTime);
        }
    },

    move : function(dir) {
        with (head.city) {
            if (found == 0) return false;
            dir = +dir;
            if (selected === false) {
                selected = (dir > 0) ? 0 : (found - 1);
            } else {
                $($city[selected]).removeClass('_hover');
                selected += dir;
                if (selected < 0) {
                    selected = (found - 1);
                } else if (selected >= found) {
                    selected = 0;
                }
            }
            $($city[selected]).addClass('_hover');
        }
    },

    setCity : function($city) {
        $city = $($city);
        head.city.toggle(false);
        $.ajax({
            type     : 'POST',
            url      : '/a/geo/setCity/',
            data     : {
                cityId : $city.attr('data-id'),
                BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
            },
            dataType : 'json',
            success  : function(json) {
                document.location.href = $city.attr('href');
            }
        });
    },

    select: function() {
        with (head.city) {
            if (selected === false) return false;
            setCity($city[selected]);
        }
    },

    init : function() {
        with (head.city) {
            if (inited == true) return false;

            $main = head.$main.find('[headcity-elem="main"]');
            $search = $main.find('[headcity-elem="search"]');
            $cities = $main.find('[headcity-elem="cities"]');

            $city = $main.find('[headcity-elem="city"]');
            found = $city.length;

            // получим правильный шаблон для ссылки
            var url = document.location.href.split('/');
            if (!url[4]) {
                if (url[2] != SITE_DOMAIN) {
                    url[2] = url[2].split('.');
                    if (url[2][0] != 'www') {
                        url[2][0] = '{{ domain }}';
                    }
                    url[2] = url[2].join('.');
                }
                tpl.url = url.join('/');
            }

            $(window).on('click', function(ev){
                var $el = $(ev.target);
                if ($el.is('[head-action="city"]')) {
                    head.city.toggle();
                } else {
                    if (!$el.closest('[headcity-elem="main"]').length) {
                        head.city.toggle(false);
                    }
                }
            });

            $main.on({
                'click' : function(ev) {
                    var $el = $(ev.target);
                    if ($el.is('[headcity-elem="city"]')) {
                        head.city.setCity($el);
                        ev.preventDefault();
                    }
                },
                'change keyup' : function(ev) {
                    var $el = $(ev.target);
                    if ($el.is('[headcity-elem="search"]')) {
                        if (ev.keyCode == 38 || ev.keyCode == 40) {
                            head.city.move(ev.keyCode - 39);
                            ev.preventDefault();
                        } else if (ev.keyCode == 13) {
                            head.city.select();
                        } else {
                            head.city.search($el.val());
                        }
                    }
                },
                'mouseover' : function(ev) {
                    var $el = $(ev.target);
                    if ( $el.is('[headcity-elem="city"]') && (head.city.selected !== false) ) {
                        with (head.city) {
                            $($city[selected]).removeClass('_hover');
                            selected = false;
                        }
                    }
                }
            });
            inited = true;
        }
    }
}

/* 
 * head_lang.js
 */
head.lang = {
    $main  : null,
    $langs : null,

    tpl : {
        langs   :
            '<div class="langs">' +
                '{% if langs %}' +
                    '<div class="head_list head_result langs_list">{{ langs }}</div>' +
                '{% endif %}' +
                '<div class="langs_regions">' +
                    '<p class="langs_caption">' + t('This site in other countries and regions') +'</p>' +
                    '{{ regions }}' +
                '</div>' +
            '</div>',
        lang    : '<a class="head_list_item" href="{{ url }}">{{ language_name_original }}</a>',
        curlang : '<p class="head_list_item _cur">{{ language_name_original }}</p>',
        region  : '<p class="lang_region flag16x11" data-iso="{{ country_iso }}"><a href="{{ url }}">{{ country_name }}</a></p>',
    },

    currentDomain : 0,
    currentLang : 0,
    inited  : false,
    toggled : false,

    info : null,

    render : function() {
        var langs = head.lang
        var langs$ = ''
        var regions$ = ''
        if (langs.info.lang.length > 1) {
            for (var i = 0; langs.info.lang[i]; i++) {
                var lang = langs.info.lang[i];
                if (lang.language_alias == currentLang && lang.site_domain == currentDomain) {
                    langs$ += simpleTpl(langs.tpl.curlang, lang)
                } else {
                    langs$ += simpleTpl(langs.tpl.lang, lang)
                }
            }
        }
        for (var i=0; langs.info.region[i]; i++) {
            var region = langs.info.region[i];
            regions$ += simpleTpl(langs.tpl.region, region)
        }
        langs.$langs = simpleTpl(langs.tpl.langs, {
            langs   : langs$,
            regions : regions$,
        }, true).appendTo(langs.$main);
    },

    load : function() {
        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/sites?url=' + document.location.href,
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
            success  : function(json) {
                head.lang.info = {
                    lang : json.sites.filter(function(site) { return site.site_domain===SITE_DOMAIN }),
                    region : json.sites.filter(function(site) { return site.site_domain!==SITE_DOMAIN })
                }

            }
        });
    },

    toggle : function(show) {
        var langs = head.lang
        if (show !== true && show !== false) {
            show = !langs.toggled
        }

        if (show) {
            if (langs.$langs === null) {
                langs.load().then(langs.render)
            } else {
                langs.$langs.removeClass('h')
            }
        } else if (langs.$langs !== null) {
            langs.$langs.addClass('h')
        }
        langs.toggled = show
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[langs-action="switch"]')) {
                head.lang.toggle()
            } else if (!$el.closest('[head-elem="langs"]').length) {
                head.lang.toggle(false)
            }
        }
    },

    init : function() {
        var langs = head.lang
        if (langs.inited) return false

        langs.$main = head.$main.find('[head-elem="langs"]')
        if (!langs.$main.length) {
            langs.$main = null
            return false
        }
        currentLang = langs.$main.attr('data-lang')
        currentDomain = langs.$main.attr('data-domain')

        $(window).on(langs.events)
        langs.inited = true
    },
}

/* 
 * help.js
 */
var helpWidget = {
    $form: false,

    loading: false,
    scriptUrl: null,
    timer : 0,

    load: function (id) {
        helpWidget.loading = true
        bigpreloader.show()
        !function(e,t,n){function a(){var e=t.getElementsByTagName("script")[0],n=t.createElement("script");n.type="text/javascript",n.async=!0,n.src="https://beacon-v2.helpscout.net",e.parentNode.insertBefore(n,e)}if(e.Beacon=n=function(t,n,a){e.Beacon.readyQueue.push({method:t,options:n,data:a})},n.readyQueue=[],"complete"===t.readyState)return a();e.attachEvent?e.attachEvent("onload",a):e.addEventListener("load",a,!1)}(window,document,window.Beacon||function(){});
        window.Beacon('init', id)
        window.Beacon('on', 'open', function() {
            bigpreloader.hide()
        })

        helpWidget.loading = false
        helpWidget.open()
    },

    open: function () {
        $.ajax({
            url      : API_URL + '/v2/my',
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
        }).then(function(data) {
            const user = data.user
            window.Beacon('identify', {
                name: user.name,
                email: user.email ? user.email : '',
                _gorkoId: user.id + ':' + user.role.name + ':' + user.profile_url,
                _gorkoIds: user.extra_auth.users.map(function (u) {
                    return u.id
                }).join(', '),
                _socials: user.extra_auth.socials.join(', '),
                bill: user.bill_display + ' (free: ' + user.bill_free + ', hold:' + user.bill_hold + ')',
                city: user.city.id + ':' + user.city.name,
                'city+': user.additional_cities.map(function(city) { return city.id + ':' + city.name}).join(', '),
                join: user.join,
                last_act: user.last_act,
                pro: user.top ? 1 : 0,
            })
        }).always(function (data) {
            window.Beacon('open')
        })
    },

    set: function () {
        var widgetId = 'c75dc29e-9629-3107-e85c-4f2ef2158ea7';
        if (LANG == 'ru') {
            widgetId = 'c75dc29e-9629-3107-e85c-4f2ef2158ea7';
        }

        window.groove = window.groove || {}
        groove.widget = function () {
            groove._widgetQueue.push(Array.prototype.slice.call(arguments))
        }
        groove._widgetQueue = []
        groove.widget('setWidgetId', widgetId)

        var myCustomData = {}
        if (USER.name) {
            myCustomData['name'] = USER.name
        }
        if (USER.email) {
            myCustomData['email'] = USER.email
        }
        groove.widget('setCustomer', myCustomData)
    },

    events : {
        click : function (ev) {
            var $el = $(ev.target)
            if ($el.is('[help-action="show"]')) {
                ev.stopPropagation()
                if (helpWidget.loading) {
                    return false
                }
                if (!window.Beacon) {
                    helpWidget.load($el.attr('help-id'))
                } else {
                    helpWidget.open()
                }
                return false
            }
        }
    },

    init: function () {
        $(window).on(helpWidget.events)
    }
}

$(document).ready(helpWidget.init)

/* 
 * html5.js
 */
function supports_history_api() {
  return !!(window.history && history.pushState);
}
var popstateUrl = document.location.pathname + document.location.search;
var popstateHash = location.hash;
$(window).load(function() {
    if (!supports_history_api()) { return; }
    window.setTimeout(function() {
        window.addEventListener("popstate", function(e) {
            // Чтобы работала модная хистори на странице должен быть этот импут:
//            if(!document.id('opacity_block_id')) return;
            if (popstateUrl != document.location.pathname + document.location.search || popstateHash == document.location.hash) {
                loadAjaxContent(document.location.pathname + document.location.search, false);
            }
            popstateUrl = document.location.pathname + document.location.search;
            popstateHash = document.location.hash;
            e.preventDefault();
        }, false);
    }, 1);
});


function loadAjaxContent(url, saveHistory) {
    var historyUrl = url;
    if(url.indexOf("?")==-1) {
        url += '?';
    } else {
        url += '&';
    }
    var reffererUrl = document.location.href;
    var opacityBlock = $('#opacity_block_id').length>0 ? $( '#' + $('#opacity_block_id').val() ) : false;
    $.ajax({
        url: url,
        dataType: "json",
        success: function( data ) {
            if(saveHistory) history.pushState(null, null, historyUrl);
            document.title = data.title;
            if (data.h1) {
                $('h1').text(data.h1);
            }
            $.each(data, function(key, value) {
                var keyBlock = $('#' + key);
                if(keyBlock.length>0) {
                    keyBlock.html(value);
                }
            });
            if(data.callback) {
                callback = eval(data.callback);
            }
            ajaxHit(historyUrl, reffererUrl)
        }
    })
    .always(function() {
        if(opacityBlock.length>0) {
            opacityBlock.css('opacity', 1);
        }
    })
    .error(function() {
       window.location = historyUrl;
    });
    if(opacityBlock.length>0) opacityBlock.css('opacity', 0.7);
}

function setOpacityBlockId(id) {
    var opacityBlockId = $('#opacity_block_id');
    if(opacityBlockId.length>0) {
        opacityBlockId.val(id);
    }
}

window.globalReffererUrl = '';
function ajaxHit(historyUrl, reffererUrl, jsHit)
{
    if (typeof jsHit == 'undefined') {
        jsHit = {metrika: true, google: true};
    }
    if (!reffererUrl) {
        reffererUrl = window.globalReffererUrl;
    }

    if(typeof liveinternetHit == 'function') liveinternetHit(reffererUrl);
    if(jsHit.metrika && window.yaCounter) window.yaCounter.hit(historyUrl, {referer: reffererUrl, title: document.title});
    if(jsHit.google && window.ga) ga('send', 'pageview', {
        'page': historyUrl,
        'title': document.title
    });

    window.globalReffererUrl = historyUrl;
}
/* 
 * imagePreload.js
 */
var imagePreload = {
    list : [],

    load : function(src) {
        if (imagePreload.list.indexOf(src) >= 0) {
            return true
        }
        imagePreload.list.push(src)
        $('<img />').attr({
            'src'    : src,
            'width'  : 0,
            'height' : 0
        }).css('position', 'absolute').prependTo($('body'));
    }
}
/* 
 * lightbox.js
 */
var lightbox = {
    list : [],

    binded : false,
    create : null,

    tpl :
        '<div class="lightbox">' +
            '<div class="lightbox_area" lightbox-action="close"></div>' +
            '<div class="lightbox_content">' +
                '<div lightbox-elem="content"></div>' +
                '<div class="lightbox_close" lightbox-action="close"></div>' +
                '<div class="lightbox_arrow-prev h" lightbox-action="prev"></div>' +
                '<div class="lightbox_arrow-next h" lightbox-action="next"></div>' +
            '</div>' +
        '</div>',

    close : function() {
        var count = lightbox.list.length;
        if (!count) {
            return true;
        }
        for (var i=count-1; i>=0; i--) {
            lightbox.list[i].close();
        }
    },

    show : function($block, width, callbacks, params) {
        if (!$block) {
            return false;
        }
        if (typeof $block == 'string') {
            $block = $($block);
        }

        var needSetTop = false;
        if ( !lightbox.list.length || (params && (params.isOver === true)) ) {
            var lbItem = lightbox.init();
            needSetTop = true;
        } else {
            var lbItem = lightbox.list[lightbox.list.length - 1];
        }

        width = ( width && (width != 'auto') ) ? width + 'px' : '';
        lbItem.$content.parent().css('width', width);

        lbItem.$content.removeAttr('class');
        if (params) {
            if ( params.class && (params.class.replace(' ', '') != '') ) {
                lbItem.$content.addClass(params.class);
            }
        }

        for (var dir in lbItem.$arrow) if (lbItem.$arrow.hasOwnProperty(dir)) {
            if (callbacks && callbacks[dir]) {
                lbItem.$arrow[dir].removeClass('h');
                lbItem.callback[dir] = callbacks[dir];
            } else {
                lbItem.$arrow[dir].addClass('h');
                lbItem.callback[dir] = null;
            }
        }

        lbItem.$content.empty().append($block);
        if (needSetTop) {
            lbItem.setTop();
        } else {
            var top = parseInt(lbItem.$main.css('top'));
            if ( $(window).scrollTop() > (top + lbItem.$main.outerHeight()) ) {
                $(window).scrollTop(top - 20);
            }
        }
        lbItem.callback.close = (callbacks && callbacks.close) ? callbacks.close : null;
    },

    getLast : function() {
        var count = lightbox.list.length;
        if (!count) {
            return false;
        }
        return lightbox.list[count-1];
    },

    events : {
        click : function(ev){
            var el = $(ev.target);
            if (el.is('[lightbox-action]')) {
                var lbItem = lightbox.getLast();
                if (lbItem === false) {
                    return false;
                }
                var action = el.attr('lightbox-action');
                switch (action) {
                    case 'close' : lbItem.close(); break;
                    case 'prev'  :
                    case 'next'  :
                        if (lbItem.callback[action] !== null) {
                            lbItem.callback[action]();
                        }
                        break;
                }
            }
        },
        keyup: function (ev) {
            var lbItem = lightbox.getLast();
            if (lbItem === false) {
                return false;
            }
            switch (ev.keyCode) {
                case 27 :
                    return lbItem.close()
                    break;
                case 37 :
                case 39 :
                    var $el = $(ev.target)
                    if ($('textarea:focus,input:focus').length) {
                        return false
                    }
                    var action = (ev.keyCode == 37) ? 'prev' : 'next'
                    if (lbItem.callback[action] !== null) {
                        lbItem.callback[action]()
                    }
                    break
            }
        },
    },

    init : function() {
        var num = lightbox.list.length;
        lightbox.list[num] = lightbox.create()
        if (num == 0) {
            lightbox.list[num].$main.prependTo($('body'))
        } else {
            lightbox.list[num].$main.insertAfter(lightbox.list[num-1].$main)
        }

        if (!lightbox.binded) {
            $(window).on(lightbox.events)
            lightbox.binded = true
        }
        return lightbox.list[num]
    }
}
/* 
 * lightbox_create.js
 */
lightbox.create = function() {
    var lbItem = {
        $main    : null,
        $content : null,
        $arrow : {
            prev : null,
            next : null
        },
        callback : {
            close : null,
            prev  : null,
            next  : null
        },

        close : function() {
            if (lbItem.$main === null) {
                return true;
            }
            lbItem.$main.remove();
            if (lbItem.callback.close !== null) {
                lbItem.callback.close();
            }
            lightbox.list.pop();
        },

        setTop : function(top) {
            if (!top) {
                top = $(window).scrollTop() + 20;
                var lbHeight = lbItem.$main.outerHeight();
                var lbBottom = top + lbHeight;
                var pageHeight = $(document).outerHeight();
                if (lbBottom > pageHeight) {
                    top = pageHeight - lbHeight - 60;
                }
                if (top < 0) {
                    top = 0;
                }
            }
            lbItem.$main.css('top', top + 'px');
            $(window).scrollTop(top - 20);
        }
    };

    lbItem.$main = $(lightbox.tpl);
    lbItem.$content = lbItem.$main.find('[lightbox-elem="content"]');
    for (var dir in lbItem.$arrow) if (lbItem.$arrow.hasOwnProperty(dir)) {
        lbItem.$arrow[dir] = lbItem.$main.find('[lightbox-action="' + dir + '"]');
    }

    return lbItem;
}

/* 
 * likes.js
 */
var likes = {
    $main : false,
    $list : false,
    $page : {
        prev : false,
        next : false
    },

    id : 0,
    viewportWidth : 205,
    count : 0,
    page : 0,
    loaded : 0,
    perPage : 9,
    tpl : {
        list : 
            '<div class="likes" data-caption="' + t('Likes') + '" data-count="0" likes-elem="main">' +
                '<div class="likes_items" likes-elem="list"></div>' +
                '<div class="likes_page-prev" likes-action="prev"></div>' +
                '<div class="likes_page-next" likes-action="next"></div>' +
            '</div>',
        item : '<a class="like" href="{{ user.profile_url }}" title="{{ user.name }}" data-user_id="{{ user.id }}"><img src="{{ user.avatar_url }}" alt="{{ user.name }}" width="50" height="50"></a>'
    },

    checkPaginator : function() {
        with (likes) {
            $page.prev.removeClass('h');
            $page.next.removeClass('h');
            var pages = Math.ceil(count / perPage);
            if (page == 1) {
                $page.prev.addClass('h');
            }
            if (page == pages) {
                $page.next.addClass('h');
            }
        }
    },

    movePage : function() {
        with (likes) {
            $list.css('left', '-' + (viewportWidth*(page-1)) + 'px');
            checkPaginator();
        }
    },

    changePage : function(dir) {
        with (likes) {
            page += +dir;
            if (page > loaded) {
                load(page, movePage);
            } else {
                movePage();
            }
        }
    },

    toggleLike : function(mediaId, isLiked, callback) {
        $.ajax({
            type     : (isLiked == 1) ? 'DELETE' : 'POST',
            url      : API_URL + '/v2/media/' + mediaId + '/likes/',
            xhrFields: {
                withCredentials: true
            },
            dataType : 'json',
            success  : function(json) {
                with (likes) {
                    var vote = +!+isLiked;
                    if (vote) {
                        simpleTpl( tpl.item, {user:USER}, true ).prependTo($list);
                        count++;
                    } else {
                        $list.find('[data-user_id="' + USER.id + '"]').remove();
                        count--;
                    }
                    $main.attr('data-count', count);
                    checkPaginator();
                }
                if (callback) {
                    callback(vote);
                }
            }
        });
    },

    load : function(page, callback) {
        $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/media/' + likes.id + '/likes/',
            data     : {
                page     : page,
                per_page : likes.perPage,
            },
            xhrFields: {
                withCredentials: true
            },
            dataType : 'json',
            success  : function(json){
                with (likes) {
                    count = json.meta.total_count;
                    var likesStr = '';
                    for (var i in json.likes) if (json.likes.hasOwnProperty(i)) {
                        likesStr += simpleTpl(tpl.item, json.likes[i]);
                    }
                    $(likesStr).appendTo($list);
                    $main.attr('data-count', count);
                    loaded++;

                    if (callback) {
                        callback();
                    }
                }
            }
        });
    },

    init : function(mediaId) {
        with (likes) {
            if ($main !== false) {
                $main.remove();
            }

            loaded = 0;
            id = mediaId;
            page = 0;

            $main = simpleTpl(tpl.list, {}, true);
            $list = $main.find('[likes-elem="list"]');
            $page.prev = $main.find('[likes-action="prev"]');
            $page.next = $main.find('[likes-action="next"]');

            changePage(1);

            $main.on('click', function(ev){
                var $el = $(ev.target);
                if ($el.is('[likes-action]')) {
                    var action = $el.attr('likes-action');
                    switch (action) {
                        case 'prev' :
                        case 'next' :
                            var dir = (action == 'prev') ? (-1) : 1;
                            likes.changePage(dir);
                            break;
                    }
                }
            });

            return $main;
        }
    }
}

/* 
 * menu.js
 */
var menu = {
    $main : false,
    $user : false,

    inited : false,
    toggled : false,

    toggle : function(show) {
        with (menu) {
            if (show !== false && show !== true) {
                show = !toggled;
            }
            toggled = show;
            $user.toggleClass('_expanded', show);
        }
    },

    init : function() {
        with (menu) {
            if (inited == true) return true;

            $main = $('#menu');
            $user = $main.find('[menu-elem="user"]');
            if (!$user.length) {
                $user = false;
                return true;
            }

            $(window).on('click', function(ev){
                var $el = $(ev.target);
                if ($el.is('[menu-action="toggle"]')) {
                    menu.toggle();
                } else {
                    if (!$el.closest('[menu-elem="user"]').length) {
                        menu.toggle(false);
                    }
                }
            });
            inited = true;
        }
    }
}

$(document).ready(function(){
    menu.init();
});

/* 
 * menu_down_list.js
 */
$(document).ready(function() {
    var menu = $('#menu_with_down_list');
    if (menu) {
        menu.mouseenter(function() {
            $(this).addClass('hover');
        });
        menu.mouseleave(function() {
            $(this).removeClass('hover');
        });
    }
});
/* 
 * messages.js
 */
function expandMessages(id, user_id) {
    $.ajax({
        type : 'POST',
        url  : '/a/forum/getMessages/',
        data : 'topic_id=' + id +
            '&user_id=' + user_id +
            '&BITRIX_SECURITY_KEY=' + BITRIX_SECURITY_KEY,
        dataType : 'json',
        success  : function(data) {
            $('#content_message_expander_' + id).addClass('h');
            var html = '';
            $.each(data.messages, function(key, value) {
                html += '' +
                    '<div class="content_message">' +
                        '<div class="content_message_date">' + value.message_date + '</div>' +
                        '<div class="content_message_text">' + value.message_text + '</div>' +
                    '</div>';
            });
            $('#content_message_block_' + id).html(html);
        }
    });
}
/* 
 * moment.js
 */
//! moment.js
//! version : 2.18.1
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return sd.apply(null,arguments)}function b(a){sd=a}function c(a){return a instanceof Array||"[object Array]"===Object.prototype.toString.call(a)}function d(a){return null!=a&&"[object Object]"===Object.prototype.toString.call(a)}function e(a){var b;for(b in a)return!1;return!0}function f(a){return void 0===a}function g(a){return"number"==typeof a||"[object Number]"===Object.prototype.toString.call(a)}function h(a){return a instanceof Date||"[object Date]"===Object.prototype.toString.call(a)}function i(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function j(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function k(a,b){for(var c in b)j(b,c)&&(a[c]=b[c]);return j(b,"toString")&&(a.toString=b.toString),j(b,"valueOf")&&(a.valueOf=b.valueOf),a}function l(a,b,c,d){return sb(a,b,c,d,!0).utc()}function m(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null,rfc2822:!1,weekdayMismatch:!1}}function n(a){return null==a._pf&&(a._pf=m()),a._pf}function o(a){if(null==a._isValid){var b=n(a),c=ud.call(b.parsedDateParts,function(a){return null!=a}),d=!isNaN(a._d.getTime())&&b.overflow<0&&!b.empty&&!b.invalidMonth&&!b.invalidWeekday&&!b.nullInput&&!b.invalidFormat&&!b.userInvalidated&&(!b.meridiem||b.meridiem&&c);if(a._strict&&(d=d&&0===b.charsLeftOver&&0===b.unusedTokens.length&&void 0===b.bigHour),null!=Object.isFrozen&&Object.isFrozen(a))return d;a._isValid=d}return a._isValid}function p(a){var b=l(NaN);return null!=a?k(n(b),a):n(b).userInvalidated=!0,b}function q(a,b){var c,d,e;if(f(b._isAMomentObject)||(a._isAMomentObject=b._isAMomentObject),f(b._i)||(a._i=b._i),f(b._f)||(a._f=b._f),f(b._l)||(a._l=b._l),f(b._strict)||(a._strict=b._strict),f(b._tzm)||(a._tzm=b._tzm),f(b._isUTC)||(a._isUTC=b._isUTC),f(b._offset)||(a._offset=b._offset),f(b._pf)||(a._pf=n(b)),f(b._locale)||(a._locale=b._locale),vd.length>0)for(c=0;c<vd.length;c++)d=vd[c],e=b[d],f(e)||(a[d]=e);return a}function r(b){q(this,b),this._d=new Date(null!=b._d?b._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),wd===!1&&(wd=!0,a.updateOffset(this),wd=!1)}function s(a){return a instanceof r||null!=a&&null!=a._isAMomentObject}function t(a){return a<0?Math.ceil(a)||0:Math.floor(a)}function u(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=t(b)),c}function v(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&u(a[d])!==u(b[d]))&&g++;return g+f}function w(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function x(b,c){var d=!0;return k(function(){if(null!=a.deprecationHandler&&a.deprecationHandler(null,b),d){for(var e,f=[],g=0;g<arguments.length;g++){if(e="","object"==typeof arguments[g]){e+="\n["+g+"] ";for(var h in arguments[0])e+=h+": "+arguments[0][h]+", ";e=e.slice(0,-2)}else e=arguments[g];f.push(e)}w(b+"\nArguments: "+Array.prototype.slice.call(f).join("")+"\n"+(new Error).stack),d=!1}return c.apply(this,arguments)},c)}function y(b,c){null!=a.deprecationHandler&&a.deprecationHandler(b,c),xd[b]||(w(c),xd[b]=!0)}function z(a){return a instanceof Function||"[object Function]"===Object.prototype.toString.call(a)}function A(a){var b,c;for(c in a)b=a[c],z(b)?this[c]=b:this["_"+c]=b;this._config=a,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)}function B(a,b){var c,e=k({},a);for(c in b)j(b,c)&&(d(a[c])&&d(b[c])?(e[c]={},k(e[c],a[c]),k(e[c],b[c])):null!=b[c]?e[c]=b[c]:delete e[c]);for(c in a)j(a,c)&&!j(b,c)&&d(a[c])&&(e[c]=k({},e[c]));return e}function C(a){null!=a&&this.set(a)}function D(a,b,c){var d=this._calendar[a]||this._calendar.sameElse;return z(d)?d.call(b,c):d}function E(a){var b=this._longDateFormat[a],c=this._longDateFormat[a.toUpperCase()];return b||!c?b:(this._longDateFormat[a]=c.replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a])}function F(){return this._invalidDate}function G(a){return this._ordinal.replace("%d",a)}function H(a,b,c,d){var e=this._relativeTime[c];return z(e)?e(a,b,c,d):e.replace(/%d/i,a)}function I(a,b){var c=this._relativeTime[a>0?"future":"past"];return z(c)?c(b):c.replace(/%s/i,b)}function J(a,b){var c=a.toLowerCase();Hd[c]=Hd[c+"s"]=Hd[b]=a}function K(a){return"string"==typeof a?Hd[a]||Hd[a.toLowerCase()]:void 0}function L(a){var b,c,d={};for(c in a)j(a,c)&&(b=K(c),b&&(d[b]=a[c]));return d}function M(a,b){Id[a]=b}function N(a){var b=[];for(var c in a)b.push({unit:c,priority:Id[c]});return b.sort(function(a,b){return a.priority-b.priority}),b}function O(b,c){return function(d){return null!=d?(Q(this,b,d),a.updateOffset(this,c),this):P(this,b)}}function P(a,b){return a.isValid()?a._d["get"+(a._isUTC?"UTC":"")+b]():NaN}function Q(a,b,c){a.isValid()&&a._d["set"+(a._isUTC?"UTC":"")+b](c)}function R(a){return a=K(a),z(this[a])?this[a]():this}function S(a,b){if("object"==typeof a){a=L(a);for(var c=N(a),d=0;d<c.length;d++)this[c[d].unit](a[c[d].unit])}else if(a=K(a),z(this[a]))return this[a](b);return this}function T(a,b,c){var d=""+Math.abs(a),e=b-d.length,f=a>=0;return(f?c?"+":"":"-")+Math.pow(10,Math.max(0,e)).toString().substr(1)+d}function U(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Md[a]=e),b&&(Md[b[0]]=function(){return T(e.apply(this,arguments),b[1],b[2])}),c&&(Md[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function V(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function W(a){var b,c,d=a.match(Jd);for(b=0,c=d.length;b<c;b++)Md[d[b]]?d[b]=Md[d[b]]:d[b]=V(d[b]);return function(b){var e,f="";for(e=0;e<c;e++)f+=z(d[e])?d[e].call(b,a):d[e];return f}}function X(a,b){return a.isValid()?(b=Y(b,a.localeData()),Ld[b]=Ld[b]||W(b),Ld[b](a)):a.localeData().invalidDate()}function Y(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Kd.lastIndex=0;d>=0&&Kd.test(a);)a=a.replace(Kd,c),Kd.lastIndex=0,d-=1;return a}function Z(a,b,c){ce[a]=z(b)?b:function(a,d){return a&&c?c:b}}function $(a,b){return j(ce,a)?ce[a](b._strict,b._locale):new RegExp(_(a))}function _(a){return aa(a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}))}function aa(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function ba(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),g(b)&&(d=function(a,c){c[b]=u(a)}),c=0;c<a.length;c++)de[a[c]]=d}function ca(a,b){ba(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function da(a,b,c){null!=b&&j(de,a)&&de[a](b,c._a,c,a)}function ea(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function fa(a,b){return a?c(this._months)?this._months[a.month()]:this._months[(this._months.isFormat||oe).test(b)?"format":"standalone"][a.month()]:c(this._months)?this._months:this._months.standalone}function ga(a,b){return a?c(this._monthsShort)?this._monthsShort[a.month()]:this._monthsShort[oe.test(b)?"format":"standalone"][a.month()]:c(this._monthsShort)?this._monthsShort:this._monthsShort.standalone}function ha(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],d=0;d<12;++d)f=l([2e3,d]),this._shortMonthsParse[d]=this.monthsShort(f,"").toLocaleLowerCase(),this._longMonthsParse[d]=this.months(f,"").toLocaleLowerCase();return c?"MMM"===b?(e=ne.call(this._shortMonthsParse,g),e!==-1?e:null):(e=ne.call(this._longMonthsParse,g),e!==-1?e:null):"MMM"===b?(e=ne.call(this._shortMonthsParse,g),e!==-1?e:(e=ne.call(this._longMonthsParse,g),e!==-1?e:null)):(e=ne.call(this._longMonthsParse,g),e!==-1?e:(e=ne.call(this._shortMonthsParse,g),e!==-1?e:null))}function ia(a,b,c){var d,e,f;if(this._monthsParseExact)return ha.call(this,a,b,c);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;d<12;d++){if(e=l([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}function ja(a,b){var c;if(!a.isValid())return a;if("string"==typeof b)if(/^\d+$/.test(b))b=u(b);else if(b=a.localeData().monthsParse(b),!g(b))return a;return c=Math.min(a.date(),ea(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a}function ka(b){return null!=b?(ja(this,b),a.updateOffset(this,!0),this):P(this,"Month")}function la(){return ea(this.year(),this.month())}function ma(a){return this._monthsParseExact?(j(this,"_monthsRegex")||oa.call(this),a?this._monthsShortStrictRegex:this._monthsShortRegex):(j(this,"_monthsShortRegex")||(this._monthsShortRegex=re),this._monthsShortStrictRegex&&a?this._monthsShortStrictRegex:this._monthsShortRegex)}function na(a){return this._monthsParseExact?(j(this,"_monthsRegex")||oa.call(this),a?this._monthsStrictRegex:this._monthsRegex):(j(this,"_monthsRegex")||(this._monthsRegex=se),this._monthsStrictRegex&&a?this._monthsStrictRegex:this._monthsRegex)}function oa(){function a(a,b){return b.length-a.length}var b,c,d=[],e=[],f=[];for(b=0;b<12;b++)c=l([2e3,b]),d.push(this.monthsShort(c,"")),e.push(this.months(c,"")),f.push(this.months(c,"")),f.push(this.monthsShort(c,""));for(d.sort(a),e.sort(a),f.sort(a),b=0;b<12;b++)d[b]=aa(d[b]),e[b]=aa(e[b]);for(b=0;b<24;b++)f[b]=aa(f[b]);this._monthsRegex=new RegExp("^("+f.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+e.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+d.join("|")+")","i")}function pa(a){return qa(a)?366:365}function qa(a){return a%4===0&&a%100!==0||a%400===0}function ra(){return qa(this.year())}function sa(a,b,c,d,e,f,g){var h=new Date(a,b,c,d,e,f,g);return a<100&&a>=0&&isFinite(h.getFullYear())&&h.setFullYear(a),h}function ta(a){var b=new Date(Date.UTC.apply(null,arguments));return a<100&&a>=0&&isFinite(b.getUTCFullYear())&&b.setUTCFullYear(a),b}function ua(a,b,c){var d=7+b-c,e=(7+ta(a,0,d).getUTCDay()-b)%7;return-e+d-1}function va(a,b,c,d,e){var f,g,h=(7+c-d)%7,i=ua(a,d,e),j=1+7*(b-1)+h+i;return j<=0?(f=a-1,g=pa(f)+j):j>pa(a)?(f=a+1,g=j-pa(a)):(f=a,g=j),{year:f,dayOfYear:g}}function wa(a,b,c){var d,e,f=ua(a.year(),b,c),g=Math.floor((a.dayOfYear()-f-1)/7)+1;return g<1?(e=a.year()-1,d=g+xa(e,b,c)):g>xa(a.year(),b,c)?(d=g-xa(a.year(),b,c),e=a.year()+1):(e=a.year(),d=g),{week:d,year:e}}function xa(a,b,c){var d=ua(a,b,c),e=ua(a+1,b,c);return(pa(a)-d+e)/7}function ya(a){return wa(a,this._week.dow,this._week.doy).week}function za(){return this._week.dow}function Aa(){return this._week.doy}function Ba(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function Ca(a){var b=wa(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}function Da(a,b){return"string"!=typeof a?a:isNaN(a)?(a=b.weekdaysParse(a),"number"==typeof a?a:null):parseInt(a,10)}function Ea(a,b){return"string"==typeof a?b.weekdaysParse(a)%7||7:isNaN(a)?null:a}function Fa(a,b){return a?c(this._weekdays)?this._weekdays[a.day()]:this._weekdays[this._weekdays.isFormat.test(b)?"format":"standalone"][a.day()]:c(this._weekdays)?this._weekdays:this._weekdays.standalone}function Ga(a){return a?this._weekdaysShort[a.day()]:this._weekdaysShort}function Ha(a){return a?this._weekdaysMin[a.day()]:this._weekdaysMin}function Ia(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],d=0;d<7;++d)f=l([2e3,1]).day(d),this._minWeekdaysParse[d]=this.weekdaysMin(f,"").toLocaleLowerCase(),this._shortWeekdaysParse[d]=this.weekdaysShort(f,"").toLocaleLowerCase(),this._weekdaysParse[d]=this.weekdays(f,"").toLocaleLowerCase();return c?"dddd"===b?(e=ne.call(this._weekdaysParse,g),e!==-1?e:null):"ddd"===b?(e=ne.call(this._shortWeekdaysParse,g),e!==-1?e:null):(e=ne.call(this._minWeekdaysParse,g),e!==-1?e:null):"dddd"===b?(e=ne.call(this._weekdaysParse,g),e!==-1?e:(e=ne.call(this._shortWeekdaysParse,g),e!==-1?e:(e=ne.call(this._minWeekdaysParse,g),e!==-1?e:null))):"ddd"===b?(e=ne.call(this._shortWeekdaysParse,g),e!==-1?e:(e=ne.call(this._weekdaysParse,g),e!==-1?e:(e=ne.call(this._minWeekdaysParse,g),e!==-1?e:null))):(e=ne.call(this._minWeekdaysParse,g),e!==-1?e:(e=ne.call(this._weekdaysParse,g),e!==-1?e:(e=ne.call(this._shortWeekdaysParse,g),e!==-1?e:null)))}function Ja(a,b,c){var d,e,f;if(this._weekdaysParseExact)return Ia.call(this,a,b,c);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),d=0;d<7;d++){if(e=l([2e3,1]).day(d),c&&!this._fullWeekdaysParse[d]&&(this._fullWeekdaysParse[d]=new RegExp("^"+this.weekdays(e,"").replace(".",".?")+"$","i"),this._shortWeekdaysParse[d]=new RegExp("^"+this.weekdaysShort(e,"").replace(".",".?")+"$","i"),this._minWeekdaysParse[d]=new RegExp("^"+this.weekdaysMin(e,"").replace(".",".?")+"$","i")),this._weekdaysParse[d]||(f="^"+this.weekdays(e,"")+"|^"+this.weekdaysShort(e,"")+"|^"+this.weekdaysMin(e,""),this._weekdaysParse[d]=new RegExp(f.replace(".",""),"i")),c&&"dddd"===b&&this._fullWeekdaysParse[d].test(a))return d;if(c&&"ddd"===b&&this._shortWeekdaysParse[d].test(a))return d;if(c&&"dd"===b&&this._minWeekdaysParse[d].test(a))return d;if(!c&&this._weekdaysParse[d].test(a))return d}}function Ka(a){if(!this.isValid())return null!=a?this:NaN;var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Da(a,this.localeData()),this.add(a-b,"d")):b}function La(a){if(!this.isValid())return null!=a?this:NaN;var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Ma(a){if(!this.isValid())return null!=a?this:NaN;if(null!=a){var b=Ea(a,this.localeData());return this.day(this.day()%7?b:b-7)}return this.day()||7}function Na(a){return this._weekdaysParseExact?(j(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysStrictRegex:this._weekdaysRegex):(j(this,"_weekdaysRegex")||(this._weekdaysRegex=ye),this._weekdaysStrictRegex&&a?this._weekdaysStrictRegex:this._weekdaysRegex)}function Oa(a){return this._weekdaysParseExact?(j(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(j(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=ze),this._weekdaysShortStrictRegex&&a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function Pa(a){return this._weekdaysParseExact?(j(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(j(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=Ae),this._weekdaysMinStrictRegex&&a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function Qa(){function a(a,b){return b.length-a.length}var b,c,d,e,f,g=[],h=[],i=[],j=[];for(b=0;b<7;b++)c=l([2e3,1]).day(b),d=this.weekdaysMin(c,""),e=this.weekdaysShort(c,""),f=this.weekdays(c,""),g.push(d),h.push(e),i.push(f),j.push(d),j.push(e),j.push(f);for(g.sort(a),h.sort(a),i.sort(a),j.sort(a),b=0;b<7;b++)h[b]=aa(h[b]),i[b]=aa(i[b]),j[b]=aa(j[b]);this._weekdaysRegex=new RegExp("^("+j.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+i.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+h.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+g.join("|")+")","i")}function Ra(){return this.hours()%12||12}function Sa(){return this.hours()||24}function Ta(a,b){U(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}function Ua(a,b){return b._meridiemParse}function Va(a){return"p"===(a+"").toLowerCase().charAt(0)}function Wa(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Xa(a){return a?a.toLowerCase().replace("_","-"):a}function Ya(a){for(var b,c,d,e,f=0;f<a.length;){for(e=Xa(a[f]).split("-"),b=e.length,c=Xa(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=Za(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&v(e,c,!0)>=b-1)break;b--}f++}return null}function Za(a){var b=null;if(!Fe[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=Be._abbr,require("./locale/"+a),$a(b)}catch(a){}return Fe[a]}function $a(a,b){var c;return a&&(c=f(b)?bb(a):_a(a,b),c&&(Be=c)),Be._abbr}function _a(a,b){if(null!==b){var c=Ee;if(b.abbr=a,null!=Fe[a])y("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),c=Fe[a]._config;else if(null!=b.parentLocale){if(null==Fe[b.parentLocale])return Ge[b.parentLocale]||(Ge[b.parentLocale]=[]),Ge[b.parentLocale].push({name:a,config:b}),null;c=Fe[b.parentLocale]._config}return Fe[a]=new C(B(c,b)),Ge[a]&&Ge[a].forEach(function(a){_a(a.name,a.config)}),$a(a),Fe[a]}return delete Fe[a],null}function ab(a,b){if(null!=b){var c,d=Ee;null!=Fe[a]&&(d=Fe[a]._config),b=B(d,b),c=new C(b),c.parentLocale=Fe[a],Fe[a]=c,$a(a)}else null!=Fe[a]&&(null!=Fe[a].parentLocale?Fe[a]=Fe[a].parentLocale:null!=Fe[a]&&delete Fe[a]);return Fe[a]}function bb(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return Be;if(!c(a)){if(b=Za(a))return b;a=[a]}return Ya(a)}function cb(){return Ad(Fe)}function db(a){var b,c=a._a;return c&&n(a).overflow===-2&&(b=c[fe]<0||c[fe]>11?fe:c[ge]<1||c[ge]>ea(c[ee],c[fe])?ge:c[he]<0||c[he]>24||24===c[he]&&(0!==c[ie]||0!==c[je]||0!==c[ke])?he:c[ie]<0||c[ie]>59?ie:c[je]<0||c[je]>59?je:c[ke]<0||c[ke]>999?ke:-1,n(a)._overflowDayOfYear&&(b<ee||b>ge)&&(b=ge),n(a)._overflowWeeks&&b===-1&&(b=le),n(a)._overflowWeekday&&b===-1&&(b=me),n(a).overflow=b),a}function eb(a){var b,c,d,e,f,g,h=a._i,i=He.exec(h)||Ie.exec(h);if(i){for(n(a).iso=!0,b=0,c=Ke.length;b<c;b++)if(Ke[b][1].exec(i[1])){e=Ke[b][0],d=Ke[b][2]!==!1;break}if(null==e)return void(a._isValid=!1);if(i[3]){for(b=0,c=Le.length;b<c;b++)if(Le[b][1].exec(i[3])){f=(i[2]||" ")+Le[b][0];break}if(null==f)return void(a._isValid=!1)}if(!d&&null!=f)return void(a._isValid=!1);if(i[4]){if(!Je.exec(i[4]))return void(a._isValid=!1);g="Z"}a._f=e+(f||"")+(g||""),lb(a)}else a._isValid=!1}function fb(a){var b,c,d,e,f,g,h,i,j={" GMT":" +0000"," EDT":" -0400"," EST":" -0500"," CDT":" -0500"," CST":" -0600"," MDT":" -0600"," MST":" -0700"," PDT":" -0700"," PST":" -0800"},k="YXWVUTSRQPONZABCDEFGHIKLM";if(b=a._i.replace(/\([^\)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s|\s$/g,""),c=Ne.exec(b)){if(d=c[1]?"ddd"+(5===c[1].length?", ":" "):"",e="D MMM "+(c[2].length>10?"YYYY ":"YY "),f="HH:mm"+(c[4]?":ss":""),c[1]){var l=new Date(c[2]),m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][l.getDay()];if(c[1].substr(0,3)!==m)return n(a).weekdayMismatch=!0,void(a._isValid=!1)}switch(c[5].length){case 2:0===i?h=" +0000":(i=k.indexOf(c[5][1].toUpperCase())-12,h=(i<0?" -":" +")+(""+i).replace(/^-?/,"0").match(/..$/)[0]+"00");break;case 4:h=j[c[5]];break;default:h=j[" GMT"]}c[5]=h,a._i=c.splice(1).join(""),g=" ZZ",a._f=d+e+f+g,lb(a),n(a).rfc2822=!0}else a._isValid=!1}function gb(b){var c=Me.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(eb(b),void(b._isValid===!1&&(delete b._isValid,fb(b),b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b)))))}function hb(a,b,c){return null!=a?a:null!=b?b:c}function ib(b){var c=new Date(a.now());return b._useUTC?[c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()]:[c.getFullYear(),c.getMonth(),c.getDate()]}function jb(a){var b,c,d,e,f=[];if(!a._d){for(d=ib(a),a._w&&null==a._a[ge]&&null==a._a[fe]&&kb(a),null!=a._dayOfYear&&(e=hb(a._a[ee],d[ee]),(a._dayOfYear>pa(e)||0===a._dayOfYear)&&(n(a)._overflowDayOfYear=!0),c=ta(e,0,a._dayOfYear),a._a[fe]=c.getUTCMonth(),a._a[ge]=c.getUTCDate()),b=0;b<3&&null==a._a[b];++b)a._a[b]=f[b]=d[b];for(;b<7;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];24===a._a[he]&&0===a._a[ie]&&0===a._a[je]&&0===a._a[ke]&&(a._nextDay=!0,a._a[he]=0),a._d=(a._useUTC?ta:sa).apply(null,f),null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[he]=24)}}function kb(a){var b,c,d,e,f,g,h,i;if(b=a._w,null!=b.GG||null!=b.W||null!=b.E)f=1,g=4,c=hb(b.GG,a._a[ee],wa(tb(),1,4).year),d=hb(b.W,1),e=hb(b.E,1),(e<1||e>7)&&(i=!0);else{f=a._locale._week.dow,g=a._locale._week.doy;var j=wa(tb(),f,g);c=hb(b.gg,a._a[ee],j.year),d=hb(b.w,j.week),null!=b.d?(e=b.d,(e<0||e>6)&&(i=!0)):null!=b.e?(e=b.e+f,(b.e<0||b.e>6)&&(i=!0)):e=f}d<1||d>xa(c,f,g)?n(a)._overflowWeeks=!0:null!=i?n(a)._overflowWeekday=!0:(h=va(c,d,e,f,g),a._a[ee]=h.year,a._dayOfYear=h.dayOfYear)}function lb(b){if(b._f===a.ISO_8601)return void eb(b);if(b._f===a.RFC_2822)return void fb(b);b._a=[],n(b).empty=!0;var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=Y(b._f,b._locale).match(Jd)||[],c=0;c<e.length;c++)f=e[c],d=(h.match($(f,b))||[])[0],d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&n(b).unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),Md[f]?(d?n(b).empty=!1:n(b).unusedTokens.push(f),da(f,d,b)):b._strict&&!d&&n(b).unusedTokens.push(f);n(b).charsLeftOver=i-j,h.length>0&&n(b).unusedInput.push(h),b._a[he]<=12&&n(b).bigHour===!0&&b._a[he]>0&&(n(b).bigHour=void 0),n(b).parsedDateParts=b._a.slice(0),n(b).meridiem=b._meridiem,b._a[he]=mb(b._locale,b._a[he],b._meridiem),jb(b),db(b)}function mb(a,b,c){var d;return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&b<12&&(b+=12),d||12!==b||(b=0),b):b}function nb(a){var b,c,d,e,f;if(0===a._f.length)return n(a).invalidFormat=!0,void(a._d=new Date(NaN));for(e=0;e<a._f.length;e++)f=0,b=q({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._f=a._f[e],lb(b),o(b)&&(f+=n(b).charsLeftOver,f+=10*n(b).unusedTokens.length,n(b).score=f,(null==d||f<d)&&(d=f,c=b));k(a,c||b)}function ob(a){if(!a._d){var b=L(a._i);a._a=i([b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],function(a){return a&&parseInt(a,10)}),jb(a)}}function pb(a){var b=new r(db(qb(a)));return b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b}function qb(a){var b=a._i,d=a._f;return a._locale=a._locale||bb(a._l),null===b||void 0===d&&""===b?p({nullInput:!0}):("string"==typeof b&&(a._i=b=a._locale.preparse(b)),s(b)?new r(db(b)):(h(b)?a._d=b:c(d)?nb(a):d?lb(a):rb(a),o(a)||(a._d=null),a))}function rb(b){var e=b._i;f(e)?b._d=new Date(a.now()):h(e)?b._d=new Date(e.valueOf()):"string"==typeof e?gb(b):c(e)?(b._a=i(e.slice(0),function(a){return parseInt(a,10)}),jb(b)):d(e)?ob(b):g(e)?b._d=new Date(e):a.createFromInputFallback(b)}function sb(a,b,f,g,h){var i={};return f!==!0&&f!==!1||(g=f,f=void 0),(d(a)&&e(a)||c(a)&&0===a.length)&&(a=void 0),i._isAMomentObject=!0,i._useUTC=i._isUTC=h,i._l=f,i._i=a,i._f=b,i._strict=g,pb(i)}function tb(a,b,c,d){return sb(a,b,c,d,!1)}function ub(a,b){var d,e;if(1===b.length&&c(b[0])&&(b=b[0]),!b.length)return tb();for(d=b[0],e=1;e<b.length;++e)b[e].isValid()&&!b[e][a](d)||(d=b[e]);return d}function vb(){var a=[].slice.call(arguments,0);return ub("isBefore",a)}function wb(){var a=[].slice.call(arguments,0);return ub("isAfter",a)}function xb(a){for(var b in a)if(Re.indexOf(b)===-1||null!=a[b]&&isNaN(a[b]))return!1;for(var c=!1,d=0;d<Re.length;++d)if(a[Re[d]]){if(c)return!1;parseFloat(a[Re[d]])!==u(a[Re[d]])&&(c=!0)}return!0}function yb(){return this._isValid}function zb(){return Sb(NaN)}function Ab(a){var b=L(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;this._isValid=xb(b),this._milliseconds=+k+1e3*j+6e4*i+1e3*h*60*60,this._days=+g+7*f,this._months=+e+3*d+12*c,this._data={},this._locale=bb(),this._bubble()}function Bb(a){return a instanceof Ab}function Cb(a){return a<0?Math.round(-1*a)*-1:Math.round(a)}function Db(a,b){U(a,0,0,function(){var a=this.utcOffset(),c="+";return a<0&&(a=-a,c="-"),c+T(~~(a/60),2)+b+T(~~a%60,2)})}function Eb(a,b){var c=(b||"").match(a);if(null===c)return null;var d=c[c.length-1]||[],e=(d+"").match(Se)||["-",0,0],f=+(60*e[1])+u(e[2]);return 0===f?0:"+"===e[0]?f:-f}function Fb(b,c){var d,e;return c._isUTC?(d=c.clone(),e=(s(b)||h(b)?b.valueOf():tb(b).valueOf())-d.valueOf(),d._d.setTime(d._d.valueOf()+e),a.updateOffset(d,!1),d):tb(b).local()}function Gb(a){return 15*-Math.round(a._d.getTimezoneOffset()/15)}function Hb(b,c,d){var e,f=this._offset||0;if(!this.isValid())return null!=b?this:NaN;if(null!=b){if("string"==typeof b){if(b=Eb(_d,b),null===b)return this}else Math.abs(b)<16&&!d&&(b=60*b);return!this._isUTC&&c&&(e=Gb(this)),this._offset=b,this._isUTC=!0,null!=e&&this.add(e,"m"),f!==b&&(!c||this._changeInProgress?Xb(this,Sb(b-f,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?f:Gb(this)}function Ib(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function Jb(a){return this.utcOffset(0,a)}function Kb(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Gb(this),"m")),this}function Lb(){if(null!=this._tzm)this.utcOffset(this._tzm,!1,!0);else if("string"==typeof this._i){var a=Eb($d,this._i);null!=a?this.utcOffset(a):this.utcOffset(0,!0)}return this}function Mb(a){return!!this.isValid()&&(a=a?tb(a).utcOffset():0,(this.utcOffset()-a)%60===0)}function Nb(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Ob(){if(!f(this._isDSTShifted))return this._isDSTShifted;var a={};if(q(a,this),a=qb(a),a._a){var b=a._isUTC?l(a._a):tb(a._a);this._isDSTShifted=this.isValid()&&v(a._a,b.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function Pb(){return!!this.isValid()&&!this._isUTC}function Qb(){return!!this.isValid()&&this._isUTC}function Rb(){return!!this.isValid()&&(this._isUTC&&0===this._offset)}function Sb(a,b){var c,d,e,f=a,h=null;return Bb(a)?f={ms:a._milliseconds,d:a._days,M:a._months}:g(a)?(f={},b?f[b]=a:f.milliseconds=a):(h=Te.exec(a))?(c="-"===h[1]?-1:1,f={y:0,d:u(h[ge])*c,h:u(h[he])*c,m:u(h[ie])*c,s:u(h[je])*c,ms:u(Cb(1e3*h[ke]))*c}):(h=Ue.exec(a))?(c="-"===h[1]?-1:1,f={y:Tb(h[2],c),M:Tb(h[3],c),w:Tb(h[4],c),d:Tb(h[5],c),h:Tb(h[6],c),m:Tb(h[7],c),s:Tb(h[8],c)}):null==f?f={}:"object"==typeof f&&("from"in f||"to"in f)&&(e=Vb(tb(f.from),tb(f.to)),f={},f.ms=e.milliseconds,f.M=e.months),d=new Ab(f),Bb(a)&&j(a,"_locale")&&(d._locale=a._locale),d}function Tb(a,b){var c=a&&parseFloat(a.replace(",","."));return(isNaN(c)?0:c)*b}function Ub(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Vb(a,b){var c;return a.isValid()&&b.isValid()?(b=Fb(b,a),a.isBefore(b)?c=Ub(a,b):(c=Ub(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c):{milliseconds:0,months:0}}function Wb(a,b){return function(c,d){var e,f;return null===d||isNaN(+d)||(y(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Sb(c,d),Xb(this,e,a),this}}function Xb(b,c,d,e){var f=c._milliseconds,g=Cb(c._days),h=Cb(c._months);b.isValid()&&(e=null==e||e,f&&b._d.setTime(b._d.valueOf()+f*d),g&&Q(b,"Date",P(b,"Date")+g*d),h&&ja(b,P(b,"Month")+h*d),e&&a.updateOffset(b,g||h))}function Yb(a,b){var c=a.diff(b,"days",!0);return c<-6?"sameElse":c<-1?"lastWeek":c<0?"lastDay":c<1?"sameDay":c<2?"nextDay":c<7?"nextWeek":"sameElse"}function Zb(b,c){var d=b||tb(),e=Fb(d,this).startOf("day"),f=a.calendarFormat(this,e)||"sameElse",g=c&&(z(c[f])?c[f].call(this,d):c[f]);return this.format(g||this.localeData().calendar(f,this,tb(d)))}function $b(){return new r(this)}function _b(a,b){var c=s(a)?a:tb(a);return!(!this.isValid()||!c.isValid())&&(b=K(f(b)?"millisecond":b),"millisecond"===b?this.valueOf()>c.valueOf():c.valueOf()<this.clone().startOf(b).valueOf())}function ac(a,b){var c=s(a)?a:tb(a);return!(!this.isValid()||!c.isValid())&&(b=K(f(b)?"millisecond":b),"millisecond"===b?this.valueOf()<c.valueOf():this.clone().endOf(b).valueOf()<c.valueOf())}function bc(a,b,c,d){return d=d||"()",("("===d[0]?this.isAfter(a,c):!this.isBefore(a,c))&&(")"===d[1]?this.isBefore(b,c):!this.isAfter(b,c))}function cc(a,b){var c,d=s(a)?a:tb(a);return!(!this.isValid()||!d.isValid())&&(b=K(b||"millisecond"),"millisecond"===b?this.valueOf()===d.valueOf():(c=d.valueOf(),this.clone().startOf(b).valueOf()<=c&&c<=this.clone().endOf(b).valueOf()))}function dc(a,b){return this.isSame(a,b)||this.isAfter(a,b)}function ec(a,b){return this.isSame(a,b)||this.isBefore(a,b)}function fc(a,b,c){var d,e,f,g;return this.isValid()?(d=Fb(a,this),d.isValid()?(e=6e4*(d.utcOffset()-this.utcOffset()),b=K(b),"year"===b||"month"===b||"quarter"===b?(g=gc(this,d),"quarter"===b?g/=3:"year"===b&&(g/=12)):(f=this-d,g="second"===b?f/1e3:"minute"===b?f/6e4:"hour"===b?f/36e5:"day"===b?(f-e)/864e5:"week"===b?(f-e)/6048e5:f),c?g:t(g)):NaN):NaN}function gc(a,b){var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),f=a.clone().add(e,"months");return b-f<0?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)||0}function hc(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ic(){if(!this.isValid())return null;var a=this.clone().utc();return a.year()<0||a.year()>9999?X(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):z(Date.prototype.toISOString)?this.toDate().toISOString():X(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}function jc(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var a="moment",b="";this.isLocal()||(a=0===this.utcOffset()?"moment.utc":"moment.parseZone",b="Z");var c="["+a+'("]',d=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",e="-MM-DD[T]HH:mm:ss.SSS",f=b+'[")]';return this.format(c+d+e+f)}function kc(b){b||(b=this.isUtc()?a.defaultFormatUtc:a.defaultFormat);var c=X(this,b);return this.localeData().postformat(c)}function lc(a,b){return this.isValid()&&(s(a)&&a.isValid()||tb(a).isValid())?Sb({to:this,from:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function mc(a){return this.from(tb(),a)}function nc(a,b){return this.isValid()&&(s(a)&&a.isValid()||tb(a).isValid())?Sb({from:this,to:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function oc(a){return this.to(tb(),a)}function pc(a){var b;return void 0===a?this._locale._abbr:(b=bb(a),null!=b&&(this._locale=b),this)}function qc(){return this._locale}function rc(a){switch(a=K(a)){case"year":this.month(0);case"quarter":case"month":this.date(1);case"week":case"isoWeek":case"day":case"date":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function sc(a){return a=K(a),void 0===a||"millisecond"===a?this:("date"===a&&(a="day"),this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms"))}function tc(){return this._d.valueOf()-6e4*(this._offset||0)}function uc(){return Math.floor(this.valueOf()/1e3)}function vc(){return new Date(this.valueOf())}function wc(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function xc(){var a=this;return{years:a.year(),months:a.month(),date:a.date(),hours:a.hours(),minutes:a.minutes(),seconds:a.seconds(),milliseconds:a.milliseconds()}}function yc(){return this.isValid()?this.toISOString():null}function zc(){return o(this)}function Ac(){
return k({},n(this))}function Bc(){return n(this).overflow}function Cc(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}function Dc(a,b){U(0,[a,a.length],0,b)}function Ec(a){return Ic.call(this,a,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)}function Fc(a){return Ic.call(this,a,this.isoWeek(),this.isoWeekday(),1,4)}function Gc(){return xa(this.year(),1,4)}function Hc(){var a=this.localeData()._week;return xa(this.year(),a.dow,a.doy)}function Ic(a,b,c,d,e){var f;return null==a?wa(this,d,e).year:(f=xa(a,d,e),b>f&&(b=f),Jc.call(this,a,b,c,d,e))}function Jc(a,b,c,d,e){var f=va(a,b,c,d,e),g=ta(f.year,0,f.dayOfYear);return this.year(g.getUTCFullYear()),this.month(g.getUTCMonth()),this.date(g.getUTCDate()),this}function Kc(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}function Lc(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function Mc(a,b){b[ke]=u(1e3*("0."+a))}function Nc(){return this._isUTC?"UTC":""}function Oc(){return this._isUTC?"Coordinated Universal Time":""}function Pc(a){return tb(1e3*a)}function Qc(){return tb.apply(null,arguments).parseZone()}function Rc(a){return a}function Sc(a,b,c,d){var e=bb(),f=l().set(d,b);return e[c](f,a)}function Tc(a,b,c){if(g(a)&&(b=a,a=void 0),a=a||"",null!=b)return Sc(a,b,c,"month");var d,e=[];for(d=0;d<12;d++)e[d]=Sc(a,d,c,"month");return e}function Uc(a,b,c,d){"boolean"==typeof a?(g(b)&&(c=b,b=void 0),b=b||""):(b=a,c=b,a=!1,g(b)&&(c=b,b=void 0),b=b||"");var e=bb(),f=a?e._week.dow:0;if(null!=c)return Sc(b,(c+f)%7,d,"day");var h,i=[];for(h=0;h<7;h++)i[h]=Sc(b,(h+f)%7,d,"day");return i}function Vc(a,b){return Tc(a,b,"months")}function Wc(a,b){return Tc(a,b,"monthsShort")}function Xc(a,b,c){return Uc(a,b,c,"weekdays")}function Yc(a,b,c){return Uc(a,b,c,"weekdaysShort")}function Zc(a,b,c){return Uc(a,b,c,"weekdaysMin")}function $c(){var a=this._data;return this._milliseconds=df(this._milliseconds),this._days=df(this._days),this._months=df(this._months),a.milliseconds=df(a.milliseconds),a.seconds=df(a.seconds),a.minutes=df(a.minutes),a.hours=df(a.hours),a.months=df(a.months),a.years=df(a.years),this}function _c(a,b,c,d){var e=Sb(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}function ad(a,b){return _c(this,a,b,1)}function bd(a,b){return _c(this,a,b,-1)}function cd(a){return a<0?Math.floor(a):Math.ceil(a)}function dd(){var a,b,c,d,e,f=this._milliseconds,g=this._days,h=this._months,i=this._data;return f>=0&&g>=0&&h>=0||f<=0&&g<=0&&h<=0||(f+=864e5*cd(fd(h)+g),g=0,h=0),i.milliseconds=f%1e3,a=t(f/1e3),i.seconds=a%60,b=t(a/60),i.minutes=b%60,c=t(b/60),i.hours=c%24,g+=t(c/24),e=t(ed(g)),h+=e,g-=cd(fd(e)),d=t(h/12),h%=12,i.days=g,i.months=h,i.years=d,this}function ed(a){return 4800*a/146097}function fd(a){return 146097*a/4800}function gd(a){if(!this.isValid())return NaN;var b,c,d=this._milliseconds;if(a=K(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+ed(b),"month"===a?c:c/12;switch(b=this._days+Math.round(fd(this._months)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 1440*b+d/6e4;case"second":return 86400*b+d/1e3;case"millisecond":return Math.floor(864e5*b)+d;default:throw new Error("Unknown unit "+a)}}function hd(){return this.isValid()?this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*u(this._months/12):NaN}function id(a){return function(){return this.as(a)}}function jd(a){return a=K(a),this.isValid()?this[a+"s"]():NaN}function kd(a){return function(){return this.isValid()?this._data[a]:NaN}}function ld(){return t(this.days()/7)}function md(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function nd(a,b,c){var d=Sb(a).abs(),e=uf(d.as("s")),f=uf(d.as("m")),g=uf(d.as("h")),h=uf(d.as("d")),i=uf(d.as("M")),j=uf(d.as("y")),k=e<=vf.ss&&["s",e]||e<vf.s&&["ss",e]||f<=1&&["m"]||f<vf.m&&["mm",f]||g<=1&&["h"]||g<vf.h&&["hh",g]||h<=1&&["d"]||h<vf.d&&["dd",h]||i<=1&&["M"]||i<vf.M&&["MM",i]||j<=1&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,md.apply(null,k)}function od(a){return void 0===a?uf:"function"==typeof a&&(uf=a,!0)}function pd(a,b){return void 0!==vf[a]&&(void 0===b?vf[a]:(vf[a]=b,"s"===a&&(vf.ss=b-1),!0))}function qd(a){if(!this.isValid())return this.localeData().invalidDate();var b=this.localeData(),c=nd(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function rd(){if(!this.isValid())return this.localeData().invalidDate();var a,b,c,d=wf(this._milliseconds)/1e3,e=wf(this._days),f=wf(this._months);a=t(d/60),b=t(a/60),d%=60,a%=60,c=t(f/12),f%=12;var g=c,h=f,i=e,j=b,k=a,l=d,m=this.asSeconds();return m?(m<0?"-":"")+"P"+(g?g+"Y":"")+(h?h+"M":"")+(i?i+"D":"")+(j||k||l?"T":"")+(j?j+"H":"")+(k?k+"M":"")+(l?l+"S":""):"P0D"}var sd,td;td=Array.prototype.some?Array.prototype.some:function(a){for(var b=Object(this),c=b.length>>>0,d=0;d<c;d++)if(d in b&&a.call(this,b[d],d,b))return!0;return!1};var ud=td,vd=a.momentProperties=[],wd=!1,xd={};a.suppressDeprecationWarnings=!1,a.deprecationHandler=null;var yd;yd=Object.keys?Object.keys:function(a){var b,c=[];for(b in a)j(a,b)&&c.push(b);return c};var zd,Ad=yd,Bd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},Cd={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},Dd="Invalid date",Ed="%d",Fd=/\d{1,2}/,Gd={future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Hd={},Id={},Jd=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,Kd=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Ld={},Md={},Nd=/\d/,Od=/\d\d/,Pd=/\d{3}/,Qd=/\d{4}/,Rd=/[+-]?\d{6}/,Sd=/\d\d?/,Td=/\d\d\d\d?/,Ud=/\d\d\d\d\d\d?/,Vd=/\d{1,3}/,Wd=/\d{1,4}/,Xd=/[+-]?\d{1,6}/,Yd=/\d+/,Zd=/[+-]?\d+/,$d=/Z|[+-]\d\d:?\d\d/gi,_d=/Z|[+-]\d\d(?::?\d\d)?/gi,ae=/[+-]?\d+(\.\d{1,3})?/,be=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,ce={},de={},ee=0,fe=1,ge=2,he=3,ie=4,je=5,ke=6,le=7,me=8;zd=Array.prototype.indexOf?Array.prototype.indexOf:function(a){var b;for(b=0;b<this.length;++b)if(this[b]===a)return b;return-1};var ne=zd;U("M",["MM",2],"Mo",function(){return this.month()+1}),U("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),U("MMMM",0,0,function(a){return this.localeData().months(this,a)}),J("month","M"),M("month",8),Z("M",Sd),Z("MM",Sd,Od),Z("MMM",function(a,b){return b.monthsShortRegex(a)}),Z("MMMM",function(a,b){return b.monthsRegex(a)}),ba(["M","MM"],function(a,b){b[fe]=u(a)-1}),ba(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);null!=e?b[fe]=e:n(c).invalidMonth=a});var oe=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,pe="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),qe="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),re=be,se=be;U("Y",0,0,function(){var a=this.year();return a<=9999?""+a:"+"+a}),U(0,["YY",2],0,function(){return this.year()%100}),U(0,["YYYY",4],0,"year"),U(0,["YYYYY",5],0,"year"),U(0,["YYYYYY",6,!0],0,"year"),J("year","y"),M("year",1),Z("Y",Zd),Z("YY",Sd,Od),Z("YYYY",Wd,Qd),Z("YYYYY",Xd,Rd),Z("YYYYYY",Xd,Rd),ba(["YYYYY","YYYYYY"],ee),ba("YYYY",function(b,c){c[ee]=2===b.length?a.parseTwoDigitYear(b):u(b)}),ba("YY",function(b,c){c[ee]=a.parseTwoDigitYear(b)}),ba("Y",function(a,b){b[ee]=parseInt(a,10)}),a.parseTwoDigitYear=function(a){return u(a)+(u(a)>68?1900:2e3)};var te=O("FullYear",!0);U("w",["ww",2],"wo","week"),U("W",["WW",2],"Wo","isoWeek"),J("week","w"),J("isoWeek","W"),M("week",5),M("isoWeek",5),Z("w",Sd),Z("ww",Sd,Od),Z("W",Sd),Z("WW",Sd,Od),ca(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=u(a)});var ue={dow:0,doy:6};U("d",0,"do","day"),U("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),U("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),U("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),U("e",0,0,"weekday"),U("E",0,0,"isoWeekday"),J("day","d"),J("weekday","e"),J("isoWeekday","E"),M("day",11),M("weekday",11),M("isoWeekday",11),Z("d",Sd),Z("e",Sd),Z("E",Sd),Z("dd",function(a,b){return b.weekdaysMinRegex(a)}),Z("ddd",function(a,b){return b.weekdaysShortRegex(a)}),Z("dddd",function(a,b){return b.weekdaysRegex(a)}),ca(["dd","ddd","dddd"],function(a,b,c,d){var e=c._locale.weekdaysParse(a,d,c._strict);null!=e?b.d=e:n(c).invalidWeekday=a}),ca(["d","e","E"],function(a,b,c,d){b[d]=u(a)});var ve="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),we="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),xe="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),ye=be,ze=be,Ae=be;U("H",["HH",2],0,"hour"),U("h",["hh",2],0,Ra),U("k",["kk",2],0,Sa),U("hmm",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)}),U("hmmss",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)+T(this.seconds(),2)}),U("Hmm",0,0,function(){return""+this.hours()+T(this.minutes(),2)}),U("Hmmss",0,0,function(){return""+this.hours()+T(this.minutes(),2)+T(this.seconds(),2)}),Ta("a",!0),Ta("A",!1),J("hour","h"),M("hour",13),Z("a",Ua),Z("A",Ua),Z("H",Sd),Z("h",Sd),Z("k",Sd),Z("HH",Sd,Od),Z("hh",Sd,Od),Z("kk",Sd,Od),Z("hmm",Td),Z("hmmss",Ud),Z("Hmm",Td),Z("Hmmss",Ud),ba(["H","HH"],he),ba(["k","kk"],function(a,b,c){var d=u(a);b[he]=24===d?0:d}),ba(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),ba(["h","hh"],function(a,b,c){b[he]=u(a),n(c).bigHour=!0}),ba("hmm",function(a,b,c){var d=a.length-2;b[he]=u(a.substr(0,d)),b[ie]=u(a.substr(d)),n(c).bigHour=!0}),ba("hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[he]=u(a.substr(0,d)),b[ie]=u(a.substr(d,2)),b[je]=u(a.substr(e)),n(c).bigHour=!0}),ba("Hmm",function(a,b,c){var d=a.length-2;b[he]=u(a.substr(0,d)),b[ie]=u(a.substr(d))}),ba("Hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[he]=u(a.substr(0,d)),b[ie]=u(a.substr(d,2)),b[je]=u(a.substr(e))});var Be,Ce=/[ap]\.?m?\.?/i,De=O("Hours",!0),Ee={calendar:Bd,longDateFormat:Cd,invalidDate:Dd,ordinal:Ed,dayOfMonthOrdinalParse:Fd,relativeTime:Gd,months:pe,monthsShort:qe,week:ue,weekdays:ve,weekdaysMin:xe,weekdaysShort:we,meridiemParse:Ce},Fe={},Ge={},He=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Ie=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Je=/Z|[+-]\d\d(?::?\d\d)?/,Ke=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],Le=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Me=/^\/?Date\((\-?\d+)/i,Ne=/^((?:Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d?\d\s(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(?:\d\d)?\d\d\s)(\d\d:\d\d)(\:\d\d)?(\s(?:UT|GMT|[ECMP][SD]T|[A-IK-Za-ik-z]|[+-]\d{4}))$/;a.createFromInputFallback=x("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),a.ISO_8601=function(){},a.RFC_2822=function(){};var Oe=x("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=tb.apply(null,arguments);return this.isValid()&&a.isValid()?a<this?this:a:p()}),Pe=x("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=tb.apply(null,arguments);return this.isValid()&&a.isValid()?a>this?this:a:p()}),Qe=function(){return Date.now?Date.now():+new Date},Re=["year","quarter","month","week","day","hour","minute","second","millisecond"];Db("Z",":"),Db("ZZ",""),Z("Z",_d),Z("ZZ",_d),ba(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Eb(_d,a)});var Se=/([\+\-]|\d\d)/gi;a.updateOffset=function(){};var Te=/^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Ue=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/;Sb.fn=Ab.prototype,Sb.invalid=zb;var Ve=Wb(1,"add"),We=Wb(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",a.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var Xe=x("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});U(0,["gg",2],0,function(){return this.weekYear()%100}),U(0,["GG",2],0,function(){return this.isoWeekYear()%100}),Dc("gggg","weekYear"),Dc("ggggg","weekYear"),Dc("GGGG","isoWeekYear"),Dc("GGGGG","isoWeekYear"),J("weekYear","gg"),J("isoWeekYear","GG"),M("weekYear",1),M("isoWeekYear",1),Z("G",Zd),Z("g",Zd),Z("GG",Sd,Od),Z("gg",Sd,Od),Z("GGGG",Wd,Qd),Z("gggg",Wd,Qd),Z("GGGGG",Xd,Rd),Z("ggggg",Xd,Rd),ca(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=u(a)}),ca(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),U("Q",0,"Qo","quarter"),J("quarter","Q"),M("quarter",7),Z("Q",Nd),ba("Q",function(a,b){b[fe]=3*(u(a)-1)}),U("D",["DD",2],"Do","date"),J("date","D"),M("date",9),Z("D",Sd),Z("DD",Sd,Od),Z("Do",function(a,b){return a?b._dayOfMonthOrdinalParse||b._ordinalParse:b._dayOfMonthOrdinalParseLenient}),ba(["D","DD"],ge),ba("Do",function(a,b){b[ge]=u(a.match(Sd)[0],10)});var Ye=O("Date",!0);U("DDD",["DDDD",3],"DDDo","dayOfYear"),J("dayOfYear","DDD"),M("dayOfYear",4),Z("DDD",Vd),Z("DDDD",Pd),ba(["DDD","DDDD"],function(a,b,c){c._dayOfYear=u(a)}),U("m",["mm",2],0,"minute"),J("minute","m"),M("minute",14),Z("m",Sd),Z("mm",Sd,Od),ba(["m","mm"],ie);var Ze=O("Minutes",!1);U("s",["ss",2],0,"second"),J("second","s"),M("second",15),Z("s",Sd),Z("ss",Sd,Od),ba(["s","ss"],je);var $e=O("Seconds",!1);U("S",0,0,function(){return~~(this.millisecond()/100)}),U(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),U(0,["SSS",3],0,"millisecond"),U(0,["SSSS",4],0,function(){return 10*this.millisecond()}),U(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),U(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),U(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),U(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),U(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),J("millisecond","ms"),M("millisecond",16),Z("S",Vd,Nd),Z("SS",Vd,Od),Z("SSS",Vd,Pd);var _e;for(_e="SSSS";_e.length<=9;_e+="S")Z(_e,Yd);for(_e="S";_e.length<=9;_e+="S")ba(_e,Mc);var af=O("Milliseconds",!1);U("z",0,0,"zoneAbbr"),U("zz",0,0,"zoneName");var bf=r.prototype;bf.add=Ve,bf.calendar=Zb,bf.clone=$b,bf.diff=fc,bf.endOf=sc,bf.format=kc,bf.from=lc,bf.fromNow=mc,bf.to=nc,bf.toNow=oc,bf.get=R,bf.invalidAt=Bc,bf.isAfter=_b,bf.isBefore=ac,bf.isBetween=bc,bf.isSame=cc,bf.isSameOrAfter=dc,bf.isSameOrBefore=ec,bf.isValid=zc,bf.lang=Xe,bf.locale=pc,bf.localeData=qc,bf.max=Pe,bf.min=Oe,bf.parsingFlags=Ac,bf.set=S,bf.startOf=rc,bf.subtract=We,bf.toArray=wc,bf.toObject=xc,bf.toDate=vc,bf.toISOString=ic,bf.inspect=jc,bf.toJSON=yc,bf.toString=hc,bf.unix=uc,bf.valueOf=tc,bf.creationData=Cc,bf.year=te,bf.isLeapYear=ra,bf.weekYear=Ec,bf.isoWeekYear=Fc,bf.quarter=bf.quarters=Kc,bf.month=ka,bf.daysInMonth=la,bf.week=bf.weeks=Ba,bf.isoWeek=bf.isoWeeks=Ca,bf.weeksInYear=Hc,bf.isoWeeksInYear=Gc,bf.date=Ye,bf.day=bf.days=Ka,bf.weekday=La,bf.isoWeekday=Ma,bf.dayOfYear=Lc,bf.hour=bf.hours=De,bf.minute=bf.minutes=Ze,bf.second=bf.seconds=$e,bf.millisecond=bf.milliseconds=af,bf.utcOffset=Hb,bf.utc=Jb,bf.local=Kb,bf.parseZone=Lb,bf.hasAlignedHourOffset=Mb,bf.isDST=Nb,bf.isLocal=Pb,bf.isUtcOffset=Qb,bf.isUtc=Rb,bf.isUTC=Rb,bf.zoneAbbr=Nc,bf.zoneName=Oc,bf.dates=x("dates accessor is deprecated. Use date instead.",Ye),bf.months=x("months accessor is deprecated. Use month instead",ka),bf.years=x("years accessor is deprecated. Use year instead",te),bf.zone=x("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",Ib),bf.isDSTShifted=x("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",Ob);var cf=C.prototype;cf.calendar=D,cf.longDateFormat=E,cf.invalidDate=F,cf.ordinal=G,cf.preparse=Rc,cf.postformat=Rc,cf.relativeTime=H,cf.pastFuture=I,cf.set=A,cf.months=fa,cf.monthsShort=ga,cf.monthsParse=ia,cf.monthsRegex=na,cf.monthsShortRegex=ma,cf.week=ya,cf.firstDayOfYear=Aa,cf.firstDayOfWeek=za,cf.weekdays=Fa,cf.weekdaysMin=Ha,cf.weekdaysShort=Ga,cf.weekdaysParse=Ja,cf.weekdaysRegex=Na,cf.weekdaysShortRegex=Oa,cf.weekdaysMinRegex=Pa,cf.isPM=Va,cf.meridiem=Wa,$a("en",{dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===u(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),a.lang=x("moment.lang is deprecated. Use moment.locale instead.",$a),a.langData=x("moment.langData is deprecated. Use moment.localeData instead.",bb);var df=Math.abs,ef=id("ms"),ff=id("s"),gf=id("m"),hf=id("h"),jf=id("d"),kf=id("w"),lf=id("M"),mf=id("y"),nf=kd("milliseconds"),of=kd("seconds"),pf=kd("minutes"),qf=kd("hours"),rf=kd("days"),sf=kd("months"),tf=kd("years"),uf=Math.round,vf={ss:44,s:45,m:45,h:22,d:26,M:11},wf=Math.abs,xf=Ab.prototype;return xf.isValid=yb,xf.abs=$c,xf.add=ad,xf.subtract=bd,xf.as=gd,xf.asMilliseconds=ef,xf.asSeconds=ff,xf.asMinutes=gf,xf.asHours=hf,xf.asDays=jf,xf.asWeeks=kf,xf.asMonths=lf,xf.asYears=mf,xf.valueOf=hd,xf._bubble=dd,xf.get=jd,xf.milliseconds=nf,xf.seconds=of,xf.minutes=pf,xf.hours=qf,xf.days=rf,xf.weeks=ld,xf.months=sf,xf.years=tf,xf.humanize=qd,xf.toISOString=rd,xf.toString=rd,xf.toJSON=rd,xf.locale=pc,xf.localeData=qc,xf.toIsoString=x("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",rd),xf.lang=Xe,U("X",0,0,"unix"),U("x",0,0,"valueOf"),Z("x",Zd),Z("X",ae),ba("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),ba("x",function(a,b,c){c._d=new Date(u(a))}),a.version="2.18.1",b(tb),a.fn=bf,a.min=vb,a.max=wb,a.now=Qe,a.utc=l,a.unix=Pc,a.months=Vc,a.isDate=h,a.locale=$a,a.invalid=p,a.duration=Sb,a.isMoment=s,a.weekdays=Xc,a.parseZone=Qc,a.localeData=bb,a.isDuration=Bb,a.monthsShort=Wc,a.weekdaysMin=Zc,a.defineLocale=_a,a.updateLocale=ab,a.locales=cb,a.weekdaysShort=Yc,a.normalizeUnits=K,a.relativeTimeRounding=od,a.relativeTimeThreshold=pd,a.calendarFormat=Yb,a.prototype=bf,a});
/* 
 * moment_bn.js
 */
//! moment.js locale configuration
//! locale : Bengali [bn]
//! author : Kaushik Gandhi : https://github.com/kaushikgandhi

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '১',
    '2': '২',
    '3': '৩',
    '4': '৪',
    '5': '৫',
    '6': '৬',
    '7': '৭',
    '8': '৮',
    '9': '৯',
    '0': '০'
};
var numberMap = {
    '১': '1',
    '২': '2',
    '৩': '3',
    '৪': '4',
    '৫': '5',
    '৬': '6',
    '৭': '7',
    '৮': '8',
    '৯': '9',
    '০': '0'
};

var bn = moment.defineLocale('bn', {
    months : 'জানুয়ারী_ফেব্রুয়ারি_মার্চ_এপ্রিল_মে_জুন_জুলাই_আগস্ট_সেপ্টেম্বর_অক্টোবর_নভেম্বর_ডিসেম্বর'.split('_'),
    monthsShort : 'জানু_ফেব_মার্চ_এপ্র_মে_জুন_জুল_আগ_সেপ্ট_অক্টো_নভে_ডিসে'.split('_'),
    weekdays : 'রবিবার_সোমবার_মঙ্গলবার_বুধবার_বৃহস্পতিবার_শুক্রবার_শনিবার'.split('_'),
    weekdaysShort : 'রবি_সোম_মঙ্গল_বুধ_বৃহস্পতি_শুক্র_শনি'.split('_'),
    weekdaysMin : 'রবি_সোম_মঙ্গ_বুধ_বৃহঃ_শুক্র_শনি'.split('_'),
    longDateFormat : {
        LT : 'A h:mm সময়',
        LTS : 'A h:mm:ss সময়',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm সময়',
        LLLL : 'dddd, D MMMM YYYY, A h:mm সময়'
    },
    calendar : {
        sameDay : '[আজ] LT',
        nextDay : '[আগামীকাল] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[গতকাল] LT',
        lastWeek : '[গত] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s পরে',
        past : '%s আগে',
        s : 'কয়েক সেকেন্ড',
        m : 'এক মিনিট',
        mm : '%d মিনিট',
        h : 'এক ঘন্টা',
        hh : '%d ঘন্টা',
        d : 'এক দিন',
        dd : '%d দিন',
        M : 'এক মাস',
        MM : '%d মাস',
        y : 'এক বছর',
        yy : '%d বছর'
    },
    preparse: function (string) {
        return string.replace(/[১২৩৪৫৬৭৮৯০]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    meridiemParse: /রাত|সকাল|দুপুর|বিকাল|রাত/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if ((meridiem === 'রাত' && hour >= 4) ||
                (meridiem === 'দুপুর' && hour < 5) ||
                meridiem === 'বিকাল') {
            return hour + 12;
        } else {
            return hour;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'রাত';
        } else if (hour < 10) {
            return 'সকাল';
        } else if (hour < 17) {
            return 'দুপুর';
        } else if (hour < 20) {
            return 'বিকাল';
        } else {
            return 'রাত';
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return bn;

})));

/* 
 * moment_en-au.js
 */
//! moment.js locale configuration
//! locale : English (Australia) [en-au]
//! author : Jared Morse : https://github.com/jarcoal

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var enAu = moment.defineLocale('en-au', {
    months : 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_'),
    monthsShort : 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),
    weekdays : 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_'),
    weekdaysShort : 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),
    weekdaysMin : 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),
    longDateFormat : {
        LT : 'h:mm A',
        LTS : 'h:mm:ss A',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY h:mm A',
        LLLL : 'dddd, D MMMM YYYY h:mm A'
    },
    calendar : {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'in %s',
        past : '%s ago',
        s : 'a few seconds',
        m : 'a minute',
        mm : '%d minutes',
        h : 'an hour',
        hh : '%d hours',
        d : 'a day',
        dd : '%d days',
        M : 'a month',
        MM : '%d months',
        y : 'a year',
        yy : '%d years'
    },
    dayOfMonthOrdinalParse: /\d{1,2}(st|nd|rd|th)/,
    ordinal : function (number) {
        var b = number % 10,
            output = (~~(number % 100 / 10) === 1) ? 'th' :
            (b === 1) ? 'st' :
            (b === 2) ? 'nd' :
            (b === 3) ? 'rd' : 'th';
        return number + output;
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 4  // The week that contains Jan 4th is the first week of the year.
    }
});

return enAu;

})));

/* 
 * moment_en-ca.js
 */
//! moment.js locale configuration
//! locale : English (Canada) [en-ca]
//! author : Jonathan Abourbih : https://github.com/jonbca

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var enCa = moment.defineLocale('en-ca', {
    months : 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_'),
    monthsShort : 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),
    weekdays : 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_'),
    weekdaysShort : 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),
    weekdaysMin : 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),
    longDateFormat : {
        LT : 'h:mm A',
        LTS : 'h:mm:ss A',
        L : 'YYYY-MM-DD',
        LL : 'MMMM D, YYYY',
        LLL : 'MMMM D, YYYY h:mm A',
        LLLL : 'dddd, MMMM D, YYYY h:mm A'
    },
    calendar : {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'in %s',
        past : '%s ago',
        s : 'a few seconds',
        m : 'a minute',
        mm : '%d minutes',
        h : 'an hour',
        hh : '%d hours',
        d : 'a day',
        dd : '%d days',
        M : 'a month',
        MM : '%d months',
        y : 'a year',
        yy : '%d years'
    },
    dayOfMonthOrdinalParse: /\d{1,2}(st|nd|rd|th)/,
    ordinal : function (number) {
        var b = number % 10,
            output = (~~(number % 100 / 10) === 1) ? 'th' :
            (b === 1) ? 'st' :
            (b === 2) ? 'nd' :
            (b === 3) ? 'rd' : 'th';
        return number + output;
    }
});

return enCa;

})));

/* 
 * moment_en-gb.js
 */
//! moment.js locale configuration
//! locale : English (United Kingdom) [en-gb]
//! author : Chris Gedrim : https://github.com/chrisgedrim

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var enGb = moment.defineLocale('en-gb', {
    months : 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_'),
    monthsShort : 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),
    weekdays : 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_'),
    weekdaysShort : 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),
    weekdaysMin : 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY HH:mm',
        LLLL : 'dddd, D MMMM YYYY HH:mm'
    },
    calendar : {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'in %s',
        past : '%s ago',
        s : 'a few seconds',
        m : 'a minute',
        mm : '%d minutes',
        h : 'an hour',
        hh : '%d hours',
        d : 'a day',
        dd : '%d days',
        M : 'a month',
        MM : '%d months',
        y : 'a year',
        yy : '%d years'
    },
    dayOfMonthOrdinalParse: /\d{1,2}(st|nd|rd|th)/,
    ordinal : function (number) {
        var b = number % 10,
            output = (~~(number % 100 / 10) === 1) ? 'th' :
            (b === 1) ? 'st' :
            (b === 2) ? 'nd' :
            (b === 3) ? 'rd' : 'th';
        return number + output;
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 4  // The week that contains Jan 4th is the first week of the year.
    }
});

return enGb;

})));

/* 
 * moment_en-ie.js
 */
//! moment.js locale configuration
//! locale : English (Ireland) [en-ie]
//! author : Chris Cartlidge : https://github.com/chriscartlidge

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var enIe = moment.defineLocale('en-ie', {
    months : 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_'),
    monthsShort : 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),
    weekdays : 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_'),
    weekdaysShort : 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),
    weekdaysMin : 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD-MM-YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY HH:mm',
        LLLL : 'dddd D MMMM YYYY HH:mm'
    },
    calendar : {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'in %s',
        past : '%s ago',
        s : 'a few seconds',
        m : 'a minute',
        mm : '%d minutes',
        h : 'an hour',
        hh : '%d hours',
        d : 'a day',
        dd : '%d days',
        M : 'a month',
        MM : '%d months',
        y : 'a year',
        yy : '%d years'
    },
    dayOfMonthOrdinalParse: /\d{1,2}(st|nd|rd|th)/,
    ordinal : function (number) {
        var b = number % 10,
            output = (~~(number % 100 / 10) === 1) ? 'th' :
            (b === 1) ? 'st' :
            (b === 2) ? 'nd' :
            (b === 3) ? 'rd' : 'th';
        return number + output;
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 4  // The week that contains Jan 4th is the first week of the year.
    }
});

return enIe;

})));

/* 
 * moment_en-nz.js
 */
//! moment.js locale configuration
//! locale : English (New Zealand) [en-nz]
//! author : Luke McGregor : https://github.com/lukemcgregor

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var enNz = moment.defineLocale('en-nz', {
    months : 'January_February_March_April_May_June_July_August_September_October_November_December'.split('_'),
    monthsShort : 'Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec'.split('_'),
    weekdays : 'Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday'.split('_'),
    weekdaysShort : 'Sun_Mon_Tue_Wed_Thu_Fri_Sat'.split('_'),
    weekdaysMin : 'Su_Mo_Tu_We_Th_Fr_Sa'.split('_'),
    longDateFormat : {
        LT : 'h:mm A',
        LTS : 'h:mm:ss A',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY h:mm A',
        LLLL : 'dddd, D MMMM YYYY h:mm A'
    },
    calendar : {
        sameDay : '[Today at] LT',
        nextDay : '[Tomorrow at] LT',
        nextWeek : 'dddd [at] LT',
        lastDay : '[Yesterday at] LT',
        lastWeek : '[Last] dddd [at] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'in %s',
        past : '%s ago',
        s : 'a few seconds',
        m : 'a minute',
        mm : '%d minutes',
        h : 'an hour',
        hh : '%d hours',
        d : 'a day',
        dd : '%d days',
        M : 'a month',
        MM : '%d months',
        y : 'a year',
        yy : '%d years'
    },
    dayOfMonthOrdinalParse: /\d{1,2}(st|nd|rd|th)/,
    ordinal : function (number) {
        var b = number % 10,
            output = (~~(number % 100 / 10) === 1) ? 'th' :
            (b === 1) ? 'st' :
            (b === 2) ? 'nd' :
            (b === 3) ? 'rd' : 'th';
        return number + output;
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 4  // The week that contains Jan 4th is the first week of the year.
    }
});

return enNz;

})));

/* 
 * moment_hi.js
 */
//! moment.js locale configuration
//! locale : Hindi [hi]
//! author : Mayank Singhal : https://github.com/mayanksinghal

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '१',
    '2': '२',
    '3': '३',
    '4': '४',
    '5': '५',
    '6': '६',
    '7': '७',
    '8': '८',
    '9': '९',
    '0': '०'
};
var numberMap = {
    '१': '1',
    '२': '2',
    '३': '3',
    '४': '4',
    '५': '5',
    '६': '6',
    '७': '7',
    '८': '8',
    '९': '9',
    '०': '0'
};

var hi = moment.defineLocale('hi', {
    months : 'जनवरी_फ़रवरी_मार्च_अप्रैल_मई_जून_जुलाई_अगस्त_सितम्बर_अक्टूबर_नवम्बर_दिसम्बर'.split('_'),
    monthsShort : 'जन._फ़र._मार्च_अप्रै._मई_जून_जुल._अग._सित._अक्टू._नव._दिस.'.split('_'),
    monthsParseExact: true,
    weekdays : 'रविवार_सोमवार_मंगलवार_बुधवार_गुरूवार_शुक्रवार_शनिवार'.split('_'),
    weekdaysShort : 'रवि_सोम_मंगल_बुध_गुरू_शुक्र_शनि'.split('_'),
    weekdaysMin : 'र_सो_मं_बु_गु_शु_श'.split('_'),
    longDateFormat : {
        LT : 'A h:mm बजे',
        LTS : 'A h:mm:ss बजे',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm बजे',
        LLLL : 'dddd, D MMMM YYYY, A h:mm बजे'
    },
    calendar : {
        sameDay : '[आज] LT',
        nextDay : '[कल] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[कल] LT',
        lastWeek : '[पिछले] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s में',
        past : '%s पहले',
        s : 'कुछ ही क्षण',
        m : 'एक मिनट',
        mm : '%d मिनट',
        h : 'एक घंटा',
        hh : '%d घंटे',
        d : 'एक दिन',
        dd : '%d दिन',
        M : 'एक महीने',
        MM : '%d महीने',
        y : 'एक वर्ष',
        yy : '%d वर्ष'
    },
    preparse: function (string) {
        return string.replace(/[१२३४५६७८९०]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    // Hindi notation for meridiems are quite fuzzy in practice. While there exists
    // a rigid notion of a 'Pahar' it is not used as rigidly in modern Hindi.
    meridiemParse: /रात|सुबह|दोपहर|शाम/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'रात') {
            return hour < 4 ? hour : hour + 12;
        } else if (meridiem === 'सुबह') {
            return hour;
        } else if (meridiem === 'दोपहर') {
            return hour >= 10 ? hour : hour + 12;
        } else if (meridiem === 'शाम') {
            return hour + 12;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'रात';
        } else if (hour < 10) {
            return 'सुबह';
        } else if (hour < 17) {
            return 'दोपहर';
        } else if (hour < 20) {
            return 'शाम';
        } else {
            return 'रात';
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return hi;

})));

/* 
 * moment_kn.js
 */
//! moment.js locale configuration
//! locale : Kannada [kn]
//! author : Rajeev Naik : https://github.com/rajeevnaikte

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '೧',
    '2': '೨',
    '3': '೩',
    '4': '೪',
    '5': '೫',
    '6': '೬',
    '7': '೭',
    '8': '೮',
    '9': '೯',
    '0': '೦'
};
var numberMap = {
    '೧': '1',
    '೨': '2',
    '೩': '3',
    '೪': '4',
    '೫': '5',
    '೬': '6',
    '೭': '7',
    '೮': '8',
    '೯': '9',
    '೦': '0'
};

var kn = moment.defineLocale('kn', {
    months : 'ಜನವರಿ_ಫೆಬ್ರವರಿ_ಮಾರ್ಚ್_ಏಪ್ರಿಲ್_ಮೇ_ಜೂನ್_ಜುಲೈ_ಆಗಸ್ಟ್_ಸೆಪ್ಟೆಂಬರ್_ಅಕ್ಟೋಬರ್_ನವೆಂಬರ್_ಡಿಸೆಂಬರ್'.split('_'),
    monthsShort : 'ಜನ_ಫೆಬ್ರ_ಮಾರ್ಚ್_ಏಪ್ರಿಲ್_ಮೇ_ಜೂನ್_ಜುಲೈ_ಆಗಸ್ಟ್_ಸೆಪ್ಟೆಂಬ_ಅಕ್ಟೋಬ_ನವೆಂಬ_ಡಿಸೆಂಬ'.split('_'),
    monthsParseExact: true,
    weekdays : 'ಭಾನುವಾರ_ಸೋಮವಾರ_ಮಂಗಳವಾರ_ಬುಧವಾರ_ಗುರುವಾರ_ಶುಕ್ರವಾರ_ಶನಿವಾರ'.split('_'),
    weekdaysShort : 'ಭಾನು_ಸೋಮ_ಮಂಗಳ_ಬುಧ_ಗುರು_ಶುಕ್ರ_ಶನಿ'.split('_'),
    weekdaysMin : 'ಭಾ_ಸೋ_ಮಂ_ಬು_ಗು_ಶು_ಶ'.split('_'),
    longDateFormat : {
        LT : 'A h:mm',
        LTS : 'A h:mm:ss',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm',
        LLLL : 'dddd, D MMMM YYYY, A h:mm'
    },
    calendar : {
        sameDay : '[ಇಂದು] LT',
        nextDay : '[ನಾಳೆ] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[ನಿನ್ನೆ] LT',
        lastWeek : '[ಕೊನೆಯ] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s ನಂತರ',
        past : '%s ಹಿಂದೆ',
        s : 'ಕೆಲವು ಕ್ಷಣಗಳು',
        m : 'ಒಂದು ನಿಮಿಷ',
        mm : '%d ನಿಮಿಷ',
        h : 'ಒಂದು ಗಂಟೆ',
        hh : '%d ಗಂಟೆ',
        d : 'ಒಂದು ದಿನ',
        dd : '%d ದಿನ',
        M : 'ಒಂದು ತಿಂಗಳು',
        MM : '%d ತಿಂಗಳು',
        y : 'ಒಂದು ವರ್ಷ',
        yy : '%d ವರ್ಷ'
    },
    preparse: function (string) {
        return string.replace(/[೧೨೩೪೫೬೭೮೯೦]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    meridiemParse: /ರಾತ್ರಿ|ಬೆಳಿಗ್ಗೆ|ಮಧ್ಯಾಹ್ನ|ಸಂಜೆ/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'ರಾತ್ರಿ') {
            return hour < 4 ? hour : hour + 12;
        } else if (meridiem === 'ಬೆಳಿಗ್ಗೆ') {
            return hour;
        } else if (meridiem === 'ಮಧ್ಯಾಹ್ನ') {
            return hour >= 10 ? hour : hour + 12;
        } else if (meridiem === 'ಸಂಜೆ') {
            return hour + 12;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'ರಾತ್ರಿ';
        } else if (hour < 10) {
            return 'ಬೆಳಿಗ್ಗೆ';
        } else if (hour < 17) {
            return 'ಮಧ್ಯಾಹ್ನ';
        } else if (hour < 20) {
            return 'ಸಂಜೆ';
        } else {
            return 'ರಾತ್ರಿ';
        }
    },
    dayOfMonthOrdinalParse: /\d{1,2}(ನೇ)/,
    ordinal : function (number) {
        return number + 'ನೇ';
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return kn;

})));

/* 
 * moment_ml.js
 */
//! moment.js locale configuration
//! locale : Malayalam [ml]
//! author : Floyd Pink : https://github.com/floydpink

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var ml = moment.defineLocale('ml', {
    months : 'ജനുവരി_ഫെബ്രുവരി_മാർച്ച്_ഏപ്രിൽ_മേയ്_ജൂൺ_ജൂലൈ_ഓഗസ്റ്റ്_സെപ്റ്റംബർ_ഒക്ടോബർ_നവംബർ_ഡിസംബർ'.split('_'),
    monthsShort : 'ജനു._ഫെബ്രു._മാർ._ഏപ്രി._മേയ്_ജൂൺ_ജൂലൈ._ഓഗ._സെപ്റ്റ._ഒക്ടോ._നവം._ഡിസം.'.split('_'),
    monthsParseExact : true,
    weekdays : 'ഞായറാഴ്ച_തിങ്കളാഴ്ച_ചൊവ്വാഴ്ച_ബുധനാഴ്ച_വ്യാഴാഴ്ച_വെള്ളിയാഴ്ച_ശനിയാഴ്ച'.split('_'),
    weekdaysShort : 'ഞായർ_തിങ്കൾ_ചൊവ്വ_ബുധൻ_വ്യാഴം_വെള്ളി_ശനി'.split('_'),
    weekdaysMin : 'ഞാ_തി_ചൊ_ബു_വ്യാ_വെ_ശ'.split('_'),
    longDateFormat : {
        LT : 'A h:mm -നു',
        LTS : 'A h:mm:ss -നു',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm -നു',
        LLLL : 'dddd, D MMMM YYYY, A h:mm -നു'
    },
    calendar : {
        sameDay : '[ഇന്ന്] LT',
        nextDay : '[നാളെ] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[ഇന്നലെ] LT',
        lastWeek : '[കഴിഞ്ഞ] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s കഴിഞ്ഞ്',
        past : '%s മുൻപ്',
        s : 'അൽപ നിമിഷങ്ങൾ',
        m : 'ഒരു മിനിറ്റ്',
        mm : '%d മിനിറ്റ്',
        h : 'ഒരു മണിക്കൂർ',
        hh : '%d മണിക്കൂർ',
        d : 'ഒരു ദിവസം',
        dd : '%d ദിവസം',
        M : 'ഒരു മാസം',
        MM : '%d മാസം',
        y : 'ഒരു വർഷം',
        yy : '%d വർഷം'
    },
    meridiemParse: /രാത്രി|രാവിലെ|ഉച്ച കഴിഞ്ഞ്|വൈകുന്നേരം|രാത്രി/i,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if ((meridiem === 'രാത്രി' && hour >= 4) ||
                meridiem === 'ഉച്ച കഴിഞ്ഞ്' ||
                meridiem === 'വൈകുന്നേരം') {
            return hour + 12;
        } else {
            return hour;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'രാത്രി';
        } else if (hour < 12) {
            return 'രാവിലെ';
        } else if (hour < 17) {
            return 'ഉച്ച കഴിഞ്ഞ്';
        } else if (hour < 20) {
            return 'വൈകുന്നേരം';
        } else {
            return 'രാത്രി';
        }
    }
});

return ml;

})));

/* 
 * moment_mr.js
 */
//! moment.js locale configuration
//! locale : Marathi [mr]
//! author : Harshad Kale : https://github.com/kalehv
//! author : Vivek Athalye : https://github.com/vnathalye

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '१',
    '2': '२',
    '3': '३',
    '4': '४',
    '5': '५',
    '6': '६',
    '7': '७',
    '8': '८',
    '9': '९',
    '0': '०'
};
var numberMap = {
    '१': '1',
    '२': '2',
    '३': '3',
    '४': '4',
    '५': '5',
    '६': '6',
    '७': '7',
    '८': '8',
    '९': '9',
    '०': '0'
};

function relativeTimeMr(number, withoutSuffix, string, isFuture)
{
    var output = '';
    if (withoutSuffix) {
        switch (string) {
            case 's': output = 'काही सेकंद'; break;
            case 'm': output = 'एक मिनिट'; break;
            case 'mm': output = '%d मिनिटे'; break;
            case 'h': output = 'एक तास'; break;
            case 'hh': output = '%d तास'; break;
            case 'd': output = 'एक दिवस'; break;
            case 'dd': output = '%d दिवस'; break;
            case 'M': output = 'एक महिना'; break;
            case 'MM': output = '%d महिने'; break;
            case 'y': output = 'एक वर्ष'; break;
            case 'yy': output = '%d वर्षे'; break;
        }
    }
    else {
        switch (string) {
            case 's': output = 'काही सेकंदां'; break;
            case 'm': output = 'एका मिनिटा'; break;
            case 'mm': output = '%d मिनिटां'; break;
            case 'h': output = 'एका तासा'; break;
            case 'hh': output = '%d तासां'; break;
            case 'd': output = 'एका दिवसा'; break;
            case 'dd': output = '%d दिवसां'; break;
            case 'M': output = 'एका महिन्या'; break;
            case 'MM': output = '%d महिन्यां'; break;
            case 'y': output = 'एका वर्षा'; break;
            case 'yy': output = '%d वर्षां'; break;
        }
    }
    return output.replace(/%d/i, number);
}

var mr = moment.defineLocale('mr', {
    months : 'जानेवारी_फेब्रुवारी_मार्च_एप्रिल_मे_जून_जुलै_ऑगस्ट_सप्टेंबर_ऑक्टोबर_नोव्हेंबर_डिसेंबर'.split('_'),
    monthsShort: 'जाने._फेब्रु._मार्च._एप्रि._मे._जून._जुलै._ऑग._सप्टें._ऑक्टो._नोव्हें._डिसें.'.split('_'),
    monthsParseExact : true,
    weekdays : 'रविवार_सोमवार_मंगळवार_बुधवार_गुरूवार_शुक्रवार_शनिवार'.split('_'),
    weekdaysShort : 'रवि_सोम_मंगळ_बुध_गुरू_शुक्र_शनि'.split('_'),
    weekdaysMin : 'र_सो_मं_बु_गु_शु_श'.split('_'),
    longDateFormat : {
        LT : 'A h:mm वाजता',
        LTS : 'A h:mm:ss वाजता',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm वाजता',
        LLLL : 'dddd, D MMMM YYYY, A h:mm वाजता'
    },
    calendar : {
        sameDay : '[आज] LT',
        nextDay : '[उद्या] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[काल] LT',
        lastWeek: '[मागील] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future: '%sमध्ये',
        past: '%sपूर्वी',
        s: relativeTimeMr,
        m: relativeTimeMr,
        mm: relativeTimeMr,
        h: relativeTimeMr,
        hh: relativeTimeMr,
        d: relativeTimeMr,
        dd: relativeTimeMr,
        M: relativeTimeMr,
        MM: relativeTimeMr,
        y: relativeTimeMr,
        yy: relativeTimeMr
    },
    preparse: function (string) {
        return string.replace(/[१२३४५६७८९०]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    meridiemParse: /रात्री|सकाळी|दुपारी|सायंकाळी/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'रात्री') {
            return hour < 4 ? hour : hour + 12;
        } else if (meridiem === 'सकाळी') {
            return hour;
        } else if (meridiem === 'दुपारी') {
            return hour >= 10 ? hour : hour + 12;
        } else if (meridiem === 'सायंकाळी') {
            return hour + 12;
        }
    },
    meridiem: function (hour, minute, isLower) {
        if (hour < 4) {
            return 'रात्री';
        } else if (hour < 10) {
            return 'सकाळी';
        } else if (hour < 17) {
            return 'दुपारी';
        } else if (hour < 20) {
            return 'सायंकाळी';
        } else {
            return 'रात्री';
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return mr;

})));

/* 
 * moment_pa-in.js
 */
//! moment.js locale configuration
//! locale : Punjabi (India) [pa-in]
//! author : Harpreet Singh : https://github.com/harpreetkhalsagtbit

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '੧',
    '2': '੨',
    '3': '੩',
    '4': '੪',
    '5': '੫',
    '6': '੬',
    '7': '੭',
    '8': '੮',
    '9': '੯',
    '0': '੦'
};
var numberMap = {
    '੧': '1',
    '੨': '2',
    '੩': '3',
    '੪': '4',
    '੫': '5',
    '੬': '6',
    '੭': '7',
    '੮': '8',
    '੯': '9',
    '੦': '0'
};

var paIn = moment.defineLocale('pa-in', {
    // There are months name as per Nanakshahi Calender but they are not used as rigidly in modern Punjabi.
    months : 'ਜਨਵਰੀ_ਫ਼ਰਵਰੀ_ਮਾਰਚ_ਅਪ੍ਰੈਲ_ਮਈ_ਜੂਨ_ਜੁਲਾਈ_ਅਗਸਤ_ਸਤੰਬਰ_ਅਕਤੂਬਰ_ਨਵੰਬਰ_ਦਸੰਬਰ'.split('_'),
    monthsShort : 'ਜਨਵਰੀ_ਫ਼ਰਵਰੀ_ਮਾਰਚ_ਅਪ੍ਰੈਲ_ਮਈ_ਜੂਨ_ਜੁਲਾਈ_ਅਗਸਤ_ਸਤੰਬਰ_ਅਕਤੂਬਰ_ਨਵੰਬਰ_ਦਸੰਬਰ'.split('_'),
    weekdays : 'ਐਤਵਾਰ_ਸੋਮਵਾਰ_ਮੰਗਲਵਾਰ_ਬੁਧਵਾਰ_ਵੀਰਵਾਰ_ਸ਼ੁੱਕਰਵਾਰ_ਸ਼ਨੀਚਰਵਾਰ'.split('_'),
    weekdaysShort : 'ਐਤ_ਸੋਮ_ਮੰਗਲ_ਬੁਧ_ਵੀਰ_ਸ਼ੁਕਰ_ਸ਼ਨੀ'.split('_'),
    weekdaysMin : 'ਐਤ_ਸੋਮ_ਮੰਗਲ_ਬੁਧ_ਵੀਰ_ਸ਼ੁਕਰ_ਸ਼ਨੀ'.split('_'),
    longDateFormat : {
        LT : 'A h:mm ਵਜੇ',
        LTS : 'A h:mm:ss ਵਜੇ',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm ਵਜੇ',
        LLLL : 'dddd, D MMMM YYYY, A h:mm ਵਜੇ'
    },
    calendar : {
        sameDay : '[ਅਜ] LT',
        nextDay : '[ਕਲ] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[ਕਲ] LT',
        lastWeek : '[ਪਿਛਲੇ] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s ਵਿੱਚ',
        past : '%s ਪਿਛਲੇ',
        s : 'ਕੁਝ ਸਕਿੰਟ',
        m : 'ਇਕ ਮਿੰਟ',
        mm : '%d ਮਿੰਟ',
        h : 'ਇੱਕ ਘੰਟਾ',
        hh : '%d ਘੰਟੇ',
        d : 'ਇੱਕ ਦਿਨ',
        dd : '%d ਦਿਨ',
        M : 'ਇੱਕ ਮਹੀਨਾ',
        MM : '%d ਮਹੀਨੇ',
        y : 'ਇੱਕ ਸਾਲ',
        yy : '%d ਸਾਲ'
    },
    preparse: function (string) {
        return string.replace(/[੧੨੩੪੫੬੭੮੯੦]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    // Punjabi notation for meridiems are quite fuzzy in practice. While there exists
    // a rigid notion of a 'Pahar' it is not used as rigidly in modern Punjabi.
    meridiemParse: /ਰਾਤ|ਸਵੇਰ|ਦੁਪਹਿਰ|ਸ਼ਾਮ/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'ਰਾਤ') {
            return hour < 4 ? hour : hour + 12;
        } else if (meridiem === 'ਸਵੇਰ') {
            return hour;
        } else if (meridiem === 'ਦੁਪਹਿਰ') {
            return hour >= 10 ? hour : hour + 12;
        } else if (meridiem === 'ਸ਼ਾਮ') {
            return hour + 12;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'ਰਾਤ';
        } else if (hour < 10) {
            return 'ਸਵੇਰ';
        } else if (hour < 17) {
            return 'ਦੁਪਹਿਰ';
        } else if (hour < 20) {
            return 'ਸ਼ਾਮ';
        } else {
            return 'ਰਾਤ';
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return paIn;

})));

/* 
 * moment_pl.js
 */
//! moment.js locale configuration
//! locale : Polish [pl]
//! author : Rafal Hirsz : https://github.com/evoL

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var monthsNominative = 'styczeń_luty_marzec_kwiecień_maj_czerwiec_lipiec_sierpień_wrzesień_październik_listopad_grudzień'.split('_');
var monthsSubjective = 'stycznia_lutego_marca_kwietnia_maja_czerwca_lipca_sierpnia_września_października_listopada_grudnia'.split('_');
function plural(n) {
    return (n % 10 < 5) && (n % 10 > 1) && ((~~(n / 10) % 10) !== 1);
}
function translate(number, withoutSuffix, key) {
    var result = number + ' ';
    switch (key) {
        case 'm':
            return withoutSuffix ? 'minuta' : 'minutę';
        case 'mm':
            return result + (plural(number) ? 'minuty' : 'minut');
        case 'h':
            return withoutSuffix  ? 'godzina'  : 'godzinę';
        case 'hh':
            return result + (plural(number) ? 'godziny' : 'godzin');
        case 'MM':
            return result + (plural(number) ? 'miesiące' : 'miesięcy');
        case 'yy':
            return result + (plural(number) ? 'lata' : 'lat');
    }
}

var pl = moment.defineLocale('pl', {
    months : function (momentToFormat, format) {
        if (!momentToFormat) {
            return monthsNominative;
        } else if (format === '') {
            // Hack: if format empty we know this is used to generate
            // RegExp by moment. Give then back both valid forms of months
            // in RegExp ready format.
            return '(' + monthsSubjective[momentToFormat.month()] + '|' + monthsNominative[momentToFormat.month()] + ')';
        } else if (/D MMMM/.test(format)) {
            return monthsSubjective[momentToFormat.month()];
        } else {
            return monthsNominative[momentToFormat.month()];
        }
    },
    monthsShort : 'sty_lut_mar_kwi_maj_cze_lip_sie_wrz_paź_lis_gru'.split('_'),
    weekdays : 'niedziela_poniedziałek_wtorek_środa_czwartek_piątek_sobota'.split('_'),
    weekdaysShort : 'ndz_pon_wt_śr_czw_pt_sob'.split('_'),
    weekdaysMin : 'Nd_Pn_Wt_Śr_Cz_Pt_So'.split('_'),
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD.MM.YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY HH:mm',
        LLLL : 'dddd, D MMMM YYYY HH:mm'
    },
    calendar : {
        sameDay: '[Dziś o] LT',
        nextDay: '[Jutro o] LT',
        nextWeek: '[W] dddd [o] LT',
        lastDay: '[Wczoraj o] LT',
        lastWeek: function () {
            switch (this.day()) {
                case 0:
                    return '[W zeszłą niedzielę o] LT';
                case 3:
                    return '[W zeszłą środę o] LT';
                case 6:
                    return '[W zeszłą sobotę o] LT';
                default:
                    return '[W zeszły] dddd [o] LT';
            }
        },
        sameElse: 'L'
    },
    relativeTime : {
        future : 'za %s',
        past : '%s temu',
        s : 'kilka sekund',
        m : translate,
        mm : translate,
        h : translate,
        hh : translate,
        d : '1 dzień',
        dd : '%d dni',
        M : 'miesiąc',
        MM : translate,
        y : 'rok',
        yy : translate
    },
    dayOfMonthOrdinalParse: /\d{1,2}\./,
    ordinal : '%d.',
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 4  // The week that contains Jan 4th is the first week of the year.
    }
});

return pl;

})));

/* 
 * moment_ru.js
 */
//! moment.js locale configuration
//! locale : Russian [ru]
//! author : Viktorminator : https://github.com/Viktorminator
//! Author : Menelion Elensúle : https://github.com/Oire
//! author : Коренберг Марк : https://github.com/socketpair

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


function plural(word, num) {
    var forms = word.split('_');
    return num % 10 === 1 && num % 100 !== 11 ? forms[0] : (num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 10 || num % 100 >= 20) ? forms[1] : forms[2]);
}
function relativeTimeWithPlural(number, withoutSuffix, key) {
    var format = {
        'mm': withoutSuffix ? 'минута_минуты_минут' : 'минуту_минуты_минут',
        'hh': 'час_часа_часов',
        'dd': 'день_дня_дней',
        'MM': 'месяц_месяца_месяцев',
        'yy': 'год_года_лет'
    };
    if (key === 'm') {
        return withoutSuffix ? 'минута' : 'минуту';
    }
    else {
        return number + ' ' + plural(format[key], +number);
    }
}
var monthsParse = [/^янв/i, /^фев/i, /^мар/i, /^апр/i, /^ма[йя]/i, /^июн/i, /^июл/i, /^авг/i, /^сен/i, /^окт/i, /^ноя/i, /^дек/i];

// http://new.gramota.ru/spravka/rules/139-prop : § 103
// Сокращения месяцев: http://new.gramota.ru/spravka/buro/search-answer?s=242637
// CLDR data:          http://www.unicode.org/cldr/charts/28/summary/ru.html#1753
var ru = moment.defineLocale('ru', {
    months : {
        format: 'января_февраля_марта_апреля_мая_июня_июля_августа_сентября_октября_ноября_декабря'.split('_'),
        standalone: 'январь_февраль_март_апрель_май_июнь_июль_август_сентябрь_октябрь_ноябрь_декабрь'.split('_')
    },
    monthsShort : {
        // по CLDR именно "июл." и "июн.", но какой смысл менять букву на точку ?
        format: 'янв._февр._мар._апр._мая_июня_июля_авг._сент._окт._нояб._дек.'.split('_'),
        standalone: 'янв._февр._март_апр._май_июнь_июль_авг._сент._окт._нояб._дек.'.split('_')
    },
    weekdays : {
        standalone: 'воскресенье_понедельник_вторник_среда_четверг_пятница_суббота'.split('_'),
        format: 'воскресенье_понедельник_вторник_среду_четверг_пятницу_субботу'.split('_'),
        isFormat: /\[ ?[Вв] ?(?:прошлую|следующую|эту)? ?\] ?dddd/
    },
    weekdaysShort : 'вс_пн_вт_ср_чт_пт_сб'.split('_'),
    weekdaysMin : 'вс_пн_вт_ср_чт_пт_сб'.split('_'),
    monthsParse : monthsParse,
    longMonthsParse : monthsParse,
    shortMonthsParse : monthsParse,

    // полные названия с падежами, по три буквы, для некоторых, по 4 буквы, сокращения с точкой и без точки
    monthsRegex: /^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,

    // копия предыдущего
    monthsShortRegex: /^(январ[ья]|янв\.?|феврал[ья]|февр?\.?|марта?|мар\.?|апрел[ья]|апр\.?|ма[йя]|июн[ья]|июн\.?|июл[ья]|июл\.?|августа?|авг\.?|сентябр[ья]|сент?\.?|октябр[ья]|окт\.?|ноябр[ья]|нояб?\.?|декабр[ья]|дек\.?)/i,

    // полные названия с падежами
    monthsStrictRegex: /^(январ[яь]|феврал[яь]|марта?|апрел[яь]|ма[яй]|июн[яь]|июл[яь]|августа?|сентябр[яь]|октябр[яь]|ноябр[яь]|декабр[яь])/i,

    // Выражение, которое соотвествует только сокращённым формам
    monthsShortStrictRegex: /^(янв\.|февр?\.|мар[т.]|апр\.|ма[яй]|июн[ья.]|июл[ья.]|авг\.|сент?\.|окт\.|нояб?\.|дек\.)/i,
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD.MM.YYYY',
        LL : 'D MMMM YYYY г.',
        LLL : 'D MMMM YYYY г., HH:mm',
        LLLL : 'dddd, D MMMM YYYY г., HH:mm'
    },
    calendar : {
        sameDay: '[Сегодня в] LT',
        nextDay: '[Завтра в] LT',
        lastDay: '[Вчера в] LT',
        nextWeek: function (now) {
            if (now.week() !== this.week()) {
                switch (this.day()) {
                    case 0:
                        return '[В следующее] dddd [в] LT';
                    case 1:
                    case 2:
                    case 4:
                        return '[В следующий] dddd [в] LT';
                    case 3:
                    case 5:
                    case 6:
                        return '[В следующую] dddd [в] LT';
                }
            } else {
                if (this.day() === 2) {
                    return '[Во] dddd [в] LT';
                } else {
                    return '[В] dddd [в] LT';
                }
            }
        },
        lastWeek: function (now) {
            if (now.week() !== this.week()) {
                switch (this.day()) {
                    case 0:
                        return '[В прошлое] dddd [в] LT';
                    case 1:
                    case 2:
                    case 4:
                        return '[В прошлый] dddd [в] LT';
                    case 3:
                    case 5:
                    case 6:
                        return '[В прошлую] dddd [в] LT';
                }
            } else {
                if (this.day() === 2) {
                    return '[Во] dddd [в] LT';
                } else {
                    return '[В] dddd [в] LT';
                }
            }
        },
        sameElse: 'L'
    },
    relativeTime : {
        future : 'через %s',
        past : '%s назад',
        s : 'несколько секунд',
        m : relativeTimeWithPlural,
        mm : relativeTimeWithPlural,
        h : 'час',
        hh : relativeTimeWithPlural,
        d : 'день',
        dd : relativeTimeWithPlural,
        M : 'месяц',
        MM : relativeTimeWithPlural,
        y : 'год',
        yy : relativeTimeWithPlural
    },
    meridiemParse: /ночи|утра|дня|вечера/i,
    isPM : function (input) {
        return /^(дня|вечера)$/.test(input);
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'ночи';
        } else if (hour < 12) {
            return 'утра';
        } else if (hour < 17) {
            return 'дня';
        } else {
            return 'вечера';
        }
    },
    dayOfMonthOrdinalParse: /\d{1,2}-(й|го|я)/,
    ordinal: function (number, period) {
        switch (period) {
            case 'M':
            case 'd':
            case 'DDD':
                return number + '-й';
            case 'D':
                return number + '-го';
            case 'w':
            case 'W':
                return number + '-я';
            default:
                return number;
        }
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 7  // The week that contains Jan 1st is the first week of the year.
    }
});

return ru;

})));

/* 
 * moment_ta.js
 */
//! moment.js locale configuration
//! locale : Tamil [ta]
//! author : Arjunkumar Krishnamoorthy : https://github.com/tk120404

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var symbolMap = {
    '1': '௧',
    '2': '௨',
    '3': '௩',
    '4': '௪',
    '5': '௫',
    '6': '௬',
    '7': '௭',
    '8': '௮',
    '9': '௯',
    '0': '௦'
};
var numberMap = {
    '௧': '1',
    '௨': '2',
    '௩': '3',
    '௪': '4',
    '௫': '5',
    '௬': '6',
    '௭': '7',
    '௮': '8',
    '௯': '9',
    '௦': '0'
};

var ta = moment.defineLocale('ta', {
    months : 'ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்'.split('_'),
    monthsShort : 'ஜனவரி_பிப்ரவரி_மார்ச்_ஏப்ரல்_மே_ஜூன்_ஜூலை_ஆகஸ்ட்_செப்டெம்பர்_அக்டோபர்_நவம்பர்_டிசம்பர்'.split('_'),
    weekdays : 'ஞாயிற்றுக்கிழமை_திங்கட்கிழமை_செவ்வாய்கிழமை_புதன்கிழமை_வியாழக்கிழமை_வெள்ளிக்கிழமை_சனிக்கிழமை'.split('_'),
    weekdaysShort : 'ஞாயிறு_திங்கள்_செவ்வாய்_புதன்_வியாழன்_வெள்ளி_சனி'.split('_'),
    weekdaysMin : 'ஞா_தி_செ_பு_வி_வெ_ச'.split('_'),
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, HH:mm',
        LLLL : 'dddd, D MMMM YYYY, HH:mm'
    },
    calendar : {
        sameDay : '[இன்று] LT',
        nextDay : '[நாளை] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[நேற்று] LT',
        lastWeek : '[கடந்த வாரம்] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s இல்',
        past : '%s முன்',
        s : 'ஒரு சில விநாடிகள்',
        m : 'ஒரு நிமிடம்',
        mm : '%d நிமிடங்கள்',
        h : 'ஒரு மணி நேரம்',
        hh : '%d மணி நேரம்',
        d : 'ஒரு நாள்',
        dd : '%d நாட்கள்',
        M : 'ஒரு மாதம்',
        MM : '%d மாதங்கள்',
        y : 'ஒரு வருடம்',
        yy : '%d ஆண்டுகள்'
    },
    dayOfMonthOrdinalParse: /\d{1,2}வது/,
    ordinal : function (number) {
        return number + 'வது';
    },
    preparse: function (string) {
        return string.replace(/[௧௨௩௪௫௬௭௮௯௦]/g, function (match) {
            return numberMap[match];
        });
    },
    postformat: function (string) {
        return string.replace(/\d/g, function (match) {
            return symbolMap[match];
        });
    },
    // refer http://ta.wikipedia.org/s/1er1
    meridiemParse: /யாமம்|வைகறை|காலை|நண்பகல்|எற்பாடு|மாலை/,
    meridiem : function (hour, minute, isLower) {
        if (hour < 2) {
            return ' யாமம்';
        } else if (hour < 6) {
            return ' வைகறை';  // வைகறை
        } else if (hour < 10) {
            return ' காலை'; // காலை
        } else if (hour < 14) {
            return ' நண்பகல்'; // நண்பகல்
        } else if (hour < 18) {
            return ' எற்பாடு'; // எற்பாடு
        } else if (hour < 22) {
            return ' மாலை'; // மாலை
        } else {
            return ' யாமம்';
        }
    },
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'யாமம்') {
            return hour < 2 ? hour : hour + 12;
        } else if (meridiem === 'வைகறை' || meridiem === 'காலை') {
            return hour;
        } else if (meridiem === 'நண்பகல்') {
            return hour >= 10 ? hour : hour + 12;
        } else {
            return hour + 12;
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return ta;

})));

/* 
 * moment_te.js
 */
//! moment.js locale configuration
//! locale : Telugu [te]
//! author : Krishna Chaitanya Thota : https://github.com/kcthota

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var te = moment.defineLocale('te', {
    months : 'జనవరి_ఫిబ్రవరి_మార్చి_ఏప్రిల్_మే_జూన్_జూలై_ఆగస్టు_సెప్టెంబర్_అక్టోబర్_నవంబర్_డిసెంబర్'.split('_'),
    monthsShort : 'జన._ఫిబ్ర._మార్చి_ఏప్రి._మే_జూన్_జూలై_ఆగ._సెప్._అక్టో._నవ._డిసె.'.split('_'),
    monthsParseExact : true,
    weekdays : 'ఆదివారం_సోమవారం_మంగళవారం_బుధవారం_గురువారం_శుక్రవారం_శనివారం'.split('_'),
    weekdaysShort : 'ఆది_సోమ_మంగళ_బుధ_గురు_శుక్ర_శని'.split('_'),
    weekdaysMin : 'ఆ_సో_మం_బు_గు_శు_శ'.split('_'),
    longDateFormat : {
        LT : 'A h:mm',
        LTS : 'A h:mm:ss',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY, A h:mm',
        LLLL : 'dddd, D MMMM YYYY, A h:mm'
    },
    calendar : {
        sameDay : '[నేడు] LT',
        nextDay : '[రేపు] LT',
        nextWeek : 'dddd, LT',
        lastDay : '[నిన్న] LT',
        lastWeek : '[గత] dddd, LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : '%s లో',
        past : '%s క్రితం',
        s : 'కొన్ని క్షణాలు',
        m : 'ఒక నిమిషం',
        mm : '%d నిమిషాలు',
        h : 'ఒక గంట',
        hh : '%d గంటలు',
        d : 'ఒక రోజు',
        dd : '%d రోజులు',
        M : 'ఒక నెల',
        MM : '%d నెలలు',
        y : 'ఒక సంవత్సరం',
        yy : '%d సంవత్సరాలు'
    },
    dayOfMonthOrdinalParse : /\d{1,2}వ/,
    ordinal : '%dవ',
    meridiemParse: /రాత్రి|ఉదయం|మధ్యాహ్నం|సాయంత్రం/,
    meridiemHour : function (hour, meridiem) {
        if (hour === 12) {
            hour = 0;
        }
        if (meridiem === 'రాత్రి') {
            return hour < 4 ? hour : hour + 12;
        } else if (meridiem === 'ఉదయం') {
            return hour;
        } else if (meridiem === 'మధ్యాహ్నం') {
            return hour >= 10 ? hour : hour + 12;
        } else if (meridiem === 'సాయంత్రం') {
            return hour + 12;
        }
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'రాత్రి';
        } else if (hour < 10) {
            return 'ఉదయం';
        } else if (hour < 17) {
            return 'మధ్యాహ్నం';
        } else if (hour < 20) {
            return 'సాయంత్రం';
        } else {
            return 'రాత్రి';
        }
    },
    week : {
        dow : 0, // Sunday is the first day of the week.
        doy : 6  // The week that contains Jan 1st is the first week of the year.
    }
});

return te;

})));

/* 
 * moment_th.js
 */
//! moment.js locale configuration
//! locale : Thai [th]
//! author : Kridsada Thanabulpong : https://github.com/sirn

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


var th = moment.defineLocale('th', {
    months : 'มกราคม_กุมภาพันธ์_มีนาคม_เมษายน_พฤษภาคม_มิถุนายน_กรกฎาคม_สิงหาคม_กันยายน_ตุลาคม_พฤศจิกายน_ธันวาคม'.split('_'),
    monthsShort : 'ม.ค._ก.พ._มี.ค._เม.ย._พ.ค._มิ.ย._ก.ค._ส.ค._ก.ย._ต.ค._พ.ย._ธ.ค.'.split('_'),
    monthsParseExact: true,
    weekdays : 'อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัสบดี_ศุกร์_เสาร์'.split('_'),
    weekdaysShort : 'อาทิตย์_จันทร์_อังคาร_พุธ_พฤหัส_ศุกร์_เสาร์'.split('_'), // yes, three characters difference
    weekdaysMin : 'อา._จ._อ._พ._พฤ._ศ._ส.'.split('_'),
    weekdaysParseExact : true,
    longDateFormat : {
        LT : 'H:mm',
        LTS : 'H:mm:ss',
        L : 'DD/MM/YYYY',
        LL : 'D MMMM YYYY',
        LLL : 'D MMMM YYYY เวลา H:mm',
        LLLL : 'วันddddที่ D MMMM YYYY เวลา H:mm'
    },
    meridiemParse: /ก่อนเที่ยง|หลังเที่ยง/,
    isPM: function (input) {
        return input === 'หลังเที่ยง';
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 12) {
            return 'ก่อนเที่ยง';
        } else {
            return 'หลังเที่ยง';
        }
    },
    calendar : {
        sameDay : '[วันนี้ เวลา] LT',
        nextDay : '[พรุ่งนี้ เวลา] LT',
        nextWeek : 'dddd[หน้า เวลา] LT',
        lastDay : '[เมื่อวานนี้ เวลา] LT',
        lastWeek : '[วัน]dddd[ที่แล้ว เวลา] LT',
        sameElse : 'L'
    },
    relativeTime : {
        future : 'อีก %s',
        past : '%sที่แล้ว',
        s : 'ไม่กี่วินาที',
        m : '1 นาที',
        mm : '%d นาที',
        h : '1 ชั่วโมง',
        hh : '%d ชั่วโมง',
        d : '1 วัน',
        dd : '%d วัน',
        M : '1 เดือน',
        MM : '%d เดือน',
        y : '1 ปี',
        yy : '%d ปี'
    }
});

return th;

})));

/* 
 * moment_uk.js
 */
//! moment.js locale configuration
//! locale : Ukrainian [uk]
//! author : zemlanin : https://github.com/zemlanin
//! Author : Menelion Elensúle : https://github.com/Oire

;(function (global, factory) {
   typeof exports === 'object' && typeof module !== 'undefined'
       && typeof require === 'function' ? factory(require('../moment')) :
   typeof define === 'function' && define.amd ? define(['../moment'], factory) :
   factory(global.moment)
}(this, (function (moment) { 'use strict';


function plural(word, num) {
    var forms = word.split('_');
    return num % 10 === 1 && num % 100 !== 11 ? forms[0] : (num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 10 || num % 100 >= 20) ? forms[1] : forms[2]);
}
function relativeTimeWithPlural(number, withoutSuffix, key) {
    var format = {
        'mm': withoutSuffix ? 'хвилина_хвилини_хвилин' : 'хвилину_хвилини_хвилин',
        'hh': withoutSuffix ? 'година_години_годин' : 'годину_години_годин',
        'dd': 'день_дні_днів',
        'MM': 'місяць_місяці_місяців',
        'yy': 'рік_роки_років'
    };
    if (key === 'm') {
        return withoutSuffix ? 'хвилина' : 'хвилину';
    }
    else if (key === 'h') {
        return withoutSuffix ? 'година' : 'годину';
    }
    else {
        return number + ' ' + plural(format[key], +number);
    }
}
function weekdaysCaseReplace(m, format) {
    var weekdays = {
        'nominative': 'неділя_понеділок_вівторок_середа_четвер_п’ятниця_субота'.split('_'),
        'accusative': 'неділю_понеділок_вівторок_середу_четвер_п’ятницю_суботу'.split('_'),
        'genitive': 'неділі_понеділка_вівторка_середи_четверга_п’ятниці_суботи'.split('_')
    };

    if (!m) {
        return weekdays['nominative'];
    }

    var nounCase = (/(\[[ВвУу]\]) ?dddd/).test(format) ?
        'accusative' :
        ((/\[?(?:минулої|наступної)? ?\] ?dddd/).test(format) ?
            'genitive' :
            'nominative');
    return weekdays[nounCase][m.day()];
}
function processHoursFunction(str) {
    return function () {
        return str + 'о' + (this.hours() === 11 ? 'б' : '') + '] LT';
    };
}

var uk = moment.defineLocale('uk', {
    months : {
        'format': 'січня_лютого_березня_квітня_травня_червня_липня_серпня_вересня_жовтня_листопада_грудня'.split('_'),
        'standalone': 'січень_лютий_березень_квітень_травень_червень_липень_серпень_вересень_жовтень_листопад_грудень'.split('_')
    },
    monthsShort : 'січ_лют_бер_квіт_трав_черв_лип_серп_вер_жовт_лист_груд'.split('_'),
    weekdays : weekdaysCaseReplace,
    weekdaysShort : 'нд_пн_вт_ср_чт_пт_сб'.split('_'),
    weekdaysMin : 'нд_пн_вт_ср_чт_пт_сб'.split('_'),
    longDateFormat : {
        LT : 'HH:mm',
        LTS : 'HH:mm:ss',
        L : 'DD.MM.YYYY',
        LL : 'D MMMM YYYY р.',
        LLL : 'D MMMM YYYY р., HH:mm',
        LLLL : 'dddd, D MMMM YYYY р., HH:mm'
    },
    calendar : {
        sameDay: processHoursFunction('[Сьогодні '),
        nextDay: processHoursFunction('[Завтра '),
        lastDay: processHoursFunction('[Вчора '),
        nextWeek: processHoursFunction('[У] dddd ['),
        lastWeek: function () {
            switch (this.day()) {
                case 0:
                case 3:
                case 5:
                case 6:
                    return processHoursFunction('[Минулої] dddd [').call(this);
                case 1:
                case 2:
                case 4:
                    return processHoursFunction('[Минулого] dddd [').call(this);
            }
        },
        sameElse: 'L'
    },
    relativeTime : {
        future : 'за %s',
        past : '%s тому',
        s : 'декілька секунд',
        m : relativeTimeWithPlural,
        mm : relativeTimeWithPlural,
        h : 'годину',
        hh : relativeTimeWithPlural,
        d : 'день',
        dd : relativeTimeWithPlural,
        M : 'місяць',
        MM : relativeTimeWithPlural,
        y : 'рік',
        yy : relativeTimeWithPlural
    },
    // M. E.: those two are virtually unused but a user might want to implement them for his/her website for some reason
    meridiemParse: /ночі|ранку|дня|вечора/,
    isPM: function (input) {
        return /^(дня|вечора)$/.test(input);
    },
    meridiem : function (hour, minute, isLower) {
        if (hour < 4) {
            return 'ночі';
        } else if (hour < 12) {
            return 'ранку';
        } else if (hour < 17) {
            return 'дня';
        } else {
            return 'вечора';
        }
    },
    dayOfMonthOrdinalParse: /\d{1,2}-(й|го)/,
    ordinal: function (number, period) {
        switch (period) {
            case 'M':
            case 'd':
            case 'DDD':
            case 'w':
            case 'W':
                return number + '-й';
            case 'D':
                return number + '-го';
            default:
                return number;
        }
    },
    week : {
        dow : 1, // Monday is the first day of the week.
        doy : 7  // The week that contains Jan 1st is the first week of the year.
    }
});

return uk;

})));

/* 
 * niceSelect.js
 */
function initNiceSelect(selectTag, callback)
{
    // определение мобилки пока костылём, потом выпилить над будет
    var isMobile = ($(selectTag).find('.nice_select_mobile').size() > 0);

    var select = {
        'tag' : {
            'main'   : false,
            'search' : false,
            'items'  : false,
            'cur'    : false
        },
        'prevSearch' : '',
        'clearCurrent' : function() {
            if (select.tag.cur == false) {
                return false;
            }
            select.tag.cur.removeClass('_cur');
            select.tag.cur = false;
        },
        'setCurrent' : function(item) {
            select.tag.cur = item;
            select.tag.cur.addClass('_cur');
        },
        'selectCur' : function(dir) {
            // сначала проверим, вдруг у нас вообще нет результатов поиска
            var foundItems = select.tag.items.find('.nc_s:not(.h)');
            if (foundItems.size() == 0) {
                return false;
            }

            // если есть результаты, то поищем соседние нескрытые итемы с учётом направления поиска
            var newCur = false;
            if (select.tag.cur === false) { // если у нас нет выделенного элемента, то это будет первый или последний
                newCur = (dir < 0) ? foundItems.first() : foundItems.last();
            } else {
                var allItems = select.tag.items.find('.nc_s');
                var count = allItems.length;
                var curIndex = select.tag.cur.index();
                for (var i=curIndex; (i>=0 && i<count); i=i-dir) {
                    if (i == curIndex) {
                        continue;
                    }
                    if (!$(allItems[i]).hasClass('h')) {
                        newCur = $(allItems[i]);
                        select.clearCurrent();
                        break;
                    }
                }
            }
            // если мы нашли, что выделить
            if (newCur !== false) {
                select.setCurrent(newCur); // выделим этот пункт
                // подравняем список, если выделенный элемент запределами видимой области селектора
                var posTop = select.tag.cur.position().top;
                if ( (posTop > (select.tag.items.height() - select.tag.cur.height)) || (posTop < 0) ) {
                    select.tag.items.animate({'scrollTop' : select.tag.items.scrollTop() + posTop + 'px'}, 100);
                }
            }
        },
        'search' : function(partOfName) {
            // защита от обработки несимвольных клавиш (кнопка вверх, энтер, итд).
            if (select.prevSearch == partOfName) {
                return false;
            }
            select.prevSearch = partOfName;
            select.clearCurrent();

            var items = select.tag.items.find('.nc_s');
            // если строка пустая, то покажем все результаты
            if (partOfName == '') {
                items.each(function(i, item){
                    item = $(item);
                    item.html(item.text());
                    item.removeClass('h');
                });
                return false;
            }

            // если же не пустая, то для начала скроем все итемы
            items.addClass('h');
            // теперь поищем совпадения
            var found = items.filter('[data-search_tag*="' + partOfName.toLowerCase() + '"]');
            // если не нашли, то и хрен с ним
            if (found.size() == 0) {
                return false;
            }
            // иначе пройдёмся по каждому из совпадений
            found.each(function(i, item){
                item = $(item);
                item.removeClass('h');
                // и выделим жирным искомую фразу
                var reg = new RegExp('(.*?)(' + partOfName + ')(.*?)', 'ig');
                item.html(item.text().replace(reg, "$1<b>$2</b>$3"));
            });
        },
        'doSelect' : function() {
            if (select.tag.cur == false) {
                return false;
            }
            select.tag.search.val(select.tag.cur.text());
            select.tag.items.addClass('h');
            if (callback) {
                callback(select.tag.cur);
            }
        },
        'init' : function(selectTag) {
            select.tag.main = $(selectTag);
            if (!isMobile) {
                select.tag.search = select.tag.main.find('[name="search"]');
                select.tag.items  = select.tag.main.find('.nice_select_div');

                select.prevSearch = select.tag.search.val();

                select.tag.main.on({
                    'click' : function(ev) {
                        var el = $(ev.target);
                        select.tag.items.removeClass('h');
                    },
                    'keyup' : function(ev) {
                        var el = $(ev.target);
                        if (ev.keyCode == 13) {
                            select.doSelect();
                        } else if (el.is('[name="search"]')) {
                            select.search(el.val());
                        }
                    },
                    'keydown' : function(ev) {
                        var el = $(ev.target);
                        if ( ((ev.keyCode == 38) || (ev.keyCode == 40)) && el.is('[name="search"]')) {
                            select.selectCur(39 - ev.keyCode); // получим направление для перемещения выделенного 1 или (-1)
                        }
                    },
                    'change' : function(ev) {
                        var el = $(ev.target);
                    }
                });
                $(window).on('click', function(ev){
                    var el = $(ev.target);
                    if (el.closest('.nice_select_wrapper').size() == 0) {
                        select.tag.items.addClass('h');
                    }
                })
            }

            return select;
        }
    }

    return select.init(selectTag);
}

/* 
 * oldComments.js
 */
var defaultFeedHint = false
function photoalbum_comments_load(contentId, inhistory, likes_skip) {
    if (typeof inhistory == 'undefined') {
        inhistory = true
    }
    if (typeof likes_skip == 'undefined') {
        likes_skip = 0
    }
    $('[data-mediaId]').attr('data-mediaId', contentId);
    var forFillMediaId = $('[media_id]');
    if (forFillMediaId.length > 0) {
        forFillMediaId.attr('media_id', contentId);
    }
    $.ajax({
        url: API_URL + '/v2/media/' + contentId,
        data: {
            'fields': 'title,my_vote,my_like,url',
            'embed': 'mediaFeed,album,user',
            'set_city': CITY_ID
        },
        dataType: 'json',
        xhrFields: {
            withCredentials: true
        },
        success: function (data) {
            data = data.media;
            if (inhistory) {
                with (document.location) {
                    var historyUrl = data.url.indexOf(origin)===0 ? data.url : data.static_url;
                    document.title = data.title;
                    if (historyUrl !== href) {
                        ajaxHit(historyUrl, document.location.href);
                        history.pushState(null, null, historyUrl);
                    }
                }
            }
            var $mediaFeedHint = $('[data-elem="mediaFeed-hint"]');
            var $mediaFeedSend = $('[data-action="mediaFeed-send"]');
            var $mediaFeedText = $('[data-elem="mediaFeed-text"]');
            if (USER.mediaFeed_limit !== false) {
                $mediaFeedSend.removeClass('h');
                $mediaFeedText.removeClass('h');
                if (USER.mediaFeed_limit_text) {
                    $mediaFeedText.html(USER.mediaFeed_limit_text);
                }
                if (data.mediaFeed) {
                    $mediaFeedSend.prop('disabled', true);
                    if ($mediaFeedSend.attr('data-mediaType') == 'photos') {
                        $mediaFeedSend.text(t('Sent to photo stream'));
                    } else if ($mediaFeedSend.attr('data-mediaType') == 'videos') {
                        $mediaFeedSend.text(t('Sent to video stream'));
                    }
                } else {
                    if (USER.mediaFeed_limit) {
                        $mediaFeedSend.prop('disabled', !data.can_send_to_feed);
                        if ($mediaFeedSend.attr('data-mediaType') == 'photos') {
                            $mediaFeedSend.text(t('Send to photo stream'));
                        } else if ($mediaFeedSend.attr('data-mediaType') == 'videos') {
                            $mediaFeedSend.text(t('Send to video stream'));
                        }
                    } else {
                        $mediaFeedSend.prop('disabled', true);
                    }
                }
            } else {
                $mediaFeedSend.addClass('h');
                $mediaFeedText.addClass('h');
            }
            if (data.can_send_to_feed) {
                var canSend = false;
                if (USER.isGuest === false) {
                    if (USER.role_key == 'photo' && $mediaFeedSend.attr('data-mediaType') == 'photos') {
                        canSend = true;
                    } else if (USER.role_key == 'video' && $mediaFeedSend.attr('data-mediaType') == 'videos') {
                        canSend = true;
                    }
                }
                if (canSend === true) {
                    $mediaFeedHint.removeClass('h');
                    $mediaFeedSend.removeClass('h');
                    $mediaFeedText.removeClass('h');
                } else {
                    $mediaFeedHint.addClass('h');
                    $mediaFeedSend.addClass('h');
                    $mediaFeedText.addClass('h');
                }
                if (defaultFeedHint) {
                    $mediaFeedHint.html(defaultFeedHint);
                }
            } else {
                if (defaultFeedHint === false) {
                    defaultFeedHint = $mediaFeedHint.html()
                }
                $mediaFeedText.addClass('h');
                if (!data.mediaFeed) {
                    $mediaFeedHint.removeClass('h');
                    $mediaFeedHint.html('<span class="hint_bubble">' + ($mediaFeedSend.attr('data-mediaType') == 'photos' ? t('You cant sent non-wedding photo to photosteam') : t('You cant sent non-wedding video to videosteam')) + '</span>');
                } else {
                    $mediaFeedHint.addClass('h');
                }
            }
            photoalbum_redraw_comments(data, contentId);
            $('.ckeditor').attr('data-contentId', contentId);
            $.ajax({
                type     : 'POST',
                url      : API_URL + '/v2/media/' + contentId + '/countView/',
                xhrFields: {
                    withCredentials: true
                },
                success  : function() {
                }
            });
        }
    });

    $('[data-action="mediaFeed-send"]').off('click').on('click', function () {
        var mediaId = $(this).attr('data-mediaId');
        $.ajax({
            type: 'POST',
            url: API_URL + '/v2/media/'+mediaId+'/feed',
            xhrFields: {
                withCredentials: true
            },
            dataType: 'json',
            success: function (data) {
                var $mediaFeedSend = $('[data-action="mediaFeed-send"]');
                var $mediaFeedText = $('[data-elem="mediaFeed-text"]');
                if (data.text) {
                    $mediaFeedText.html(data.text);
                }
                $mediaFeedSend.prop('disabled', true);
                if (data.ok) {
                    USER.mediaFeed_limit = data.limit;
                    USER.mediaFeed_limit_text = data.text;
                    if ($mediaFeedSend.attr('data-mediaType') == 'photos') {
                        $mediaFeedSend.text(t('Sent to photo stream'));
                    } else if ($mediaFeedSend.attr('data-mediaType') == 'videos') {
                        $mediaFeedSend.text(t('Sent to video stream'));
                    }
                }
            }
        });
        
    });
}
function photoalbum_redraw_comments(json, contentId) {
    var contest_vote = false;
    if (json.album.category.name === 'contest') {
        if (json.my_vote) {
            contest_vote = true;
            $('[data-action="vote_contest"]').addClass('h');
            $('[data-finder="contest_result_title"]').removeClass('h').html(json.my_vote.contest_result_title);
            $('[data-finder="contest_result_body"]').removeClass('h').html(json.my_vote.contest_result_body);
        } else {
            $('[data-action="vote_contest"]').removeClass('h');
            $('[data-finder="contest_result_title"]').addClass('h');
            $('[data-finder="contest_result_body"]').addClass('h');
        }
    } else {
        if (json.my_like) {
            $('[data-action="vote"]').addClass('active');
        } else {
            $('[data-action="vote"]').removeClass('active');
        }
    }
    var $contestOrigin = $('[data-finder="media_orig"]');
    var $galleryOrigin = $('a.photoalbum_origin');
    if (json.original_url && json.type == 'image') {
        if ($contestOrigin) {
            $contestOrigin.removeClass('h');
            $contestOrigin.attr('href', json.original_url);
            $contestOrigin.find('[data-finder="media_orig_size"]').text(json.original_size);
        }
        if ($galleryOrigin) {
            $galleryOrigin.removeClass('h');
            $galleryOrigin.attr('href', json.original_url);
        }
    } else {
        $contestOrigin.addClass('h');
        $galleryOrigin.addClass('h');
    }
    var $info = $('[data-finder="album_info"]');
    $info.addClass('h');
    var $userLink = $('[data-finder="user_link"]');
    if ((contest_vote || USER.group === 'admin') && $userLink.length && json.user.profile_url) {
        $userLink.html('<a href="'+json.user.profile_url+'">'+json.user.name+'</a>');
        $('[data-finder="user_city"]').html(json.user.city.name);
        $info.removeClass('h');
    }

    var $opinions = $('#opinions');
    likes.init(contentId).prependTo($opinions);
    comments.init(contentId).appendTo($opinions);
}

/* 
 * oldupload.js
 */
var oldupload = {
    video : null,

    $main : false,
    $list : false,

    albumId : 0,
    timer : 1500,
    tpl : '',
    text : {
        success : '',
        error   : ''
    },
    items : {},

    render : function(info) {
        with (oldupload) {
            var $item = $(simpleTpl(tpl, info));
            $item.appendTo($list);
            items[info.id] = {
                timerId : 0,
                text    : info.text || ''
            }
        }
    },

    move : function($item, dir) {
        var checkFunc = (dir == 'up' || dir == 'top') ? 'prev' : 'next';
        if (!$item[checkFunc]().is('[oldupload-elem="item"]')) {
            return false;
        }

        $.ajax({
            type     : 'POST',
            url      : '/a/media/photoTo' + dir.capitalize() + '/',
            data     : {
                id : +$item.attr('data-id'),
                BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
            },
            dataType : 'json',
            success  : function(json) {
                switch (dir) {
                    case 'top'    : $item.prependTo(oldupload.$list); break;
                    case 'up'     : $item.insertBefore($item.prev()); break;
                    case 'down'   : $item.insertAfter($item.next()); break;
                    case 'bottom' : $item.appendTo(oldupload.$list); break;
                }
            }
        });
    },

    updateText : function($item) {
        var id = +$item.attr('data-id');
        with (oldupload.items[id]) {
            var $text = $item.find('[oldupload-elem="text"]');
            if ($text.val() == text) {
                return false;
            }
            if (timerId) {
                clearTimeout(timerId);
            }
            text = $text.val();
            timerId = setTimeout(function() {
                $.ajax({
                    type     : 'POST',
                    url      : '/a/media/photoSaveText/',
                    data     : {
                        id   : id,
                        text : text,
                        BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
                    },
                    dataType : 'json',
                    success  : function(json) {
                        alert2(oldupload.text.success);
                    }
                });
            }, oldupload.timer);
        }
    },

    delete : function($item) {
        var id = +$item.attr('data-id');
        $.ajax({
            type     : 'POST',
            url      : '/a/media/deletePhoto/',
            data     : {
                id : id,
                BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
            },
            dataType : 'json',
            success  : function(json) {
                $item.remove();
                delete oldupload.items[id];
            }
        });
    },

    init : function() {
        with (oldupload) {
            $main = $('#oldupload');
            if (!$main.length) {
                return false;
            }

            $list = $main.find('[oldupload-elem="list"]');
            albumId = $main.attr('data-album_id');
            tpl = $('#_tpl_uploadItem').html();
            text.success = $main.attr('data-text_success') || false;
            text.error   = $main.attr('data-text_error') || false;

            $list.find('[oldupload-elem="item"]').each(function(i, $item){
                $item = $($item);
                oldupload.items[$item.attr('data-id')] = {
                    timerId : 0,
                    text    : $item.find('[oldupload-elem="text"]').val()
                }
            });

            $main.on({
                'click' : function(ev) {
                    var $el = $(ev.target);
                    if ($el.is('[oldupload-action]')) {
                        var action = $el.attr('oldupload-action');
                        switch (action) {
                            case 'delete' :
                            case 'move'   :
                                var $item = $el.closest('[oldupload-elem="item"]');
                                var dir = $el.attr('data-dir') || false;
                                oldupload[action]($item, dir); break;
                            case 'video'  : oldupload.video.init(oldupload.render); break;
                        }
                    }
                },
                'keyup change' : function(ev) {
                    var $el = $(ev.target);
                    if ($el.is('[oldupload-elem="text"]')) {
                        var $item = $el.closest('[oldupload-elem="item"]');
                        oldupload.updateText($item);
                    }
                }
            });
        }
    }
}

/* 
 * oldupload_video.js
 */
oldupload.video = {
    $main : false,
    $code : false,
    $thumb : false,
    $descr : false,

    inited : false,

    tpl : false,
    timer : 1000,
    timerId : 0,
    code : '',

    close: function() {
        with (oldupload.video) {
            $main = false;
            inited = false;
        }
    },

    check : function() {
        with (oldupload.video) {
            if ($code.val() == code) {
                return false;
            }

            code = $code.val();
            if (timerId) {
                clearTimeout(timerId);
            }
            $main.removeClass('_error _success');
            if (code == '') {
                return true;
            }

            timerId = setTimeout(function(){
                $.ajax({
                    type     : 'POST',
                    url      : '/a/embed/index/',
                    data     : {
                        embed_code : code,
                        BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
                    },
                    dataType : 'json',
                    success  : function(json) {
                        if (json.error) {
                            $main.addClass('_error');
                            return false;
                        }
                        $thumb.attr('src', json.thumb);
                        $descr.val(json.description);
                        $main.addClass('_success');
                    }
                });
            }, timer);
        }
    },

    save : function(callback) {
        $.ajax({
            type     : 'POST',
            url      : '/a/embed/save/',
            data     : {
                album_id : oldupload.albumId,
                embed_code : oldupload.video.code,
                embed_description : oldupload.video.$descr.val(),
                BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY
            },
            dataType : 'json',
            success  : function(json) {
                if (callback) {
                    callback({
                        id     : json.id,
                        thumbs : json.preview,
                        text   : json.description
                    });
                }
                lightbox.close();
            }
        });
    },

    init : function (callback) {
        with (oldupload.video) {
            if (inited) {
                return false;
            }
            if (tpl === false) {
                tpl = $('#_tpl_uploadVideo').html();
            }
            $main = $(tpl);
            $code = $main.find('[oldupload-elem="code"]');
            $thumb = $main.find('[oldupload-elem="thumb"]');
            $descr = $main.find('[oldupload-elem="descr"]');
            code = $code.val();

            lightbox.show($main, 520, {close:close});
            fillFields.init($main);

            $main.on({
                'click' : function(ev){
                    var $el = $(ev.target);
                    if ($el.is('[oldupload-action="save"]')) {
                        oldupload.video.save(callback);
                    }
                },
                'keyup change': function(ev){
                    var $el = $(ev.target);
                    if ($el.is('[oldupload-elem="code"]')) {
                        oldupload.video.check();
                    }
                }
            });
        }
    }
}

/* 
 * opinions.js
 */
var opinions = {
    $main : false,

    id   : 0,
    type : false,

    init : function() {
        with (opinions) {
            $main = $('#opinions');
            if (!$main.length) {
                $main = false;
                return false;
            }

            id   = $main.attr('opinions-id') || 0;
            type = $main.attr('opinions-type') || false;

            if (!id || !type) return false;

            comments.init(id, type).appendTo($main);
        }
    }
}

$(document).ready(opinions.init);
/* 
 * packs.js
 */
var packs = {
    $main    : null,
    $caption : null,
    $list    : null,

    inited : false,
    tpl : {
        main : twig.compile(
            '<div id="packs" class="packs">' +
                '<div class="packs_caption" packs-elem="caption">' +
                    '<div class="packs_header-guests">' + t('Qty') + '</div>' +
                    '<div class="packs_header-price">' + t('Price') + '</div>' +
                    '<div class="packs_header-rooms">' + t('Spaces') + '</div>' +
                '</div>' +
                '<div class="packs_list" empty-text="' + t('No packages added') + '" packs-elem="list"></div>' +
            '</div>'
        ),
        pack : twig.compile(
            '<div class="pack' + (SITE_DOMAIN == 'centerwedding.com' ? ' _cw' : '') + '" pack-id="{{ pack.id }}" pack-elem="main" spec-id="{{ pack.spec_id|join(" ") }}">' +
                '<div class="pack_header"{% if isEdit %} pack-action="edit"{% elseif hasBody %} pack-action="expand"{% endif %}>' +
                    '<div class="pack_name">' +
                        '{{ pack.name }}' +
                    '</div>' +
                    '<div class="pack_guests">' + 
                        '{% if pack.guests %}' +
                            '<span class="pack_guests_count">{{ pack.guests }}</span> ' +
                            t('guests') +
                        '{% endif %}' +
                    '</div>' +
                    '<div class="pack_price">' +
                        '<p class="pack_price_type">' + t('Rental') + '</p>' +
                        '{% if pack.payment_model > 1 and pack.price_rent %}' +
                            '<p class="pack_price_value">{{ pack.price_rent_display }}</p>' +
                        '{% else %}' +
                            '<p class="pack_price_value _havenot">' + t('No')+ '</p>' +
                        '{% endif %}' +
                    '</div>' +
                    '<div class="pack_surcharges">' +
                        '{% if pack.surcharge.caption %}' +
                            '<p class="pack_surcharge_caption">{{ pack.surcharge.caption }}</p>' +
                            '{% if pack.surcharge.notice %}' +
                                '<p class="pack_surcharge_notice">{{ pack.surcharge.notice }}</p>' +
                            '{% else %}' +
                                '<p class="pack_surcharge_value">{{ pack.surcharge.value }}</p>' +
                            '{% endif %}' +
                        '{% elseif pack.surcharge.length %}' +
                            '{% for surcharge in pack.surcharge %}' +
                                '<div class="pack_surcharge">' +
                                    '<div class="pack_surcharge_name">{{ surcharge.name }}</div>' +
                                    '<div class="pack_surcharge_value">{{ surcharge.value }}</div>' +
                                '</div>' +
                            '{% endfor %}' +
                        '{% endif %}' +
                    '</div>' +
                    '<div class="pack_rooms">' +
                        '<div class="pack_text">' +
                            '{{ pack.spaces }}' +
                        '</div>' +
                    '</div>' +
                    '{% if isEdit %}' +
                        '<a class="pack_sort" pack-action="sort"></a>' +
                    '{% elseif hasBody %}' +
                        '<a class="pack_expand"></a>' +
                    '{% endif %}' +
                '</div>' +
                '{% if hasBody %}' +
                    '<div class="pack_body">' +
                        '{% if pack.description %}' +
                            '<div class="pack_description">{{ pack.description }}</div>' +
                        '{% endif %}' +
                        '{% if pack.descriptions.length %}' +
                            '<div class="pack_params">' +
                                '{% for description in pack.descriptions %}' +
                                    '<div class="pack_param">' +
                                        '<div class="pack_param_name">{{ description.title }}</div>' +
                                        '<div class="pack_param_value">{{ description.value }}</div>' +
                                    '</div>' +
                                '{% endfor %}' +
                            '</div>' +
                        '{% endif %}' +
                        '{% if pack.files and pack.files.length %}' +
                            '{% for file in pack.files %}' +
                                '<a class="file" href="{{ file.path }}" target="_blank">' +
                                    '{{ file.title }}' +
                                    '<div class="file_downloadIcon"></div>' +
                                '</a>' +
                            '{% endfor %}' +
                        '{% endif %}' +
                        '{% if pack.media and pack.media.length %}' +
                            '<div class="pack_medias" pack-elem="medias">' +
                                '{% for media in pack.media %}' +
                                    '<a class="pack_media" href="{{ media.url }}" target="_blank">' +
                                        '<img src="{{ media.preview_url.0x200x0 ? media.preview_url.0x200x0 : media.preview_url }}" height="200" alt="">' +
                                    '</a>' +
                                '{% endfor %}' +
                            '</div>' +
                        '{% endif %}' +
                    '</div>' +
                '{% endif %}' +
            '</div>'
        ),
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.closest('[pack-action="expand"]').length) {
                packs.toggleExpand($el.closest('[pack-elem="main"]'))
            }
        }
    },

    init : function() {
        if (packs.inited) {
            return true
        }
        if (packs.$main === null) {
            packs.$main = $('#packs')
        }
        if (!packs.$main.length) {
            return false
        }
        packs.$caption = packs.$main.find('[packs-elem="caption"]')
        packs.$list = packs.$main.find('[packs-elem="list"]')

        packs.$main.on(packs.events)
        packs.inited = true
    },

    toggleExpand : function($pack) {
        $pack.toggleClass('_expanded')
        if ($pack.hasClass('_expanded') && !$pack.hasClass('_slided')) {
            var $medias = $pack.find('[pack-elem="medias"]')
            if ($medias.length) {
                initSlider($medias, 'h', true)
            }
            $pack.addClass('_slided')
        }
    },

    prepare : function(info) {
        if (info.payment_model == 4 && info.price_all) {
            info.surcharge = [{
                name : t('Price'),
                value : info.price_all_display,
            }]
        } else if (info.price_veg !== undefined) {
            info.surcharge = [{
                name : t('Veg. cuisine'),
                value : info.price_veg_display,
            },{
                name : t('Non-veg. cuisine'),
                value : info.price_no_veg_display,
            }]
        } else {
            info.surcharge = {
                caption : t(''),
            }
            if (info.payment_model == 3) {
                info.surcharge.notice = 'Требуется кейтеринг'
            } else {
                info.surcharge.value = info.price_banquet ? info.price_banquet_display : null
            }
        }

        info.descriptions = []
        if (info.services_0) {
            info.descriptions.push({
                title : t('Services included in the price'),
                value : info.services_0,
            })
        }
        if (info.services_1) {
            info.descriptions.push({
                title : t('Services for an additional fee'),
                value : info.services_1,
            })
        }
        if (info.description_veg) {
            info.descriptions.push({
                title : t('Veg. cuisine'),
                value : info.description_veg,
            })
        }
        if (info.description_no_veg) {
            info.descriptions.push({
                title : t('Non-veg. cuisine'),
                value : info.description_no_veg,
            })
        }
    },

    render : {
        main : function() {
            packs.$main = twig.render(packs.tpl.main, null, true)
            packs.init()
            return packs.$main
        },
        pack : function(info, isEdit) {
            packs.prepare(info)
            return twig.render(packs.tpl.pack, {
                pack   : info,
                isEdit : isEdit,
                hasBody: info.description || info.descriptions.length || (info.files && info.files.length) || (info.media && info.media.length),
            }, true)
        },
    },
}
/* 
 * paginator.js
 */
var paginator = {
    windowBinded : false,
    list : [],
    defaultUrlTpl : '?page={page}',

    tpl : Twig.twig({data:
        '<div class="paginator" pgtr-elem="main" data-last="{{ pages }}"{% if urlTpl %} data-url="{{ urlTpl }}"{% endif %}>' +
            '<div class="paginator_block">' +
                t('Page') +
                ' <div class="paginator_curPage" pgtr-elem="current" pgtr-action="toggle" data-page="{{ page }}">' +
                    '{% if isMobile %}' +
                        '<select class="paginator_select" pgtr-elem="select">' +
                            '{% for i in 1..pages %}' +
                                '<option value="{{ i }}"{% if i == page %} selected{% endif %}>{{ i }}</option>' +
                            '{% endfor %}' +
                        '</select>' +
                    '{% else %}' +
                        '<div pgtr-elem="pages" class="paginator_pages h">' +
                            '{% if needScroll %}' +
                                '<div class="paginator_scroll-up" data-dir="up" pgtr-action="scroll"></div>' +
                            '{% endif %}' +
                            '<div pgtr-elem="list" class="paginator_list">' +
                                '{% for i in 1..pages %}' +
                                    '<a href="{{ urlTpl|replace({"{page}":i}) }}" class="paginator_page{% if i == page %} _cur{% endif %}"pgtr-action="go">{{ i }}</a>' +
                                '{% endfor %}' +
                            '</div>' +
                            '{% if needScroll %}' +
                                '<div class="paginator_scroll-down" data-dir="down" pgtr-action="scroll"></div>' +
                            '{% endif %}' +
                        '</div>' +
                    '{% endif %}' +
                '</div> ' +
                t('of') +
                ' <a href="{{ urlTpl|replace({"{page}":pages}) }}" class="paginator_last" pgtr-action="go">{{ pages }}</a>' +
            '</div>' +
            '<a class="paginator_arrow-prev" href="{{ urlTpl|replace({"{page}":page-1}) }}" pgtr-action="prev">' + t('Previous') + '</a>' +
            '<a class="paginator_arrow-next" href="{{ urlTpl|replace({"{page}":page+1}) }}" pgtr-action="next">' + t('Next') + '</a>' +
        '</div>',
    }),

    current : false,

    create : function(info) {
        if (!info.pages) {
            info.pages = Math.ceil(info.total / info.perPage);
        }
        if (!info.urlTpl) {
            info.urlTpl = defaultUrlTpl;
        }

        info.isMobile = isMobile
        if (!info.isMobile) {
            info.needScroll = (info.pages > 22)
        }

        paginator.init($(paginator.tpl.render(info)))
        var pgtr = paginator.list[paginator.list.length - 1]
        if (info.onGo) {
            pgtr.onGo = info.onGo
        }
        return pgtr.$main
    },

    close : function() {
        with (paginator) {
            if (current === false) {
                return true;
            }
            list[current].$pages.addClass('h');
            current = false;
        }
    },

    initItem : function($paginator) {
        if (+$paginator.attr('pgtr-num')) {
            return false;
        }

        var pgtr = {
            $main    : $paginator,
            $pages   : $paginator.find('[pgtr-elem="pages"]'),
            $list    : $paginator.find('[pgtr-elem="list"]'),
            $select  : $paginator.find('[pgtr-elem="select"]'),
            $current : $paginator.find('[pgtr-elem="current"]'),
            $prev    : $paginator.find('[pgtr-action="prev"]'),
            $next    : $paginator.find('[pgtr-action="next"]'),

            onGo     : false,

            urlTpl   : $paginator.attr('data-url') || paginator.defaultUrlTpl,
            curPage  : 1,
            lastPage : 1,
            height   : {
                list : 0,
                page : 0
            },

            initHeights : function() {
                with (pgtr) {
                    height.list = $list.height();
                    height.page = +$list.children().first().outerHeight();
                }
            },
            scroll : function(dir) {
                with (pgtr) {
                    var delta = (dir == 'up') ? (-1) : 1;
                    $list.animate({scrollTop : $list.scrollTop() + 100*delta}, 500);
                }
            },
            go : {
                select : function() {
                    with (pgtr) {
                        curPage = +$select.val();
                        $current.attr('data-page', curPage);
                        if (onGo) {
                            check();
                            onGo(curPage);
                        } else {
                            document.location.href = 'http://' + document.location.host + document.location.pathname + pgtr.urlTpl.replace('{page}', curPage);
                        }
                    }
                },
                page : function(page) {
                    with (pgtr) {
                        curPage = page;
                        $current.attr('data-page', curPage);
                        $list.find('._cur').removeClass('_cur');
                        $list.find(':nth-child(' + curPage + ')').addClass('_cur');
                        check();
                        onGo(curPage);
                    }
                }
            },
            toggle : function(show) {
                with (pgtr) {
                    if ( (show !== false) && (show !== true) ) {
                        show = $pages.hasClass('h');
                    }
                    if ( (show === true) && (paginator.current !== false) ) {
                        paginator.close();
                    }
                    $pages.toggleClass('h', !show);

                    if (show === true) {
                        if (height.list == 0) {
                            initHeights();
                        }

                        var posTop = parseInt($list.find('._cur').position().top);
                        // если текущая страничка за областью видимости, то нужно подскролить список и пересчитать её позицию
                        if ( (posTop < 0) || (posTop >= height.list) ) {
                            var scrollTop = parseInt($list.scrollTop()) + posTop - height.list;
                            $list.scrollTop(scrollTop);
                            var posTop = parseInt($list.find('._cur').position().top);
                        }
                        $pages.css('top', '-' + posTop + 'px');

                        paginator.current = +pgtr.$main.attr('pgtr-num');
                    }
                }
            },
            check : function() {
                with (pgtr) {
                    if ($prev.length) {
                        $prev.attr('href', urlTpl.replace('{page}', curPage - 1)).toggleClass('h', (curPage == 1));
                    }
                    if ($next.length) {
                        $next.attr('href', urlTpl.replace('{page}', curPage + 1)).toggleClass('h', (curPage == lastPage));
                    }
                }
            }
        };

        with (pgtr) {
            curPage  = +$current.attr('data-page');
            lastPage = +$main.attr('data-last');

            if (isMobile) {
                if ($pages.length) $pages.remove();
                $pages = false;
                $list  = false;
            } else {
                if ($select.length) $select.remove();
                $select = false;
            }
            check();
        }

        return pgtr;
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target);
            if ( (paginator.current !== false) && !$el.closest('[pgtr-elem="current"]').length ) {
                paginator.close();
            }
            if ($el.is('[pgtr-action]')) {
                var num = $el.closest('[pgtr-elem="main"]').attr('pgtr-num'),
                    pgtr = paginator.list[num],
                    action = $el.attr('pgtr-action');
                switch (action) {
                    case 'toggle' : pgtr.toggle(); break;
                    case 'scroll' : pgtr.scroll($el.attr('data-dir')); break;
                    case 'go'     :
                        paginator.close();
                        if (pgtr.onGo && supports_history_api()) {
                            history.pushState(null, null, $el.attr('href'));
                            pgtr.go.page(+$el.text());
                            return false;
                        }
                        break;
                    case 'next' :
                    case 'prev' :
                        if (pgtr.onGo && supports_history_api()) {
                            history.pushState(null, null, $el.attr('href'));
                            pgtr.go.page(action == 'prev' ? pgtr.curPage - 1 : pgtr.curPage + 1);
                            return false;
                        }
                        break;
                }
            }
        },
        change : function(ev) {
            var $el = $(ev.target);
            if ($el.is('[pgtr-elem="select"]')) {
                var num = $el.closest('[pgtr-elem="main"]').attr('pgtr-num');
                paginator.list[num].go.select();
            }
        }
    },

    init : function($paginator) {
        with (paginator) {
            if (!$paginator) {
                $paginator = $('[pgtr-elem="main"]');
                if (!$paginator.length) {
                    return false;
                }
            } else {
                $paginator = [$paginator];
            }

            for (var i=0; $paginator[i]; i++) {
                var item = initItem($($paginator[i]));
                if (item !== false) {
                    item.$main.attr('pgtr-num', list.length);
                    list.push(item);
                }
            }

            if (!windowBinded) {
                $(window).on(events);
                windowBinded = true;
            }
        }
    }
}

$(document).ready(function() {
    paginator.init();
});

/* 
 * payment.js
 */
var payment = {
    $main : null,

    object : {
        type : 'user',
        id   : USER.id
    },
    info : {
        sum : 0
    },

    tpl : {
        start : {
            main : Twig.twig({data:
                '<div class="payment">' +
                    '<p class="payment_text">{{ text }}</p>' +
                    '<h2 class="lightbox_caption">' + t('Payment') + '</h2>' +
                    '{{ wBalance }}' +
                    '{{ refill }}' +
                    '<p class="lightbox_notice">' +
                        t('Making purchases on {site_name} you confirm that you\'ve accepted the Terms and Conditions of chargeable services at <a href="{site_url}/page/payment/" target="_blank">{site_url}/page/payment/</a>.', {'{site_url}' : SITE_URL}) +
                    '</p>' +
                '</div>'
            }),
            wBalance : Twig.twig({data:
                '<div class="payment_wBalance">' +
                    '<div class="payment_summ">{{ summText }}</div>' +
                    '<div class="payment_balance" data-currency="{{ currency }}">' + t('Balance') +
                        ' <span class="payment_account">{{ balance }}</span>' +
                    '</div>' +
                    '{% if balanceOnly %}' +
                        '<button class="button" payment-action="wbalance">' + t('Pay from balance') + '</button>' +
                    '{% endif %}' +
                    '<p class="lightbox_notice">' + t('Remaining balance after purchase') + ': {{ balanceLeft }}</p>' +
                '</div>'
            }),
            refill : Twig.twig({data:
                '<div class="payment_refill">' +
                    '<div class="payment_summ">{{ summText }}</div>' +
                    '<div class="payment_providers">' +
                        '<p class="payment_text">' + t('Select refill method') + '</p>' +
                        '{% for provider in providers %}' +
                            '<a class="payment_provider-{{ provider.key }}" href="{{ provider.url }}" data-text="{{ provider.title }}"></a>' +
                        '{% endfor %}' +
                    '</div>' +
                '</div>'
            }),
        },
        complete : Twig.twig({data:
            '<div class="payment">' +
                '<h2 class="lightbox_caption">' + t('Payment completed successfully') + '</h2>' +
                '<button class="button" lightbox-action="close">' + t('Close') + '</button>'+
            '</div>'
        }),
        error : Twig.twig({data:
            '<div class="payment">' +
                '<h2 class="lightbox_caption">' + t('Payment interrupted') + '</h2>' +
                '<button class="button" lightbox-action="close">' + t('Close') + '</button>'+
            '</div>'
        }),
    },

    providerName : {
        'card'          : t('Credit/debit card'),
        'cloudpayments' : t('Credit/debit card'),
        'liqpay'        : t('Credit/debit card'),
        'yandex'        : t('Yandex Money'),
        'robox'         : t('Other payment methods'),
        'instamojo'     : t('Credit/debit card, Net banking, EMI, UPI'),
        'qiwi'          : t('Qiwi wallet'),
    },

    close : function() {
        payment.$main = null
        payment.info  = {
            sum : 0,
        }
    },

    error : function(text, errorText) {
        payment.$main = $(payment.tpl.error.render({
            text  : text,
            error : errorText,
        }))
        lightbox.show(payment.$main, 650, {close:payment.close})
    },

    complete : function() {
        payment.$main = $(payment.tpl.complete.render())
        lightbox.show(payment.$main, 650, {close:payment.close})
    },

    doPay : function() {
        var apiUrl;
        if (payment.object.type == 'user') {
            apiUrl = API_URL + '/v2/my/buyPro'
            if ( payment.info.label && (payment.info.label == 'cities') ) {
                apiUrl = API_URL + '/v2/bill/cities'
            }
        } else if (payment.object.type == 'restaurant' || payment.object.type == 'venue') {
            apiUrl = API_URL + '/v2/' + payment.object.type + 's/' + payment.object.id + '/buyPro'
        } else if (payment.object.type == 'limousine') {
            apiUrl = API_URL + '/v2/bill/carsPro'
        } else {
            return false
        }

        $.ajax({
            type     : 'POST',
            url      : apiUrl,
            data     : JSON.stringify(payment.info),
            xhrFields : {
                withCredentials: true,
            },
            dataType : 'json',
            success  : function(json) {
                window.location.reload()
            }
        });
    },

    getProviders : function(sum) {
        var postData = Object.assign({}, payment.info)
        postData.sum = Math.abs(postData.delta)

        if (postData.label == 'cities') {
            var cities = []
            for (var cityId in postData.city) if (postData.city.hasOwnProperty(cityId)) {
                cities.push('city[' + cityId + ']=' + postData.city[cityId])
            }
            postData.city = cities.join('&')
        }

        return $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/bill/providers',
            data     : postData,
            xhrFields: {
                withCredentials: true,
            },
            dataType : 'json',
            success  : function(json) {
                if (json.error) {
                    alert2(json.error, 'error')
                } else {
                    payment.info.providers = json.providers.map(function(provider) {
                        provider.title = payment.providerName[provider.key]
                        return provider
                    })
                }
            }
        })
    },

    check : function() {
        var status = ['complete', 'error']
        var hash = document.location.hash
        for (var i=0; status[i]; i++) {
            var hashStatus = 'payment_' + status[i]
            if (hash.indexOf(hashStatus) < 0) {
                continue
            }
            // выводим лайтбокс об успешной или неуспешной оплате
            payment[status[i]]();
            // удаляем хэш о результате оплаты
            hash = hash.replace(new RegExp('(\&' + hashStatus + ')|(' + hashStatus + '\&)|(' + hashStatus + ')'), '')
            document.location.hash = hash
            break
        }
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[payment-action="wbalance"]')) {
                payment.doPay()
            }
        }
    },

    render : function(text, sum_display) {
        var width   = 650
        var tplInfo = {
            text : text,
        }
        var delta_display = USER.balance.total_display.replace(moneyFormat(USER.balance.total), moneyFormat(Math.abs(payment.info.delta)))
        if (USER.balance.total) {
            var summText = payment.info.sum < USER.balance.total ? sum_display : USER.balance.total_display
            if (payment.info.delta < 0) {
                width = 764
                summText =  t('From balance: {balance}', {'{balance}' : summText})
            }
            tplInfo.wBalance = payment.tpl.start.wBalance.render({
                balance     : USER.balance.total_display,
                summText    : summText,
                balanceOnly : (payment.info.delta >= 0),
                balanceLeft : payment.info.delta > 0 ? delta_display : USER.balance.total_display.replace(moneyFormat(USER.balance.total), 0),
                currency   : USER.balance.currency,
            })
        }

        if (payment.info.delta < 0) {
            var summText = delta_display

            if (USER.balance.total) {
                width = 764
                summText = t('Added funds: {refill}', {'{refill}' : summText})
            }
            tplInfo.refill = payment.tpl.start.refill.render({
                summText  : summText,
                providers : payment.info.providers,
            })
        }

        payment.$main = $(payment.tpl.start.main.render(tplInfo))
        lightbox.show(payment.$main, width, {close:payment.close})
        payment.$main.on(payment.events)
    },

    init : function(text, sum, sum_display, params, providers) {
        payment.info.sum = sum
        payment.info.delta = USER.balance.total - payment.info.sum // сколько денег останется на балансе после списания

        if (params) {
            if (params.object) {
                payment.object.type = params.object.type
                payment.object.id   = params.object.id
                delete params.object
            }
            for (var paramName in params) if (params.hasOwnProperty(paramName)) {
                payment.info[paramName] = params[paramName]
            }
        }

        if (payment.info.sum <= 0) {
            payment.doPay()
            return true
        }

        if (payment.info.delta < 0) {
            payment.getProviders().then(function() {
                payment.render(text, sum_display)
            })
        } else {
            payment.render(text, sum_display)
        }
    }
}

$(document).ready(payment.check)

/* 
 * phoneEdit.js
 */
var phoneEdit = {
    list : null,

    inited    : false,
    countries : [],
    codes     : false,

    tpl : {
        main :
            '<div class="formItem" formitem-elem="main">' +
                '<div class="phoneEdit" phoneedit-elem="main" data-code="{{ phone_code }}" data-default="{{ default.iso }}">' +
                    '<div class="phoneEdit_toggler flag16x11" phoneedit-action="toggle" data-iso="{{ iso }}"></div>' +
                    '<input class="phoneEdit_field" type="text" name="{{ name }}[number]{% if multiple %}[]{% endif %}" data-phone="number" value="{{ phone }}" formitem-default="{{ default.phone_code }}" formitem-on="keyup">' +
                    '<input class="h" type="hidden" name="{{ name }}[iso]{% if multiple %}[]{% endif %}" data-phone="iso" value="{{ iso }}" formitem-default="{{ default.iso }}">' +
                    '{% if canEmpty %}' +
                        '<input type="hidden" ff-empty="[ff]' + t('phone') + '[/ff]" ff-group="phone" phoneedit-elem="ff" value="1" phoneedit-canempty="1" formitem-default="1">' +
                    '{% else %}' +
                        '<input type="hidden" ff-empty="[ff]' + t('phone') + '[/ff]" ff-group="phone" phoneedit-elem="ff" value="{{ ffValid }}">' +
                    '{% endif %}' +
                '</div>' +
                '{% if multiple %}' +
                    '<div class="formItem_action-del" formitem-action="del"></div>' +
                    '<div class="formItem_action-add" formitem-action="add"></div>' +
                '{% endif %}' +
            '</div>',
    },

    timer : {},

    render : function(phones, params) {
        with (phoneEdit) {
            var country = (USER && USER.country) || (params && params.country) || null
            if (!phones || !phones.length) {
                phones = [{
                    phone : country.phone_code,
                    label : 'phone',
                    extra : {
                        iso        : country.iso,
                        phone_code : country.phone_code
                    },
                    value : country.phone_code
                }];
            }

            var items = '';
            for (var i=0; phones[i]; i++) {
                var phone = phones[i];

                if (('' + phone.extra.phone_code)[0] !== '+') {
                    phone.extra.phone_code = '+' + phone.extra.phone_code;
                }
                items += simpleTpl(tpl.main, {
                    name       : params.name || 'phone',
                    phone      : phone.value.replace(' ext. ', '#'),
                    iso        : phone.extra.iso,
                    phone_code : phone.extra.phone_code,
                    label      : phone.label,
                    canEmpty   : params && params.canEmpty,
                    multiple   : params && params.multiple,
                    ffValid    : +phone.value.length > 10,
                    default    : country
                });
            }
            if (!inited) {
                init(true);
            }
            return items;
        }
    },

    /*
     * Проверка введённого телефона. Сверяем код страны и меняем флажок
     * @param $main - jQ-блок с формой телефона
     */
    checkCountry : function($main) {
        with (phoneEdit) {
            var $phone  = $main.find('[data-phone="number"]'),
                oldCode = $main.attr('data-code'),
                code    = $phone.val().match(/\+\d+/g),
                iso     = $main.attr('data-default');

            if (code) {
                code = code[0];
                while ( !codes[code] && (code.length > 0) ) {
                    code = code.slice(0, -1);
                }
                if ( (code == '+1') && (iso != 'CA') ) {
                    iso = 'US';
                } else if ( (code == '+7') && (iso != 'KZ') ){
                    iso = 'RU';
                } else {
                    iso = codes[code];
                }
            }

            if ($main.attr('data-code') != code) {
                $main.find('[phoneedit-action="toggle"]').attr('data-iso', iso);
                $main.find('[data-phone="iso"]').val(iso);
                $main.attr('data-code', code);
            }
            error.hide($main);
            checkPhone($main);
        }
    },

    /*
     * Выбор страны из списка
     * @param $main - jQ-блок с формой телефона
     * @param code - код страны (с "+")
     * @param iso - ISO-код страны
     */
    select : function($main, code, iso) {
        with (phoneEdit) {
            if (code[0] !== '+') {
                code = '+' + code;
            }
            $main.find('[phoneedit-action="toggle"]').attr('data-iso', iso);
            $main.find('[data-phone="iso"]').val(iso);

            var $phone = $main.find('[data-phone="number"]'),
                phone = $phone.val(),
                oldCode = $main.attr('data-code');
            if (oldCode && (phone != '') ) {
                phone = phone.replace(oldCode, code + ' ').replace(/  /g, ' ');
            } else {
                phone = code + ' ' + phone.replace('+', ' ');
            }
            $phone.val(phone).focus();
            $main.attr('data-code', code);

            list.hide();

            error.hide($main);
            checkPhone($main);
        }
    },

    checkPhone : function($main, force) {
        with (phoneEdit) {
            var phone = $main.find('[data-phone="number"]').val(),
                $ff   = $main.find('[phoneedit-elem="ff"]'),
                val   = ( (phone == '') && $ff.is('[phoneedit-canempty="1"]') ) ? 1 : '';
            $ff.val(val).change();

            if ( !force && (phone.length < 9) ) {
                return true;
            }

            var timerId = $main.attr('data-timer') || false;
            if (timerId) {
                clearTimeout(timer[timerId]);
            } else {
                timerId = (new Date()).getTime() + '';
                $main.attr('data-timer', timerId);
                timer[timerId] = 0;
            }
            timer[timerId] = setTimeout(function() {
                $.ajax({
                    type     : 'GET',
                    url      : API_URL + '/v2/tools/phoneCheck',
                    data     : {
                        phone : $main.find('[data-phone="number"]').val(),
                        iso   : $main.find('[data-phone="iso"]').val()
                    },
                    dataType : 'json',
                    xhrFields : {
                        withCredentials: true
                    },
                    success  : function(json){
                        if (json.ok == 0 && json.error) {
                            phoneEdit.error.show($main, json.error);
                        } else {
                            $main.find('[phoneedit-elem="ff"]').val(1).change();
                        }
                        $main.removeAttr('data-timer');
                        delete phoneEdit.timer[timerId];
                    }
                });
            }, 700);
        }
    },

    blur : function($main) {
        var $ff = $main.find('[phoneedit-elem="ff"]');
        if ($ff.val() == '') {
            phoneEdit.checkPhone($main, true);
        }
    },

    error : {
        tpl  : '<div class="phoneEdit_error" phoneedit-elem="error" formitem-noclone>{{ text }}</div>',

        hide : function($main) {
            $main.find('[phoneedit-elem="error"]').remove();
            $main.removeClass('_error');
        },
        show : function($main, text) {
            with (phoneEdit.error) {
                hide($main);
                simpleTpl(tpl, {text:text}, true).appendTo($main);
                $main.addClass('_error');
            }
        }
    },

    loadCodes : function() {
        $.ajax({
            type     : 'GET',
            url      : API_URL + '/v2/countries',
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            },
            success  : function(json) {
                with (phoneEdit) {
                    var countries = json.countries;
                    codes = {};
                    for (var i=0; countries[i]; i++) {
                        if (('' + countries[i].phone_code)[0] !== '+') {
                            countries[i].phone_code = '+' + countries[i].phone_code;
                        }
                        if (codes[countries[i].phone_code]) {
                            continue;
                        }
                        codes[countries[i].phone_code] = countries[i].iso;
                    }
                }
            }
        });
    },

    events : {
        click : function(ev){
            var $el = $(ev.target);

            if ( (phoneEdit.$list !== false) && !$el.closest('[phoneedit-elem="main"]').length ) {
                phoneEdit.list.hide();
            }
            if ($el.is('[phoneedit-action]')) {
                var $main = $el.closest('[phoneedit-elem="main"]');
                switch ($el.attr('phoneedit-action')) {
                    case 'toggle' : phoneEdit.list.toggle($main); break;
                    case 'select' : phoneEdit.select($main, $el.attr('data-code'), $el.attr('data-iso')); break;
                }
            }
        },
        keyup : function(ev) {
            var $el = $(ev.target);

            if ($el.is('[data-phone="number"]')) {
                var key = ev.keyCode;
                if (key >= 35 && key <= 41) { // home, end, left, right
                    return true;
                }
                var $main = $el.closest('[phoneedit-elem="main"]');
                phoneEdit.checkCountry($main);
            }
        },
        select : function(ev) {
            var $el = $(ev.target);

            if ($el.is('[data-phone="number"]')) {
                var $main = $el.closest('[phoneedit-elem="main"]');
                phoneEdit.checkCountry($main);
            }
        },
        keydown : function(ev) {
            var $el = $(ev.target);

            if ($el.is('[data-phone="number"]')) {
                var shift = ev.shiftKey,
                    ctrl = (ev.ctrlKey === true),
                    key = ev.keyCode;
                if (
                     !(key >= 35 && key <= 39) && // home, end, left, right
                     !(key == 8 || key == 32 || key == 46) && // backspace, space, delete
                     !(ctrl && (key == 65 || key == 67 || key == 86 || key == 88)) && // Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                     !(!shift && (key == 173) || key == 109) && // минус
                     !(shift && (key == 61) || (key == 107)) && // плюс
                     !(shift && (key == 57 || key == 48)) && // скобошки (.)(.)
                     !(shift && (key == 51)) && // решётка #
                     !(!shift && (key >= 48 && key <= 57) || (key >= 96 && key <= 105))
                    ) {
                    return false;
                }
            }
        },
        focusout : function(ev) {
            var $el = $(ev.target);
            if ($el.is('[data-phone="number"]')) {
                var $main = $el.closest('[phoneedit-elem="main"]');
                phoneEdit.blur($main);
            }
        }
    },

    init : function(_force) {
        with (phoneEdit) {
            if (inited) {
                return true;
            }
            if (!$('[phoneedit-elem="main"]').length && !_force) {
                return false;
            }
            if (codes === false) {
                loadCodes();
            }
            $(window).on(events);
            inited = true;
        }
    }
}

$(document).ready(function() {
    phoneEdit.init();
});

/* 
 * phoneEdit_list.js
 */
phoneEdit.list = {
    $main : false,

    tpl : {
        main : '<div class="phoneEdit_countries">{{ items }}</div>',
        item : '<div class="phoneEdit_country flag16x11" data-iso="{{ iso }}" data-code="{{ phone_code }}" phoneedit-action="select">{{ name }}</div>',
    },


    show : function($phoneEdit) {
        with (phoneEdit.list) {
            if ($main !== false) {
                hide();
            }

            var pageHeight = $(document).height(),
                items = '';

            for (var i=0; phoneEdit.countries[i]; i++) {
                var item = simpleTpl(tpl.item, phoneEdit.countries[i]);
                items += item;
            }
            $main = simpleTpl(tpl.main, {items:items}, true).appendTo($phoneEdit);

            if ( pageHeight < ($phoneEdit.offset().top + $main.height()) ) {
                $main.addClass('_upper');
            }
            $phoneEdit.addClass('_expanded');
        }
    },

    hide : function() {
        with (phoneEdit.list) {
            if ($main === false) {
                return true;
            }

            $main.closest('[phoneedit-elem="main"]').removeClass('_expanded');
            $main.remove();
            $main = false;
        }
    },

    toggle : function($phoneEdit) {
        with (phoneEdit.list) {
            if ($phoneEdit.hasClass('_expanded')) {
                hide();
            } else {
                show($phoneEdit);
            }
        }
    },

}

/* 
 * postVotes.js
 */
var postVotes = {
    $main : null,

    lastId : 0,
    tpl : {
        main :
            '<div class="postVotes">'+
                '<span class="postVotes_good">{{ good }}</span>' +
                '<span class="postVotes_bad">{{ bad }}</span>' +
                '<p class="postVotes_title">' + t('People that supported') + '</p>' +
                '<div class="postVotes_users">{{ users }}</div>' +
                '<div class="postVotes_close" postvotes-action="close"></div>' +
            '</div>',
        user : '<a class="postVotes_user" href="{{ href }}"><img width="50" height="50" src="{{ avatar }}"></a>'
    },

    close : function() {
        with (postVotes) {
            if ($main === null) {
                return true;
            }
            $main.remove();
            $main = null;
            lastId = 0;
        }
    },

    render : function(info) {
        with (postVotes) {
            info.users = '';
            info.good = info.good || null;
            info.bad  = info.bad || null;
            for (var i in info.user) if (info.user.hasOwnProperty(i)) {
                info.users += simpleTpl(tpl.user, info.user[i]);
            }
            return $(simpleTpl(tpl.main, info));
        }
    },

    show : function($block) {
        with (postVotes) {
            var id = +$block.attr('postvotes-id');
            if (id == lastId) {
                close();
                return true;
            }

            if ($main !== null) {
                close();
            }
            $.ajax({
                type     : 'POST',
                url  : '/a/comment/showvotes/',
                data : {
                    action : $block.attr('postvotes-type'),
                    comment_id : id,
                    BITRIX_SECURITY_KEY : BITRIX_SECURITY_KEY,
                },
                dataType : 'json',
                success  : function(json) {
                    with (postVotes) {
                        $main = render(json).appendTo($block);
                        lastId = id;
                    }
                }
            });
        }
    },

    init : function() {
        $(window).on('click', function(ev){
            var $el = $(ev.target);
            if ($el.is('[postvotes-action]')) {
                switch ($el.attr('postvotes-action')) {
                    case 'close' : postVotes.close(); break;
                    case 'show'  : postVotes.show($el); break;
                }
            } else if (!$el.closest('[postvotes-action="show"]').length) {
                postVotes.close();
            }
        });
    }
}

$(document).ready(function(){
    postVotes.init();
})

/*
        // функция показа голосов
        var postVotesTpl = forumTopics.find('#post_votes');
        function commentShowVotes(commentId)
        {
            forumTopics.find('.post_votes').addClass('h');

            $.ajax({
                type : 'POST',

                dataType : 'json',
                success  : function(result) {
                    var commentElem = forumTopics.find('#comment_' + commentId);
                    var markElem    = commentElem.find('.post_mark');
                    var votesElem   = markElem.find('.post_votes');

                    if (votesElem.size() == 0) {
                        votesElem = postVotesTpl.clone().removeAttr('id').appendTo(markElem);
                    }

                    var votesUser = votesElem.find('.post_v_users').removeClass('h').empty();
                    if (result.good > 0) {
                        votesElem.find('.post_v_good').text(result.good).removeClass('h');
                        votesElem.find('.post_v_title').removeClass('h');
                        if (result.user.length > 9) {
                            votesUser.removeClass('post_v_center');
                        } else {
                            votesUser.addClass('post_v_center');
                        }

                        for (var i in result.user) {
                            var userElem = $('<a />').attr({
                                'class' : 'post_v_user',
                                'href'  : result.user[i].href
                            });
                            $('<img />').attr({
                                'height' : 50,
                                'width'  : 50,
                                'src'    : result.user[i].avatar
                            }).appendTo(userElem);
                            userElem.appendTo(votesUser);
                        }

                    } else {
                        votesElem.find('.post_v_good').addClass('h');
                        votesElem.find('.post_v_title').addClass('h');
                    }

                    if (result.bad > 0) {
                        votesElem.find('.post_v_bad').text(result.bad).removeClass('h');
                    } else {
                        votesElem.find('.post_v_bad').addClass('h');
                    }

                    var value = result.good - result.bad;
                    markElem.attr('data-mark', value);

                    votesElem.removeClass('h');
                }
            });
        }
*/
/* 
 * ppContacts.js
 */
var ppContacts = {
    map  : null,
    form : null,

    $main      : null,
    $summoner  : null,

    $contacts  : null,
    $bubble    : null,
    $branches  : null,
    $feedback  : null,
    $bigs      : null,
    $worktime  : null,
    $phones    : null,
    $toggler   : {
        tomap      : null,
        tocontacts : null
    },

    more : {
        $button : null,
        $bubble : null,
        isShow  : false
    },
    binded : false,
    branchId : 0,
    info : {
        userId : 0,
        contentId : 0,
        contentType : '',
        controller : '',
        content : {},
        commission : false,
        feedback_list: [],
    },

    isReachGoal : false,

    tpl : {
        main : Twig.twig({data:
            '<div class="ppContacts _contacts">' +
                '{% if content.objectName %}' +
                    '<p class="ppContacts_objectName">{{ content.objectName }}</p>' +
                '{% endif %}' +
                '<p class="ppContacts_name">{{ content.name }}</p>' +
                '{% if content.isShowGift %}' +
                    '<a class="gift" gift-action="show" object-type="Venue" object-id="{{ content.id }}" source="contacts">' + '<b>Сертификат в подарок</b> при бронировании этого ресторана' +'</a>' +
                '{% endif %}' +
                '{{ address }}' +
                '{{ contacts }}' +
            '</div>'
        }),
        contacts :
            '<div ppcontacts-elem="contacts">' +
                '<div class="ppContacts_bigs{% if not big$ %} h{% endif %}" ppcontacts-elem="bigs">{{ big$ }}</div>' +
                '<p class="ppContacts_worktime{% if not working_hours %} h{% endif %}" ppcontacts-elem="worktime">{{ working_hours }}</p>' +
                '<p class="ppContacts_gorko">' + t('Please mention that you found the information at <i>{site_name}</i> : )') + '</p>' +
                '{{ form$ }}' +
                '{% if feedbacks$ %}' +
                    '<div class="ppContacts_talk">' +
                        '<p class="ppContacts_caption">' + t('Call feedback') + '</p>' +
                        '<div class="ppContacts_feedbacks">' +
                            '{{ feedbacks$ }}' +
                        '</div>' +
                        '<p class="ppContacts_notice">' + t('Your feedback on the call is anonymous. It will be used to improve the quality of {site_name} services') + '</p>' +
                    '</div>' +
                '{% endif %}' +
                '<div class="ppContacts_foot clearA">' +
                    '{% if phones$ %}' +
                        '<div class="ppContacts_phones" ppcontacts-elem="phones">' +
                            '<p class="ppContacts_label">' + t('Additional phones') + '</p>' +
                            '{{ phones$ }}' +
                        '</div>' +
                        '{% endif %}' +
                    '<div class="ppContacts_links">' +
                        '{{ links$ }}' +
                    '</div>' +
                '</div>' +
            '</div>',
        big :
            '<div class="ppContacts_big">' +
                '<span class="ppContacts_big_name">{{ name }}</span>' +
                '{{ text }}' +
                '{% if chat %}<a href="{{ chat }}" class="ppContacts_action-chat" data-contact_id="{{ id }}"></a>{% endif %}' +
                '{% if call %}<a href="{{ call }}" class="ppContacts_action-call" data-contact_id="{{ id }}"></a>{% endif %}' +
            '</div>',
        feedback : '<a class="ppContacts_feedback" ppcontacts-action="feedback" feedback-id="{{ id }}">{{ text }}</a>',
        phone : '<p class="ppContacts_phone{% if hidden %} h{% endif %}" ppcontacts-elem="phone">{{ phone }}</p>',
        link : {
            normal :
                '<a href="{{ url }}" class="ppContacts_link-{{ social }}" target="_blank" ppcontacts-hover="full_link" data-hover_text="{{ text }}" ppcontacts-action="link" data-contact_id="{{ id }}">' +
                    '{% if social == "site" %}<span class="ppContacts_site">{{ text }}</span>{% endif %}' +
                '</a>',
            collapsed :
                '<a href="{% if social == "email" %}mailto:{% endif %}{{ url }}" class="ppContacts_link-{{ social }}" target="_blank"{% if not collapsed %} ppcontacts-hover="full_link" data-hover_text="{{ text }}"{% endif %} ppcontacts-action="link" data-contact_id="{{ id }}">' +
                    '<span class="ppContacts_site">{{ text }}</span>' +
                '</a>',
        },
        moreLinks : '<div class="ppContacts_link-more" ppcontacts-action="more_links"></div>',
        bubble : '<span class="bubble-dark">{{ content }}</span>',
        address : {
            main : Twig.twig({data:
                '<div class="ppContacts_address">' +
                    '{% if canMap %}' +
                        '<a class="ppContacts_onmap" ppcontacts-action="onmap">' + t('Show on map') + '</a>' +
                        '<a class="ppContacts_tocontacts h" ppcontacts-action="tocontacts">' + t('Show contact info') + '</a>' +
                    '{% endif %}' +
                    '{% if addresses.length > 1 %}' +
                        '<select class="ppContacts_branches" ppcontacts-action="branch">' +
                            '{% for address in addresses %}' +
                                '<option value="{{ address.id }}"{% if address.selected %} selected{% endif %}>{{ address.address }}</option>' +
                            '{% endfor %}' +
                        '</select>' +
                    '{% else %}' +
                        '{% if canMap %}' +
                            '<a class="ppContacts_address-link" ppcontacts-action="onmap">{{ addresses[0].address }}{% if landmark %} – <b>{{ landmark }}</b>{% endif %}</a>' +
                            '<span class="ppContacts_address-name">{{ addresses[0].address }}{% if landmark %} – <b>{{ landmark }}</b>{% endif %}</span>' +
                        '{% else %}' +
                            '{{ addresses[0].address }}{% if landmark %} – <b>{{ landmark }}</b>{% endif %}' +
                        '{% endif %}' +
                    '{% endif %}' +
                '</div>'
            }),
        }
    },

    init : function() {
        if (ppContacts.binded) {
            return true
        }
        $(window).on(ppContacts.events);
        ppContacts.binded = true
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.closest('[ppcontacts-action]').length) {
                $el = $el.closest('[ppcontacts-action]')
                var action = $el.attr('ppcontacts-action')
                switch (action) {
                    case 'showmap' :
                    case 'show'    :
                        if ($el.is('._disabled')) {
                            return false
                        }
                        return ppContacts.show({
                            userId      : +$el.attr('cp-user'),
                            contentId   : +$el.attr('cp-contentid'),
                            contentType : $el.attr('cp-contenttype'),
                            controller  : $el.attr('controller'),
                            action      : action
                        }, $el)
                    case 'onmap' : return ppContacts.showMap()
                    case 'tocontacts' : return ppContacts.toContacts()
                    case 'more_links' : return ppContacts.moreLinks()
                    case 'feedback' : return ppContacts.feedback.set($el)
                    case 'link' : return ppContacts.link($el.attr('data-contact_id'))
                }
            } else if (!$el.closest('[ppcontacts-action="more_links"]').length) {
                ppContacts.moreLinks(false);
            }
        },
        mouseenter : function(ev) {
            var $el = $(ev.target)
            if ($el.closest('[ppcontacts-hover="full_link"]').length) {
                ppContacts.showFullLink($el, true)
            } else {
                ppContacts.showFullLink(null, false)
            }
        },
        change : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[ppcontacts-action="branch"]')) {
                ppContacts.switchBranch($el.val())
            }
        }
    },

    toContacts : function() {
        ppContacts.$contacts.removeClass('h')
        ppContacts.map.$main.addClass('h')
        ppContacts.$toggler.tomap.removeClass('h')
        ppContacts.$toggler.tocontacts.addClass('h')
        ppContacts.reachGoal('showContacts')
        ppContacts.$main.removeClass('_map').addClass('_contacts')
    },

    showMap : function() {
        ppContacts.$contacts.addClass('h')
        if (ppContacts.map.opened) {
            ppContacts.map.$main.removeClass('h')
        } else {
            var points = []
            var content = ppContacts.info.content
            if (content.branches) {
                var branches = content.branches
                for (var i=0; branches[i]; i++) {
                    var branch = branches[i]
                    points.push({
                        branchId : branch.id,
                        opened   : ppContacts.branchId == branch.id,
                        address  : branch.address,
                        coords   : [branch.coords.latitude, branch.coords.longitude]
                    })
                }
            } else {
                var address =  content.address
                if (content.landmark) {
                    address += ' – ' + content.landmark
                }
                points.push({
                    opened  : true,
                    address : address,
                    coords  : [content.coords.latitude, content.coords.longitude]
                })
            }
            ppContacts.map.init(points)
        }
        ppContacts.$toggler.tomap.addClass('h')
        ppContacts.$toggler.tocontacts.removeClass('h')
        ppContacts.$main.addClass('_map').removeClass('_contacts')
    },

    grabContacts : function(_contacts, _info, _branch) {
        var cache = {
            phones     : [],
            links      : [],
            messengers : [],
        }
        if (_info.phones) {
            for (var i=0; _info.phones[i]; i++) {
                cache.phones.push(_info.phones[i].number)
            }
        }
        if (_info.links) {
            for (var i=0; _info.links[i]; i++) {
                cache.links.push(_info.links[i].text)
            }
        }
        if (_info.messengers) {
            for (var i=0; _info.messengers[i]; i++) {
                cache.messengers.push(_info.messengers[i].text)
            }
        }

        for (var i=0; _contacts[i]; i++) {
            var contact = _contacts[i]
            contact.value += ''
            switch (contact.key) {
                case 'address' : _info.address = contact.value; break
                case 'phone' :
                    if (cache.phones.indexOf(contact.value) >= 0) {
                        break
                    }
                    if (!_info.phones) {
                        _info.phones = []
                    }
                    _info.phones.push({
                        number   : contact.value,
                        branchId : (_branch) ?_branch.id : 0,
                        channel : contact.extra && contact.extra.channel ? contact.extra.channel : null,
                    })
                    cache.phones.push(contact.value)
                    break
                case 'email' :
                case 'url'   :
                    if (!_info.links) {
                        _info.links = {
                            normal : [],
                            collapsed : [],
                        }
                    }
                    var link = {
                        id : contact.id,
                        url  : contact.value,
                        test  : contact.value.replace(/(https?:\/\/[^\/]+).*/, '$1'),
                        text : contact.value.replace(/(?:https?:\/\/)?([^\/]+).*/, '$1'),
                    }
                    if (cache.links.indexOf(link.text) >= 0) {
                        break
                    }
                    if (contact.key == 'email') {
                        link.social = 'email'
                        link.url = 'mailto:' + link.url
                    } else if (/fb.com|facebook.com/i.test(link.test)) {
                        link.social = 'fb'
                    } else if (/vk.com|vkontakte.ru/i.test(link.test)) {
                        link.social = 'vk'
                    } else if (/twitter.com/i.test(link.test)) {
                        link.social = 'tw'
                    } else if (/plus.google.com/i.test(link.test)) {
                        link.social = 'gplus'
                    } else if (/odnoklassniki.ru|\/\/ok.ru/i.test(link.test)) {
                        link.social = 'ok'
                    } else if (/gorko.ru|wedding.net/i.test(link.test)) {
                        link.social = 'gorko'
                    } else if (/instagram.com/i.test(link.test)) {
                        link.social = 'ig'
                    } else {
                        link.social = 'site'
                    }

                    if ( (link.social != 'email') && (!/http(s|):\/\//.test(link.url)) ) {
                        link.url = 'http://' + link.url;
                    }
                    if (link.social == 'site') {
                        if (_info.links.normal.getBy('social', 'site')) {
                            type = 'collapsed'
                            _info.links.collapsed.push(link)
                        } else {
                            _info.links.normal.unshift(link)
                            if (_info.links.normal[5]) {
                                _info.links.collapsed.unshift(_info.links.normal[5])
                            }
                        }
                    } else {
                        var type = _info.links.length >= 5 ? 'collapsed' : 'normal'
                        _info.links[type].push(link)
                    }
                    cache.links.push(contact.value)
                    break
                case 'telegram' :
                case 'viber'    :
                case 'whatsapp' :
                case 'line'     :
                    if (!_info.messengers) {
                        _info.messengers = []
                    }
                    if (cache.messengers.indexOf(contact.key + '_' + contact.value) >= 0) {
                        break
                    }
                    var messenger = {
                        id : contact.id,
                        name : null,
                        chat : null,
                        call : null,
                        text : contact.value,
                    }
                    if (contact.key == 'telegram') {
                        messenger.name = 'Telegram'
                        messenger.chat = 'tg://resolve?domain=' + contact.value
                    } else if (contact.key == 'viber') {
                        messenger.name = 'Viber'
                        messenger.chat = 'viber://chat?number=%2B' + contact.value.replace(/[^\d]/g, '')
                    } else if (contact.key == 'whatsapp') {
                        messenger.name = 'WhatsApp'
                        messenger.chat = 'whatsapp://send?phone=' + contact.value
                    } else if (contact.key == 'line') {
                        messenger.name = 'Line'
                        messenger.call = 'http://line.me/ti/p/~' + contact.value
                    }
                    _info.messengers.push(messenger)
                    cache.messengers.push(contact.key + '_' + contact.value)
                    break
            }
        }
    },

    prepare : function(_info) {
        var info = {
            id            : _info.id,
            name          : _info.name,
            hasMap        : _info.type || _info.role && _info.role.has_map,
            coords        : _info.coords || null,
            landmark      : _info.landmark || null,
            type          : _info.type || _info.role || {key:ppContacts.info.contentType.toLowerCase()},
            commission    : _info.commission,
            isShowGift    : _info.show_gift,
        }
        if (_info.branches) {
            info.branches = _info.branches
            ppContacts.branchId = info.branches[0].id
            for (var i=0; info.branches[i]; i++) {
                var branch = info.branches[i]
                ppContacts.grabContacts(branch.contacts, info, branch)
            }
        } else {
            if (_info.contacts) {
                ppContacts.grabContacts(_info.contacts, info)
            }
        }
        if (info.phones) {
            info.mainPhone = info.phones[0].number
        }
        if (_info.commission === 4 || _info.commission === 5) { // pay per call
            delete info.phones
            delete info.links
            delete info.messengers
        }
        if (ppContacts.info.contentType.toLowerCase() === 'car') {
            info.name = _info.user.name
        }
        if (info.type.key == 'user') {
            info.hasFreeDate = _info.has_free_date
        }
        return info
    },

    load : function(info) {
        var data = {
            embed  : [],
            fields : ['coords','contacts','feedback_list']
        }
        if (info.contentType === 'user') {
            data.fields.push('has_free_date')
        }
        if (info.contentType === 'shop') {
            data.embed.push('branches')
            data.set_city = CITY_ID
        }
        if (info.contentType.toLowerCase() === 'car') {
            data.embed.push('user')
        }
        data.embed  = data.embed.join(',')
        data.fields = data.fields.join(',')
        return $.ajax({
            type      : 'GET',
            url       : API_URL + '/v2/' + info.contentType.toLowerCase() + 's/' + info.contentId,
            data      : data,
            dataType  : 'json',
            xhrFields : {
                withCredentials : true
            }
        });
    },

    showFullLink : function(_$link, _isShow) {
        if (ppContacts.$bubble !== null) {
            ppContacts.$bubble.remove()
        }
        if (!_isShow) {
            return true
        }
        ppContacts.$bubble = simpleTpl(ppContacts.tpl.bubble, {content:_$link.attr('data-hover_text')}, true)
        ppContacts.$bubble.appendTo(_$link)
    },

    moreLinks : function(_isShow) {
        if (_isShow !== true && _isShow !== false) {
            _isShow = !ppContacts.more.isShow
        }
        ppContacts.more.isShow = _isShow

        if (_isShow === false) {
            if (ppContacts.more.$bubble === null) {
                return true
            }
            ppContacts.more.$bubble.remove()
            ppContacts.more.$bubble = null
            ppContacts.more.$button.removeClass('_expanded')
            return true
        }

        var content$ = ''
        ppContacts.info.content.links.collapsed.forEach(function(link) {
            content$ += simpleTpl(ppContacts.tpl.link.collapsed, link)
        })
        ppContacts.more.$bubble = simpleTpl(ppContacts.tpl.bubble, {content:content$}, true)
        ppContacts.more.$bubble.appendTo(ppContacts.more.$button)
        ppContacts.more.$button.addClass('_expanded')
    },

    switchBranch : function(_branchId, _fromMap) {
        _branchId = +_branchId
        var branch = null,
            content = ppContacts.info.content,
            branches = content.branches
            big$ = ''
        for (var i=0; branches[i]; i++) {
            if (branches[i].id == _branchId) {
                branch = branches[i]
                break
            }
        }
        if (content.phones && content.phones.length) {
            for (var i=0; content.phones[i]; i++) {
                if (content.phones[i].branchId == _branchId) {
                    content.mainPhone = content.phones[i].number
                    break
                }
            }
            big$ = simpleTpl(ppContacts.tpl.big, {
                name : t('Phone'),
                text : content.mainPhone,
            })
            if (!ppContacts.$phones.length) {
                ppContacts.$phones.removeClass('h')
                $(ppContacts.$phones[i]).addClass('h')
            }
        }
        if (content.messengers) {
            for (var i=0; content.messengers[i]; i++) {
                big$ += simpleTpl(ppContacts.tpl.big, content.messengers[i])
            }
        }
        ppContacts.$bigs.html(big$)
        if (branch.working_hours) {
            ppContacts.$worktime.text(branch.working_hours).removeClass('h')
        } else {
            ppContacts.$worktime.addClass('h')
        }
        ppContacts.branchId = _branchId
        if (_fromMap) {
            if (ppContacts.$branches !== null) {
                ppContacts.$branches.val(_branchId)
            }
        } else if (ppContacts.map.opened) {
            ppContacts.map.openBranch(ppContacts.branchId)
        }
    },

    render : {
        main : function() {
            var tplParams = ppContacts.info
            tplParams.address = ppContacts.render.address()
            tplParams.feedbacks$ = ppContacts.render.feedbacks()

            if (tplParams.content.phones && tplParams.content.phones.length > 1) {
                tplParams.phones$ = ppContacts.render.phones()
            }
            if (tplParams.content.links) {
                tplParams.links$ = ppContacts.render.links()
            }
            if (tplParams.content.branches) {
                tplParams.working_hours = tplParams.content.branches[0].working_hours
            }
            if (!USER.isGuest) {
                tplParams.form$ = ppContacts.form.render()
            }
            if (tplParams.content.mainPhone) {
                tplParams.big$ = simpleTpl(ppContacts.tpl.big, {
                    name : t('Phone'),
                    text : tplParams.content.mainPhone,
                })
            } else {
                tplParams.big$ = ''
            }
            if (tplParams.content.messengers) {
                for (var i=0; tplParams.content.messengers[i]; i++) {
                    tplParams.big$ += simpleTpl(ppContacts.tpl.big, tplParams.content.messengers[i])
                }
            }
            tplParams.contacts = simpleTpl(ppContacts.tpl.contacts, tplParams)
            return $(ppContacts.tpl.main.render(tplParams))
        },
        links : function() {
            var result$ = ''
            ppContacts.info.content.links.normal.forEach(function(link) {
                result$ += simpleTpl(ppContacts.tpl.link.normal, link)
            })
            if (ppContacts.info.content.links.collapsed && ppContacts.info.content.links.collapsed.length) {
                result$ += simpleTpl(ppContacts.tpl.moreLinks)
            }
            return result$
        },
        phones : function() {
            var result$ = ''
            var phones = ppContacts.info.content.phones
            for (var i=0; phones[i]; i++) {
                var hidden = false
                if (i == 0) {
                    if (ppContacts.info.contentType != 'shop') {
                        continue
                    }
                    hidden = true
                }
                result$ += simpleTpl(ppContacts.tpl.phone, {
                    phone   : phones[i].number,
                    hidden  : hidden
                })
            }
            return result$
        },
        address : function() {
            var result$ = ''
            var canMap = true
            var addresses = []
            if (ppContacts.info.content.branches) {
                var branches = ppContacts.info.content.branches
                if (branches.length == 1) {
                    addresses.push({
                        id      : 0,
                        address : branches[0].address,
                    })
                } else {
                    addresses = branches
                }
            } else if (ppContacts.info.content.address) {
                var coords = ppContacts.info.content.coords
                canMap = coords && coords.latitude && coords.longitude
                addresses.push({
                    id      : 0,
                    address : ppContacts.info.content.address,
                })
            }
            if (addresses.length) {
                result$ = ppContacts.tpl.address.main.render({
                    addresses : addresses,
                    landmark  : ppContacts.info.content.landmark,
                    canMap    : canMap,
                })
            }
            return result$
        },
        feedbacks : function() {
            var result$ = ''
            if (!USER.isGuest && USER.group != 'nevesta') {
                return result$
            }
            feedback = null
            for (var i in ppContacts.info.feedback_list) if (ppContacts.info.feedback_list.hasOwnProperty(i)) {
                result$ += simpleTpl(ppContacts.tpl.feedback, {
                    text: ppContacts.info.feedback_list[i].text,
                    id: ppContacts.info.feedback_list[i].id,
                    selected: feedback == ppContacts.info.feedback_list[i].id
                })
            }
            return result$
        }
    },

    feedback : {
        set : function(_$feedback) {
            viewInfo({}, {'feedback': _$feedback.attr('feedback-id')}, ppContacts.$summoner)
            if (ppContacts.$feedback !== null) {
                ppContacts.$feedback.removeClass('_selected')
            }
            ppContacts.$feedback = _$feedback
            ppContacts.$feedback.addClass('_selected')
        },
        onload : function(feedback) {
            ppContacts.$feedback = ppContacts.$main.find('[feedback-id="' + feedback +'"]')
            ppContacts.$feedback.addClass('_selected')
        }
    },

    show : function(info, $summoner, additional) {
        if ($summoner) {
            ppContacts.$summoner = $summoner
        }
        ppContacts.$summoner.prop('disabled', true).addClass('_disabled')
        ppContacts.info = info
        ppContacts.load(info).then(function(json) {
            ppContacts.info.feedback_list = json[info.contentType.toLowerCase()].feedback_list
            ppContacts.info.content = ppContacts.prepare(json[info.contentType.toLowerCase()])
            if (additional) {
                if (additional.objectName) {
                    ppContacts.info.content.objectName = additional.objectName
                }
            }

            ppContacts.$main = ppContacts.render.main()
            ppContacts.$contacts = ppContacts.$main.find('[ppcontacts-elem="contacts"]')
            ppContacts.more.$button = ppContacts.$main.find('[ppcontacts-action="more_links"]')
            ppContacts.$bigs = ppContacts.$main.find('[ppcontacts-elem="bigs"]')
            ppContacts.$worktime = ppContacts.$main.find('[ppcontacts-elem="worktime"]')
            ppContacts.$phones = ppContacts.$main.find('[ppcontacts-elem="phone"]')
            if (!ppContacts.$phones.length) {
                ppContacts.$phones = null
            }
            ppContacts.$branches = ppContacts.$main.find('[ppcontacts-action="branch"]')
            if (!ppContacts.$branches.length) {
                ppContacts.$branches = null
            }
            ppContacts.$toggler.tomap = $(ppContacts.$main.find('[ppcontacts-action="onmap"]')[0])
            ppContacts.$toggler.tocontacts = ppContacts.$main.find('[ppcontacts-action="tocontacts"]')

            ppContacts.form.init()

            if (info.action === 'show') {
                ppContacts.reachGoal('showContacts')
            }
            viewInfo({}, {'phone': 1}, ppContacts.$summoner)

            ppContacts.$summoner.prop('disabled', false).removeClass('_disabled')
            lightbox.show(ppContacts.$main, 700, {close:ppContacts.close}, {isOver:true})
            if (ppContacts.$summoner.attr('ppcontacts-action') == 'showmap') {
                ppContacts.showMap()
            }
        })
    },

    close: function() {
        if (ppContacts.map.opened) {
            ppContacts.map.close()
        }
        ppContacts.form.close()
        ppContacts.$main = null
    },

    link: function (contactId) {
        console.log({
            contact_id : contactId
        });
        $.ajax({
            type      : 'POST',
            url       : API_URL + '/v2/viewInfos/click',
            data      : JSON.stringify({
                contact_id : contactId
            }),
            dataType  : 'json',
            xhrFields : {
                withCredentials : true
            },
            success  : function(data) {
                if (data.goal) ppContacts.reachGoal(data.goal)
            }
        });
    },

    reachGoal: function (goal) {
        if (goal === 'showContacts' && ppContacts.isReachGoal) return false
        var commissionGoal = ''
        var totalGoal = ''
        if (ppContacts.info.content.commission) {
            if (ppContacts.info.contentType === 'Car') {
                if (ppContacts.info.content.commission === 4 || ppContacts.info.content.commission === 5) {
                    commissionGoal = 'showContactsPayPerCallCar'
                    totalGoal = 'totalComCar'
                }
            } else if (ppContacts.info.contentType === 'User') {
                if (ppContacts.info.content.commission === 4 || ppContacts.info.content.commission === 5) {
                    commissionGoal = 'showContactsPayPerCallUser'
                    totalGoal = 'totalComUser'
                }
            } else {
                commissionGoal = (ppContacts.info.content.commission === 4 || ppContacts.info.content.commission === 5)
                    ? 'showContactsPayPerCallVenue'
                    : 'showComVenueContacts'
                totalGoal = (commissionGoal === 'showComVenueContacts') ? 'totalComVenue' : ''
                if (commissionGoal === 'showComVenueContacts') {
                    var conversionData = {
                        phone: ppContacts.info.content.mainPhone,
                        channel: ppContacts.info.content.phones.length ? ppContacts.info.content.phones[0].channel : null,
                    }
                    if (typeof window.ga === 'function') {
                        ga(function (tracker) {
                            conversionData.gaClientId = tracker.get('clientId');
                        })
                    }
                    $.ajax({
                        type: 'POST',
                        url: API_URL + '/v2/conversions',
                        dataType: 'json',
                        data: JSON.stringify(conversionData),
                        xhrFields: {
                            withCredentials: true
                        },
                    })
                }
            }
        }
        var params = {vendor_type: ppContacts.info.contentType.toLowerCase(), vendor_id: ppContacts.info.contentId, domain: SITE_DOMAIN}
        console.log('goal: ', goal, params);
        if (goal === 'showContacts' && ppContacts.info.content.commission) console.log('goal: ' + commissionGoal, params);
        if (totalGoal) console.log('goal: ' + totalGoal, params);
        if (window.yaCounter) {
            window.yaCounter.reachGoal(goal, params);
            if (goal === 'showContacts' && commissionGoal) {
                window.yaCounter.reachGoal(commissionGoal, params);
            }
            if (totalGoal) {
                window.yaCounter.reachGoal(totalGoal, params);
            }
        }
        if (typeof ga === 'function') {
            ga('send', 'event', 'action', goal);
            if (goal === 'showContacts' && commissionGoal) {
                ga('send', 'event', 'action', commissionGoal, ppContacts.info.contentType.toLowerCase() + ':' + ppContacts.info.contentId);
            }
            if (totalGoal) {
                ga('send', 'event', 'action', totalGoal, ppContacts.info.contentType.toLowerCase() + ':' + ppContacts.info.contentId);
            }
        }
        if (typeof fbq === 'function') {
            fbq('trackCustom', goal, params);
            if (goal === 'showContacts' && commissionGoal) {
                fbq('trackCustom', commissionGoal, params);
            }
        }
        if (typeof window._tmr !== 'undefined') {
            window._tmr.push({ id: "3193583", type: "reachGoal", goal: goal })
        }
        if (typeof VK !== 'undefined' && typeof VK.Goal === 'function') {
            VK.Goal('conversion')
        }
        if (goal === 'showContacts') ppContacts.isReachGoal = true
    }
}

$(document).ready(function() {
    ppContacts.init()
})

/* 
 * ppContacts_form.js
 */
ppContacts.form = {
    $main  : null,
    $text  : null,
    $verdict : null,

    growInited : false,

    tpl :
        '<form class="ppContacts_form"ppcontacts-elem="form">' +
            '<img src="' + USER.avatar_url + '" class="ppContacts_avatar" width=40 height=40>' +
            '<textarea name="text" rows="1" class="ppContacts_field-area" placeholder="' + t('Send a message') + '" ff-empty="[ff]' + t('message') + '[/ff]"></textarea>' +
            '<div class="form_ffWrapper h" form-elem="verdict">' +
                '<button class="button-small" type="button" ff-elem="button" form-action="send" disabled>' + t('Send') + '</button>' +
            '</div>' +
        '</form>',

    init : function() {
        if (USER.isGuest) {
            return false
        }
        var form = ppContacts.form
        form.$main  = ppContacts.$main.find('[ppcontacts-elem="form"]')
        form.$text  = ppContacts.$main.find('[name="text"]')
        form.$verdict = ppContacts.$main.find('[form-elem="verdict"]')

        form.$main.on(form.events)

        fillFields.init(form.$main)
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[form-action="send"]')) {
                ppContacts.form.send()
            }
        },
        focusin : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[name="text"]')) {
                var form = ppContacts.form
                form.$verdict.removeClass('h')
                if (!form.growInited) {
                    form.$text.autoGrow()
                    form.growInited = true
                }
                fillFields.init(form.$main)
            }
        },
        focusout : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[name="text"]') && !$el.val().length) {
                ppContacts.form.$verdict.addClass('h')
            }
        }
    },

    close : function() {
        var form = ppContacts.form
        form.$main = null
        form.growInited = false
    },

    render : function() {
        return simpleTpl(ppContacts.form.tpl)
    },

    send : function() {
        var form = ppContacts.form

        $.ajax({
            type      : 'POST',
            url       : API_URL + '/v2/pm/',
            data      : JSON.stringify({
                'user_id' : ppContacts.info.userId,
                'text'    : form.$text.val()
            }),
            dataType  : 'json',
            xhrFields : {
                withCredentials: true
            },
            success: function (json) {
                if (json) {
                    alert2(json.message)
                } else {
                    form.$main.addClass('h')
                }
            },
            error: function (er) {
                if (er.status == 401) {
                    alert2(t('You should be logged in.'))
                } else if (er.status == 403) {
                    alert2(t('User not found'))
                } else if (er.status == 400) {
                    alert2(t('Message text is required.'))
                } else {
                    alert2(t('Unknown error'))
                }
            }
        })
    }
}
/* 
 * ppContacts_map.js
 */
ppContacts.map = {
    $main : null,

    tpl : {
        main    : '<div id="ppContacts_map" class="ppContacts_map"></div>',
        balloon :
            '<p class="gorkoMap_bText">{{ address }}</p>' +
            '<p class="gorkoMap_bText"><a ppcontacts-action="tocontacts">' + t('Show contact info') + '</a></p>',
    },

    map      : null,
    opened   : false,
    branchId : 0,
    points   : [],

    close : function() {
        var map = ppContacts.map
        map.$main = null
        map.branchPoints = []
        map.opened = false
        map.map.destroy()
        map.map = null
    },

    openBranch : function(branchId) {
        var map = ppContacts.map
        for (var i=0; map.points[i]; i++) {
            if (map.points[i].branchId == map.branchId) {
                map.points[i].opened = false
            } else if (map.points[i].branchId == branchId) {
                map.points[i].opened = true
                map.map.openBalloon(map.points[i])
            }
        }
        map.branchId = branchId
    },

    onMarker : function(point) {
        ppContacts.switchBranch(point.branchId, true)
    },

    init : function(points) {
        var map = ppContacts.map
        map.points = points
        for (var i=0; map.points[i]; i++) {
            if (map.points[i].opened) {
                map.branchId = map.points[i].branchId
                break
            }
        }
        map.$main = simpleTpl(map.tpl.main, {}, true).appendTo(ppContacts.$main)
        map.map = gorkoMap.init(map.$main, map.points, {
            onMarker : map.onMarker,
            center   : map.points[i].coords,
            balloon  : map.tpl.balloon,
        })
        map.opened = true
    }
}

/* 
 * preloading.js
 */
var preloading = {
    tpl : '<div class="isPreloading_icon" preloading-elem="icon"></div>',

    padding : 100,
    inited : false,
    class : 'isPreloading-slide',

    init : function() {
        if (preloading.inited) {
            return true
        }
        $(window).on(preloading.events)
        preloading.inited = true
    },

    events : {
        scroll : function(ev) {
            preloading.reSetIcons()
        }
    },

    setIcon : function($block) {
        var $icon = $block.children('[preloading-elem="icon"]')
        if (!$icon.length) {
            return false
        }
        var borderTop = $(window).scrollTop() - $block.offset().top + $(window).height() / 2
        var top = Math.max(preloading.padding, borderTop)
        var borderBottom = $block.innerHeight() - preloading.padding
        top = Math.min(top, borderBottom)
        $icon.css({'top' : top + 'px'})
    },

    reSetIcons : function() {
        $('[preloading-elem="block"]').each(function(i, $block) {
            preloading.setIcon($($block))
        })
    },

    set : function($block) {
        if ($block.hasClass(preloading.class)) {
            return true
        }
        $block.addClass(preloading.class).attr('preloading-elem', 'block')
        $(preloading.tpl).appendTo($block)
        preloading.setIcon($block)
    },

    remove : function($block) {
        if (!$block.hasClass(preloading.class)) {
            return true
        }
        var $icon = $block.children('[preloading-elem="icon"]')
        if ($icon.length) {
            $icon.remove()
        }
        $block.removeClass(preloading.class).removeAttr('preloading-elem')
    },
}

$(document).ready(function(){
    imagePreload.load('/i/svg/logo/pink.svg')
    preloading.init()
})
/* 
 * regionSelect.js
 */
function regionSelect(link)
{
    if (document.location != link) {
        document.location = link;
    }
}

$(document).ready(function(){
    var citySelect = $('.nice_select_wrapper');
    if (citySelect.size() > 0) {
        citySelect.each(function(i, select){
            initNiceSelect(select, function(item){
                regionSelect(item.attr('href'));
            });
        });
        var html = '';
        var template = citySelect.find('.nice_select_template').val();
        $.each(cities, function(id) {
            html += createCityHtmlRow(template, cities[id][0], cities[id][1]);
        });
        citySelect.find('.nice_select_div').html(html);
    }
});

function createCityHtmlRow(template, domain, name) {
    return '<a href="' + template.replace('{domain}', domain) + '" class="nc_s" data-search_tag="' + name.toLowerCase() + '">' + name + '</a>';
}
/* 
 * rollbox.js
 */
var rollbox = {
    list : [],

    tpl : twig.compile(
        '<div class="rollbox" {% if params.width %}style="width:{{ params.width }}px;"{% endif %}>' +
            '<a class="rollbox_close" rollbox-action="close"></a>' +
            '<div class="rollbox_content{% if params and params.class %} {{ params.class }}{% endif %}">{{ content }}</div>' +
        '</div>'
    ),

    close : function() {
        var item = rollbox.list.pop()
        item.$main.remove()
        if (item.callback !== null) {
            item.callback()
        }
        delete item
        if (!rollbox.list.length) {
            $('body').removeClass('stopScrolling')
        }
    },

    create : function(content, callback, params) {
        var item = {
            $main : null,
            callback : callback || null,
            events : {
                click : function(ev) {
                    var $el = $(ev.target)
                    if ($el.is('[rollbox-action="close"]')) {
                        rollbox.close()
                    }
                }
            }
        }
        item.$main = twig.render(rollbox.tpl, {
            content : content,
            params  : params,
        }, true).appendTo('body')
        item.$main.on(item.events)

        rollbox.list.push(item)

        $('body').addClass('stopScrolling')
        return item
    },

    show : function(content, callback, params) {
        var item = rollbox.create(content, callback, params)
        return item
    }
}

/* 
 * selectWFirst.js
 */
var selectWFirst = {
    binded : false,

    check : function($select) {
        $select.toggleClass('_first', ($select.val() === $select.attr('select_wfirst')))
    },

    init : function($selects) {
        if (!selectWFirst.binded) {
            $(window).on('change', function(ev){
                var $el = $(ev.target)
                if ($el.is('[select_wfirst]')) {
                    selectWFirst.check($el)
                }
            });
            selectWFirst.binded = true
        }
        if (!$selects) {
            $selects = $('[select_wfirst]')
        }
        $selects.each(function(i, $select) {
            selectWFirst.check($($select))
        });
    }
}

$(document).ready(function() {
    selectWFirst.init()
})

/* 
 * showMore.js
 */
var showMore = {
    inited : false,

    heights : {
        venues : 580,
        restaurants : 330,
        default : 180,
    },
    expand : function($text) {
        $text.removeClass('_collapsed');
        $text.find('[showmore-action="expand"]').remove();
    },
    init : function() {
        $('[showmore-elem="main"]._collapsed').each(function(i, $text) {
            $text = $($text);
            if ($text.hasClass('h')) {
                return
            }
            var type = $text.attr('showmore-type')
            var hideHeight = showMore.heights[type] || showMore.heights.default
            if ($text[0].scrollHeight <= hideHeight) {
                showMore.expand($text);
            }
        })
        if (showMore.inited) {
            return true;
        }
        $(window).on('click', function(ev) {
            var $el = $(ev.target);
            if ($el.is('[showmore-action="expand"]')) {
                showMore.expand($el.closest('[showmore-elem="main"]'))
            }
        });
        showMore.inited = true;
    }
}
$(document).ready(function(){
    showMore.init();
})

/* 
 * simpleTpl.js
 */
var simpleTpl = function(tpl, data, render)
{
    if (!tpl) {
        return false;
    }
    if (!data) {
        return tpl;
    }

    function simpleTplValue(str, data)
    {
        // если вдруг у нас строка
        var value = str.match(/^\'(.*)\'$/) || str.match(/^\"(.*)\"$/);
        if (value) {
            return value[1];
        }

        // если вдруг у нас целое число
        value = str.match(/^((\-|)\d+)$/);
        if ( value || (value === 0) ) {
            return parseInt(value[1]);
        }

        // если вдруг у нас дробное число
        value = str.match(/^((\-|)\d+(\.|)(\d+|))$/);
        if (value) {
            return parseFloat(value[1]);
        }

        // если вдруг у нас переменная
        value = data;
        var deeps = str.split('.');
        for (var i=0; deeps[i]; i++) {
            if ( (value[deeps[i]] !== undefined) && (value[deeps[i]] !== null) ) {
                value = value[deeps[i]];
            } else {
                value = false;
                break;
            }
        }

        if ( value != null && ((typeof value).toLowerCase() == 'object') ) {
            value = true;
        }
        return value;
    }

    /* сначала пройдёмся по условным операторам
        ifInfo[0] - найденный блок целиком
        ifInfo[1] - условие выполнения
        ifInfo[2] - тело блока. Делится потом на
            blocks[0] - блок, который выполняется при соблюдении условия
            blocks[1] - выполняется при {% else %} (становится пустым, если нет {% else %})
    */
    var ifInfo;
    while (ifInfo = (new RegExp('{% if (.*?) %}(.*?){% endif %}')).exec(tpl)) {
        var matched = false,
            not     = false,
            blocks  = ifInfo[2].split('{% else %}');

        if (!blocks[1]) {
            blocks[1] = '';
        }

        if (ifInfo[1].indexOf('not') >= 0) {
            not = true;
            ifInfo[1] = ifInfo[1].replace(/not\s*/, '');
        }
        var operator = ifInfo[1].match(/(\>\=|\<=|\<|\>|\=\=)/);
        if (operator) {
            operator = operator[1];
            ifInfo[1] = ifInfo[1].split(operator);

            var left  = simpleTplValue(ifInfo[1][0].trim(), data),
                right = simpleTplValue(ifInfo[1][1].trim(), data);

            switch (operator) {
                case '>=' : matched = (left >= right); break;
                case '<=' : matched = (left <= right); break;
                case '<'  : matched = (left < right);  break;
                case '>'  : matched = (left > right);  break;
                case '==' : matched = (left == right); break;
            }
        } else {
            matched = simpleTplValue(ifInfo[1], data) != false;
        }

        if (matched == !not) {
            tpl = tpl.replace(ifInfo[0], simpleTpl(blocks[0], data));
        } else {
            tpl = tpl.replace(ifInfo[0], blocks[1]);
        }
    }

    // теперь заменим просто переменные
    var valueInfo;
    while (valueInfo = (new RegExp('{{ (.*?) }}')).exec(tpl)) {
        var value = simpleTplValue(valueInfo[1], data);
        if (value || value === 0) {
            tpl = tpl.replace(valueInfo[0], value);
        } else {
            tpl = tpl.replace(valueInfo[0], '');
        }
    }

    return (render ? $(tpl) : tpl);
}


/* Оставьте плз этот блок. я на нём тестю новый функционал ^_^
var testTpl  =
    '<div>' +
        '{% if var1 %}' +
            '<div>{{ var1.test1 }}</div>' +
        '{% endif %}' +
        '{% if var2 == var1 %}' +
            '<div>var2 checked</div>' +
        '{% else %}' +
            '<div>var2 not checked</div>' +
        '{% endif %}' +
        '<p>{{ var1 }}</p>'+
    '</div>',
    testVars = {
        var1 : {
            test1:'aaa',
        },
        var2 : 'asaa'
    };

console.log(simpleTpl(testTpl, testVars));
*/

/* 
 * slider.js
 */
/*
 * Навешивание слайдера на список
 * @param $contentList - jQ-объект со списком
 * @param type - тип слайдера ('h' - горизонтальный, 'v' - вертикальный (default))
 *
 * структура для слайдера должна быть такой:
 *  div - родитель контента. с (position:relative|absolute и overflow-x:hidden)
 *      div - сам контент с элементами. (max-height и overflow-y:scroll)
 */
function initSlider($contentList, type, canDrag, afterLoad)
{
    if (!$contentList) {
        return false;
    }
    if (!type) {
        type = 'v';
    }

    if (afterLoad === true) {
        var $medias  = $contentList.find('img')
        var count = $medias.length
        if (count) {
            $medias.each(function(i, $media) {
                $media = $($media)
                if ($media.width() && $media.height()) {
                    count--
                    if (count == 0) {
                        initSlider($contentList, type, canDrag)
                    }
                } else {
                    $media.on('load', function() {
                        count--
                        $media.off('load')
                        if (count == 0) {
                            initSlider($contentList, type, canDrag)
                        }
                    })
                }
            })
            return true
        }
    }

    var slider = {
        $content : $contentList,
        $knob    : null,
        $slider  : null,
        $items   : null,

        inited : false,

        calc   : null,
        scroll : null,
        slide  : null,
        check  : null,

        tpl : {
            slider : '<div class="sliderbox-{{ type }}"></div>',
            knob   : '<div class="slider_knob"></div>',
            items  : '<div class="slider_items-{{ type }}" slider-elem="items"></div>'
        },

        init : function() {
            if (slider.inited) {
                slider.check()
                return true
            }

            slider.$items = simpleTpl(slider.tpl.items, {type:type}, true)
            slider.$content.children().appendTo(slider.$items)
            slider.$items.appendTo(slider.$content)

            slider.$slider = simpleTpl(slider.tpl.slider, {type:type}, true)
            slider.$knob = simpleTpl(slider.tpl.knob, {}, true).appendTo(slider.$slider)
            slider.$slider.appendTo(slider.$content)

            if (type == 'v') {
                slider.$knob.css('top', 0)
                slider.$content.on('scroll', slider.scroll)
                slider.$knob.on('mousedown', function(ev) {
                    slider.slide(ev.pageY)
                    return false // IE fix
                })
            } else {
                slider.$content.addClass('slider-h')
                slider.$knob.css('left', 0)
                slider.$slider.on('mousedown', function(ev) {
                    slider.slide(ev.pageX)
                    return false // IE fix
                })
                if (canDrag) {
                    slider.$items.on('mousedown', function(ev) {
                        if (slider.$slider.hasClass('h')) {
                            return false
                        }
                        slider.drag(ev.pageX)
                        return false // IE fix
                    })
                }
            }

            $(window).on('resize', slider.check)
            slider.inited = true

            slider.check()
        }
    };

    // Дополнение вертикального слайдера
    if (type == 'v') {
        slider.maxScrollTop = 0;
        slider.maxSliderTop = 0;

        slider.calc = function() {
            with (slider) {
                maxScrollTop = $items.height() - $content.parent().height();
                maxSliderTop = $knob.parent().height() - $knob.height();
            }
        };

        /*
         * Выставляем слайдер в соответствии со scrollTop'ом блока со списком
         */
        slider.scroll = function() {
            if ($('body').hasClass('slider_dragging-' + type)) {
                return
            }

            slider.calc()

            var stepRatio = slider.$content.scrollTop() / slider.maxScrollTop
            if (stepRatio > 1) {
                stepRatio = 1
            }
            var sliderTop = slider.maxSliderTop * stepRatio
            slider.$knob.css('top', sliderTop + 'px')
        }

        /*  
         * Заставляем слайдер двигаться, пока нажата мышка. Попутно двигаем список
         * pageYOrig - точка Y на экране, в которой была вызвана функция
         */
        slider.slide = function(pageYOrig) {
            slider.calc()
            // сначала узнаем текущее расположение слайдера
            var topOrig = parseInt(slider.$knob.css('top'))
            $('body').addClass('slider_dragging-' + slider.type) // по сути просто меняем курсор
            $(window).on({
                mousemove : function(ev) {
                    var delta = ev.pageY - pageYOrig // вычисляем отклонение слайдера
                    var top = topOrig + delta // его новое расположение
                    // корректируем расположение (чтоб не выходил за края)
                    if (top < 0) {
                        top = 0
                    } else if (top > slider.maxSliderTop) {
                        top = slider.maxSliderTop
                    }
                    slider.$knob.css('top', top + 'px')
                    // осталось подвигать список сцен
                    var stepRatio = top / slider.maxSliderTop
                    var contentTop = slider.maxScrollTop * stepRatio
                    slider.$content.scrollTop(contentTop)
                },
                mouseup : function(ev) {
                    $(window).off('mousemove').off('mouseup')
                    $('body').removeClass('slider_dragging-' + slider.type)
                }
            })
        }

        slider.check = function() {
            with (slider) {
                $slider.addClass('h');
                calc();
                $slider.toggleClass('h', (maxScrollTop <= 1));
                scroll();
            }
        };

    // Дополнение горизонтального слайдера
    } else {
        slider.maxScrollLeft = 0
        slider.maxSliderLeft = 0

        slider.calc = function() {
            slider.maxScrollLeft = slider.$items.width() - slider.$content.width()
            slider.maxSliderLeft = slider.$knob.parent().width() - slider.$knob.width()
        }


        slider.move = function(left) {
            // корректируем расположение (чтоб не выходил за края)
            if (left < 0) {
                left = 0
            } else if (left > slider.maxSliderLeft) {
                left = slider.maxSliderLeft
            }
            slider.$knob.css('left', left + 'px')
            // осталось подвигать контент
            var stepRatio = left / slider.maxSliderLeft
            var contentLeft = slider.maxScrollLeft * stepRatio
            slider.$items.css('left', '-' + contentLeft + 'px')
            slider.$content.toggleClass('_start', (left == 0)).toggleClass('_end', (left == slider.maxSliderLeft))
        }

        /*  
         * Заставляем слайдер двигаться, пока нажата мышка. Попутно двигаем контент
         * pageXOrig - точка X на экране, в которой была вызвана функция
         */
        slider.slide = function(pageXOrig) {
            slider.calc()
            slider.move(pageXOrig - slider.$slider.offset().left - slider.$knob.width()/2)
            // сначала узнаем текущее расположение слайдера
            var leftOrig = parseInt(slider.$knob.css('left'))
            $('body').addClass('slider_dragging-' + slider.type) // по сути просто меняем курсор
            $(window).on({
                mousemove : function(ev) {
                    var delta = ev.pageX - pageXOrig // вычисляем отклонение слайдера
                    var left = leftOrig + delta // его новое расположение
                    slider.move(left)
                },
                mouseup : function(ev){
                    $(window).off('mousemove').off('mouseup')
                    $('body').removeClass('slider_dragging-' + slider.type)
                }
            })
        }

        /*  
         * Заставляем контент двигаться, пока нажата мышка. Попутно двигаем ползунок
         * pageXOrig - точка X на экране, в которой была вызвана функция
         */
        slider.drag = function(pageXOrig) {
            slider.calc()
            // сначала узнаем текущее расположение контента
            var leftOrig = parseInt(slider.$items.css('left'))
            // и максимально возможный сдвиг
            var negativeMaxLeft = slider.maxScrollLeft * (-1)
            $('body').addClass('slider_dragging-' + type) // по сути просто меняем курсор
            $(window).on({
                mousemove : function(ev) {
                    slider.$items.addClass('_drag')
                    var delta = pageXOrig - ev.pageX // вычисляем отклонение контента
                    var left = leftOrig - delta // его новое расположение
                    // корректируем расположение (чтоб не выходил за края)
                    if (left > 0) {
                        left = 0
                    } else if (left < negativeMaxLeft) {
                        left = negativeMaxLeft
                    }
                    slider.$items.css('left', left + 'px')
                    slider.$content.toggleClass('_start', (left == 0)).toggleClass('_end', (left == negativeMaxLeft));

                    var stepRatio = left / negativeMaxLeft
                    if (stepRatio > 1) {
                        stepRatio = 1
                    }
                    var sliderLeft = slider.maxSliderLeft * stepRatio
                    slider.$knob.css('left', sliderLeft + 'px')
                },
                mouseup : function(ev) {
                    $(window).off('mousemove').off('mouseup')
                    $('body').removeClass('slider_dragging-' + type)
                    slider.$items.removeClass('_drag')
                }
            });
        };

        slider.check = function() {
            with (slider) {
                calc()
                var onStart, onEnd
                if (maxScrollLeft <= 1) {
                    $slider.addClass('h')
                    onStart = true
                    onEnd   = true
                } else {
                    if ($slider.hasClass('h')) {
                        $slider.removeClass('h')
                    }
                    var left = parseInt($knob.css('left'))
                    onStart = (left == 0)
                    onEnd   = (left == maxSliderLeft)
                }
                $content.toggleClass('_start', onStart).toggleClass('_end', onEnd)
            }
        };
    }

    slider.init();

    return slider;
}

/* 
 * suggest.js
 */
var suggest = {
    list : [],
    tpl : {
        main     : Twig.twig({data:
            '<span class="suggest{{ className ? " " ~ className }}" suggest-elem="main" suggest-id="{{ id }}" style="width:{{ width }};">' +
                '<span class="suggest_results h" suggest-elem="results"></span>' +
            '</span>'
        }),
        result   : Twig.twig({data:
            '<span class="suggest_result" result-id="{{ id }}" suggest-action="select" suggest-elem="result" data-name="{{ name }}">{{ fullName }}</span>'
        }),
        notFound : Twig.twig({data:'<span class="suggest_notFound">{{ text }}</span>'}),
    },

    events : {
        click  : function(ev) {
            var $el = $(ev.target)
            var $result = $el.closest('[suggest-action="select"]')
            if ($result.length) {
                var suggestId = $result.closest('[suggest-elem="main"]').attr('suggest-id')
                suggest.list[suggestId].select($result)
            }
        },
        change : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[suggest-elem="search"]')) {
                var suggestId = $el.closest('[suggest-elem="main"]').attr('suggest-id')
                suggest.list[suggestId].search(true)
            }
        },
        keyup  : function(ev) {
            var $el = $(ev.target);
            if ($el.is('[suggest-elem="search"]')) {
                var suggestId = $el.closest('[suggest-elem="main"]').attr('suggest-id')
                if ( (ev.keyCode == 38) || (ev.keyCode == 40) ) {
                    var dir = ev.keyCode - 39 // будет (-1) для кнопки вверх (keyCode == 38) и 1 для кнопки вниз (40)
                    suggest.list[suggestId].move(dir)
                } else {
                    suggest.list[suggestId].search()
                }
            }
        },
        keydown : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[suggest-elem="search"]')) {
                if (ev.keyCode == 13) {
                    var suggestId = $el.closest('[suggest-elem="main"]').attr('suggest-id')
                    var $result = suggest.list[suggestId].$results.find('[suggest-elem="result"]._cur')
                    if ($result.length) {
                        suggest.list[suggestId].select($result)
                    }
                    return false
                } else if (ev.keyCode == 27) {
                    var suggestId = $el.closest('[suggest-elem="main"]').attr('suggest-id')
                    suggest.list[suggestId].cancel()
                    return false
                }
            }
        },
        mouseover : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[suggest-elem="result"]')) {
                $el.closest('[suggest-elem="results"]').find('._cur').removeClass('_cur')
            }
        }
    },

    create : function($input, params, callbacks) {
        if (!$input) {
            return false
        }
        if (!params || !params.url) {
            return false
        }

        if (typeof $input == 'string') {
            $input = $('#' + $input)
            if (!$input.length) {
                return false
            }
        }

        if ($input.is('[citysuggest-elem="search"]')) {
            return false
        }

        var suggestItem = {
            $main    : $(suggest.tpl.main.render({
                id        : suggest.list.length,
                className : params && params.className ? params.className : null,
                width     : $input.css('width'),
            })).insertBefore($input),
            $field   : $input,
            $results : null,

            url   : params.url,
            field : {
                results : params.field.results,
                name    : params.field.name || 'name',
            },
            last : {
                partOfName : $input.val(),
                result     : null,
            },
            results  : [],
            timer : {
                id    : 0,
                delay : 500,
            },
            notFoundText : params && params.notFoundText ? params.notFoundText : t('No results found'),

            render : suggest.render,
            select : suggest.select,
            search : suggest.search,
            move   : suggest.move,
            cancel : suggest.cancel,

            callback : {
                clear  : callbacks && callbacks.clear || null,
                select : callbacks && callbacks.select || null,
            },
            getFullName : params && params.getFullName ? params.getFullName : suggest.getFullName,
        }
        suggestItem.$field.attr({
            'suggest-elem' : 'search',
            'autocomplete' : 'new-password',
        }).prependTo(suggestItem.$main)
        suggestItem.$results = suggestItem.$main.find('[suggest-elem="results"]')
        suggestItem.$main.on(suggest.events)

        suggest.list.push(suggestItem)
        return suggestItem
    },

    select : function($result) {
        var suggestItem = this
        if ($result !== null) {
            suggestItem.last.result = suggestItem.results[$result.index()]
            var resultName = suggestItem.last.result[suggestItem.field.name]
            suggestItem.last.partOfName = resultName
        } else {
            suggestItem.last.result = null
            suggestItem.last.partOfName = ''
        }
        suggestItem.$field.val(resultName)
        suggestItem.$results.addClass('h')
        if (suggestItem.callback.select) {
            suggestItem.callback.select(suggestItem.last.result)
        }
    },

    cancel : function() {
        var suggestItem = this
        if (suggestItem.last.result !== null) {
            suggestItem.last.partOfName = suggestItem.last.result[suggestItem.field.name]
        } else {
            suggestItem.last.partOfName = ''
        }
        suggestItem.$field.val(suggestItem.last.partOfName)
        if (suggestItem.timer.id !== 0) {
            clearTimeout(suggestItem.timer.id)
        }
        suggestItem.$results.addClass('h')
        if (suggestItem.callback.select) {
            suggestItem.callback.select(suggestItem.last.result)
        }
    },

    move : function(dir) {
        var suggestItem = this
        dir = +dir;

        var $results = suggestItem.$results.find('[suggest-elem="result"]')
        var $current = $results.filter('._cur')
        var $selected = false

        if (!$current.length) {
            $selected = (dir > 0) ? $results.first() : $results.last()
        } else {
            $current.removeClass('_cur')
            var selectedIndex = $current.index() + dir
            count = $results.length
            if (selectedIndex < 0) {
                $selected = $results.last()
            } else if (selectedIndex >= count) {
                $selected = $results.first()
            } else {
                $selected = $($results[selectedIndex])
            }
        }
        if ($selected === false) {
            return false
        }
        $selected.addClass('_cur')
    },

    getFullName : function(result, partOfName) {
        var suggestItem = this
        return highlightText(result[suggestItem.field.name], partOfName)
    },

    render : function() {
        var suggestItem = this
        if (suggestItem.results.length) {
            var results = ''
            for (var i in suggestItem.results) if (suggestItem.results.hasOwnProperty(i)) {
                var result = suggestItem.results[i]
                var fullName = suggestItem.getFullName(result, suggestItem.last.partOfName)
                results += suggest.tpl.result.render({
                    id : result.id,
                    name : result.name,
                    fullName : fullName,
                })
            }
            suggestItem.$results.html(results)
        } else {
            suggestItem.$results.html(suggest.tpl.notFound.render({text:suggestItem.notFoundText}))
        }
    },

    search : function(wSelect) {
        var suggestItem = this

        var partOfName = suggestItem.$field.val()
        if (partOfName == suggestItem.last.partOfName) {
            return false
        }

        suggestItem.last.partOfName = partOfName
        if (suggestItem.callback.clear) {
            suggestItem.callback.clear()
        }
        if (suggestItem.timer.id !== 0) {
            clearTimeout(suggestItem.timer.id)
        }
        suggestItem.results = []

        suggestItem.$results.empty()
        if (suggestItem.last.partOfName == '') {
            if (wSelect === true) {
                suggestItem.select(null)
            }
            suggestItem.$results.addClass('h')
            return true
        }

        suggestItem.$results.removeClass('h')
        suggestItem.timer.id = setTimeout(function() {
            $.ajax({
                type     : 'GET',
                url      : suggestItem.url.replace('{{ partOfName }}', suggestItem.last.partOfName),
                xhrFields: {
                    withCredentials: true
                },
                dataType : 'json',
                success  : function(json) {
                    suggestItem.results = json[suggestItem.field.results] || []
                    suggestItem.render()
                    clearTimeout(suggestItem.timer.id)
                }
            })
        }, suggestItem.timer.delay)
    },

}

/* 
 * switcher.js
 */
var switcher = Twig.twig({data:
    '<label class="switcher{% if class %} {{ class }}{% endif %}"' +
        '{% for attrName, attrValue in labelAttrs %}' +
            ' {{ attrName }}="{{ attrValue }}"' +
        '{% endfor %}>' +
        '<input' +
            '{% if id %} id="{{ id }}" {% endif %}' +
            ' class="switcher-{% if type %}{{ type }}{% else %}checkbox{% endif %}"' +
            ' type="{% if type %}{{ type }}{% else %}checkbox{% endif %}"' +
            '{% if name %} name="{{ name }}"{% endif %}' +
            '{% if checked %} checked{% endif %}' +
            '{% if disabled %} disabled{% endif %}' +
            ' value="{{ value }}"' +
            '{% for attrName, attrValue in attrs %}' +
                ' {{ attrName }}="{{ attrValue }}"' +
            '{% endfor %}' +
        '>' +
        '<span class="switcher_icon"></span>' +
        '{% if HTML %}{{ HTML }}' +
        '{% elseif text %}<span class="switcher_text"> {{ text }}</span>' +
        '{% endif %}' +
    '</label>'
})

/* 
 * t.js
 */
function t(text, vars) {
    var tmp = text.split('|')
    if (tmp.length > 1 && (typeof(vars) === 'number' || typeof(vars) === 'string')) {
        text = plural(text, vars)
    } else {
        if (typeof vars === 'number' || typeof vars === 'string') {
            vars = {'{n}': vars}
        }
        if (vars) {
            for (var k in vars) {
                text = text.replace(new RegExp(k, 'g'), vars[k])
            }
        }
    }
    if (SITE_NAME) {
        text = text.replace('{site_name}', SITE_NAME)
    }
    return text
}

if(!LANG) {
    var LANG = 'en';
}

var FORMS = {
    RU: {
        ONE: 0,
        FEW: 1,
        MANY: 2
    },
    EN: {
        ONE: 0,
        OTHER: 1
    },
    INDIAN: {
        ONE: 0,
        OTHER: 1
    },
    UK: {
        ONE: 0,
        FEW: 1,
        MANY: 2,
        OTHER: 3
    },
    PL: {
        ONE: 0,
        FEW: 1,
        MANY: 2,
        OTHER: 3
    },
    TH: {
        OTHER: 0
    }
}

var Plural = {
    form: function (n) {
        if (language.isRussian(LANG)) {
            if (this.isInt(n)) {
                return n % 10 === 1 && n % 100 !== 11 ? 0 : n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20) ? 1 : 2
            }

            return FORMS.RU.FEW
        }

        if (language.isEnglish(LANG)) {
            if (this.isInt(n) && n === 1) {
                return FORMS.EN.ONE
            }
            return FORMS.EN.OTHER
        }

        if (language.isIndian(LANG)) {
            if (this.isInt(n) && (n === 0 || n === 1)) {
                return FORMS.INDIAN.ONE
            }
            return FORMS.INDIAN.OTHER
        }

        if (language.isUkrainian(LANG)) {
            if (this.isInt(n)) {
                return n % 10 === 1 && n % 100 !== 11 ? 0 : n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20) ? 1 : 2
            }
            return FORMS.UK.OTHER
        }

        if (language.isPolish(LANG)) {
            if (this.isInt(n)) {
                return n === 1 ? 0 : n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20) ? 1 : 2
            }
            return FORMS.PL.OTHER
        }

        if (language.isThai(LANG)) {
            return FORMS.TH.OTHER
        }
    },

    isInt: function (n) {
        return Number(n) === n && n % 1 === 0
    }
}

var language = {
    supportedLanguages: function() {
        return [
            this.bengali(),
            this.english(),
            this.gujarati(),
            this.hindi(),
            this.kannada(),
            this.malayalam(),
            this.marathi(),
            this.polish(),
            this.punjabi(),
            this.russian(),
            this.tamil(),
            this.telugu(),
            this.thai(),
            this.ukrainian()
        ]
    },

    indianLanguages: function() {
        return [
            this.bengali(),
            this.gujarati(),
            this.hindi(),
            this.kannada(),
            this.malayalam(),
            this.marathi(),
            this.punjabi(),
            this.tamil(),
            this.telugu()
        ]
    },

    russian: function() {
        return 'ru'
    },

    isRussian: function(language) {
        return !!(this.isValid(language) && language.toLowerCase() === this.russian())
    },

    english: function() {
        return 'en'
    },

    isEnglish: function(language) {
        return !!(this.isValid(language) && language.toLowerCase() === this.english())
    },

    ukrainian: function() {
        return 'uk'
    },

    isUkrainian: function(language) {
        return !!(this.isValid(language) && language.toLowerCase() === this.ukrainian())
    },

    hindi: function() {
        return 'hi'
    },
    bengali: function() {
        return 'bn'
    },
    telugu: function() {
        return 'te'
    },
    marathi: function() {
        return 'mr'
    },
    tamil: function() {
        return 'ta'
    },
    kannada: function() {
        return 'kn'
    },
    gujarati: function() {
        return 'gu'
    },
    malayalam: function() {
        return 'ml'
    },
    punjabi: function() {
        return 'pa'
    },

    isIndian: function(language) {
        return !!(this.isValid(language) && this.indianLanguages().indexOf(language.toLowerCase())>-1)
    },

    polish: function() {
        return 'pl'
    },

    isPolish: function(language) {
        return !!(this.isValid(language) && language.toLowerCase() === this.polish())
    },

    thai: function() {
        return 'th'
    },

    isThai: function(language) {
        return !!(this.isValid(language) && language.toLowerCase() === this.thai())
    },

    isValid: function(language) {
        return !!(language && this.supportedLanguages().indexOf(language.toLowerCase())>-1)
    }
}


function plural(text,Number) {
    var aEndings = text.split('|');
    var sEnding = aEndings[Plural.form(Number)];
    return sEnding.replace('{n}',Number);
}

/* 
 * time.js
 */
var time = {
    now : function(params) {
        var datetime = new Date()
        var today = {
            y : +datetime.getFullYear(),
            m : +datetime.getMonth() + 1,
            d : +datetime.getDate(),
            h : +datetime.getHours(),
            i : +datetime.getMinutes(),
            s : +datetime.getHours(),
        }
        if (params && params.asObject) {
            return today
        }
        return today.y + '-' + today.m.padLeft() + '-' + today.d.padLeft() + ' ' + today.h.padLeft() + ':' + today.i.padLeft() + ':' + today.s.padLeft()
    },

    dowName : [t(''), t(''), t(''), t(''), t(''), t(''), t('')],
}
/* 
 * toMobile.js
 */
toMobile = {
    $main : false,

    tpl : {
        0 :
            '<div class="tomobile-big">' +
                '<a class="tomobile_close" href="javascript:void(0);" tomobile-action="close"></a>' +
                '<p class="tomobile_text">' + t('You are browsing the the full version') + '</p>'+
                '<p class="tomobile_text"><a href="javascript:void(0);" tomobile-action="go">' + t('Switch to the mobile version') + '</a></p>' +
            '</div>',
        1 : '<a class="tomobile-light" href="javascript:void(0);" tomobile-action="go">' + t('Mobile version') + '</a>'
    },

    close : function() {
        localStorage.setItem('switchToMobile', true)
        toMobile.$main.remove()
        toMobile.$main = simpleTpl(toMobile.tpl[1], {}, true).prependTo($('body'))
    },

    go : function() {
        setCookie('is_mobile', 1, {expires: 86400*7, domain: '.' + SITE_DOMAIN, path: '/'})
        window.caches.keys().then(function (cacheNames) {
            return Promise.all(
                cacheNames.map(function (cacheName) {
                    return window.caches.delete(cacheName)
                })
            )
        })
        document.location.reload()
    },

    events : {
        click : function(ev) {
            var $el = $(ev.target)
            if ($el.is('[tomobile-action="close"]')) {
                toMobile.close()
            } else if ($el.is('[tomobile-action="go"]')) {
                toMobile.go()
            }
        }
    },

    init : function() {
        if (!isMobile) return false
        if (!hasMobile) return false

        var closed = localStorage.getItem('forumToMobile') || false

        toMobile.$main = simpleTpl(toMobile.tpl[+!!closed], {}, true).prependTo($('body'))

        toMobile.$main.on(toMobile.events)
    }
}


$(window).load(function() {
    toMobile.init()
})
/* 
 * topHint.js
 */
var topHint = {
    $main : null,

    binded : false,
    cache : {},
    curUser : 0,

    tpl : {
        main :
            '<div class="balloon-dark">' +
                '<div class="topHint">' +
                    '<p class="topHint_caption">' + t('Nomination') + '</p>' +
                    '<p class="topHint_nomination">«{{ nomination }}»</p>' +
                    '{{ places }}' +
                    '<p class="topHint_notice">' + t('By voting results in top.gorko.ru rating') + '</p>' +
                '</div>' +
            '</div>',
        place :
            '<p class="topHint_place" place-text="{{ place_text }}"> — {{ location }}</p>',
    },

    init : function() {
        if (topHint.binded) {
            return true
        }
        $(window).on(topHint.events)
        topHint.binded = true
    },

    events : {
        mouseenter : function(ev) {
            var $el = $(ev.target)
            var $top = $el.closest('[top_hint-action="show"]')
            topHint.toggle($top, !!$top.length)
        }
    },

    toggle : function($top, show) {
        if (show === false) {
            if (topHint.$main !== null) {
                topHint.curUser = 0
                topHint.$main.remove()
            }
            return true
        }
        var userId = +$top.attr('user-id')
        if (userId == topHint.curUser) {
            return true
        }
        topHint.curUser = userId
        topHint.load(userId).then(function(user) {
            var info = user.user.global_contest
            var contests = []
            for (var locationId in info) if (info.hasOwnProperty(locationId)) {
                var contest = info[locationId]
                contest.locationId = locationId
                if (contests.length && contest.position < contests[0].position) {
                    contests.unshift(contest)
                } else {
                    contests.push(contest)
                }
            }
            var places$ = ''
            for (var i=0; contests[i]; i++) {
                var contest = contests[i]
                places$ += simpleTpl(topHint.tpl.place, {
                    place_text : t('{place} place', {'{place}':contest.position}),
                    location   : contest.location,
                })
            }
            topHint.$main = simpleTpl(topHint.tpl.main, {
                nomination : contests[0].nomination,
                places     : places$,
            }, true).appendTo($top)
        })
    },

    load : function(userId) {
        if (topHint.cache[userId]) {
            return new Promise(function(resolve, reject) {
                resolve(topHint.cache[userId])
            })
        } else {
            return $.ajax({
                type      : 'GET',
                url       : API_URL + '/v2/users/' + userId,
                dataType  : 'json',
                xhrFields : {
                    withCredentials: true
                },
                success : function(json) {
                    topHint.cache[userId] = json
                }
            })
        }
    },
}

$(document).ready(function() {
    topHint.init()
})
/* 
 * twig_extend.js
 */
Twig.extendFilter('switcher', function(params) {
    var tpl = twig.compile(
        '<label class="switcher{% if class %} {{ class }}{% endif %}"' +
            '{% for attrName, attrValue in labelAttrs %}' +
                ' {{ attrName }}="{{ attrValue }}"' +
            '{% endfor %}>' +
            '<input' +
                '{% if id %}id="{{ id }}" {% endif %}' +
                ' class="switcher-{% if type %}{{ type }}{% else %}checkbox{% endif %}"' +
                ' type="{% if type %}{{ type }}{% else %}checkbox{% endif %}"' +
                '{% if name %} name="{{ name }}"{% endif %}' +
                '{% if checked %} checked{% endif %}' +
                '{% if disabled %} disabled{% endif %}' +
                ' value="{{ value }}"' +
                '{% for attrName, attrValue in attrs %}' +
                    ' {{ attrName }}="{{ attrValue }}"' +
                '{% endfor %}' +
            '>' +
            '<span class="switcher_icon"></span>' +
            '{% if HTML %}{{ HTML }}' +
            '{% else %}<span class="switcher_text"> {{ text }}</span>' +
            '{% endif %}' +
        '</label>')

    return twig.render(tpl, params)
})
/* 
 * upload.js
 */
/*
 <input data-action="upload" class="uploadPhoto_input" name="Filedata" type="file" multiple="false/true"
 accept="image/jpeg,image/gif,image/png"
 data-url="/uploader/transfer/?album_id={{ album_id }}&preview_size={{ preview_size }}"
 data-callback="contestUpdatePhoto" />
 */
$(document).ready(function(){
    var script = document.createElement('script');
    script.type = 'text/javascript';
    var uploadInput = $("[data-action='upload']");
    if (uploadInput.length) {
        if (typeof jQuery.ui != 'object') {
            console.log('ALERT! no jquery ui!');
        }
        if (typeof jQuery.fn.fileupload != 'function') {
            console.log('ALERT! no fileupload plugin!');
        }
        $("[data-action='upload']").each(function(instance,input){
            $(this).fileupload({
                url: $(this).data('url')+'&BITRIX_SECURITY_KEY='+ BITRIX_SECURITY_KEY,
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                done: function (e, data) {
                    var callback = $(this).data('callback');
                    if (callback) {
                        eval(callback+'(data.result);');
                    }
                }
            });
        });
    }
});
/* 
 * uploader.js
 */
var uploader = {
    do : function(ev, params) {
        return new Promise(function(resolve, reject) {
            if (!ev && !params.files || (params.files && !params.files.length)) {
                resolve(false)
                return
            }
            if ( !params || !params.url ) {
                params.url =  API_URL + '/v2/upload/'
            }

            if (ev) {
                ev.stopPropagation() // Stop stuff happening
                ev.preventDefault() // Totally stop stuff happening
            }
            // Create a formdata object and add the files
            var data = new FormData()
            if (params.otherData) {
                for (var key in params.otherData) if (params.otherData.hasOwnProperty(key)) {
                    if (Array.isArray(params.otherData[key])) {
                        for (var i=0; params.otherData[key][i]; i++) {
                            data.append(key + '[]', params.otherData[key][i])
                        }
                    } else {
                        data.append(key, params.otherData[key])
                    }
                }
            }
            var files = ev ? ev.target.files : params.files
            for (var key in files) if (files.hasOwnProperty(key)) {
                var file = files[key]
                if (file.title) {
                    data.append(key, file, file.title + '.' + file.type.split('/')[1])
                } else {
                    data.append(key, file)
                }
            }

            $.ajax({
                url: params.url,
                type: params && params.protocol || 'POST',
                data: data,
                cache: false,
                dataType: 'json',
                processData: false, // Don't process the files
                contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                uploadProgress : params && params.progress ? params.progress : null,
                xhrFields: {
                    withCredentials: true,
                },
                success: function(json, textStatus, jqXHR) {
                    if (json.error && json.error.length) {
                        return false
                    }
                    if (params && params.done) {
                        params.done(json)
                        resolve(files.length)
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    // Handle errors here
                    console.error('UPLOADER ERRORS: ' + textStatus)
                    // STOP LOADING SPINNER
                }
            })
        })
    }
}
/* 
 * user.js
 */
var user = {
    avatar : null,

    init : function() {
        with (user) {
            avatar.init();
        }
    }
}

$(document).ready(function(){
    user.init();
});
/* 
 * user_avatar.js
 */
user.avatar = {
    $menu  : false,

    timerId   : 0,
    hoveredId : 0,

    inited : false,
    userFields : ['profile_url', 'pm_url', 'pro'],
    tpl : {
        avatar : Twig.twig({data:
            '<div class="avatar{{ roleClass }}" href="javascript:void(0);" avatar-elem="main" user-id="{{ id }}" user-profile_url="{{ profile_url }}" user-pm_url="{{ pm_url }}" user-pro="{{ pro }}">' +
                '<img src="{{ avatar_url }}" width="{{ size }}" height="{{ size }}" alt="">' +
                '<a class="avatar_profile" href="{{ profile_url }}" target="_blank"></a>' +
            '</div>'
        }),
        menu   :
            '<div class="avatar_menu" avatar-elem="menu">' +
                '<a class="avatar_link" href="{{ profile_url }}">' + t('Go to profile') + '</a>' +
                '<a class="avatar_link" href="{{ pm_url }}" target="_blank">' + t('Private message') + '</a>' +
                '{{ actions.fav }}' +
                '{{ actions.doer }}' +
                '{{ actions.admin }}' +
                //'<a class="avatarAction-small" href="">' + t('Activity') + '</a>' + // Выключено пока нет такой страницы
            '</div>',
        action : {
            fav   : '<a class="avatar_link user_tofav-text" href="javascript:void(0);" user-action="fav" user-fav_text="' + t('Add to favorites') + '" user-unfav_text="' + t('Remove from favorites') + '"></a>',
            doer  : '<a class="avatar_link user_todoer-text" href="javascript:void(0);" user-action="doer" user-doer_text="' + t('Selecting a vendor') + '" user-undoer_text="' + t('Remove vendor') + '"></a>',
            admin : '<a href="{{ url }}" class="avatar_link">' + t('Log in as user') + '</a>'
        }
    },

    render : function(info, size, wRole, render) {
        if (size) {
            info.size = size
        }
        if (wRole && info.color) {
            info.roleClass = '-' + info.color
        }
        info.pro = info.role ? info.role.pro : 0
        var $avatar = user.avatar.tpl.avatar.render(info)
        return render ? $($avatar) : $avatar
    },

    load : function($avatar, andShow) {
        if ($avatar.is('._loading')) {
            return false;
        }
        var userId = +$avatar.attr('user-id');
        $avatar.addClass('_loading');
        $.ajax({
            type      : 'GET',
            url       : API_URL + '/v2/users/' + userId,
            dataType  : 'json',
            data      : {
                set_city : CITY_ID
            },
            xhrFields : {
                withCredentials: true
            },
            success  : function(json) {
                var userInfo = json.user;
                with (user.avatar) {
                    for (var i in userFields) if (userFields.hasOwnProperty(i)) {
                        var field = userFields[i];
                        if (field == 'pro') {
                            $avatar.attr('user-pro', userInfo.role.pro);
                        } else {
                            if (userInfo[field] != undefined) {
                                $avatar.attr('user-' + field, userInfo[field]);
                            }
                        }
                    }
                    $('[user-elem="main"][user-id="' + userId +'"]').attr({
                        'user-my_fav'  : +userInfo.my_fav,
                        'user-my_doer' : +userInfo.my_doer
                    });

                    $avatar.removeClass('_loading');
                    if (andShow) {
                        menu.show($avatar);
                    }
                }
            }
        });
    },

    menu : {
        show : function($avatar) {
            with (user.avatar) {
                if ($avatar.is('._hovered')) {
                    return false;
                }
                if ($menu !== false) {
                    menu.close();
                }

                var needLoad = false;
                info = {
                    id      : +$avatar.attr('user-id'),
                    actions : {}
                };
                for (var i in userFields) if (userFields.hasOwnProperty(i)) {
                    var field = userFields[i]
                    if (!$avatar.attr('user-' + field)) {
                        needLoad = true;
                        break;
                    }
                    info[field] = $avatar.attr('user-' + field);
                }
                if ( !USER.isGuest && (info.id == USER.id) ) {
                    return false;
                }

                if (needLoad) {
                    load($avatar, true);
                } else {
                    info.pro = +info.pro;
                    if ( !USER.isGuest && (info.id != USER.id) ) {
                        if (info.pro) {
                            info.actions.fav = simpleTpl(user.avatar.tpl.action.fav);
                            if (USER.group == 'nevesta' || USER.group == 'guest') {
                                info.actions.doer = simpleTpl(tpl.action.doer);
                            }
                        }
                        if (USER.group == 'admin') {
                            info.actions.admin = simpleTpl(tpl.action.admin, {
                                url : USER.adminGoToUrl.replace('{{ id }}', info.id)
                            })
                        }
                    }
                    $menu = simpleTpl(tpl.menu, info, true).appendTo($avatar);
                    $avatar.addClass('_hovered');
                    hoveredId = info.id;
                }
            }
        },
        hover : function($avatar) {
            with (user.avatar) {
                if (hoveredId == +$avatar.attr('user-id')) {
                    return false;
                }
                if (timerId) {
                    clearTimeout(timerId);
                }
                timerId = setTimeout(function(){
                    user.avatar.menu.show($avatar);
                }, 500);
            }
        },
        close : function() {
            with (user.avatar) {
                if (timerId) {
                    clearTimeout(timerId);
                }
                if ($menu === false) {
                    return true;
                }
                $menu.closest('[avatar-elem="main"]').removeClass('_hovered');
                $menu.remove();
                $menu = false;
                hoveredId = 0;
            }
        }
    },

    init : function() {
        with (user.avatar) {
            if (USER.isGuest) return false;
            if (inited) return false;

            $(window).on({
                'mouseenter' : function(ev){
                    var $el = $(ev.target);
                    var $avatar = $el.closest('[avatar-elem="main"]');
                    if ( $avatar.length && !$el.is('[avatar-hover="hide"]') ) {
                        user.avatar.menu.hover($avatar);
                    } else {
                        user.avatar.menu.close();
                    }
                }
            });
            inited = true;
        }
    }
}

/* 
 * videoPlayer.js
 */
var videoPlayer = {
    info: null,
    serviceApi: {
        youtube: false,
        vimeo: false,
        vk: false,
        facebook: false
    },
    serviceApiUrl: {
        youtube: 'https://www.youtube.com/iframe_api',
        vimeo: '',
        vk: '',
        facebook: ''
    },
    size: [],
    defaultVolume: 0.7,

    getSize: function (info, $wrapper) {
        info.video_aspect_ratio = 1.77778; // 16:9 Временный костыль
        if (info.video_aspect_ratio > 0) {
            var resultWidth = $wrapper.parent().width(),
                resultHeight = resultWidth / info.video_aspect_ratio;
        } else {
            var original_size = info.original_size.split('x'),
                maxWidth = $wrapper.parent().width(),
                width = +original_size[0],
                height = +original_size[1],
                ratio = (width / height).toFixed(2),
                resultWidth = maxWidth,
                resultHeight = 0;
            if (width > maxWidth) {
                var diff = Math.round((width - maxWidth) / ratio);
                resultHeight = height - diff;
            } else {
                var diff = Math.round((maxWidth - width) / ratio);
                resultHeight = height + diff;
            }
        }

        // Временный 16:9 хак
        resultWidth = $wrapper.parent().width();
        resultHeight = resultWidth / 1.78;

        return [resultWidth, resultHeight];
    },

    youtube: {
        play: function () {
            player = new YT.Player('videoPlayer', {
                width: videoPlayer.size[0],
                height: videoPlayer.size[1],
                videoId: videoPlayer.info.video_id,
                playerVars: {'autoplay': 1,},
                events: {
                    'onReady': onPlayerReady
                }
            });
        },
        destroy: function () {
        },
    },
    vimeo: {
        play: function ($wrapper) {
            var player = '<iframe id="videoPlayer" src="https://player.vimeo.com/video/' + videoPlayer.info.video_id + '?api=1&player_id=videoPlayer&autoplay=1" width="' + videoPlayer.size[0] + '" height="' + videoPlayer.size[1] + '" bgcolor="black" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>';
            $wrapper.html(player);
            vimeoHandler();
        },
        destroy: function () {
        },
        onReady: function () {
            videoPlayer.vimeo.post('setVolume', videoPlayer.getVideoParam('video_volume', 'vimeo'));
            playerTimer = setInterval(function () {
                if ($('#videoPlayer').length) {
                    videoPlayer.vimeo.post('getVolume');
                } else {
                    clearInterval(playerTimer);
                }
            }, 1000);
        },
        post: function (action, value) {
            var data = {
                method: action
            };

            if (value || value == 0) {
                data.value = value;
            }

            var message = JSON.stringify(data);
            player = $('#videoPlayer');
            player[0].contentWindow.postMessage(message, playerOrigin);
        },
    },
    vk: {
        play: function ($wrapper) {
            var player = '<iframe id="videoPlayer" src="' + videoPlayer.info.video_link + '&autoplay=1" width="' + videoPlayer.size[0] + '" height="' + videoPlayer.size[1] + '" bgcolor="black" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>';
            $wrapper.html(player);
        },
        destroy: function () {
        },
    },
    facebook: {
        play: function ($wrapper) {
            var player = '<div id="videoPlayer" class="fb-video" data-href="' + videoPlayer.info.video_link + '" data-width="' + videoPlayer.size[0] + '" data-autoplay="true" data-allowfullscreen="true"></div>';
            $wrapper.html(player);
            fbAsyncInit(true);
        },
        destroy: function () {
        },
    },

    init: function (data, $wrapper) {
        with (videoPlayer) {
            info = data;
            size = getSize(info, $wrapper);

            clearInterval(playerTimer);

            if (!serviceApi[info.video_service]) {
                var tag = document.createElement('script');
                tag.src = serviceApiUrl[info.video_service];
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
                serviceApi[info.video_service] = true;
                if (info.video_service != 'youtube') {
                    setTimeout(function () {
                        videoPlayer[info.video_service].play($wrapper);
                    }, 1000);
                }
            } else {
                setTimeout(function () {
                    videoPlayer[info.video_service].play($wrapper);
                }, 1);
            }

            $wrapper.css({
                width: size[0],
                height: size[1],
                background: 'black'
            }).html('<div id="videoPlayer"></div>');

            if (!getCookie('video_volume')) {
                setCookie('video_volume', videoPlayer.defaultVolume);
            }

        }
    },

    getVideoParam: function (param, service) {
        var value = getCookie(param);
        if (param == 'video_volume' && service == 'youtube') {
            value *= 100;
        }
        if (param == 'video_volume') {
            value = parseFloat(value);
        }
        return value;
    },

    setVideoParam: function (param, value, service) {
        if (param == 'video_volume' && service == 'youtube') {
            value /= 100;
        }
        setCookie(param, value);
    },

}

var player;
var playerTimer;



// Youtube

function onYouTubeIframeAPIReady() {
    videoPlayer['youtube'].play();
}

function onPlayerReady(event) {
    player.unMute();
    player.setVolume(videoPlayer.getVideoParam('video_volume', 'youtube'));
    playerTimer = setInterval(function () {
        if ($('#videoPlayer').length) {
            if (player.isMuted()) {
                videoPlayer.setVideoParam('video_volume', 0, 'youtube');
            } else {
                videoPlayer.setVideoParam('video_volume', player.getVolume(), 'youtube');
            }
        } else {
            clearInterval(playerTimer);
        }
    }, 1000);
}



// Vimeo

var playerOrigin = '*';

function vimeoMessageReceiver(event) {
    if (!(/^https?:\/\/player.vimeo.com/).test(event.origin)) {
        return false;
    }
    if (playerOrigin === '*') {
        playerOrigin = event.origin;
    }
    var data = JSON.parse(event.data);
    switch (data.event) {
        case 'ready':
            videoPlayer.vimeo.onReady();
            break;
    }
    switch (data.method) {
        case 'getVolume':
            videoPlayer.setVideoParam('video_volume', data.value, 'vimeo');
            break
    }
}

function vimeoHandler() {
    if (window.addEventListener) {
        window.addEventListener('message', vimeoMessageReceiver, false);
    } else {
        window.attachEvent('onmessage', vimeoMessageReceiver, false);
    }
}



// Facebook

window.fbAsyncInit = function(events) {
    FB.init({
        appId      : 169963323054454,
        xfbml      : true,
        version    : 'v2.5'
    });

    if (!events) {
        var my_video_player;
        FB.Event.subscribe('xfbml.ready', function(msg) {
            if (msg.type === 'video') {
                my_video_player = msg.instance;
                my_video_player.unmute();
                my_video_player.setVolume(videoPlayer.getVideoParam('video_volume', 'facebook'));
                playerTimer = setInterval(function () {
                    if ($('#videoPlayer').length) {
                        if (my_video_player.isMuted()) {
                            videoPlayer.setVideoParam('video_volume', 0, 'facebook');
                        } else {
                            videoPlayer.setVideoParam('video_volume', my_video_player.getVolume(), 'facebook');
                        }
                    } else {
                        clearInterval(playerTimer);
                    }
                }, 1000);
            }
        });
    }
};

(function(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
/* 
 * viewInfoStats.js
 */
var viewInfoStats = {
    tpl : {
        icon : '<img width="7" title="registered users" alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQCAYAAAAiYZ4HAAAABmJLR0QA/wD/AP+gvaeTAAABAklEQVQoka2RMU7DQBBF/x/FkCopVytKKigi6ChzAFO6CA0RkSxzg4giSDmGpSA6enMKGsQBaMnGNITSMvKkCEa2CHIi8buZfW92R0tUEoah51w6FeEAAIpCH6w1kziO85JpVQXn0inJseq6JjleLN4VwE3JSFUgeYnfGVYLqZ8pNwi11ARV3G9gar3aDtaaiXMpSI7WA3RmrbltuvV/87NkEAR7WfZ1BegIwOF3+5XUmTHmrvwLAoDv+wcirUcAp38MfgaK8yRJ5uz3h+1O5/MJ0F7Da17yPDuTbvfjegsYAE48bz8SVV5sAZcZCICjHYRjAbjcQViKKiIA82aWb6RGK63CTHLctDEJAAAAAElFTkSuQmCC">',
        main :
            '<div class="cl_member_block">' +
                '{% if stats.comment %}' +
                    '<div class="cl_member_block_title">Admin note</div>' +
                    '<span style="color:red; display:block;margin-bottom:20px;">{{ stats.comment }}</span>' +
                '{% endif %}' +

                '<div class="cl_member_block_title">Statistics</div>' +

                '<div><span class="cl_contact_title">Page views</span></div>' +
                '<div>Day - {{ stats.cntViewsDayTotal }}, {{ stats.cntViewsDayRegistered }} {{ icon }}</div>' +
                '<div>Week - {{ stats.cntViewsWeekTotal }}, {{ stats.cntViewsWeekRegistered }} {{ icon }}</div>' +
                '<div>Month - {{ stats.cntViewsMonthTotal }}, {{ stats.cntViewsMonthRegistered }} {{ icon }}</div>' +

                '<div><span class="cl_contact_title">Phone views</span></div>' +
                '<div>Day - {{ stats.cntPhoneDayTotal }}, {{ stats.cntPhoneDayRegistered }} {{ icon }}</div>' +
                '<div>Week - {{ stats.cntPhoneWeekTotal }}, {{ stats.cntPhoneWeekRegistered }} {{ icon }}</div>' +
                '<div>Month - {{ stats.cntPhoneMonthTotal }}, {{ stats.cntPhoneMonthRegistered }} {{ icon }}</div>' +
            '</div>',
    },

    load : function(contentType, contentId) {
        return $.ajax({
            url      : API_URL + '/v2/viewInfos/summary',
            data     : {
                content_type : contentType,
                content_id   : contentId,
            },
            dataType : 'json',
            xhrFields: {
                withCredentials: true
            }
        })
    },

    render : function(stats) {
        return simpleTpl(viewInfoStats.tpl.main, {
            stats : stats,
            icon  : viewInfoStats.tpl.icon,
        }, true)
    },

    show : function(contentType, contentId, $block) {
        if (USER.group !== 'admin') {
            return false
        }
        if (!contentType || !contentId) {
            return false
        }
        if (!$block || !$block.length) {
            return false
        }

        viewInfoStats.load(contentType, contentId)
        .then(function(json) {
            viewInfoStats.render(json.summary).appendTo($block)
        })
    }
}
/* 
 * view_info.js
 */
$(document).ready(function () {
    if (!window.viewInfoData) {
        window.viewInfoData = [];
    }
    if ($('[ppcontacts-action="show"]').length) {
        if ($('.fotorama').size()) {
            viewInfo({},{'portfolio':1});
        } else {
            viewInfo({},{});
        }
    }
});

function viewInfo(entityObj, paramsObj, contactsPopup) {
    var $contactPopup = contactsPopup ? contactsPopup : $('[ppcontacts-action="show"]');
    if (!$contactPopup && (!entityObj || !entityObj.contentId)) {return null}

    var defaultEntity = {
        controller: $contactPopup.attr('controller'),
        action: $contactPopup.attr('action'),
        contentType: $contactPopup.attr('cp-contentType'),
        contentId: $contactPopup.attr('cp-contentId')
    };
    if (!paramsObj) {
        paramsObj = {};
    }
    var i;
    for (i in defaultEntity) {
        if (defaultEntity.hasOwnProperty(i)) {
            if (!entityObj[i]) {
                entityObj[i] = defaultEntity[i];
            }
        }
    }
    if (!entityObj.controller || !entityObj.action || !entityObj.contentType || !entityObj.contentId) {
        console.error('viewinfo missing major parameter:' + entityObj.controller + '_' + entityObj.action + '_' + entityObj.contentType + '_' + entityObj.contentId);
        return null;
    }
    var go = true;
    if (window.sessionStorage) {
        var dtCurrent = Math.round(new Date().getTime()/1000);
        var cache = localStorage.getItem('viewInfo');
        if (!cache) {
            cache = {};
        } else {
            cache = JSON.parse(cache);
        }
        var dtCreate = cache['dtCreate'] ? cache['dtCreate'] : dtCurrent;
        dtCreate = +dtCreate;
        var dtExpired = dtCreate + (86400 * 7);
        var userId = USER.isGuest ? 'guest' : USER.id;
        if (dtExpired<dtCurrent) {
            localStorage.removeItem('viewInfo');
            cache = {};
            dtCreate = dtCurrent;
        }
        if (dtCreate == dtCurrent) {
            cache['dtCreate'] = dtCurrent;
        }
        if (getProperty(cache,userId+'.'+entityObj.contentType+'.'+entityObj.contentId+'.'+entityObj.controller+'.'+entityObj.action)) { // если есть в кеше, не делаем пост
            go = false;
        }
        if (getProperty(cache,userId+'.'+entityObj.contentType+'.'+entityObj.contentId+'.params')) { // если в кеше есть параметры, ставим их в глобальный массив
            var settedParams = cache[userId][entityObj.contentType][entityObj.contentId]['params'];
            var attr = null;
            for(var index in settedParams) {
                if (settedParams.hasOwnProperty(index)) {
                    attr = settedParams[index];
                    window.viewInfoData[index] = attr;
                    if ((!paramsObj || !paramsObj.feedback) && index == 'feedback' && ppContacts.$main !== null) {
                        ppContacts.feedback.onload(attr);
                    }
                }
            }

            if (paramsObj) {
                go = false;
                for(i in paramsObj) {
                    if (paramsObj.hasOwnProperty(i)) {
                        if (cache[userId][entityObj.contentType][entityObj.contentId]['params'][i] != paramsObj[i]) {
                            go = true;
                        }
                    }
                }
            }
        }
        if (go) {
            viewInfo_setCache(cache,userId,entityObj.contentType,entityObj.contentId,entityObj.controller,entityObj.action,paramsObj);
        }
    }
    if (go) {
        var data = {
            'content_type': entityObj.contentType,
            'content_id': entityObj.contentId,
            'controller': entityObj.controller,
            'action': entityObj.action
        };
        if (paramsObj) {
            for(i in paramsObj) {
                if (paramsObj.hasOwnProperty(i)) {
                    data.param = i;
                    data.value = paramsObj[i];
                }
            }
        }

        data = JSON.stringify(data);
        $.ajax({
            type: 'POST',
            url: API_URL + '/v2/viewInfos/',
            data: data,
            dataType: 'json',
            xhrFields: {
                withCredentials: true
            },
            success: function (json) {
                if (json) {
                    var params = {};
                    var need = ['feedback','phone'];
                    $(need).each(function(i,param){
                        params[param] = json.view_info[param];
                        window.viewInfoData[param] = json.view_info[param];
                        if (param == 'feedback' && ppContacts.$main !== null) {
                            ppContacts.feedback.onload(json.view_info[param]);
                        }
                    });
                    viewInfo_setCache(cache,userId,json.view_info.content_type,json.view_info.content_id,null,null,params);
                    try {
                        localStorage.setItem('viewInfo', JSON.stringify(cache));
                    } catch (error) {
                    }
                }
            }
        });
    }
}

function viewInfo_setCache(cache,userId,contentType,contentId,controller,action,params) {
    if (!cache[userId]) {
        cache[userId] = {};
    }
    if (!cache[userId][contentType]) {
        cache[userId][contentType] = {};
    }
    if (!cache[userId][contentType][contentId]) {
        cache[userId][contentType][contentId] = {};
    }
    if (controller && !cache[userId][contentType][contentId][controller]) {
        cache[userId][contentType][contentId][controller] = {};
    }
    if (action && !cache[userId][contentType][contentId][controller][action]) {
        cache[userId][contentType][contentId][controller][action] = 1;
    }
    if (params) {
        if (!cache[userId][contentType][contentId]['params']) {
            cache[userId][contentType][contentId]['params'] = {};
        }
        for (var param in params) if (params.hasOwnProperty(param)) {
            var value = params[param];
            if (!cache[userId][contentType][contentId]['params'][param] || cache[userId][contentType][contentId]['params'][param]!=value) {
                cache[userId][contentType][contentId]['params'][param] = value;
            }
        }
    }
}

/* 
 * waitImages.js
 */
function waitImages($block, callback)
{
    var $images  = $block.find('img')
    var count = $images.length
    if (count) {
        $images.each(function(i, $image) {
            $image = $($image)
            if ($image.width() && $image.height()) {
                count--
                if (count == 0) {
                    callback()
                }
            } else {
                $image.on('load', function() {
                    count--
                    $image.off('load')
                    if (count == 0) {
                        callback()
                    }
                })
            }
        })
    } else {
        callback()
    }
}